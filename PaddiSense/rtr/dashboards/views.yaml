# =============================================================================
# REAL TIME RICE (RTR) DASHBOARD
# =============================================================================
# Displays paddock predictions from Real Time Rice integration.
# Data is fetched daily from the RTR CSV endpoint.
# Filters to show only paddocks marked as current_season in the registry.
# =============================================================================

title: Real Time Rice
views:
  - title: Predictions
    path: predictions
    icon: mdi:rice
    cards:
      # Header with title and refresh button
      - type: custom:button-card
        entity: sensor.paddisense_real_time_rice
        show_name: false
        show_state: false
        show_icon: false
        tap_action:
          action: none
        styles:
          card:
            - background: transparent
            - box-shadow: none
            - padding: 0 0 16px 0
          grid:
            - display: block
        custom_fields:
          header: |
            [[[
              const attrs = entity.attributes || {};
              const lastUpdated = attrs.last_updated || '';
              let lastUpdateText = '';

              if (lastUpdated) {
                try {
                  const d = new Date(lastUpdated);
                  const now = new Date();
                  const diffMs = now - d;
                  const diffDays = Math.floor(diffMs / 86400000);
                  const diffHours = Math.floor(diffMs / 3600000);

                  if (diffDays === 0) {
                    if (diffHours < 1) {
                      lastUpdateText = 'Updated just now';
                    } else {
                      lastUpdateText = `Updated ${diffHours}h ago`;
                    }
                  } else if (diffDays === 1) {
                    lastUpdateText = 'Updated yesterday';
                  } else if (diffDays < 7) {
                    lastUpdateText = `Updated ${diffDays} days ago`;
                  } else {
                    lastUpdateText = `Updated ${d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}`;
                  }
                } catch(e) {
                  lastUpdateText = lastUpdated;
                }
              }

              return `
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                  <div style="display:flex;align-items:center;gap:12px;">
                    <ha-icon icon="mdi:rice" style="--mdc-icon-size:32px;color:#43a047;"></ha-icon>
                    <div>
                      <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);">Real Time Rice</div>
                      <div style="font-size:13px;color:var(--secondary-text-color);">
                        Crop growth predictions${lastUpdateText ? ` · <span style="color:#43a047;">${lastUpdateText}</span>` : ''}
                      </div>
                    </div>
                  </div>
                  <button onclick="
                    event.stopPropagation();
                    const btn = this;
                    const origHtml = btn.innerHTML;
                    btn.innerHTML = '<ha-icon icon=\\'mdi:loading\\' style=\\'--mdc-icon-size:18px;animation:spin 1s linear infinite;\\'></ha-icon> Refreshing...';
                    btn.disabled = true;
                    const ha = document.querySelector('home-assistant');
                    if (ha && ha.hass) {
                      ha.hass.callService('paddisense', 'refresh_rtr_data').then(() => {
                        setTimeout(() => { btn.innerHTML = origHtml; btn.disabled = false; }, 3000);
                      }).catch(() => { btn.innerHTML = origHtml; btn.disabled = false; });
                    }
                  " style="background:#0066cc;color:white;border:none;border-radius:10px;padding:12px 20px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
                    <ha-icon icon="mdi:refresh" style="--mdc-icon-size:20px;"></ha-icon>Refresh Data
                  </button>
                </div>
                <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
              `;
            ]]]

      # Paddock Predictions - filtered by RTR Year matching active season
      - type: custom:button-card
        entity: sensor.farm_registry_data
        triggers_update:
          - sensor.paddisense_real_time_rice
        show_name: false
        show_state: false
        show_icon: false
        tap_action:
          action: none
        styles:
          card:
            - background: transparent
            - box-shadow: none
            - padding: 0
          grid:
            - display: block
        custom_fields:
          paddocks: |
            [[[
              try {
                const registryEntity = entity;
                if (!registryEntity || !registryEntity.attributes) {
                  return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">Loading registry...</div>`;
                }

                // Get active season from registry to determine RTR year filter
                // RTR Year = harvest year (calendar year when crop is harvested)
                // CY25 = crops sown late 2025, harvested 2026 → RTR Year 2026
                // CY26 = crops sown late 2026, harvested 2027 → RTR Year 2027
                const activeSeason = registryEntity.attributes.active_season_name || '';
                let targetYear = null;

                // Extract year from season name and add 1 for RTR harvest year
                // e.g., CY25 -> 2025 + 1 = 2026, CY26 -> 2026 + 1 = 2027
                const yearMatch = activeSeason.match(/(\d{2,4})/);
                if (yearMatch) {
                  let yr = parseInt(yearMatch[1]);
                  if (yr < 100) yr += 2000;  // CY25 -> 2025
                  yr += 1;  // Add 1: CY25 -> RTR Year 2026
                  targetYear = yr.toString();
                }

                // Get paddocks from registry that have current_season: true
                const registryPaddocks = registryEntity.attributes.paddocks || {};
                const currentSeasonPaddockNames = [];

                for (const [pid, p] of Object.entries(registryPaddocks)) {
                  if (p.current_season === true) {
                    // Store multiple name variations for matching
                    const name = (p.name || pid).toLowerCase();
                    currentSeasonPaddockNames.push({
                      original: name,
                      normalized: name.replace(/[^a-z0-9]/g, '_'),
                      compact: name.replace(/[^a-z0-9]/g, ''),
                      // Handle common abbreviations: W17 -> ward_17, SW4 -> sw4
                      expanded: name.replace(/^w(\d+)/i, 'ward_$1').replace(/[^a-z0-9]/g, '_'),
                    });
                  }
                }

                // Get all RTR sensors from hass states
                const ha = document.querySelector('home-assistant');
                if (!ha || !ha.hass) {
                  return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">Loading...</div>`;
                }

                // Helper to check if RTR paddock matches any registry paddock
                function matchesPaddock(rtrId, rtrName) {
                  const rtrNorm = rtrId.toLowerCase();
                  const rtrNameNorm = (rtrName || '').toLowerCase().replace(/[^a-z0-9]/g, '_');
                  const rtrCompact = rtrNorm.replace(/[^a-z0-9]/g, '');

                  for (const p of currentSeasonPaddockNames) {
                    // Direct matches
                    if (rtrNorm === p.normalized || rtrNorm === p.expanded) return true;
                    if (rtrNameNorm === p.normalized || rtrNameNorm === p.expanded) return true;
                    if (rtrCompact === p.compact) return true;

                    // Partial matches for bays (e.g., sw5_b1 matches sw5)
                    if (rtrNorm.startsWith(p.normalized + '_') || rtrNorm.startsWith(p.expanded + '_')) return true;

                    // Ward matching: ward_17 matches w17, ward_19 matches w19
                    const wardMatch = rtrNorm.match(/^ward[_\s]*(\d+)/);
                    if (wardMatch) {
                      const wardNum = wardMatch[1];
                      if (p.compact === 'w' + wardNum || p.normalized === 'w' + wardNum) return true;
                    }
                  }
                  return false;
                }

                const rtrSensors = [];
                for (const [entityId, state] of Object.entries(ha.hass.states)) {
                  if (entityId.startsWith('sensor.paddisense_rtr_') && !entityId.endsWith('_version')) {
                    const paddockId = entityId.replace('sensor.paddisense_rtr_', '');
                    const attrs = state.attributes || {};

                    // Filter by year if we have a target year from active season
                    if (targetYear && attrs.year && attrs.year !== targetYear) {
                      continue;
                    }

                    // Check if paddock matches current season paddocks
                    if (matchesPaddock(paddockId, attrs.paddock)) {
                      rtrSensors.push({ entityId, state, paddockId });
                    }
                  }
                }

                if (rtrSensors.length === 0) {
                  const sowYear = targetYear ? (parseInt(targetYear) - 1).toString() : '';
                  let msg = targetYear
                    ? `No RTR data for ${activeSeason} (sown ${sowYear}, harvest ${targetYear})`
                    : 'No RTR data for current season paddocks';
                  return `<div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                    <ha-icon icon="mdi:rice" style="--mdc-icon-size:48px;margin-bottom:12px;opacity:0.5;"></ha-icon>
                    <div style="font-size:16px;">${msg}</div>
                    <div style="font-size:14px;margin-top:8px;">Ensure paddocks are registered in RTR and refresh data</div>
                    <div style="font-size:12px;margin-top:12px;color:var(--secondary-text-color);">
                      Registry paddocks: ${currentSeasonPaddockNames.map(p => p.original).join(', ') || 'None'}
                    </div>
                  </div>`;
                }

                // Sort by paddock name
                rtrSensors.sort((a, b) => {
                  const nameA = a.state.attributes.paddock || a.paddockId;
                  const nameB = b.state.attributes.paddock || b.paddockId;
                  return nameA.localeCompare(nameB);
                });

                // Helper functions
                function formatDate(d) {
                  if (!d) return '—';
                  try {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
                  } catch(e) { return d; }
                }

                function getDays(d) {
                  if (!d) return null;
                  try {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    const target = new Date(d);
                    target.setHours(0, 0, 0, 0);
                    return Math.round((target - now) / 86400000);
                  } catch(e) { return null; }
                }

                function badge(d, showDays = false) {
                  const days = getDays(d);
                  let color = 'var(--primary-text-color)';
                  let bg = 'rgba(0,0,0,0.05)';
                  let daysText = '';

                  if (days !== null) {
                    if (days < 0) { color = '#9e9e9e'; bg = 'rgba(158,158,158,0.15)'; daysText = '(past)'; }
                    else if (days === 0) { color = '#f44336'; bg = 'rgba(244,67,54,0.15)'; daysText = '(today)'; }
                    else if (days <= 7) { color = '#ff9800'; bg = 'rgba(255,152,0,0.15)'; daysText = `(${days}d)`; }
                    else if (days <= 14) { color = '#4caf50'; bg = 'rgba(76,175,80,0.15)'; daysText = `(${days}d)`; }
                    else { daysText = `(${days}d)`; }
                  }

                  const daysSpan = showDays && daysText ? `<span style="font-size:11px;margin-left:4px;opacity:0.8;">${daysText}</span>` : '';
                  return `<span style="padding:6px 10px;border-radius:8px;background:${bg};color:${color};font-weight:600;font-size:15px;">${formatDate(d)}${daysSpan}</span>`;
                }

                // Show filter info - clarify the year mapping
                const sowYear = targetYear ? (parseInt(targetYear) - 1).toString() : '';
                let html = `<div style="margin-bottom:12px;padding:10px 14px;background:rgba(67,160,71,0.1);border-radius:8px;display:flex;align-items:center;gap:10px;">
                  <ha-icon icon="mdi:filter" style="--mdc-icon-size:18px;color:#43a047;"></ha-icon>
                  <span style="font-size:13px;color:var(--primary-text-color);">
                    Showing <strong>${rtrSensors.length}</strong> paddocks for <strong>${activeSeason || 'current season'}</strong>${targetYear ? ` (sown ${sowYear}, harvest ${targetYear})` : ''}
                  </span>
                </div>`;

                html += '<div style="display:flex;flex-direction:column;gap:12px;">';

                for (const sensor of rtrSensors) {
                  const a = sensor.state.attributes;
                  const name = a.paddock || sensor.paddockId.replace(/_/g, ' ').toUpperCase();
                  const variety = a.variety || '';
                  const method = a.sow_method || '';
                  const year = a.year || '';
                  const subtitle = [variety, method, year ? `CY${year.slice(-2)}` : ''].filter(x => x).join(' · ');
                  const warning = a.warnings || '';

                  html += `
                    <div style="background:var(--card-background-color);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.08);border-left:4px solid #43a047;">
                      <!-- Header -->
                      <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
                        <div style="width:50px;height:50px;border-radius:50%;background:rgba(67,160,71,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                          <ha-icon icon="mdi:rice" style="--mdc-icon-size:26px;color:#43a047;"></ha-icon>
                        </div>
                        <div style="flex:1;min-width:0;">
                          <div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">${name}</div>
                          ${subtitle ? `<div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">${subtitle}</div>` : ''}
                        </div>
                      </div>

                      <!-- Dates Grid -->
                      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding-top:14px;border-top:1px solid var(--divider-color,rgba(255,255,255,0.1));">
                        <!-- Sow Date -->
                        <div style="padding:10px;background:rgba(0,0,0,0.03);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:6px;">Sown</div>
                          <div style="font-size:15px;font-weight:600;color:var(--primary-text-color);">${formatDate(a.sow_date)}</div>
                        </div>

                        <!-- PI Date -->
                        <div style="padding:10px;background:rgba(0,0,0,0.03);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:6px;">PI</div>
                          <div>${badge(a.pi_date, true)}</div>
                        </div>

                        <!-- Flowering -->
                        <div style="padding:10px;background:rgba(0,0,0,0.03);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:6px;">Flowering</div>
                          <div>${badge(a.flowering_date, true)}</div>
                        </div>

                        <!-- Harvest -->
                        <div style="padding:10px;background:rgba(0,0,0,0.03);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:6px;">Harvest 22%</div>
                          <div>${badge(a.harvest_date, true)}</div>
                        </div>

                        <!-- Predicted Moisture -->
                        <div style="padding:10px;background:rgba(33,150,243,0.08);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:#2196f3;text-transform:uppercase;margin-bottom:6px;">Moisture</div>
                          <div style="font-size:18px;font-weight:700;color:#2196f3;">${a.moisture_predict ? a.moisture_predict + '%' : '—'}</div>
                        </div>

                        <!-- Moisture Date -->
                        <div style="padding:10px;background:rgba(33,150,243,0.08);border-radius:8px;text-align:center;">
                          <div style="font-size:10px;font-weight:600;color:#2196f3;text-transform:uppercase;margin-bottom:6px;">Moisture Date</div>
                          <div>${a.moisture_date ? badge(a.moisture_date, false) : '<span style="color:var(--secondary-text-color);">—</span>'}</div>
                        </div>
                      </div>

                      ${warning ? `
                        <div style="margin-top:12px;padding:10px 12px;background:rgba(244,67,54,0.1);border-radius:8px;color:#f44336;font-size:13px;display:flex;align-items:center;gap:8px;">
                          <ha-icon icon="mdi:alert" style="--mdc-icon-size:18px;flex-shrink:0;"></ha-icon>
                          <span>${warning}</span>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }

                html += '</div>';
                return html;
              } catch (e) {
                return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
              }
            ]]]

      # Setup card when RTR not configured
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.paddisense_real_time_rice
            state: "Not configured"
        card:
          type: custom:button-card
          entity: sensor.paddisense_real_time_rice
          show_name: false
          show_state: false
          show_icon: false
          tap_action:
            action: none
          styles:
            card:
              - background: var(--card-background-color)
              - box-shadow: 0 2px 8px rgba(0,0,0,0.1)
              - border-radius: 16px
              - padding: 24px
              - border-left: 4px solid #ff9800
          custom_fields:
            setup: |
              [[[
                return `
                  <div style="text-align:center;">
                    <div style="width:80px;height:80px;margin:0 auto 16px;border-radius:50%;background:rgba(255,152,0,0.15);display:flex;align-items:center;justify-content:center;">
                      <ha-icon icon="mdi:cog-outline" style="--mdc-icon-size:40px;color:#ff9800;"></ha-icon>
                    </div>
                    <div style="font-size:22px;font-weight:700;color:var(--primary-text-color);margin-bottom:8px;">Set Up Real Time Rice</div>
                    <div style="font-size:14px;color:var(--secondary-text-color);margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto;">
                      Connect your RTR dashboard to display crop growth predictions for your paddocks.
                    </div>

                    <div style="background:rgba(0,0,0,0.03);border-radius:12px;padding:20px;text-align:left;max-width:500px;margin:0 auto;">
                      <div style="font-weight:600;color:var(--primary-text-color);margin-bottom:16px;">How to set up:</div>

                      <div style="display:flex;gap:12px;margin-bottom:16px;">
                        <div style="width:28px;height:28px;border-radius:50%;background:#ff9800;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">1</div>
                        <div style="padding-top:2px;">
                          <div style="font-weight:600;color:var(--primary-text-color);">Find your RTR link</div>
                          <div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">Open the email from Real Time Rice containing your dashboard link</div>
                        </div>
                      </div>

                      <div style="display:flex;gap:12px;margin-bottom:16px;">
                        <div style="width:28px;height:28px;border-radius:50%;background:#ff9800;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">2</div>
                        <div style="padding-top:2px;">
                          <div style="font-weight:600;color:var(--primary-text-color);">Copy the URL</div>
                          <div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">Copy the full link (ends with .html or .csv)</div>
                        </div>
                      </div>

                      <div style="display:flex;gap:12px;margin-bottom:20px;">
                        <div style="width:28px;height:28px;border-radius:50%;background:#ff9800;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">3</div>
                        <div style="padding-top:2px;">
                          <div style="font-weight:600;color:var(--primary-text-color);">Enter the URL</div>
                          <div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">Click the button below and paste your RTR URL</div>
                        </div>
                      </div>

                      <button onclick="
                        event.stopPropagation();
                        const ha = document.querySelector('home-assistant');
                        if (ha && ha.hass) {
                          const url = prompt('Paste your Real Time Rice URL here:\\n\\n(The link from your RTR email ending in .html or .csv)');
                          if (url && url.trim()) {
                            ha.hass.callService('paddisense', 'set_rtr_url', { url: url.trim() }).then(() => {
                              alert('RTR URL saved! Fetching data...');
                              ha.hass.callService('paddisense', 'refresh_rtr_data');
                            }).catch((err) => {
                              alert('Error: ' + (err.message || 'Failed to save URL'));
                            });
                          }
                        }
                      " style="width:100%;background:#ff9800;color:white;border:none;border-radius:10px;padding:14px 20px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <ha-icon icon="mdi:link-plus" style="--mdc-icon-size:20px;"></ha-icon>
                        Enter RTR URL
                      </button>
                    </div>

                    <div style="margin-top:16px;font-size:12px;color:var(--secondary-text-color);">
                      Data will refresh automatically each day at 6am
                    </div>
                  </div>
                `;
              ]]]

      # Notice when no active season is set
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.paddisense_real_time_rice
            state_not: "Not configured"
          - condition: state
            entity: sensor.farm_registry_data
            attribute: active_season
            state: ""
        card:
          type: custom:button-card
          show_name: false
          show_state: false
          show_icon: false
          tap_action:
            action: navigate
            navigation_path: /paddisense-manager/seasons
          styles:
            card:
              - background: rgba(33,150,243,0.1)
              - border-left: 4px solid #2196f3
              - border-radius: 12px
              - padding: 16px
              - cursor: pointer
          custom_fields:
            notice: |
              [[[
                return `
                  <div style="display:flex;align-items:center;gap:14px;">
                    <ha-icon icon="mdi:calendar-alert" style="--mdc-icon-size:32px;color:#2196f3;"></ha-icon>
                    <div>
                      <div style="font-weight:600;color:var(--primary-text-color);">No Active Season</div>
                      <div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">
                        Set an active season to filter RTR predictions. <span style="color:#2196f3;">Tap to go to Seasons →</span>
                      </div>
                    </div>
                  </div>
                `;
              ]]]

      # Notice when no paddocks marked for current season
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.paddisense_real_time_rice
            state_not: "Not configured"
          - condition: numeric_state
            entity: sensor.farm_registry_data
            attribute: total_paddocks
            below: 1
        card:
          type: custom:button-card
          show_name: false
          show_state: false
          show_icon: false
          tap_action:
            action: navigate
            navigation_path: /paddisense-manager/paddocks
          styles:
            card:
              - background: rgba(156,39,176,0.1)
              - border-left: 4px solid #9c27b0
              - border-radius: 12px
              - padding: 16px
              - cursor: pointer
          custom_fields:
            notice: |
              [[[
                return `
                  <div style="display:flex;align-items:center;gap:14px;">
                    <ha-icon icon="mdi:land-fields" style="--mdc-icon-size:32px;color:#9c27b0;"></ha-icon>
                    <div>
                      <div style="font-weight:600;color:var(--primary-text-color);">No Paddocks Registered</div>
                      <div style="font-size:13px;color:var(--secondary-text-color);margin-top:2px;">
                        Add paddocks and mark them for the current season. <span style="color:#9c27b0;">Tap to go to Paddocks →</span>
                      </div>
                    </div>
                  </div>
                `;
              ]]]

  # Settings view for RTR configuration
  - title: Settings
    path: settings
    icon: mdi:cog
    cards:
      # Header
      - type: custom:button-card
        show_name: false
        show_state: false
        show_icon: false
        tap_action:
          action: none
        styles:
          card:
            - background: transparent
            - box-shadow: none
            - padding: 0 0 16px 0
        custom_fields:
          header: |
            [[[
              return `
                <div style="display:flex;align-items:center;gap:12px;">
                  <ha-icon icon="mdi:cog" style="--mdc-icon-size:32px;color:#43a047;"></ha-icon>
                  <div>
                    <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);">RTR Settings</div>
                    <div style="font-size:13px;color:var(--secondary-text-color);">Manage Real Time Rice configuration</div>
                  </div>
                </div>
              `;
            ]]]

      # Current configuration status
      - type: custom:button-card
        entity: sensor.paddisense_real_time_rice
        show_name: false
        show_state: false
        show_icon: false
        tap_action:
          action: none
        styles:
          card:
            - background: var(--card-background-color)
            - border-radius: 16px
            - padding: 20px
        custom_fields:
          status: |
            [[[
              const state = entity.state;
              const attrs = entity.attributes || {};
              const configured = state !== 'Not configured';
              const lastUpdated = attrs.last_updated || 'Never';
              const paddockCount = attrs.paddock_count || 0;
              const csvUrl = attrs.csv_url || '';

              const statusColor = configured ? '#43a047' : '#ff9800';
              const statusIcon = configured ? 'mdi:check-circle' : 'mdi:alert-circle-outline';
              const statusText = configured ? 'Configured' : 'Not Configured';

              return `
                <div>
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                    <div style="width:48px;height:48px;border-radius:50%;background:rgba(${configured ? '67,160,71' : '255,152,0'},0.15);display:flex;align-items:center;justify-content:center;">
                      <ha-icon icon="${statusIcon}" style="--mdc-icon-size:26px;color:${statusColor};"></ha-icon>
                    </div>
                    <div>
                      <div style="font-size:18px;font-weight:700;color:var(--primary-text-color);">Status: ${statusText}</div>
                      <div style="font-size:13px;color:var(--secondary-text-color);">${configured ? paddockCount + ' paddocks loaded' : 'Enter your RTR URL to get started'}</div>
                    </div>
                  </div>

                  ${configured ? `
                    <div style="background:rgba(0,0,0,0.03);border-radius:12px;padding:16px;margin-bottom:16px;">
                      <div style="display:grid;gap:12px;">
                        <div>
                          <div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:4px;">Last Updated</div>
                          <div style="font-size:14px;color:var(--primary-text-color);">${lastUpdated}</div>
                        </div>
                        <div>
                          <div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:4px;">Paddocks</div>
                          <div style="font-size:14px;color:var(--primary-text-color);">${paddockCount}</div>
                        </div>
                      </div>
                    </div>
                  ` : ''}

                  <div style="display:flex;flex-wrap:wrap;gap:10px;">
                    <button onclick="
                      event.stopPropagation();
                      const ha = document.querySelector('home-assistant');
                      if (ha && ha.hass) {
                        const url = prompt('Enter your Real Time Rice URL:\\n\\n(Paste the link from your RTR email)');
                        if (url && url.trim()) {
                          ha.hass.callService('paddisense', 'set_rtr_url', { url: url.trim() }).then(() => {
                            alert('RTR URL saved! Fetching data...');
                            ha.hass.callService('paddisense', 'refresh_rtr_data');
                          }).catch((err) => {
                            alert('Error: ' + (err.message || 'Failed to save URL'));
                          });
                        }
                      }
                    " style="flex:1;min-width:140px;background:#43a047;color:white;border:none;border-radius:10px;padding:12px 16px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                      <ha-icon icon="mdi:${configured ? 'pencil' : 'link-plus'}" style="--mdc-icon-size:18px;"></ha-icon>
                      ${configured ? 'Update URL' : 'Enter URL'}
                    </button>

                    ${configured ? `
                      <button onclick="
                        event.stopPropagation();
                        const btn = this;
                        const origHtml = btn.innerHTML;
                        btn.innerHTML = '<ha-icon icon=\\'mdi:loading\\' style=\\'--mdc-icon-size:18px;animation:spin 1s linear infinite;\\'></ha-icon>';
                        btn.disabled = true;
                        const ha = document.querySelector('home-assistant');
                        if (ha && ha.hass) {
                          ha.hass.callService('paddisense', 'refresh_rtr_data').then(() => {
                            setTimeout(() => { btn.innerHTML = origHtml; btn.disabled = false; }, 2000);
                          }).catch(() => { btn.innerHTML = origHtml; btn.disabled = false; });
                        }
                      " style="flex:1;min-width:140px;background:#0066cc;color:white;border:none;border-radius:10px;padding:12px 16px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <ha-icon icon="mdi:refresh" style="--mdc-icon-size:18px;"></ha-icon>
                        Refresh Data
                      </button>
                    ` : ''}
                  </div>
                </div>
                <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
              `;
            ]]]

      # Help section
      - type: markdown
        content: |
          ### Getting Your RTR URL

          1. Open the email you received from **Real Time Rice**
          2. Find the link to your paddock dashboard (usually ends in `.html`)
          3. Copy the full URL
          4. Paste it above using the **Enter URL** or **Update URL** button

          **Tip:** The URL looks like:
          `https://storage.googleapis.com/realtimerice/.../rtr_dashboard_xxx.html`

          ---

          **Data Refresh:** RTR data automatically updates daily at 6am. Use the Refresh button to manually fetch the latest predictions.
        card_mod:
          style: |
            ha-card {
              background: rgba(0,0,0,0.02);
              border-radius: 12px;
            }
