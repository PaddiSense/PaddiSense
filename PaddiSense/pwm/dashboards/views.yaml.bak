##############################################################################
# PWM Dashboard - Precision Water Management
# PaddiSense Farm Management System
# Generated: 2026-01-26T09:36:54
# Version: 2026.01.1
#
# PADDOCK VIEWS ARE AUTO-GENERATED
# Manual edits to paddock views will be overwritten.
# Edit Overview and Settings views safely.
##############################################################################

title: PWM - Water Management
button_card_templates:
  template_titleblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(200, 250, 55)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
      - height: 20px
      name:
      - font-size: 14px
      - font-weight: 700
      - color: black
  template_textblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(162, 55, 250)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
      - height: 20px
      name:
      - font-size: 14px
      - font-weight: 700
  template_wifi_access_points:
    variables:
      var_entity: entity.name
      var_name: Access Point Name
    name: '[[[ return variables.var_name]]]'
    color_type: card
    state:
    - value: Adoption Failed
      color: rgb(255,0,0)
      icon: mdi:wifi-alert
    - value: Disconnected
      color: rgb(255,0,0)
      icon: mdi:wifi-alert
    - value: connected
      color: rgb(0,255,0)
      icon: mdi:wifi
    - value: Isolated
      color: rgb(255, 255, 0)
      icon: mdi:wifi-alert
    styles:
      card:
      - height: 100px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
    tap_action:
      action: more-info
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
    label: |
      [[[
        var name = entity.entity_id
        if (states[name].state === "Adoption Failed") return "Maintenance Required";
        if (states[name].state === "Disconnected") return "Maintenance Required";
        if (states[name].state === "Isolated") return "Maintenance Required";
        if (states[name].state === "connected") return "OK";
        return states[name].state;
      ]]]
  template_switch_on_off:
    variables:
      var_entity: entity.name
      var_name: LocationName
    label: |
      [[[
        var name = entity.entity_id
        if (states[name].state === "on") return "On";
        else if (states[name].state === "off") return "Off";
        return states[name].state;
      ]]]
    state:
    - value: 'off'
      color: rgb(255,0, 0)
      icon: mdi:engine-off
    - value: 'on'
      color: rgb(0,255,0)
      icon: mdi:engine
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 30px
      - width: 30px
      name:
      - font-size: 12px
    tap_action:
      action: toggle
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
  template_timer_on_off:
    state:
    - value: 'off'
      color: rgb(255,0, 0)
      icon: mdi:timer-off
    - value: 'on'
      color: rgb(0,255,0)
      icon: mdi:clock-start
    - value: idle
      color: rgb(128,128,128)
      icon: mdi:timer-off
    - value: active
      color: rgb(0,255,0)
      icon: mdi:timer
    - value: paused
      color: rgb(255,165,0)
      icon: mdi:timer-pause
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 30px
      - width: 30px
      name:
      - font-size: 12px
    tap_action:
      action: toggle
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
  template_channel_autostate:
    variables:
      var_name: LocationName
    label: |
      [[[
        const entity_id = entity.entity_id;
        const stateObj = states[entity_id];
        if (!stateObj) return "Entity not found";
        switch (stateObj.state) {
          case "Off": return "Off";
          case "Manual": return "Manual";
          case "Auto": return "Auto";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Auto
      color: rgb(0, 255, 0)
      icon: mdi:door-open
    - value: Manual
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_buttoncard_openclose_simple:
    variables:
      var_name: LocationName
    label: |-
      [[[
        const stateObj = entity;
        if (!stateObj) return "Entity Not Found";
        switch (stateObj.state) {
          case "Open": return "Open";
          case "Close": return "Closed";
          case "HoldOne":
          case "HoldTwo": return "Hold Position";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: Close
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Open
      color: rgb(50, 100, 230)
      icon: mdi:door-open
    - value: HoldOne
      color: rgb(128, 128, 128)
      icon: mdi:pause
    - value: HoldTwo
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_buttoncard_openclose:
    variables:
      var_name: LocationName
      paddock_var: ''
      bay_var: ''
      device_type: supply_1
      status_label: |-
        [[[
          // --- helpers ---
          const slugify = (s) => (s ?? '')
            .toString().trim().toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/g, '')
            .replace(/_+/g, '_');

          const pdk = String(variables.paddock_var ?? '');
          const bay = String(variables.bay_var ?? '');
          const deviceType = String(variables.device_type ?? 'supply_1');

          // --- Get device from pwm_data ---
          const pwmData = hass.states['sensor.pwm_data']?.attributes || {};
          const bays = pwmData.bays || {};

          // Build bay key: paddock_bay (e.g., sw4_e_b_01)
          const baySlug = slugify(bay);
          const bayKey = pdk + '_' + baySlug;
          const bayData = bays[bayKey] || {};

          // Get device from the specified device type
          const deviceInfo = bayData[deviceType] || {};
          const devRaw = String(deviceInfo.device ?? '').trim();
          const devId = slugify(devRaw);

          // --- 1) UNSET if device unset or missing ---
          if (!devRaw || devRaw.toLowerCase() === 'unset' || devRaw === '') {
            return 'UNSET';
          }

          // --- 2) OFFLINE if online binary sensor is not online ---
          const keys = Object.keys(hass.states || {});
          const onlineKeys = keys
            .filter(k => k.startsWith('binary_sensor.'))
            .filter(k => /(^|_)online($|_)/i.test(k));

          const reDev = new RegExp(devId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
          const candidates = onlineKeys.filter(k => reDev.test(k));
          const onlineEid = candidates[0] || null;

          const onlineStates = new Set(['on', 'connected', 'online', 'true', 'available']);
          const onlineState = onlineEid ? hass.states[onlineEid]?.state : undefined;
          const isOnline = onlineStates.has(String(onlineState ?? '').toLowerCase());

          if (onlineEid && !isOnline) {
            return 'OFFLINE';
          }

          // --- 3) Return mapped door state ---
          const stateObj = entity;
          if (!stateObj) return 'Entity Not Found';

          const s = String(stateObj.state || '').toLowerCase();
          if (s === 'open') return 'Open';
          if (s === 'close' || s === 'closed') return 'Closed';
          if (['holdone','holdtwo','hold'].includes(s)) return 'Hold Position';

          // Check if we can get valve position
          const valveId = `valve.${devId}_${devId}_actuator_1`;
          const valveState = hass.states[valveId]?.state;
          const valvePos = hass.states[valveId]?.attributes?.current_position;
          if (valveState && ['opening', 'closing'].includes(valveState)) {
            return valveState.toUpperCase();
          } else if (valveState && valvePos !== undefined && valvePos !== 0 && valvePos !== 100) {
            return valveState.toUpperCase() + ' (' + valvePos + '%)';
          }

          return stateObj.state;
        ]]]
    label: '[[[ return variables.status_label ]]]'
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: Close
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Open
      color: rgb(50, 100, 230)
      icon: mdi:door-open
    - value: HoldOne
      color: rgb(128, 128, 128)
      icon: mdi:pause
    - value: HoldTwo
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      - background-color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(240, 240, 240)';
            const es = String(entity?.state || '');
            if (es === 'Close') return 'rgb(255, 0, 0)';
            if (es === 'Open') return 'rgb(50, 100, 230)';
            if (es === 'HoldOne' || es === 'HoldTwo') return 'rgb(128, 128, 128)';
            return '';
          ]]]
      icon:
      - height: 50px
      - width: 50px
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
      name:
      - font-size: 18px
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
      label:
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_inputselect_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(128, 128, 128)
      icon: mdi:autorenew-off
    - value: Flush
      color: rgb(230, 119, 230)
      icon: mdi:auto-mode
    - value: Maintain
      color: rgb(29, 171, 222)
      icon: mdi:auto-mode
    - value: Drain
      color: rgb(222, 171, 29)
      icon: mdi:auto-download
    - value: Pond
      color: rgb(29, 171, 222)
      icon: mdi:waves
    - value: Saturate
      color: rgb(106, 247, 177)
      icon: mdi:water-sync
    color_type: card
    styles:
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
      - white-space: normal
      - text-align: center
      state:
      - margin-top: 10px
      - text-align: center
      card:
      - height: 120px
      - display: |
          [[[
            const paddock = variables.paddock_var;
            if (!paddock) return null;
            const s = hass.states['sensor.pwm_data'];
            const paddocks = s?.attributes?.paddocks || {};
            const pdk = paddocks[paddock];
            if (pdk && pdk.automation_state_individual === true) return null;
            return 'none';
          ]]]
    show_name: true
    show_icon: true
    show_state: true
    show_label: false
  template_paddock_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(128, 128, 128)
      icon: mdi:autorenew-off
    - value: Flush
      color: rgb(230, 119, 230)
      icon: mdi:auto-mode
    - value: Maintain
      color: rgb(29, 171, 222)
      icon: mdi:auto-mode
    - value: Drain
      color: rgb(222, 171, 29)
      icon: mdi:auto-download
    - value: Pond
      color: rgb(29, 171, 222)
      icon: mdi:waves
    - value: Saturate
      color: rgb(106, 247, 177)
      icon: mdi:water-sync
    color_type: card
    styles:
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
      - white-space: normal
      - text-align: center
      state:
      - margin-top: 10px
      - text-align: center
      card:
      - height: 120px
    show_name: true
    show_icon: true
    show_state: true
    show_label: false
  template_paddockconfigbutton:
    variables:
      paddock_id: ''
      paddock_name: ''
    name: Paddock Config
    icon: mdi:land-fields
    color: orange
    color_type: card
    styles:
      card:
      - height: 120px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
    show_name: true
    show_icon: true
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.sequence
        data:
          sequence:
          - service: input_text.set_value
            data:
              entity_id: input_text.pwm_paddock_config_pointer
              value: '[[[ return variables.paddock_id ]]]'
          - service: browser_mod.delay
            data:
              time: 250
          - service: browser_mod.popup
            data:
              title: |
                [[[
                  const sel = variables.paddock_name || variables.paddock_id || '';
                  return sel.toUpperCase() + ' Config';
                ]]]
              tag: paddockconfig
              dismissable: true
              icon: mdi:help-circle-outline
              icon_title: Help
              icon_close: false
              icon_action:
                service: browser_mod.popup
                data:
                  title: Paddock Config Help
                  tag: paddockhelp
                  icon: mdi:help-circle-outline
                  icon_close: false
                  dismiss_icon: mdi:chevron-left
                  content: |
                    **Paddock Configuration Help**

                    This page allows you to configure devices and settings for each bay in the paddock.

                    **Time On Water** - Shows active flush timers for bays currently in Flush mode.

                    **Water Depths** - Configure minimum and maximum water depth targets for each bay.

                    **Bay Devices** - Assign ESPHome devices to each bay. Tap a bay to change its device assignment. The device selector shows all ESPHome devices. Select a device and press Save.

                    **Supply Channel** - Configure the supply channel water level sensor and offset.

                    Press the back arrow to return to the paddock config page.
              content:
                type: vertical-stack
                cards:
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Time On Water
                - type: custom:auto-entities
                  card:
                    type: custom:layout-card
                    layout_type: custom:grid-layout
                  filter:
                    template: |-
                      {% set pdk_sel = states('input_text.pwm_paddock_config_pointer') %}
                      {% set pwm = state_attr('sensor.pwm_data', 'bays') | default({}, true) %}
                      {% set row = namespace(cards=[]) %}
                      {% for bay_id, bay in pwm.items() if bay.paddock_id == pdk_sel %}
                        {% if 'drain' not in bay_id %}
                          {% set timer_entity = 'timer.' ~ bay_id ~ '_flushtimeonwater' %}
                          {% set autostate_entity = 'input_select.' ~ bay_id ~ '_automation_state' %}
                          {% set timer_state = states(timer_entity) %}
                          {% if timer_state not in ['unknown', 'unavailable'] %}
                            {% if states(autostate_entity) == 'Flush' %}
                              {% set timer_card = {
                                "type": "custom:circular-timer-card",
                                "entity": timer_entity,
                                "name": bay.name ~ " Time On",
                                "bins": "36",
                                "direction": "countdown",
                                "layout": "circular",
                                "color": ["#1e7843", "#a9bdbb", "#ee7256"],
                                "tap_action": { "action": "more-info" },
                                "primary_info": "timer",
                                "secondary_info_size": "20%"
                              } %}
                              {% set row.cards = row.cards + [timer_card] %}
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                      {{ row.cards | to_json }}
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Water Depths
                - type: custom:auto-entities
                  card:
                    type: vertical-stack
                  card_param: cards
                  filter:
                    template: |-
                      {% set pdk_sel = states('input_text.pwm_paddock_config_pointer') %}
                      {% set pwm = state_attr('sensor.pwm_data', 'bays') | default({}, true) %}
                      {% set row = namespace(cards=[]) %}
                      {% for bay_id, bay in pwm.items() if bay.paddock_id == pdk_sel %}
                        {% if 'drain' not in bay_id %}
                          {% set min_entity = 'input_number.' ~ bay_id ~ '_waterlevelmin' %}
                          {% set max_entity = 'input_number.' ~ bay_id ~ '_waterlevelmax' %}
                          {% set min_state = states(min_entity) %}
                          {% set max_state = states(max_entity) %}
                          {% if min_state not in ['unknown', 'unavailable'] or max_state not in ['unknown', 'unavailable'] %}
                            {% set header_card = {
                              "type": "custom:mushroom-title-card",
                              "title": bay.name
                            } %}
                            {% set min_card = {
                              "type": "custom:mushroom-number-card",
                              "entity": min_entity,
                              "name": "Min Water Depth",
                              "display_mode": "buttons"
                            } %}
                            {% set max_card = {
                              "type": "custom:mushroom-number-card",
                              "entity": max_entity,
                              "name": "Max Water Depth",
                              "display_mode": "buttons"
                            } %}
                            {% set levels_card = {
                              "type": "horizontal-stack",
                              "cards": [min_card, max_card]
                            } %}
                            {% set row.cards = row.cards + [header_card, levels_card] %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                      {{ row.cards | to_json }}
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Bay Devices
                - type: custom:auto-entities
                  card:
                    type: entities
                  filter:
                    template: |-
                      {% set pdk_sel = states('input_text.pwm_paddock_config_pointer') %}
                      {% set pwm = state_attr('sensor.pwm_data', 'bays') | default({}, true) %}
                      {% set out = namespace(list=[]) %}
                      {% for bay_id, bay in pwm.items() | sort(attribute='1.order') if bay.paddock_id == pdk_sel %}
                        {% set supply_data = bay.supply_1 if bay.supply_1 else {} %}
                        {% set device = supply_data.device | default('unset') if supply_data else 'unset' %}
                        {% set device = device if device else 'unset' %}
                        {% set is_set = device not in ['unset', 'none', '', none] %}
                        {% set colour = 'green' if is_set else 'red' %}

                        {# Try to get HA device ID for the default value in selector #}
                        {% set dev_slug = device | slugify | replace('_', '-') | upper if is_set else '' %}
                        {% set dev_id = device_id(dev_slug) | default('') if dev_slug else '' %}

                        {# Advanced config cards for bay settings #}
                        {% set offset_entity = 'input_number.' ~ bay_id ~ '_waterleveloffset' %}
                        {% set depth_entity = 'sensor.pwm_' ~ bay_id ~ '_water_depth' %}
                        {% set offset_state = states(offset_entity) %}

                        {% set adv_bay_cards = [] %}
                        {% if offset_state not in ['unknown', 'unavailable'] %}
                          {% set adv_bay_cards = [{
                            "type": "vertical-stack",
                            "cards": [
                              {"type": "custom:button-card", "template": "template_textblock", "variables": {"var_name": "Bay Config"}},
                              {"type": "horizontal-stack", "cards": [
                                {"type": "custom:mushroom-number-card", "entity": offset_entity, "name": "Water Level Offset", "display_mode": "buttons"},
                                {"type": "custom:mushroom-entity-card", "entity": depth_entity, "name": "Current Depth", "fill_container": true}
                              ]}
                            ]
                          }] %}
                        {% endif %}

                        {# Advanced config cards for device settings #}
                        {% set dev_slug_lower = device | slugify %}
                        {% set adv_dev_cards = [] %}
                        {% if is_set %}
                          {% set adv_dev_cards = [
                            {"type": "custom:button-card", "template": "template_textblock", "variables": {"var_name": (device | upper) ~ " Config"}},
                            {"type": "horizontal-stack", "cards": [
                              {"type": "vertical-stack", "cards": [
                                {"type": "custom:button-card", "entity": "input_boolean." ~ dev_slug_lower ~ "_flag_use_time_open", "name": "Use Open Timer", "template": "template_timer_on_off"},
                                {"type": "custom:mushroom-number-card", "entity": "input_number." ~ dev_slug_lower ~ "_duration_open_sec", "name": "Open Duration", "layout": "vertical", "display_mode": "buttons"}
                              ]},
                              {"type": "vertical-stack", "cards": [
                                {"type": "custom:button-card", "entity": "input_boolean." ~ dev_slug_lower ~ "_flag_use_time_close", "name": "Use Close Timer", "template": "template_timer_on_off"},
                                {"type": "custom:mushroom-number-card", "entity": "input_number." ~ dev_slug_lower ~ "_duration_close_sec", "name": "Close Duration", "layout": "vertical", "display_mode": "buttons"}
                              ]}
                            ]},
                            {"type": "custom:mushroom-number-card", "entity": "input_number." ~ dev_slug_lower ~ "_duration_full_close_sec", "name": "Max Duration", "layout": "vertical", "display_mode": "buttons"}
                          ] %}
                        {% endif %}

                        {% set style %}
                          :host {
                            --card-mod-icon-color: {{ colour }};
                            --paper-item-icon-color: {{ colour }};
                            --state-icon-active-color: {{ colour }};
                          }
                          ha-icon { color: {{ colour }} !important; }
                        {% endset %}

                        {% set row = {
                          "type": "custom:template-entity-row",
                          "name": bay.name,
                          "state": device if is_set else "Not Set",
                          "secondary": "Tap to change device",
                          "icon": "mdi:land-rows-vertical" if is_set else "mdi:alert",
                          "card_mod": {"style": style},
                          "tap_action": {
                            "action": "fire-dom-event",
                            "browser_mod": {
                              "service": "browser_mod.popup",
                              "data": {
                                "title": "Set Device for " ~ bay.name,
                                "tag": "bayconfig",
                                "right_button": "Save",
                                "left_button": "Advanced" if is_set else none,
                                "content": [{
                                  "name": "new_device",
                                  "label": "Select ESPHome Device",
                                  "default": dev_id if dev_id else "",
                                  "selector": {"device": {"filter": {"integration": "esphome"}}}
                                }],
                                "right_button_action": {
                                  "service": "script.pwm_update_bay_device",
                                  "data": {"paddock": pdk_sel, "bay": bay.name}
                                },
                                "right_button_variant": "brand",
                                "left_button_action": {
                                  "service": "browser_mod.popup",
                                  "data": {
                                    "title": bay.name ~ " Advanced Config",
                                    "tag": "advancedbayconfig",
                                    "dismiss_icon": "mdi:chevron-left",
                                    "content": {
                                      "type": "vertical-stack",
                                      "cards": adv_bay_cards + [{"type": "vertical-stack", "cards": adv_dev_cards}] if adv_dev_cards else adv_bay_cards
                                    }
                                  }
                                } if is_set else none,
                                "left_button_variant": "brand" if is_set else none,
                                "left_button_close": false,
                                "dismissable": false,
                                "dismiss_icon": "mdi:chevron-left"
                              }
                            }
                          }
                        } %}
                        {% set out.list = out.list + [row] %}
                      {% endfor %}
                      {{ out.list | tojson }}
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Supply Channel
                - type: custom:auto-entities
                  card:
                    type: vertical-stack
                  card_param: cards
                  filter:
                    template: |-
                      {% set pdk_sel = states('input_text.pwm_paddock_config_pointer') %}
                      {% set supply_level = 'sensor.pwm_' ~ pdk_sel ~ '_supply_water_depth' %}
                      {% set supply_offset = 'input_number.' ~ pdk_sel ~ '_supply_waterleveloffset' %}
                      {% set level_card = {
                        "type": "custom:mushroom-entity-card",
                        "entity": supply_level,
                        "name": "Current Depth",
                        "fill_container": true
                      } %}
                      {% set offset_card = {
                        "type": "custom:mushroom-number-card",
                        "entity": supply_offset,
                        "name": "Offset",
                        "display_mode": "buttons"
                      } %}
                      {{ [{"type": "horizontal-stack", "cards": [level_card, offset_card]}] | tojson }}
                - type: custom:auto-entities
                  card:
                    type: vertical-stack
                  card_param: cards
                  filter:
                    template: |-
                      {% set pdk_sel = states('input_text.pwm_paddock_config_pointer') %}
                      {% set fcs_timer = 'timer.' ~ pdk_sel ~ '_flushclosesupplytimer' %}
                      {% if states(fcs_timer) not in ['unknown', 'unavailable'] %}
                        {{ [{
                          "type": "vertical-stack",
                          "cards": [
                            {"type": "custom:button-card", "template": "template_titleblock", "variables": {"var_name": (pdk_sel | upper) ~ " Flush Close Supply Timer"}},
                            {"type": "custom:circular-timer-card", "entity": fcs_timer, "name": (pdk_sel | upper) ~ " Close Supply", "bins": "48", "direction": "countdown", "layout": "circle", "color": ["#1e7843", "#a9bdbb", "#ee7256"], "secondary_info_size": "40%"}
                          ]
                        }] | tojson }}
                      {% else %}
                        {{ [] | tojson }}
                      {% endif %}
  template_extradatabutton:
    variables:
      nav_path: /pwm-service/overview
    name: Extra Data
    icon: mdi:database
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 60px
    show_name: true
    show_icon: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'
  template_paddock_overview_card:
    variables:
      paddock_id: ''
      paddock_name: ''
      bay_count: 0
      enabled: false
      nav_path: ''
    name: '[[[ return variables.paddock_name ]]]'
    icon: mdi:waves
    color: |
      [[[
        return variables.enabled ? 'rgb(46, 125, 50)' : 'rgb(117, 117, 117)';
      ]]]
    color_type: card
    styles:
      card:
      - height: 100px
      - border-radius: 12px
      icon:
      - width: 40px
      name:
      - font-size: 18px
      - font-weight: 700
    label: |
      [[[
        return variables.bay_count + ' bays | ' + (variables.enabled ? 'Enabled' : 'Disabled');
      ]]]
    show_name: true
    show_icon: true
    show_label: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'
  template_stat_chip:
    color_type: label-card
    show_icon: true
    show_name: true
    show_state: true
    tap_action:
      action: none
    styles:
      card:
      - height: 60px
      - border-radius: 10px
      - padding: 8px
      grid:
      - grid-template-areas: '"i s" "i n"'
      - grid-template-columns: 40px 1fr
      - grid-template-rows: 1fr 1fr
      icon:
      - width: 30px
      - color: white
      state:
      - font-size: 20px
      - font-weight: 700
      - justify-self: start
      - color: white
      name:
      - font-size: 12px
      - justify-self: start
      - color: rgba(255,255,255,0.8)
views:
- title: Overview
  path: overview
  icon: mdi:view-dashboard
  type: masonry
  cards:
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: PADDOCK OVERVIEW
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_stat_chip
      name: Paddocks
      icon: mdi:view-grid
      color: rgb(46, 125, 50)
      entity: sensor.pwm_data
      state_display: |
        [[[
          return states['sensor.pwm_data']?.attributes?.enabled_paddock_count || 0;
        ]]]
    - type: custom:button-card
      template: template_stat_chip
      name: Bays
      icon: mdi:format-list-numbered
      color: rgb(21, 101, 192)
      entity: sensor.pwm_data
      state_display: |
        [[[
          return states['sensor.pwm_data']?.attributes?.total_bays || 0;
        ]]]
    - type: custom:button-card
      template: template_stat_chip
      name: Devices
      icon: mdi:access-point
      color: rgb(156, 39, 176)
      entity: sensor.pwm_data
      state_display: |
        [[[
          return states['sensor.pwm_data']?.attributes?.device_count || 0;
        ]]]
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary if p.enabled %}
        {{ {
          'type': 'custom:button-card',
          'template': 'template_paddock_overview_card',
          'variables': {
            'paddock_id': p.id,
            'paddock_name': p.name,
            'bay_count': p.bay_count,
            'enabled': p.enabled,
            'nav_path': '/pwm-service/' ~ (p.id | replace('_', '-'))
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: QUICK ACTIONS
  - type: horizontal-stack
    cards:
    - type: button
      name: Settings
      icon: mdi:cog
      tap_action:
        action: navigate
        navigation_path: /pwm-service/settings
      icon_height: 50px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 50px
- title: SW4 East
  path: sw4-e
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW4 EAST CONTROLS
  - type: custom:button-card
    entity: input_select.sw4_e_automation_state
    name: SW4 East Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw4_e_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: sw4_e
        paddock_name: SW4 East
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: SW4 West
  path: sw4-w
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW4 WEST CONTROLS
  - type: custom:button-card
    entity: input_select.sw4_w_automation_state
    name: SW4 West Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw4_w_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: sw4_w
        paddock_name: SW4 West
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: SW5
  path: sw5
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW5 CONTROLS
  - type: custom:button-card
    entity: input_select.sw5_automation_state
    name: SW5 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw5_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: sw5
        paddock_name: SW5
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: W17
  path: w17
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W17 CONTROLS
  - type: custom:button-card
    entity: input_select.w17_automation_state
    name: W17 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w17_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: w17
        paddock_name: W17
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: W18
  path: w18
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W18 CONTROLS
  - type: custom:button-card
    entity: input_select.w18_automation_state
    name: W18 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w18_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: w18
        paddock_name: W18
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: W19
  path: w19
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W19 CONTROLS
  - type: custom:button-card
    entity: input_select.w19_automation_state
    name: W19 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w19_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      template: template_paddockconfigbutton
      variables:
        paddock_id: w19
        paddock_name: W19
      styles:
        card:
        - height: 80px
        icon:
        - height: 40px
        - width: 40px
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 40px
- title: Settings
  path: settings
  type: masonry
  cards:
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: PWM SETTINGS
  - type: entities
    title: System Status
    entities:
    - entity: sensor.pwm_data
      name: Status
      icon: mdi:check-circle
    - type: attribute
      entity: sensor.pwm_data
      attribute: version
      name: Version
      icon: mdi:tag
    - type: attribute
      entity: sensor.pwm_data
      attribute: total_paddocks
      name: Total Paddocks
      icon: mdi:view-grid
    - type: attribute
      entity: sensor.pwm_data
      attribute: total_bays
      name: Total Bays
      icon: mdi:format-list-numbered
    - type: attribute
      entity: sensor.pwm_data
      attribute: device_count
      name: Devices in Use
      icon: mdi:access-point
    - type: attribute
      entity: sensor.pwm_data
      attribute: backup_count
      name: Backups
      icon: mdi:backup-restore
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SYSTEM ACTIONS
  - type: horizontal-stack
    cards:
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 50px
    - type: button
      name: Export
      icon: mdi:download
      tap_action:
        action: call-service
        service: script.pwm_export_data
      icon_height: 50px
    - type: button
      name: Initialize
      icon: mdi:database-plus
      tap_action:
        action: call-service
        service: script.pwm_init_system
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: REGISTRY SYNC
  - type: markdown
    content: |
      Sync paddock/bay structure from Farm Registry.
      This imports new paddocks and updates structure without changing device assignments.
  - type: horizontal-stack
    cards:
    - type: button
      name: Sync from Registry
      icon: mdi:sync
      tap_action:
        action: call-service
        service: script.pwm_sync_from_registry
        confirmation:
          text: Sync paddock structure from Farm Registry?
      icon_height: 50px
    - type: button
      name: View Registry
      icon: mdi:database
      tap_action:
        action: navigate
        navigation_path: /registry-service/overview
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: ENTITY GENERATOR
  - type: markdown
    content: |
      After adding or modifying paddocks, generate entities to create
      the required automations, sensors, and controls.
  - type: horizontal-stack
    cards:
    - type: button
      name: Generate Entities
      icon: mdi:cog-sync
      tap_action:
        action: call-service
        service: script.pwm_generate_entities
        confirmation:
          text: Generate YAML files for all paddocks?
      icon_height: 50px
    - type: button
      name: Generate & Reload
      icon: mdi:restart
      tap_action:
        action: call-service
        service: script.pwm_generate_and_reload
        confirmation:
          text: Generate entities and reload all domains?
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DASHBOARD GENERATOR
  - type: markdown
    content: |
      Generate dashboard views for all enabled paddocks.
      Uses paddock images and bay badge positions from config.
  - type: button
    name: Generate Dashboard Views
    icon: mdi:view-dashboard-edit
    tap_action:
      action: call-service
      service: script.pwm_generate_dashboard
      confirmation:
        text: Regenerate all paddock dashboard views?
    icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: ADD PADDOCK
  - type: entities
    entities:
    - entity: input_text.pwm_new_paddock_name
      name: Paddock Name
    - entity: input_number.pwm_new_paddock_bay_count
      name: Number of Bays
    - entity: input_boolean.pwm_new_paddock_individual
      name: Individual Bay Mode
  - type: button
    name: Add Paddock
    icon: mdi:plus-circle
    tap_action:
      action: call-service
      service: script.pwm_add_paddock
      service_data:
        name: '{{ states(''input_text.pwm_new_paddock_name'') }}'
        bay_count: '{{ states(''input_number.pwm_new_paddock_bay_count'') | int }}'
        individual: '{{ is_state(''input_boolean.pwm_new_paddock_individual'', ''on'') }}'
    icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: MANAGE PADDOCKS
  - type: markdown
    content: |
      **Tap** to toggle enable/disable. **Hold** to delete.
      Green = enabled, Gray = disabled.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:waves' if p.enabled else 'mdi:waves-arrow-right',
          'state_display': (p.bay_count | string) ~ ' bays | ' ~ ('Enabled' if p.enabled else 'Disabled'),
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(46, 125, 50)' if p.enabled else 'rgb(117, 117, 117)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '70px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}]
          },
          'tap_action': {
            'action': 'call-service',
            'service': 'script.pwm_toggle_paddock_enabled',
            'service_data': {'paddock_id': p.id, 'enabled': (not p.enabled) | string | lower}
          },
          'hold_action': {
            'action': 'call-service',
            'service': 'script.pwm_delete_paddock',
            'service_data': {'paddock_id': p.id},
            'confirmation': {'text': 'Delete paddock ' ~ p.name ~ '?'}
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: PADDOCK IMAGE & POSITIONS
  - type: markdown
    content: |
      Set paddock images and bay badge positions for dashboard views.
      Images should be in `/config/www/paddock_images/`.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:image' if p.image_url else 'mdi:image-off',
          'state_display': 'Image set' if p.image_url else 'No image',
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(33, 150, 243)' if p.image_url else 'rgb(158, 158, 158)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '60px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}]
          },
          'tap_action': {
            'action': 'fire-dom-event',
            'browser_mod': {
              'service': 'browser_mod.popup',
              'data': {
                'title': p.name ~ ' Image Settings',
                'tag': 'paddock_image',
                'content': {
                  'type': 'vertical-stack',
                  'cards': [
                    {
                      'type': 'markdown',
                      'content': 'Enter the image URL for **' ~ p.name ~ '**.\n\nExample: `/local/paddock_images/' ~ p.id ~ '.jpg`\n\nCurrent: `' ~ (p.image_url or 'Not set') ~ '`'
                    },
                    {
                      'type': 'entities',
                      'entities': [
                        {'entity': 'input_text.pwm_edit_paddock_image', 'name': 'Image URL'}
                      ]
                    },
                    {
                      'type': 'button',
                      'name': 'Save Image URL',
                      'icon': 'mdi:content-save',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'script.pwm_save_paddock_edit',
                        'service_data': {
                          'paddock_id': p.id,
                          'image_url': '{{ states(\"input_text.pwm_edit_paddock_image\") }}'
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DEVICE ASSIGNMENT WIZARD
  - type: markdown
    content: |
      Configure device assignments for each paddock.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:cog',
          'state_display': (p.configured_bays | string) ~ '/' ~ (p.bay_count | string) ~ ' configured',
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(46, 125, 50)' if p.configured_bays == p.bay_count else 'rgb(255, 152, 0)' if p.configured_bays > 0 else 'rgb(117, 117, 117)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '70px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}],
            'icon': [{'font-size': '24px'}]
          },
          'tap_action': {
            'action': 'call-service',
            'service': 'script.pwm_wizard_open_paddock',
            'service_data': {'paddock_id': p.id}
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DEVICES IN USE
  - type: markdown
    content: |
      {% set devices = state_attr('sensor.pwm_data', 'device_list') or [] %}
      {% if devices %}
      | Device |
      |--------|
      {% for d in devices %}
      | `{{ d }}` |
      {% endfor %}
      {% else %}
      No devices configured
      {% endif %}
