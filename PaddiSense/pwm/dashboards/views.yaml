##############################################################################
# PWM Dashboard - Precision Water Management
# PaddiSense Farm Management System
# Generated: 2026-01-26T09:36:54
# Version: 2026.01.1
#
# PADDOCK VIEWS ARE AUTO-GENERATED
# Manual edits to paddock views will be overwritten.
# Edit Overview and Settings views safely.
##############################################################################

title: Paddocks-PWM
button_card_templates:
  template_titleblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(200, 250, 55)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
      - height: 20px
      name:
      - font-size: 14px
      - font-weight: 700
      - color: black
  template_textblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(162, 55, 250)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
      - height: 20px
      name:
      - font-size: 14px
      - font-weight: 700
  template_wifi_access_points:
    variables:
      var_entity: entity.name
      var_name: Access Point Name
    name: '[[[ return variables.var_name]]]'
    color_type: card
    state:
    - value: Adoption Failed
      color: rgb(255,0,0)
      icon: mdi:wifi-alert
    - value: Disconnected
      color: rgb(255,0,0)
      icon: mdi:wifi-alert
    - value: connected
      color: rgb(0,255,0)
      icon: mdi:wifi
    - value: Isolated
      color: rgb(255, 255, 0)
      icon: mdi:wifi-alert
    styles:
      card:
      - height: 100px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
    tap_action:
      action: more-info
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
    label: |
      [[[
        var name = entity.entity_id
        if (states[name].state === "Adoption Failed") return "Maintenance Required";
        if (states[name].state === "Disconnected") return "Maintenance Required";
        if (states[name].state === "Isolated") return "Maintenance Required";
        if (states[name].state === "connected") return "OK";
        return states[name].state;
      ]]]
  template_switch_on_off:
    variables:
      var_entity: entity.name
      var_name: LocationName
    label: |
      [[[
        var name = entity.entity_id
        if (states[name].state === "on") return "On";
        else if (states[name].state === "off") return "Off";
        return states[name].state;
      ]]]
    state:
    - value: 'off'
      color: rgb(255,0, 0)
      icon: mdi:engine-off
    - value: 'on'
      color: rgb(0,255,0)
      icon: mdi:engine
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 30px
      - width: 30px
      name:
      - font-size: 12px
    tap_action:
      action: toggle
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
  template_timer_on_off:
    state:
    - value: 'off'
      color: rgb(255,0, 0)
      icon: mdi:timer-off
    - value: 'on'
      color: rgb(0,255,0)
      icon: mdi:clock-start
    - value: idle
      color: rgb(128,128,128)
      icon: mdi:timer-off
    - value: active
      color: rgb(0,255,0)
      icon: mdi:timer
    - value: paused
      color: rgb(255,165,0)
      icon: mdi:timer-pause
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 30px
      - width: 30px
      name:
      - font-size: 12px
    tap_action:
      action: toggle
    hold_action:
      action: more-info
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
    size: 30%
  template_channel_autostate:
    variables:
      var_name: LocationName
    label: |
      [[[
        const entity_id = entity.entity_id;
        const stateObj = states[entity_id];
        if (!stateObj) return "Entity not found";
        switch (stateObj.state) {
          case "Off": return "Off";
          case "Manual": return "Manual";
          case "Auto": return "Auto";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Auto
      color: rgb(0, 255, 0)
      icon: mdi:door-open
    - value: Manual
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_buttoncard_openclose_simple:
    variables:
      var_name: LocationName
    label: |-
      [[[
        const stateObj = entity;
        if (!stateObj) return "Entity Not Found";
        switch (stateObj.state) {
          case "Open": return "Open";
          case "Close": return "Closed";
          case "HoldOne":
          case "HoldTwo": return "Hold Position";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: Close
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Open
      color: rgb(50, 100, 230)
      icon: mdi:door-open
    - value: HoldOne
      color: rgb(128, 128, 128)
      icon: mdi:pause
    - value: HoldTwo
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_buttoncard_openclose:
    variables:
      var_name: LocationName
      paddock_var: ''
      bay_var: ''
      device_type: supply_1
      status_label: |-
        [[[
          // --- helpers ---
          const slugify = (s) => (s ?? '')
            .toString().trim().toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/g, '')
            .replace(/_+/g, '_');

          const pdk = String(variables.paddock_var ?? '');
          const bay = String(variables.bay_var ?? '');
          const deviceType = String(variables.device_type ?? 'supply_1');

          // --- Get device from pwm_data ---
          const pwmData = hass.states['sensor.pwm_data']?.attributes || {};
          const bays = pwmData.bays || {};

          // Build bay key: paddock_bay (e.g., sw4_e_b_01)
          const baySlug = slugify(bay);
          const bayKey = pdk + '_' + baySlug;
          const bayData = bays[bayKey] || {};

          // Get device from the specified device type
          const deviceInfo = bayData[deviceType] || {};
          const devRaw = String(deviceInfo.device ?? '').trim();
          const devId = slugify(devRaw);

          // --- 1) UNSET if device unset or missing ---
          if (!devRaw || devRaw.toLowerCase() === 'unset' || devRaw === '') {
            return 'UNSET';
          }

          // --- 2) OFFLINE if online binary sensor is not online ---
          const keys = Object.keys(hass.states || {});
          const onlineKeys = keys
            .filter(k => k.startsWith('binary_sensor.'))
            .filter(k => /(^|_)online($|_)/i.test(k));

          const reDev = new RegExp(devId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
          const candidates = onlineKeys.filter(k => reDev.test(k));
          const onlineEid = candidates[0] || null;

          const onlineStates = new Set(['on', 'connected', 'online', 'true', 'available']);
          const onlineState = onlineEid ? hass.states[onlineEid]?.state : undefined;
          const isOnline = onlineStates.has(String(onlineState ?? '').toLowerCase());

          if (onlineEid && !isOnline) {
            return 'OFFLINE';
          }

          // --- 3) Return mapped door state ---
          const stateObj = entity;
          if (!stateObj) return 'Entity Not Found';

          const s = String(stateObj.state || '').toLowerCase();
          if (s === 'open') return 'Open';
          if (s === 'close' || s === 'closed') return 'Closed';
          if (['holdone','holdtwo','hold'].includes(s)) return 'Hold Position';

          // Check if we can get valve position
          const valveId = `valve.${devId}_${devId}_actuator_1`;
          const valveState = hass.states[valveId]?.state;
          const valvePos = hass.states[valveId]?.attributes?.current_position;
          if (valveState && ['opening', 'closing'].includes(valveState)) {
            return valveState.toUpperCase();
          } else if (valveState && valvePos !== undefined && valvePos !== 0 && valvePos !== 100) {
            return valveState.toUpperCase() + ' (' + valvePos + '%)';
          }

          return stateObj.state;
        ]]]
    label: '[[[ return variables.status_label ]]]'
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
    - value: Close
      color: rgb(255, 0, 0)
      icon: mdi:arrow-collapse-down
    - value: Open
      color: rgb(50, 100, 230)
      icon: mdi:door-open
    - value: HoldOne
      color: rgb(128, 128, 128)
      icon: mdi:pause
    - value: HoldTwo
      color: rgb(128, 128, 128)
      icon: mdi:pause
    color_type: card
    styles:
      card:
      - height: 120px
      - background-color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(240, 240, 240)';
            const es = String(entity?.state || '');
            if (es === 'Close') return 'rgb(255, 0, 0)';
            if (es === 'Open') return 'rgb(50, 100, 230)';
            if (es === 'HoldOne' || es === 'HoldTwo') return 'rgb(128, 128, 128)';
            return '';
          ]]]
      icon:
      - height: 50px
      - width: 50px
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
      name:
      - font-size: 18px
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
      label:
      - color: |-
          [[[
            const s = String(variables.status_label || '');
            if (s === 'UNSET' || s === 'OFFLINE') return 'rgb(0, 0, 0)';
            return '';
          ]]]
    show_name: true
    show_icon: true
    show_state: false
    show_label: true
  template_inputselect_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(128, 128, 128)
      icon: mdi:autorenew-off
    - value: Flush
      color: rgb(230, 119, 230)
      icon: mdi:auto-mode
    - value: Maintain
      color: rgb(29, 171, 222)
      icon: mdi:auto-mode
    - value: Drain
      color: rgb(222, 171, 29)
      icon: mdi:auto-download
    - value: Pond
      color: rgb(29, 171, 222)
      icon: mdi:waves
    - value: Saturate
      color: rgb(106, 247, 177)
      icon: mdi:water-sync
    color_type: card
    styles:
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
      - white-space: normal
      - text-align: center
      state:
      - margin-top: 10px
      - text-align: center
      card:
      - height: 120px
      - display: |
          [[[
            const paddock = variables.paddock_var;
            if (!paddock) return null;
            const s = hass.states['sensor.pwm_data'];
            const paddocks = s?.attributes?.paddocks || {};
            const pdk = paddocks[paddock];
            if (pdk && pdk.automation_state_individual === true) return null;
            return 'none';
          ]]]
    show_name: true
    show_icon: true
    show_state: true
    show_label: false
  template_paddock_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
    - value: 'Off'
      color: rgb(128, 128, 128)
      icon: mdi:autorenew-off
    - value: Flush
      color: rgb(230, 119, 230)
      icon: mdi:auto-mode
    - value: Maintain
      color: rgb(29, 171, 222)
      icon: mdi:auto-mode
    - value: Drain
      color: rgb(222, 171, 29)
      icon: mdi:auto-download
    - value: Pond
      color: rgb(29, 171, 222)
      icon: mdi:waves
    - value: Saturate
      color: rgb(106, 247, 177)
      icon: mdi:water-sync
    color_type: card
    styles:
      icon:
      - height: 50px
      - width: 50px
      name:
      - font-size: 16px
      - white-space: normal
      - text-align: center
      state:
      - margin-top: 10px
      - text-align: center
      card:
      - height: 120px
    show_name: true
    show_icon: true
    show_state: true
    show_label: false
#############################################################
# Config Button Template - Paddock Configuration Popup
# Uses browser_mod.sequence to:
#   1. Set input_text.pwm_paddock_config_pointer to the paddock_id
#   2. Wait for state to propagate
#   3. Open popup (Jinja templates read the pointer)
#############################################################
  #---------------------------------------------------------------------------
  # Bay Device Card - Shows supply/drain devices for a bay (IPM-style)
  #---------------------------------------------------------------------------
  template_bay_device_card:
    variables:
      bay_name: ''
      bay_id: ''
      supply_1: ''
      supply_2: ''
      drain_1: ''
      drain_2: ''
      paddock_id: ''
    color_type: card
    color: |
      [[[
        const s1 = variables.supply_1;
        const hasDevice = s1 && s1 !== '' && s1 !== 'unset';
        return hasDevice ? '#2e7d32' : '#424242';
      ]]]
    show_icon: true
    show_name: true
    show_label: true
    icon: mdi:waves
    name: '[[[ return variables.bay_name ]]]'
    label: |
      [[[
        const s1 = variables.supply_1 || '—';
        const s2 = variables.supply_2 || '';
        const d1 = variables.drain_1 || '';
        let parts = [];
        if (s1 && s1 !== '—') parts.push('S1: ' + s1);
        if (s2) parts.push('S2: ' + s2);
        if (d1) parts.push('D1: ' + d1);
        return parts.length > 0 ? parts.join(' | ') : 'No devices assigned';
      ]]]
    styles:
      card:
        - height: 80px
        - border-radius: 12px
        - padding: 8px
      grid:
        - grid-template-areas: '"i n" "i l"'
        - grid-template-columns: 40px 1fr
        - grid-template-rows: 1fr 1fr
      icon:
        - width: 32px
        - color: white
      name:
        - font-size: 18px
        - font-weight: 700
        - justify-self: start
        - color: white
      label:
        - font-size: 12px
        - justify-self: start
        - color: rgba(255,255,255,0.8)
        - white-space: nowrap
        - overflow: hidden
        - text-overflow: ellipsis
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: '[[[ return variables.bay_name + " Device Config" ]]]'
          tag: baydevice
          size: normal
          style: |
            --popup-max-width: 95vw;
          content:
            type: vertical-stack
            cards:
              - type: markdown
                content: '**Configure device assignments for [[[ return variables.bay_name ]]]**'
              - type: entities
                entities:
                  - type: button
                    name: '[[[ return "Supply 1: " + (variables.supply_1 || "Not Set") ]]]'
                    icon: mdi:pipe
                    action_name: Change
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: '[[[ return "Set Supply 1 - " + variables.bay_name ]]]'
                          tag: slotconfig
                          right_button: Save
                          right_button_action:
                            service: script.pwm_assign_bay_slot
                            data:
                              paddock: '[[[ return variables.paddock_id ]]]'
                              bay: '[[[ return variables.bay_name ]]]'
                              slot: supply_1
                          content:
                            - name: new_device
                              label: Select ESPHome Device
                              selector:
                                device:
                                  filter:
                                    integration: esphome
                  - type: button
                    name: '[[[ return "Supply 2: " + (variables.supply_2 || "Not Set") ]]]'
                    icon: mdi:pipe
                    action_name: Change
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: '[[[ return "Set Supply 2 - " + variables.bay_name ]]]'
                          tag: slotconfig
                          right_button: Save
                          right_button_action:
                            service: script.pwm_assign_bay_slot
                            data:
                              paddock: '[[[ return variables.paddock_id ]]]'
                              bay: '[[[ return variables.bay_name ]]]'
                              slot: supply_2
                          content:
                            - name: new_device
                              label: Select ESPHome Device
                              selector:
                                device:
                                  filter:
                                    integration: esphome
                  - type: button
                    name: '[[[ return "Drain 1: " + (variables.drain_1 || "Not Set") ]]]'
                    icon: mdi:pipe-valve
                    action_name: Change
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: '[[[ return "Set Drain 1 - " + variables.bay_name ]]]'
                          tag: slotconfig
                          right_button: Save
                          right_button_action:
                            service: script.pwm_assign_bay_slot
                            data:
                              paddock: '[[[ return variables.paddock_id ]]]'
                              bay: '[[[ return variables.bay_name ]]]'
                              slot: drain_1
                          content:
                            - name: new_device
                              label: Select ESPHome Device
                              selector:
                                device:
                                  filter:
                                    integration: esphome
                  - type: button
                    name: '[[[ return "Drain 2: " + (variables.drain_2 || "Not Set") ]]]'
                    icon: mdi:pipe-valve
                    action_name: Change
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: '[[[ return "Set Drain 2 - " + variables.bay_name ]]]'
                          tag: slotconfig
                          right_button: Save
                          right_button_action:
                            service: script.pwm_assign_bay_slot
                            data:
                              paddock: '[[[ return variables.paddock_id ]]]'
                              bay: '[[[ return variables.bay_name ]]]'
                              slot: drain_2
                          content:
                            - name: new_device
                              label: Select ESPHome Device
                              selector:
                                device:
                                  filter:
                                    integration: esphome

  #---------------------------------------------------------------------------
  # Paddock Config Button - Full width, opens config popup
  #---------------------------------------------------------------------------
  template_paddockconfigbutton:
    variables:
      paddock_id: ''
      paddock_name: ''
    name: '[[[ return (variables.paddock_name || "Paddock") + " Config" ]]]'
    icon: mdi:cog
    color: '#1565c0'
    color_type: card
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      icon:
        - height: 30px
        - width: 30px
        - color: white
      name:
        - font-size: 18px
        - font-weight: 700
        - color: white
    show_name: true
    show_icon: true
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.sequence
        data:
          sequence:
          - service: input_text.set_value
            data:
              entity_id: input_text.pwm_paddock_config_pointer
              value: '[[[ return variables.paddock_id ]]]'
          - service: browser_mod.delay
            data:
              time: 300
          - service: browser_mod.popup
            data:
              title: '[[[ return (variables.paddock_name || variables.paddock_id || "Paddock").toUpperCase() + " Config" ]]]'
              tag: paddockconfig
              dismissable: true
              size: normal
              style: |
                --popup-max-width: 95vw;
                --popup-min-width: 320px;
              content:
                type: vertical-stack
                cards:
                #----------------------------------------------------------
                # TIMERS - Flush timers for bays in Flush mode
                #----------------------------------------------------------
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Time On Water
                - type: custom:auto-entities
                  show_empty: true
                  card:
                    type: horizontal-stack
                  card_param: cards
                  filter:
                    template: |
                      {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                      {% set bays = state_attr('sensor.pwm_data', 'bays') or {} %}
                      {% set cards = namespace(list=[]) %}
                      {% for bay_id, bay in bays.items() | sort(attribute='1.order') if bay.paddock_id == pdk and 'drain' not in bay_id %}
                        {% set timer_eid = 'timer.' ~ bay_id ~ '_flushtimeonwater' %}
                        {% set auto_eid = 'input_select.' ~ bay_id ~ '_automation_state' %}
                        {% if states(timer_eid) not in ['unknown', 'unavailable'] and states(auto_eid) == 'Flush' %}
                          {% set cards.list = cards.list + [{
                            "type": "custom:mushroom-entity-card",
                            "entity": timer_eid,
                            "name": bay.name,
                            "icon": "mdi:timer",
                            "fill_container": true
                          }] %}
                        {% endif %}
                      {% endfor %}
                      {% if cards.list | length == 0 %}
                        {% set cards.list = [{
                          "type": "markdown",
                          "content": "*No bays in Flush mode*"
                        }] %}
                      {% endif %}
                      {{ cards.list | tojson }}
                #----------------------------------------------------------
                # WATER DEPTHS - Min/Max water level settings per bay
                #----------------------------------------------------------
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Water Depths
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: vertical-stack
                  card_param: cards
                  filter:
                    template: |
                      {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                      {% set bays = state_attr('sensor.pwm_data', 'bays') or {} %}
                      {% set cards = namespace(list=[]) %}
                      {% for bay_id, bay in bays.items() | sort(attribute='1.order') if bay.paddock_id == pdk and 'drain' not in bay_id %}
                        {% set min_eid = 'input_number.' ~ bay_id ~ '_waterlevelmin' %}
                        {% set max_eid = 'input_number.' ~ bay_id ~ '_waterlevelmax' %}
                        {% if states(min_eid) not in ['unknown', 'unavailable'] %}
                          {% set cards.list = cards.list + [
                            {"type": "custom:mushroom-title-card", "title": bay.name},
                            {"type": "horizontal-stack", "cards": [
                              {"type": "custom:mushroom-number-card", "entity": min_eid, "name": "Min Depth", "display_mode": "buttons"},
                              {"type": "custom:mushroom-number-card", "entity": max_eid, "name": "Max Depth", "display_mode": "buttons"}
                            ]}
                          ] %}
                        {% endif %}
                      {% endfor %}
                      {{ cards.list | tojson }}
                #----------------------------------------------------------
                # BAY DEVICES - Device assignment for each bay
                # Each bay shown as a card with device summary
                #----------------------------------------------------------
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Bay Devices
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: vertical-stack
                  card_param: cards
                  filter:
                    template: >
                      {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                      {% set bays = state_attr('sensor.pwm_data', 'bays') or {} %}
                      {% set ns = namespace(cards=[]) %}
                      {% for bay_id, bay in bays.items() | sort(attribute='1.order') if bay.paddock_id == pdk %}
                      {% set s1 = (bay.supply_1 or {}).device | default('') %}
                      {% set s2 = (bay.supply_2 or {}).device | default('') %}
                      {% set d1 = (bay.drain_1 or {}).device | default('') %}
                      {% set d2 = (bay.drain_2 or {}).device | default('') %}
                      {% set has_device = s1 not in ['', none, 'unset'] %}
                      {% set devices = [] %}
                      {% if s1 %}{% set devices = devices + ['S1:' ~ s1] %}{% endif %}
                      {% if s2 %}{% set devices = devices + ['S2:' ~ s2] %}{% endif %}
                      {% if d1 %}{% set devices = devices + ['D1:' ~ d1] %}{% endif %}
                      {% if d2 %}{% set devices = devices + ['D2:' ~ d2] %}{% endif %}
                      {% set device_text = devices | join(' ') if devices else 'No devices' %}
                      {% set ns.cards = ns.cards + [{"type":"custom:mushroom-template-card","primary":bay.name,"secondary":device_text,"icon":"mdi:waves","icon_color":"green" if has_device else "red","tap_action":{"action":"fire-dom-event","browser_mod":{"service":"browser_mod.popup","data":{"title":bay.name ~ " Devices","tag":"baydevice","size":"normal","style":"--popup-max-width: 95vw;","content":{"type":"vertical-stack","cards":[{"type":"custom:mushroom-template-card","primary":"Supply 1","secondary":s1 if s1 else "Not Set","icon":"mdi:pipe","icon_color":"green" if s1 else "grey","tap_action":{"action":"fire-dom-event","browser_mod":{"service":"browser_mod.popup","data":{"title":"Set Supply 1","tag":"slotconfig","right_button":"Save","right_button_action":{"service":"script.pwm_assign_bay_slot","data":{"paddock":pdk,"bay":bay.name,"slot":"supply_1"}},"content":[{"name":"new_device","label":"Select Device","selector":{"device":{"filter":{"integration":"esphome"}}}}]}}}},{"type":"custom:mushroom-template-card","primary":"Supply 2","secondary":s2 if s2 else "Not Set","icon":"mdi:pipe","icon_color":"green" if s2 else "grey","tap_action":{"action":"fire-dom-event","browser_mod":{"service":"browser_mod.popup","data":{"title":"Set Supply 2","tag":"slotconfig","right_button":"Save","right_button_action":{"service":"script.pwm_assign_bay_slot","data":{"paddock":pdk,"bay":bay.name,"slot":"supply_2"}},"content":[{"name":"new_device","label":"Select Device","selector":{"device":{"filter":{"integration":"esphome"}}}}]}}}},{"type":"custom:mushroom-template-card","primary":"Drain 1","secondary":d1 if d1 else "Not Set","icon":"mdi:pipe-valve","icon_color":"blue" if d1 else "grey","tap_action":{"action":"fire-dom-event","browser_mod":{"service":"browser_mod.popup","data":{"title":"Set Drain 1","tag":"slotconfig","right_button":"Save","right_button_action":{"service":"script.pwm_assign_bay_slot","data":{"paddock":pdk,"bay":bay.name,"slot":"drain_1"}},"content":[{"name":"new_device","label":"Select Device","selector":{"device":{"filter":{"integration":"esphome"}}}}]}}}},{"type":"custom:mushroom-template-card","primary":"Drain 2","secondary":d2 if d2 else "Not Set","icon":"mdi:pipe-valve","icon_color":"blue" if d2 else "grey","tap_action":{"action":"fire-dom-event","browser_mod":{"service":"browser_mod.popup","data":{"title":"Set Drain 2","tag":"slotconfig","right_button":"Save","right_button_action":{"service":"script.pwm_assign_bay_slot","data":{"paddock":pdk,"bay":bay.name,"slot":"drain_2"}},"content":[{"name":"new_device","label":"Select Device","selector":{"device":{"filter":{"integration":"esphome"}}}}]}}}}]}}}}}] %}
                      {% endfor %}
                      {{ ns.cards | tojson }}
                #----------------------------------------------------------
                # SUPPLY CHANNEL - Water depth and offset
                #----------------------------------------------------------
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Supply Channel
                - type: horizontal-stack
                  cards:
                    - type: custom:mushroom-template-card
                      primary: Supply Depth
                      secondary: |
                        {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                        {% set eid = 'sensor.pwm_' ~ pdk ~ '_supply_water_depth' %}
                        {{ states(eid) }} {{ state_attr(eid, 'unit_of_measurement') or 'cm' }}
                      icon: mdi:water
                      icon_color: blue
                      fill_container: true
                    - type: custom:mushroom-template-card
                      primary: Offset
                      secondary: |
                        {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                        {% set eid = 'input_number.' ~ pdk ~ '_supply_waterleveloffset' %}
                        {{ states(eid) }} {{ state_attr(eid, 'unit_of_measurement') or 'cm' }}
                      icon: mdi:arrow-up-down
                      icon_color: orange
                      fill_container: true
                      tap_action:
                        action: more-info
                        entity: |
                          {% set pdk = states('input_text.pwm_paddock_config_pointer') %}
                          input_number.{{ pdk }}_supply_waterleveloffset
                #----------------------------------------------------------
                # SETTINGS - Refresh and other options
                #----------------------------------------------------------
                - type: custom:button-card
                  template: template_titleblock
                  variables:
                    var_name: Settings
                - type: horizontal-stack
                  cards:
                    - type: button
                      name: Refresh Data
                      icon: mdi:refresh
                      tap_action:
                        action: call-service
                        service: script.pwm_refresh_data
                      icon_height: 30px
                    - type: button
                      name: Close
                      icon: mdi:close
                      tap_action:
                        action: fire-dom-event
                        browser_mod:
                          service: browser_mod.close_popup
                          data:
                            tag: paddockconfig
                      icon_height: 30px
  template_extradatabutton:
    variables:
      nav_path: /pwm-service/overview
    name: Extra Data
    icon: mdi:database
    color_type: card
    styles:
      card:
      - height: 100px
      icon:
      - height: 70px
    show_name: true
    show_icon: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'
  template_paddock_overview_card:
    variables:
      paddock_id: ''
      paddock_name: ''
      bay_count: 0
      enabled: false
      nav_path: ''
    name: '[[[ return variables.paddock_name ]]]'
    icon: mdi:waves
    color: |
      [[[
        return variables.enabled ? 'rgb(46, 125, 50)' : 'rgb(117, 117, 117)';
      ]]]
    color_type: card
    styles:
      card:
      - height: 100px
      - border-radius: 12px
      icon:
      - width: 40px
      name:
      - font-size: 18px
      - font-weight: 700
    label: |
      [[[
        return variables.bay_count + ' bays | ' + (variables.enabled ? 'Enabled' : 'Disabled');
      ]]]
    show_name: true
    show_icon: true
    show_label: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'
  template_stat_chip:
    color_type: label-card
    show_icon: true
    show_name: true
    show_state: true
    tap_action:
      action: none
    styles:
      card:
      - height: 70px
      - border-radius: 10px
      - padding: 8px
      grid:
      - grid-template-areas: '"i s" "i n"'
      - grid-template-columns: 40px 1fr
      - grid-template-rows: 1fr 1fr
      icon:
      - width: 30px
      - color: white
      state:
      - font-size: 20px
      - font-weight: 700
      - justify-self: start
      - color: white
      name:
      - font-size: 12px
      - justify-self: start
      - color: rgba(255,255,255,0.8)
  #---------------------------------------------------------------------------
  # Extra Data Button - Navigates to hidden pwm-extra dashboard
  #---------------------------------------------------------------------------
  template_extradatabutton:
    variables:
      paddock_id: ''
      paddock_name: ''
    name: '[[[ return (variables.paddock_name || "Paddock") + " Extra Data" ]]]'
    icon: mdi:chart-line
    color: '#546e7a'
    color_type: card
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      icon:
        - height: 30px
        - width: 30px
        - color: white
      name:
        - font-size: 16px
        - font-weight: 600
        - color: white
    show_name: true
    show_icon: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return "/pwm-extra/" + variables.paddock_id.replace("_", "-") ]]]'
views:
- title: SW4 East
  path: sw4-e
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_e_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW4 EAST CONTROLS
  - type: custom:button-card
    entity: input_select.sw4_e_automation_state
    name: SW4 East Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_e_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_e_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw4_e_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw4_e
          paddock_name: SW4 East
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: sw4_e
          paddock_name: SW4 East
- title: SW4 West
  path: sw4-w
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw4_w_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW4 WEST CONTROLS
  - type: custom:button-card
    entity: input_select.sw4_w_automation_state
    name: SW4 West Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw4_w_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw4_w_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw4_w_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw4_w
          paddock_name: SW4 West
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: sw4_w
          paddock_name: SW4 West
- title: SW5
  path: sw5
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_sw5_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SW5 CONTROLS
  - type: custom:button-card
    entity: input_select.sw5_automation_state
    name: SW5 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.sw5_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.sw5_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.sw5_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw5
          paddock_name: SW5
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: sw5
          paddock_name: SW5
- title: W17
  path: w17
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w17_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W17 CONTROLS
  - type: custom:button-card
    entity: input_select.w17_automation_state
    name: W17 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w17_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w17_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w17_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w17
          paddock_name: W17
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: w17
          paddock_name: W17
- title: W18
  path: w18
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w18_b_05_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W18 CONTROLS
  - type: custom:button-card
    entity: input_select.w18_automation_state
    name: W18 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w18_b_05_door_control
      name: B-05
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w18_b_05_automation_state
      name: B-05 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w18_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w18
          paddock_name: W18
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: w18
          paddock_name: W18
- title: W19
  path: w19
  type: masonry
  cards:
  - type: picture-elements
    image: /local/paddock_images/default.jpg
    elements:
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_01_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_02_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_03_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
    - type: state-badge
      tap_action:
        action: more-info
      entity: sensor.pwm_w19_b_04_water_depth
      style:
        top: 50%
        left: 40%
        --ha-label-badge-title-font-size: 0em
        --paper-font-subhead_-_font-size: 8px
        transform: scale(0.8)
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: W19 CONTROLS
  - type: custom:button-card
    entity: input_select.w19_automation_state
    name: W19 Automation
    template: template_channel_autostate
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: BAY CONTROLS
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_01_door_control
      name: B-01
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_01_automation_state
      name: B-01 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_02_door_control
      name: B-02
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_02_automation_state
      name: B-02 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_03_door_control
      name: B-03
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_03_automation_state
      name: B-03 Auto
      template: template_channel_autostate
  - type: horizontal-stack
    cards:
    - type: custom:button-card
      entity: input_select.w19_b_04_door_control
      name: B-04
      template: template_buttoncard_openclose_simple
    - type: custom:button-card
      entity: input_select.w19_b_04_automation_state
      name: B-04 Auto
      template: template_channel_autostate
  - type: custom:button-card
    entity: input_select.w19_drain_door_control
    name: Drain
    template: template_buttoncard_openclose_simple
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w19
          paddock_name: W19
      - type: custom:button-card
        template: template_extradatabutton
        variables:
          paddock_id: w19
          paddock_name: W19
- title: Settings
  path: settings
  type: masonry
  cards:
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: PWM SETTINGS
  - type: entities
    title: System Status
    entities:
    - entity: sensor.pwm_data
      name: Status
      icon: mdi:check-circle
    - type: attribute
      entity: sensor.pwm_data
      attribute: version
      name: Version
      icon: mdi:tag
    - type: attribute
      entity: sensor.pwm_data
      attribute: total_paddocks
      name: Total Paddocks
      icon: mdi:view-grid
    - type: attribute
      entity: sensor.pwm_data
      attribute: total_bays
      name: Total Bays
      icon: mdi:format-list-numbered
    - type: attribute
      entity: sensor.pwm_data
      attribute: device_count
      name: Devices in Use
      icon: mdi:access-point
    - type: attribute
      entity: sensor.pwm_data
      attribute: backup_count
      name: Backups
      icon: mdi:backup-restore
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: SYSTEM ACTIONS
  - type: horizontal-stack
    cards:
    - type: button
      name: Refresh
      icon: mdi:refresh
      tap_action:
        action: call-service
        service: script.pwm_refresh_data
      icon_height: 50px
    - type: button
      name: Export
      icon: mdi:download
      tap_action:
        action: call-service
        service: script.pwm_export_data
      icon_height: 50px
    - type: button
      name: Initialize
      icon: mdi:database-plus
      tap_action:
        action: call-service
        service: script.pwm_init_system
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: REGISTRY SYNC
  - type: markdown
    content: |
      Sync paddock/bay structure from Farm Registry.
      This imports new paddocks and updates structure without changing device assignments.
  - type: horizontal-stack
    cards:
    - type: button
      name: Sync from Registry
      icon: mdi:sync
      tap_action:
        action: call-service
        service: script.pwm_sync_from_registry
        confirmation:
          text: Sync paddock structure from Farm Registry?
      icon_height: 50px
    - type: button
      name: View Registry
      icon: mdi:database
      tap_action:
        action: navigate
        navigation_path: /registry-service/overview
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: ENTITY GENERATOR
  - type: markdown
    content: |
      After adding or modifying paddocks, generate entities to create
      the required automations, sensors, and controls.
  - type: horizontal-stack
    cards:
    - type: button
      name: Generate Entities
      icon: mdi:cog-sync
      tap_action:
        action: call-service
        service: script.pwm_generate_entities
        confirmation:
          text: Generate YAML files for all paddocks?
      icon_height: 50px
    - type: button
      name: Generate & Reload
      icon: mdi:restart
      tap_action:
        action: call-service
        service: script.pwm_generate_and_reload
        confirmation:
          text: Generate entities and reload all domains?
      icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DASHBOARD GENERATOR
  - type: markdown
    content: |
      Generate dashboard views for all enabled paddocks.
      Uses paddock images and bay badge positions from config.
  - type: button
    name: Generate Dashboard Views
    icon: mdi:view-dashboard-edit
    tap_action:
      action: call-service
      service: script.pwm_generate_dashboard
      confirmation:
        text: Regenerate all paddock dashboard views?
    icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: ADD PADDOCK
  - type: entities
    entities:
    - entity: input_text.pwm_new_paddock_name
      name: Paddock Name
    - entity: input_number.pwm_new_paddock_bay_count
      name: Number of Bays
    - entity: input_boolean.pwm_new_paddock_individual
      name: Individual Bay Mode
  - type: button
    name: Add Paddock
    icon: mdi:plus-circle
    tap_action:
      action: call-service
      service: script.pwm_add_paddock
      service_data:
        name: '{{ states(''input_text.pwm_new_paddock_name'') }}'
        bay_count: '{{ states(''input_number.pwm_new_paddock_bay_count'') | int }}'
        individual: '{{ is_state(''input_boolean.pwm_new_paddock_individual'', ''on'') }}'
    icon_height: 50px
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: MANAGE PADDOCKS
  - type: markdown
    content: |
      **Tap** to toggle enable/disable. **Hold** to delete.
      Green = enabled, Gray = disabled.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:waves' if p.enabled else 'mdi:waves-arrow-right',
          'state_display': (p.bay_count | string) ~ ' bays | ' ~ ('Enabled' if p.enabled else 'Disabled'),
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(46, 125, 50)' if p.enabled else 'rgb(117, 117, 117)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '70px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}]
          },
          'tap_action': {
            'action': 'call-service',
            'service': 'script.pwm_toggle_paddock_enabled',
            'service_data': {'paddock_id': p.id, 'enabled': (not p.enabled) | string | lower}
          },
          'hold_action': {
            'action': 'call-service',
            'service': 'script.pwm_delete_paddock',
            'service_data': {'paddock_id': p.id},
            'confirmation': {'text': 'Delete paddock ' ~ p.name ~ '?'}
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: PADDOCK IMAGE & POSITIONS
  - type: markdown
    content: |
      Set paddock images and bay badge positions for dashboard views.
      Images should be in `/config/www/paddock_images/`.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:image' if p.image_url else 'mdi:image-off',
          'state_display': 'Image set' if p.image_url else 'No image',
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(33, 150, 243)' if p.image_url else 'rgb(158, 158, 158)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '60px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}]
          },
          'tap_action': {
            'action': 'fire-dom-event',
            'browser_mod': {
              'service': 'browser_mod.popup',
              'data': {
                'title': p.name ~ ' Image Settings',
                'tag': 'paddock_image',
                'content': {
                  'type': 'vertical-stack',
                  'cards': [
                    {
                      'type': 'markdown',
                      'content': 'Enter the image URL for **' ~ p.name ~ '**.\n\nExample: `/local/paddock_images/' ~ p.id ~ '.jpg`\n\nCurrent: `' ~ (p.image_url or 'Not set') ~ '`'
                    },
                    {
                      'type': 'entities',
                      'entities': [
                        {'entity': 'input_text.pwm_edit_paddock_image', 'name': 'Image URL'}
                      ]
                    },
                    {
                      'type': 'button',
                      'name': 'Save Image URL',
                      'icon': 'mdi:content-save',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'script.pwm_save_paddock_edit',
                        'service_data': {
                          'paddock_id': p.id,
                          'image_url': '{{ states(\"input_text.pwm_edit_paddock_image\") }}'
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DEVICE ASSIGNMENT WIZARD
  - type: markdown
    content: |
      Configure device assignments for each paddock.
  - type: custom:auto-entities
    filter:
      template: |
        {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
        {% for p in summary %}
        {{ {
          'type': 'custom:button-card',
          'name': p.name,
          'icon': 'mdi:cog',
          'state_display': (p.configured_bays | string) ~ '/' ~ (p.bay_count | string) ~ ' configured',
          'show_icon': true,
          'show_name': true,
          'show_state': true,
          'color': 'rgb(46, 125, 50)' if p.configured_bays == p.bay_count else 'rgb(255, 152, 0)' if p.configured_bays > 0 else 'rgb(117, 117, 117)',
          'color_type': 'card',
          'styles': {
            'card': [{'height': '70px'}, {'border-radius': '8px'}],
            'name': [{'font-size': '14px'}, {'font-weight': '600'}],
            'state': [{'font-size': '11px'}],
            'icon': [{'font-size': '24px'}]
          },
          'tap_action': {
            'action': 'call-service',
            'service': 'script.pwm_wizard_open_paddock',
            'service_data': {'paddock_id': p.id}
          }
        } | tojson }},
        {% endfor %}
    sort:
      method: none
    card:
      type: grid
      columns: 2
  - type: custom:button-card
    template: template_titleblock
    variables:
      var_name: DEVICES IN USE
  - type: markdown
    content: |
      {% set devices = state_attr('sensor.pwm_data', 'device_list') or [] %}
      {% if devices %}
      | Device |
      |--------|
      {% for d in devices %}
      | `{{ d }}` |
      {% endfor %}
      {% else %}
      No devices configured
      {% endif %}
