##############################################################################
# PWM Dashboard - Precision Water Management
# PaddiSense Farm Management System
# Version: 1.0.0
#
# Views:
#   1. Overview - All paddocks with status cards
#   2-8. Per-Paddock Views - Individual paddock controls
#   9. Settings - System status, add paddock, configuration
##############################################################################

title: PWM - Water Management

button_card_templates:
  #---------------------------------------------------------------------------
  # Section title bar (yellow-green)
  #---------------------------------------------------------------------------
  template_titleblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(200, 250, 55)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
        - height: 20px

  #---------------------------------------------------------------------------
  # Text block (purple)
  #---------------------------------------------------------------------------
  template_textblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(162, 55, 250)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
        - height: 20px

  #---------------------------------------------------------------------------
  # Door control button (Open/Close/Hold states)
  #---------------------------------------------------------------------------
  template_buttoncard_openclose:
    variables:
      var_name: LocationName
      paddock_var: ''
      bay_var: ''
    label: |-
      [[[
        const stateObj = entity;
        if (!stateObj) return "Entity Not Found";

        switch (stateObj.state) {
          case "Open": return "Open";
          case "Close": return "Closed";
          case "HoldOne":
          case "HoldTwo": return "Hold Position";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
      - value: Close
        color: rgb(255, 0, 0)
        icon: mdi:arrow-collapse-down
      - value: Open
        color: rgb(50, 100, 230)
        icon: mdi:door-open
      - value: HoldOne
        color: rgb(128, 128, 128)
        icon: mdi:pause
      - value: HoldTwo
        color: rgb(128, 128, 128)
        icon: mdi:pause
    color_type: card
    styles:
      card:
        - height: 120px
      icon:
        - height: 50px
        - width: 50px
      name:
        - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true

  #---------------------------------------------------------------------------
  # Door control button (Open/Close/Hold states)
  #---------------------------------------------------------------------------
  template_baybuttonrow:
    variables:
      var_name: LocationName
      paddock_var: ''
      bay_var: ''
      device: |-
        [[[
          const pdata = hass.states['sensor.pwm_data']?.attributes?.paddocks || {};
          const bdata = hass.states['sensor.pwm_data']?.attributes?.bays || {};

          const pdk = String(variables.paddock_var ?? '');
          const bay = String(variables.bay_var ?? '');
          return pdk;
        ]]]
      custom_fields:
        door_control:
          card:
            type: custom:button-card
            name: '[[[[ return `${variables.paddock_var} ${variables.bay_var}` (variables.bay_var.includes("drain")) ? `` : `SUPPLY` ]]]]'
            label: '[[[ return `${variables.device} ]]]'
        automation_state:
          card:
            type: custom:button-card
            name: '[[[[ return `${variables.paddock_var} ${variables.bay_var} AUTOMATION STATE` ]]]]'
            label: '[[[ return `${variables.bay_var} ]]]'
      styles:
        grid:
          - grid-template-areas: "'door_control' 'automation_state'"

  #---------------------------------------------------------------------------
  # Automation state selector (Off/Flush/Pond/Drain/Saturate/Maintain)
  #---------------------------------------------------------------------------
  template_inputselect_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
      - value: 'Off'
        color: rgb(128, 128, 128)
        icon: mdi:autorenew-off
      - value: Flush
        color: rgb(230, 119, 230)
        icon: mdi:auto-mode
      - value: Maintain
        color: rgb(29, 171, 222)
        icon: mdi:auto-mode
      - value: Drain
        color: rgb(222, 171, 29)
        icon: mdi:auto-download
      - value: Pond
        color: rgb(29, 171, 222)
        icon: mdi:waves
      - value: Saturate
        color: rgb(106, 247, 177)
        icon: mdi:water-sync
    color_type: card
    styles:
      icon:
        - height: 50px
        - width: 50px
      name:
        - font-size: 16px
        - white-space: normal
        - text-align: center
      state:
        - margin-top: 10px
        - text-align: center
      card:
        - height: 120px
        - display: |
            [[[
              const paddock = variables.paddock_var;
              const s = hass.states['sensor.pwm_data'];
              const paddocks = s?.attributes?.paddocks || {};
              const pdk = paddocks[paddock];
              if (pdk && pdk.automation_state_individual === true) return null;
              return 'none';
            ]]]
    show_name: true
    show_icon: true
    show_state: true
    show_label: false

  #---------------------------------------------------------------------------
  # Paddock automation state (always visible)
  #---------------------------------------------------------------------------
  template_paddock_automationstate:
    variables:
      var_name: LocationName
      paddock_var: ''
    label: |
      [[[
        var entity_id = entity.entity_id;
        if (!states[entity_id]) return "Entity not found";
        return "\n" + states[entity_id].state;
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      confirmation:
        text: Are you sure?
      data:
        cycle: true
    state:
      - value: 'Off'
        color: rgb(128, 128, 128)
        icon: mdi:autorenew-off
      - value: Flush
        color: rgb(230, 119, 230)
        icon: mdi:auto-mode
      - value: Maintain
        color: rgb(29, 171, 222)
        icon: mdi:auto-mode
      - value: Drain
        color: rgb(222, 171, 29)
        icon: mdi:auto-download
      - value: Pond
        color: rgb(29, 171, 222)
        icon: mdi:waves
      - value: Saturate
        color: rgb(106, 247, 177)
        icon: mdi:water-sync
    color_type: card
    styles:
      icon:
        - height: 50px
        - width: 50px
      name:
        - font-size: 16px
        - white-space: normal
        - text-align: center
      state:
        - margin-top: 10px
        - text-align: center
      card:
        - height: 120px
    show_name: true
    show_icon: true
    show_state: true
    show_label: false

  #---------------------------------------------------------------------------
  # Channel automation state (Off/Auto/Manual)
  #---------------------------------------------------------------------------
  template_channel_autostate:
    variables:
      var_name: LocationName
    label: |
      [[[
        const entity_id = entity.entity_id;
        const stateObj = states[entity_id];
        if (!stateObj) return "Entity not found";
        switch (stateObj.state) {
          case "Off": return "Off";
          case "Manual": return "Manual";
          case "Auto": return "Auto";
          default: return stateObj.state;
        }
      ]]]
    tap_action:
      action: call-service
      service: input_select.select_next
      service_data:
        entity_id: '[[[ return entity.entity_id ]]]'
      data:
        cycle: true
    state:
      - value: 'Off'
        color: rgb(255, 0, 0)
        icon: mdi:arrow-collapse-down
      - value: Auto
        color: rgb(0, 255, 0)
        icon: mdi:door-open
      - value: Manual
        color: rgb(128, 128, 128)
        icon: mdi:pause
    color_type: card
    styles:
      card:
        - height: 120px
      icon:
        - height: 50px
        - width: 50px
      name:
        - font-size: 18px
    show_name: true
    show_icon: true
    show_state: false
    show_label: true

  #---------------------------------------------------------------------------
  # Paddock config button (opens browser_mod popup)
  #---------------------------------------------------------------------------
  template_paddockconfigbutton:
    variables:
      paddock_id: test_field
      paddock_name: Test Field
    name: |
      [[[
        return 'Configure ' + variables.paddock_name;
      ]]]
    icon: mdi:cog
    color: orange
    color_type: card
    styles:
      card:
        - height: 120px
      icon:
        - height: 50px
        - width: 50px
      name:
        - font-size: 16px
    show_name: true
    show_icon: true
    tap_action:
      action: fire-dom-event
      browser_mod: |
        [[[
          const paddockId = variables.paddock_id;
          const paddockName = variables.paddock_name;
          const pwmData = states['sensor.pwm_data'];
          const paddocks = pwmData?.attributes?.paddocks || {};
          const bays = pwmData?.attributes?.bays || {};
          const p = paddocks[paddockId] || {};

          // Build paddock info HTML
          let infoHtml = `<div style="font-size:18px;font-weight:700;margin-bottom:12px;">${paddockName}</div>`;
          infoHtml += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">`;
          infoHtml += `<div><span style="color:var(--secondary-text-color);font-size:12px;">Farm:</span><br/><b>${p.farm_id || 'N/A'}</b></div>`;
          infoHtml += `<div><span style="color:var(--secondary-text-color);font-size:12px;">Bay Count:</span><br/><b>${p.bay_count || 0}</b></div>`;
          infoHtml += `<div><span style="color:var(--secondary-text-color);font-size:12px;">Enabled:</span><br/><b>${p.enabled ? 'Yes' : 'No'}</b></div>`;
          infoHtml += `<div><span style="color:var(--secondary-text-color);font-size:12px;">Individual Mode:</span><br/><b>${p.automation_state_individual ? 'Yes' : 'No'}</b></div>`;
          infoHtml += `</div>`;

          // Build bay table HTML
          let tableHtml = '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
          tableHtml += '<tr style="background:rgba(0,0,0,0.1);"><th style="padding:6px;text-align:left;">Bay</th><th style="padding:6px;">Supply</th><th style="padding:6px;">Drain</th><th style="padding:6px;">Sensor</th></tr>';

          const bayList = Object.entries(bays)
            .filter(([id, b]) => b.paddock_id === paddockId)
            .sort((a,b) => (a[1].order || 0) - (b[1].order || 0));

          for (const [bayId, bay] of bayList) {
            const sup1 = bay.supply_1?.device || '-';
            const drain = bay.drain_1?.device || '-';
            const sensor = bay.level_sensor || '-';
            tableHtml += `<tr style="border-bottom:1px solid var(--divider-color);">`;
            tableHtml += `<td style="padding:6px;font-weight:600;">${bay.name}</td>`;
            tableHtml += `<td style="padding:6px;text-align:center;font-size:10px;">${sup1}</td>`;
            tableHtml += `<td style="padding:6px;text-align:center;font-size:10px;">${drain}</td>`;
            tableHtml += `<td style="padding:6px;text-align:center;font-size:10px;">${sensor}</td>`;
            tableHtml += `</tr>`;
          }

          if (bayList.length === 0) {
            tableHtml += '<tr><td colspan="4" style="padding:12px;text-align:center;color:var(--secondary-text-color);">No bays configured</td></tr>';
          }
          tableHtml += '</table>';

          return {
            service: 'browser_mod.popup',
            data: {
              title: paddockName + ' Configuration',
              dismissable: true,
              initial_style: 'wide',
              content: {
                type: 'vertical-stack',
                cards: [
                  {
                    type: 'custom:button-card',
                    color_type: 'label-card',
                    color: 'rgb(200, 250, 55)',
                    name: 'PADDOCK SETTINGS',
                    styles: { card: [{ height: '30px' }], name: [{ 'font-size': '14px' }, { 'font-weight': '700' }] }
                  },
                  {
                    type: 'markdown',
                    content: infoHtml
                  },
                  {
                    type: 'custom:button-card',
                    color_type: 'label-card',
                    color: 'rgb(200, 250, 55)',
                    name: 'BAY DEVICE ASSIGNMENTS',
                    styles: { card: [{ height: '30px' }], name: [{ 'font-size': '14px' }, { 'font-weight': '700' }] }
                  },
                  {
                    type: 'markdown',
                    content: tableHtml
                  },
                  {
                    type: 'button',
                    name: 'Close',
                    icon: 'mdi:close',
                    tap_action: {
                      action: 'fire-dom-event',
                      browser_mod: { service: 'browser_mod.close_popup' }
                    }
                  }
                ]
              }
            }
          };
        ]]]

  #---------------------------------------------------------------------------
  # Extra data button
  #---------------------------------------------------------------------------
  template_extradatabutton:
    variables:
      nav_path: /pwm-service/overview
    name: Extra Data
    icon: mdi:database
    color_type: card
    styles:
      card:
        - height: 100px
      icon:
        - height: 60px
    show_name: true
    show_icon: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'

  #---------------------------------------------------------------------------
  # Paddock card for overview
  #---------------------------------------------------------------------------
  template_paddock_overview_card:
    variables:
      paddock_id: ''
      paddock_name: ''
      bay_count: 0
      enabled: false
      nav_path: ''
    name: '[[[ return variables.paddock_name ]]]'
    icon: mdi:waves
    color: |
      [[[
        return variables.enabled ? 'rgb(46, 125, 50)' : 'rgb(117, 117, 117)';
      ]]]
    color_type: card
    styles:
      card:
        - height: 100px
        - border-radius: 12px
      icon:
        - width: 40px
      name:
        - font-size: 18px
        - font-weight: 700
    label: |
      [[[
        return variables.bay_count + ' bays | ' + (variables.enabled ? 'Enabled' : 'Disabled');
      ]]]
    show_name: true
    show_icon: true
    show_label: true
    tap_action:
      action: navigate
      navigation_path: '[[[ return variables.nav_path ]]]'

  #---------------------------------------------------------------------------
  # Info stat chip
  #---------------------------------------------------------------------------
  template_stat_chip:
    color_type: label-card
    show_icon: true
    show_name: true
    show_state: true
    tap_action:
      action: none
    styles:
      card:
        - height: 60px
        - border-radius: 10px
        - padding: 8px
      grid:
        - grid-template-areas: '"i s" "i n"'
        - grid-template-columns: 40px 1fr
        - grid-template-rows: 1fr 1fr
      icon:
        - width: 30px
        - color: white
      state:
        - font-size: 20px
        - font-weight: 700
        - justify-self: start
        - color: white
      name:
        - font-size: 12px
        - justify-self: start
        - color: rgba(255,255,255,0.8)

views:
  #############################################################################
  # VIEW 1: OVERVIEW
  #############################################################################
  - title: Overview
    path: overview
    icon: mdi:view-dashboard
    type: masonry
    cards:
      # Title
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "PADDOCK OVERVIEW"

      # Stats row
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: template_stat_chip
            name: "Paddocks"
            icon: mdi:view-grid
            color: rgb(46, 125, 50)
            entity: sensor.pwm_data
            state_display: |
              [[[
                return states['sensor.pwm_data']?.attributes?.enabled_paddock_count || 0;
              ]]]

          - type: custom:button-card
            template: template_stat_chip
            name: "Bays"
            icon: mdi:format-list-numbered
            color: rgb(21, 101, 192)
            entity: sensor.pwm_data
            state_display: |
              [[[
                return states['sensor.pwm_data']?.attributes?.total_bays || 0;
              ]]]

          - type: custom:button-card
            template: template_stat_chip
            name: "Devices"
            icon: mdi:access-point
            color: rgb(156, 39, 176)
            entity: sensor.pwm_data
            state_display: |
              [[[
                return states['sensor.pwm_data']?.attributes?.device_count || 0;
              ]]]

      # Paddock grid (auto-entities)
      - type: custom:auto-entities
        filter:
          template: |
            {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
            {% for p in summary %}
            {{ {
              'type': 'custom:button-card',
              'template': 'template_paddock_overview_card',
              'variables': {
                'paddock_id': p.id,
                'paddock_name': p.name,
                'bay_count': p.bay_count,
                'enabled': p.enabled,
                'nav_path': '/pwm-service/' ~ (p.id | replace('_', '-'))
              }
            } | tojson }},
            {% endfor %}
        sort:
          method: none
        card:
          type: grid
          columns: 2

      # Quick actions
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "QUICK ACTIONS"

      - type: horizontal-stack
        cards:
          - type: button
            name: Settings
            icon: mdi:cog
            tap_action:
              action: navigate
              navigation_path: /pwm-service/settings
            icon_height: 50px

          - type: button
            name: Refresh
            icon: mdi:refresh
            tap_action:
              action: call-service
              service: script.pwm_refresh_data
            icon_height: 50px

  #############################################################################
  # VIEW 2: TEST FIELD
  #############################################################################
  - title: Test Field
    path: test-field
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "TEST FIELD"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.test_field_automation_state
            name: Test Field Automation State
            variables:
              paddock_var: test_field

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "TEST FIELD INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_baybuttonrow
                entity: input_select.test_field_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: test_field
                  bay_var: B-01

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.test_field_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: test_field
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.test_field_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: test_field

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.test_field_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: test_field
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.test_field_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: test_field

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.test_field_b_04_door_control
                name: B-04 SUPPLY
                variables:
                  paddock_var: test_field
                  bay_var: B-04
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.test_field_b_04_automation_state
                name: B-04 State
                variables:
                  paddock_var: test_field

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.test_field_drain_door_control
            name: B-04 DRAIN
            variables:
              paddock_var: test_field
              bay_var: B-04 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: test_field
          paddock_name: Test Field

  #############################################################################
  # VIEW 3: SW4-E
  #############################################################################
  - title: SW4-E
    path: sw4-e
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW4 EAST"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.sw4_e_automation_state
            name: SW4-E Automation State
            variables:
              paddock_var: sw4_e

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW4-E INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_e_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: sw4_e
                  bay_var: B-01
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_e_b_01_automation_state
                name: B-01 State
                variables:
                  paddock_var: sw4_e

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_e_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: sw4_e
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_e_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: sw4_e

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_e_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: sw4_e
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_e_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: sw4_e

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.sw4_e_drain_door_control
            name: B-03 DRAIN
            variables:
              paddock_var: sw4_e
              bay_var: B-03 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw4_e
          paddock_name: SW4-E

  #############################################################################
  # VIEW 4: SW4-W
  #############################################################################
  - title: SW4-W
    path: sw4-w
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW4 WEST"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.sw4_w_automation_state
            name: SW4-W Automation State
            variables:
              paddock_var: sw4_w

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW4-W INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_w_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: sw4_w
                  bay_var: B-01
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_w_b_01_automation_state
                name: B-01 State
                variables:
                  paddock_var: sw4_w

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_w_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: sw4_w
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_w_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: sw4_w

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw4_w_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: sw4_w
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw4_w_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: sw4_w

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.sw4_w_drain_door_control
            name: B-03 DRAIN
            variables:
              paddock_var: sw4_w
              bay_var: B-03 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw4_w
          paddock_name: SW4-W

  #############################################################################
  # VIEW 5: SW5
  #############################################################################
  - title: SW5
    path: sw5
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW5"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.sw5_automation_state
            name: SW5 Automation State
            variables:
              paddock_var: sw5

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "SW5 INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw5_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: sw5
                  bay_var: B-01
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw5_b_01_automation_state
                name: B-01 State
                variables:
                  paddock_var: sw5

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw5_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: sw5
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw5_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: sw5

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw5_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: sw5
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw5_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: sw5

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw5_b_04_door_control
                name: B-04 SUPPLY
                variables:
                  paddock_var: sw5
                  bay_var: B-04
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw5_b_04_automation_state
                name: B-04 State
                variables:
                  paddock_var: sw5

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.sw5_b_05_door_control
                name: B-05 SUPPLY
                variables:
                  paddock_var: sw5
                  bay_var: B-05
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.sw5_b_05_automation_state
                name: B-05 State
                variables:
                  paddock_var: sw5

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.sw5_drain_door_control
            name: B-05 DRAIN
            variables:
              paddock_var: sw5
              bay_var: B-05 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: sw5
          paddock_name: SW5

  #############################################################################
  # VIEW 6: W17
  #############################################################################
  - title: W17
    path: w17
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W17"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.w17_automation_state
            name: W17 Automation State
            variables:
              paddock_var: w17

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W17 INLET CONTROLS"

          # B-01 has dual supply (door + NML spur)
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: w17
                  bay_var: B-01
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_01_nml_door_control
                name: NML DRAIN
                variables:
                  paddock_var: w17
                  bay_var: B-01 NML

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: w17
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w17_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: w17

          # B-03 has channel supply
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: w17
                  bay_var: B-03
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_03_channel_supply_door_control
                name: B-03 Channel
                variables:
                  paddock_var: w17
                  bay_var: B-03 Channel

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w17_b_04_door_control
                name: B-04 SUPPLY
                variables:
                  paddock_var: w17
                  bay_var: B-04
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w17_b_04_automation_state
                name: B-04 State
                variables:
                  paddock_var: w17

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.w17_b_05_door_control
            name: B-05 SUPPLY
            variables:
              paddock_var: w17
              bay_var: B-05

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.w17_drain_door_control
            name: B-05 DRAIN
            variables:
              paddock_var: w17
              bay_var: B-05 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w17
          paddock_name: W17

  #############################################################################
  # VIEW 7: W18
  #############################################################################
  - title: W18
    path: w18
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W18"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.w18_automation_state
            name: W18 Automation State
            variables:
              paddock_var: w18

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W18 INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w18_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: w18
                  bay_var: B-01
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w18_b_01_automation_state
                name: B-01 State
                variables:
                  paddock_var: w18

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w18_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: w18
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w18_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: w18

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w18_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: w18
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w18_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: w18

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w18_b_04_door_control
                name: B-04 SUPPLY
                variables:
                  paddock_var: w18
                  bay_var: B-04
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w18_b_04_automation_state
                name: B-04 State
                variables:
                  paddock_var: w18

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w18_b_05_door_control
                name: B-05 SUPPLY
                variables:
                  paddock_var: w18
                  bay_var: B-05
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w18_b_05_automation_state
                name: B-05 State
                variables:
                  paddock_var: w18

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.w18_drain_door_control
            name: B-05 DRAIN
            variables:
              paddock_var: w18
              bay_var: B-05 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w18
          paddock_name: W18

  #############################################################################
  # VIEW 8: W19
  #############################################################################
  - title: W19
    path: w19
    type: masonry
    cards:
      - type: vertical-stack
        cards:
          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W19"

          - type: custom:button-card
            template: template_paddock_automationstate
            entity: input_select.w19_automation_state
            name: W19 Automation State
            variables:
              paddock_var: w19

          - type: custom:button-card
            template: template_titleblock
            variables:
              var_name: "W19 INLET CONTROLS"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w19_b_01_door_control
                name: B-01 SUPPLY
                variables:
                  paddock_var: w19
                  bay_var: B-01
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w19_b_01_automation_state
                name: B-01 State
                variables:
                  paddock_var: w19

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w19_b_02_door_control
                name: B-02 SUPPLY
                variables:
                  paddock_var: w19
                  bay_var: B-02
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w19_b_02_automation_state
                name: B-02 State
                variables:
                  paddock_var: w19

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w19_b_03_door_control
                name: B-03 SUPPLY
                variables:
                  paddock_var: w19
                  bay_var: B-03
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w19_b_03_automation_state
                name: B-03 State
                variables:
                  paddock_var: w19

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                template: template_buttoncard_openclose
                entity: input_select.w19_b_04_door_control
                name: B-04 SUPPLY
                variables:
                  paddock_var: w19
                  bay_var: B-04
              - type: custom:button-card
                template: template_inputselect_automationstate
                entity: input_select.w19_b_04_automation_state
                name: B-04 State
                variables:
                  paddock_var: w19

          - type: custom:button-card
            template: template_buttoncard_openclose
            entity: input_select.w19_drain_door_control
            name: B-04 DRAIN
            variables:
              paddock_var: w19
              bay_var: B-04 Drain

      - type: custom:button-card
        template: template_paddockconfigbutton
        variables:
          paddock_id: w19
          paddock_name: W19

  #############################################################################
  # VIEW 9: SETTINGS
  #############################################################################
  - title: Settings
    path: settings
    type: masonry
    cards:
      # Title
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "PWM SETTINGS"

      # System status
      - type: entities
        title: "System Status"
        entities:
          - entity: sensor.pwm_data
            name: "Status"
            icon: mdi:check-circle

          - type: attribute
            entity: sensor.pwm_data
            attribute: version
            name: "Version"
            icon: mdi:tag

          - type: attribute
            entity: sensor.pwm_data
            attribute: total_paddocks
            name: "Total Paddocks"
            icon: mdi:view-grid

          - type: attribute
            entity: sensor.pwm_data
            attribute: total_bays
            name: "Total Bays"
            icon: mdi:format-list-numbered

          - type: attribute
            entity: sensor.pwm_data
            attribute: device_count
            name: "Devices in Use"
            icon: mdi:access-point

          - type: attribute
            entity: sensor.pwm_data
            attribute: backup_count
            name: "Backups"
            icon: mdi:backup-restore

      # System actions
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "SYSTEM ACTIONS"

      - type: horizontal-stack
        cards:
          - type: button
            name: Refresh
            icon: mdi:refresh
            tap_action:
              action: call-service
              service: script.pwm_refresh_data
            icon_height: 50px

          - type: button
            name: Export
            icon: mdi:download
            tap_action:
              action: call-service
              service: script.pwm_export_data
            icon_height: 50px

          - type: button
            name: Initialize
            icon: mdi:database-plus
            tap_action:
              action: call-service
              service: script.pwm_init_system
            icon_height: 50px

      # Add paddock form
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "ADD PADDOCK"

      - type: entities
        entities:
          - entity: input_text.pwm_new_paddock_name
            name: "Paddock Name"

          - entity: input_number.pwm_new_paddock_bay_count
            name: "Number of Bays"

          - entity: input_boolean.pwm_new_paddock_individual
            name: "Individual Bay Mode"

      - type: button
        name: Add Paddock
        icon: mdi:plus-circle
        tap_action:
          action: call-service
          service: script.pwm_add_paddock
          service_data:
            name: "{{ states('input_text.pwm_new_paddock_name') }}"
            bay_count: "{{ states('input_number.pwm_new_paddock_bay_count') | int }}"
            individual: "{{ is_state('input_boolean.pwm_new_paddock_individual', 'on') }}"
        icon_height: 50px

      # Paddock list for management
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "MANAGE PADDOCKS"

      - type: custom:auto-entities
        filter:
          template: |
            {% set summary = state_attr('sensor.pwm_data', 'paddock_summary') or [] %}
            {% for p in summary %}
            {{ {
              'type': 'custom:button-card',
              'name': p.name,
              'icon': 'mdi:waves',
              'state_display': (p.bay_count | string) ~ ' bays',
              'show_icon': true,
              'show_name': true,
              'show_state': true,
              'color': 'rgb(46, 125, 50)' if p.enabled else 'rgb(117, 117, 117)',
              'color_type': 'card',
              'styles': {
                'card': [{'height': '60px'}, {'border-radius': '8px'}],
                'name': [{'font-size': '14px'}, {'font-weight': '600'}],
                'state': [{'font-size': '11px'}]
              },
              'hold_action': {
                'action': 'call-service',
                'service': 'script.pwm_delete_paddock',
                'service_data': {'paddock_id': p.id},
                'confirmation': {'text': 'Delete paddock ' ~ p.name ~ '?'}
              }
            } | tojson }},
            {% endfor %}
        sort:
          method: none
        card:
          type: grid
          columns: 2

      # Device list
      - type: custom:button-card
        template: template_titleblock
        variables:
          var_name: "DEVICES IN USE"

      - type: markdown
        content: |
          {% set devices = state_attr('sensor.pwm_data', 'device_list') or [] %}
          {% if devices %}
          | Device |
          |--------|
          {% for d in devices %}
          | `{{ d }}` |
          {% endfor %}
          {% else %}
          No devices configured
          {% endif %}
