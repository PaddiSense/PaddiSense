# =============================================================================
# PWM - Precision Water Management Package
# PaddiSense Farm Management System
# Version: 2.0.0
# =============================================================================
#
# This package provides automated irrigation control for rice paddocks.
# Paddock-specific entities (input_selects, sensors, automations) are
# dynamically generated by pwm_generator.py and loaded as separate packages.
#
# Key components:
#   - sensor.pwm_data: Main data sensor (JSON output from pwm_sensor.py)
#   - Template sensors: System status and UI support
#   - Shell commands: Backend operations (add/edit paddocks, assign devices)
#   - Scripts: UI actions (refresh, init, export, generate)
#
# To add a paddock:
#   1. Use the dashboard UI or call script.pwm_add_paddock
#   2. Run script.pwm_generate_and_reload to create entities
#
# =============================================================================

# -----------------------------------------------------------------------------
# COMMAND LINE SENSOR - Main data source
# -----------------------------------------------------------------------------
command_line:
  - sensor:
      name: PWM Data
      unique_id: pwm_data
      command: "python3 /config/PaddiSense/pwm/python/pwm_sensor.py"
      scan_interval: 30
      command_timeout: 15
      value_template: "{{ value_json.status }}"
      json_attributes:
        - initialized
        - config_ok
        - pwm_enabled
        - version
        - total_paddocks
        - total_bays
        - total_farms
        - enabled_paddock_count
        - device_count
        - backup_count
        - paddocks
        - bays
        - farms
        - paddock_summary
        - bay_summary
        - paddock_names
        - enabled_paddock_ids
        - farm_names
        - device_list

# -----------------------------------------------------------------------------
# SHELL COMMANDS - Backend operations
# -----------------------------------------------------------------------------
shell_command:
  # System commands
  pwm_init: "python3 /config/PaddiSense/pwm/python/pwm_backend.py init"
  pwm_status: "python3 /config/PaddiSense/pwm/python/pwm_backend.py status"
  pwm_export: "python3 /config/PaddiSense/pwm/python/pwm_backend.py export"
  pwm_backup_list: "python3 /config/PaddiSense/pwm/python/pwm_backend.py backup_list"

  # Paddock commands
  pwm_add_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py add_paddock
    --farm "{{ farm }}"
    --name "{{ name }}"
    --bay_prefix "{{ bay_prefix | default('B-') }}"
    --bay_count {{ bay_count }}
    {{ '--individual' if individual else '' }}

  pwm_edit_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py edit_paddock
    --id "{{ paddock_id }}"
    {{ '--name "' ~ name ~ '"' if name else '' }}
    {{ '--farm "' ~ farm ~ '"' if farm else '' }}
    {{ '--individual ' ~ individual if individual is defined else '' }}
    {{ '--image_url "' ~ image_url ~ '"' if image_url else '' }}
    {{ '--enabled ' ~ enabled if enabled is defined else '' }}

  pwm_delete_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py delete_paddock
    --id "{{ paddock_id }}"

  pwm_enable_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py enable_paddock
    --id "{{ paddock_id }}"

  pwm_disable_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py disable_paddock
    --id "{{ paddock_id }}"

  # Bay commands
  pwm_edit_bay: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py edit_bay
    --id "{{ bay_id }}"
    {{ '--level_sensor "' ~ level_sensor ~ '"' if level_sensor else '' }}
    {{ '--water_level_min ' ~ water_level_min if water_level_min is defined else '' }}
    {{ '--water_level_max ' ~ water_level_max if water_level_max is defined else '' }}
    {{ '--water_level_offset ' ~ water_level_offset if water_level_offset is defined else '' }}
    {{ '--flush_time ' ~ flush_time if flush_time is defined else '' }}

  pwm_assign_device: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py assign_device
    --bay "{{ bay_id }}"
    --slot "{{ slot }}"
    --device "{{ device }}"
    --type "{{ device_type | default('door') }}"
    {{ '--label "' ~ label ~ '"' if label else '' }}

  # Import/reset (dangerous)
  pwm_import_backup: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py import_backup
    --filename "{{ filename }}"

  pwm_reset: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py reset
    --token "{{ token }}"

  # Generator commands - auto-create YAML entities
  pwm_generate_all: "python3 /config/PaddiSense/pwm/python/pwm_generator.py generate"

  pwm_generate_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_generator.py generate
    --paddock "{{ paddock_id }}"

  pwm_clean_generated: "python3 /config/PaddiSense/pwm/python/pwm_generator.py clean"

  # Dashboard generator command
  pwm_generate_dashboard: "python3 /config/PaddiSense/pwm/python/pwm_generator.py dashboard"

  # Sync commands - Registry integration
  pwm_sync_from_registry: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py sync_from_registry
    {{ '--paddock "' ~ paddock ~ '"' if paddock else '' }}

  pwm_list_paddocks: "python3 /config/PaddiSense/pwm/python/pwm_backend.py list_paddocks"

  # Paddock image and bay position commands
  pwm_set_paddock_image: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py edit_paddock
    --id "{{ paddock_id }}"
    --image_url "{{ image_url }}"

  pwm_set_bay_position: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py edit_bay
    --id "{{ bay_id }}"
    --badge_top {{ badge_top }}
    --badge_left {{ badge_left }}

  pwm_toggle_paddock: >-
    python3 /config/PaddiSense/pwm/python/pwm_backend.py edit_paddock
    --id "{{ paddock_id }}"
    --enabled {{ enabled }}

# -----------------------------------------------------------------------------
# INPUT HELPERS - For UI interaction only
# -----------------------------------------------------------------------------
input_select:
  pwm_selected_paddock:
    name: "PWM Selected Paddock"
    options:
      - "Select Paddock"
    icon: mdi:view-grid

  pwm_selected_bay:
    name: "PWM Selected Bay"
    options:
      - "Select Bay"
    icon: mdi:format-list-numbered

  pwm_editor_mode:
    name: "PWM Editor Mode"
    options:
      - "view"
      - "add_paddock"
      - "edit_paddock"
      - "edit_bay"
    initial: "view"
    icon: mdi:pencil

  # Device selector for wizard - populated dynamically via script
  pwm_device_selector:
    name: "PWM Device Selector"
    options:
      - "(none)"
    initial: "(none)"
    icon: mdi:chip

input_text:
  pwm_new_paddock_name:
    name: "PWM New Paddock Name"
    initial: ""
    max: 50
    icon: mdi:form-textbox

  pwm_paddock_config_pointer:
    name: "PWM Paddock Config Pointer"
    initial: ""
    max: 50
    icon: mdi:target

  # Device assignment wizard fields
  pwm_wizard_paddock_id:
    name: "PWM Wizard Paddock ID"
    initial: ""
    max: 50
    icon: mdi:identifier

  pwm_wizard_bay_id:
    name: "PWM Wizard Bay ID"
    initial: ""
    max: 50
    icon: mdi:identifier

  pwm_device_supply_1:
    name: "PWM Device Supply 1"
    initial: ""
    max: 50
    icon: mdi:water

  pwm_device_supply_2:
    name: "PWM Device Supply 2"
    initial: ""
    max: 50
    icon: mdi:water

  pwm_device_drain_1:
    name: "PWM Device Drain 1"
    initial: ""
    max: 50
    icon: mdi:water-off

  pwm_device_drain_2:
    name: "PWM Device Drain 2"
    initial: ""
    max: 50
    icon: mdi:water-off

  pwm_device_level_sensor:
    name: "PWM Device Level Sensor"
    initial: ""
    max: 50
    icon: mdi:waves-arrow-up

  # Paddock edit fields
  pwm_edit_paddock_id:
    name: "PWM Edit Paddock ID"
    initial: ""
    max: 50
    icon: mdi:identifier

  pwm_edit_paddock_name:
    name: "PWM Edit Paddock Name"
    initial: ""
    max: 50
    icon: mdi:form-textbox

  pwm_edit_paddock_image:
    name: "PWM Edit Paddock Image URL"
    initial: ""
    max: 200
    icon: mdi:image

input_number:
  pwm_new_paddock_bay_count:
    name: "PWM New Paddock Bay Count"
    min: 1
    max: 20
    step: 1
    initial: 5
    mode: box
    icon: mdi:numeric

  pwm_bay_water_level_min:
    name: "PWM Bay Water Level Min"
    min: 0
    max: 50
    step: 1
    initial: 5
    mode: box
    unit_of_measurement: "cm"
    icon: mdi:water-minus

  pwm_bay_water_level_max:
    name: "PWM Bay Water Level Max"
    min: 0
    max: 50
    step: 1
    initial: 15
    mode: box
    unit_of_measurement: "cm"
    icon: mdi:water-plus

  pwm_bay_water_level_offset:
    name: "PWM Bay Water Level Offset"
    min: -20
    max: 20
    step: 0.5
    initial: 0
    mode: box
    unit_of_measurement: "cm"
    icon: mdi:water-sync

  pwm_bay_flush_time:
    name: "PWM Bay Flush Time"
    min: 600
    max: 14400
    step: 300
    initial: 3600
    mode: box
    unit_of_measurement: "s"
    icon: mdi:timer

  # Badge position editing
  pwm_edit_bay_top:
    name: "PWM Edit Bay Badge Top %"
    min: 0
    max: 100
    step: 1
    initial: 50
    mode: box
    unit_of_measurement: "%"
    icon: mdi:arrow-up-down

  pwm_edit_bay_left:
    name: "PWM Edit Bay Badge Left %"
    min: 0
    max: 100
    step: 1
    initial: 40
    mode: box
    unit_of_measurement: "%"
    icon: mdi:arrow-left-right

input_boolean:
  pwm_new_paddock_individual:
    name: "PWM New Paddock Individual Mode"
    initial: false
    icon: mdi:account-details

  pwm_wizard_active:
    name: "PWM Wizard Active"
    initial: false
    icon: mdi:wizard-hat

# -----------------------------------------------------------------------------
# TEMPLATE SENSORS - System status and UI support
# -----------------------------------------------------------------------------
template:
  - sensor:
      # System status sensor
      - name: "PWM System Status"
        unique_id: pwm_system_status
        state: >-
          {% set data = state_attr('sensor.pwm_data', 'initialized') %}
          {% if data == true %}ready{% else %}not_initialized{% endif %}
        icon: mdi:water-pump
        attributes:
          version: "{{ state_attr('sensor.pwm_data', 'version') }}"
          total_paddocks: "{{ state_attr('sensor.pwm_data', 'total_paddocks') }}"
          total_bays: "{{ state_attr('sensor.pwm_data', 'total_bays') }}"
          enabled_paddocks: "{{ state_attr('sensor.pwm_data', 'enabled_paddock_count') }}"
          device_count: "{{ state_attr('sensor.pwm_data', 'device_count') }}"

      # Paddock count sensor
      - name: "PWM Enabled Paddock Count"
        unique_id: pwm_enabled_paddock_count
        state: "{{ state_attr('sensor.pwm_data', 'enabled_paddock_count') | int(0) }}"
        icon: mdi:view-grid
        unit_of_measurement: "paddocks"

      # Selected paddock details
      - name: "PWM Selected Paddock Details"
        unique_id: pwm_selected_paddock_details
        state: >-
          {% set selected = states('input_select.pwm_selected_paddock') %}
          {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
          {% for pid, p in paddocks.items() if p.name == selected %}
            {{ p.name }}
          {% else %}
            none
          {% endfor %}
        attributes:
          paddock_id: >-
            {% set selected = states('input_select.pwm_selected_paddock') %}
            {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
            {% for pid, p in paddocks.items() if p.name == selected %}
              {{ pid }}
            {% else %}
              none
            {% endfor %}
          enabled: >-
            {% set selected = states('input_select.pwm_selected_paddock') %}
            {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
            {% for pid, p in paddocks.items() if p.name == selected %}
              {{ p.enabled }}
            {% else %}
              false
            {% endfor %}
          individual_mode: >-
            {% set selected = states('input_select.pwm_selected_paddock') %}
            {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
            {% for pid, p in paddocks.items() if p.name == selected %}
              {{ p.automation_state_individual }}
            {% else %}
              false
            {% endfor %}
          bay_count: >-
            {% set selected = states('input_select.pwm_selected_paddock') %}
            {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
            {% for pid, p in paddocks.items() if p.name == selected %}
              {{ p.bay_count }}
            {% else %}
              0
            {% endfor %}

      # Selected bay details
      - name: "PWM Selected Bay Details"
        unique_id: pwm_selected_bay_details
        state: >-
          {% set selected = states('input_select.pwm_selected_bay') %}
          {% set bays = state_attr('sensor.pwm_data', 'bay_summary') or [] %}
          {% for b in bays if b.id == selected or (b.paddock_name ~ ' ' ~ b.name) == selected %}
            {{ b.name }}
          {% else %}
            none
          {% endfor %}
        attributes:
          bay_id: >-
            {% set selected = states('input_select.pwm_selected_bay') %}
            {% set bays = state_attr('sensor.pwm_data', 'bays') or {} %}
            {% for bid, b in bays.items() if selected.endswith(b.name) %}
              {{ bid }}
            {% else %}
              none
            {% endfor %}

      # ESPHome device enumeration - finds all RiceBoard devices
      - name: "PWM Available ESPHome Devices"
        unique_id: "pwm_available_esphome_devices"
        state: >-
          {# Count devices that have a restart button (ESPHome pattern) #}
          {% set devices = states.button | selectattr('entity_id', 'search', 'rb_\\d+.*restart') | list %}
          {{ devices | length }}
        icon: "mdi:chip"
        attributes:
          device_list: >-
            {# Find all RiceBoard devices by their restart button pattern #}
            {% set devices = [] %}
            {% for entity in states.button %}
              {% if entity.entity_id is search('rb_\\d+') and 'restart' in entity.entity_id %}
                {% set device_id = entity.entity_id | regex_replace('^button\\.', '') | regex_replace('_.*restart.*$', '') %}
                {% if device_id not in devices %}
                  {% set devices = devices + [device_id] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ devices | sort }}
          device_status: >-
            {# Get online/offline status for each device via their sensor availability #}
            {% set result = {} %}
            {% set device_list = state_attr('sensor.pwm_available_esphome_devices', 'device_list') or [] %}
            {% for device_id in device_list %}
              {# Check if any entity from this device is available #}
              {% set test_entity = 'sensor.' ~ device_id ~ '_uptime' %}
              {% set online = states(test_entity) not in ['unavailable', 'unknown'] %}
              {% set result = dict(result, **{device_id: 'online' if online else 'offline'}) %}
            {% endfor %}
            {{ result }}
          available_devices: >-
            {# Devices not currently assigned to any bay #}
            {% set all_devices = state_attr('sensor.pwm_available_esphome_devices', 'device_list') or [] %}
            {% set used_devices = state_attr('sensor.pwm_data', 'device_list') or [] %}
            {{ all_devices | reject('in', used_devices) | list }}
          unassigned_count: >-
            {{ (state_attr('sensor.pwm_available_esphome_devices', 'available_devices') or []) | length }}

# -----------------------------------------------------------------------------
# SCRIPTS - UI Actions
# -----------------------------------------------------------------------------
script:
  pwm_refresh_data:
    alias: "PWM Refresh Data"
    description: "Force refresh of PWM sensor data"
    sequence:
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_init_system:
    alias: "PWM Initialize System"
    description: "Initialize the PWM system"
    sequence:
      - action: shell_command.pwm_init
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_export_data:
    alias: "PWM Export Data"
    description: "Export PWM data to backup"
    sequence:
      - action: shell_command.pwm_export
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_generate_entities:
    alias: "PWM Generate Entities"
    description: "Generate YAML files for all paddocks"
    sequence:
      - action: shell_command.pwm_generate_all
      - delay:
          seconds: 2
      - action: persistent_notification.create
        data:
          title: "PWM Generator"
          message: >
            Entity YAML files generated successfully.

            To activate new entities, go to Developer Tools > YAML
            and reload: Input Booleans, Input Numbers, Input Selects,
            Timers, Template Entities, and Automations.

            Or restart Home Assistant.
          notification_id: pwm_generator_complete
    mode: single

  pwm_generate_and_reload:
    alias: "PWM Generate & Reload All"
    description: "Generate entities and reload all required domains"
    sequence:
      - action: shell_command.pwm_generate_all
      - delay:
          seconds: 2
      - action: input_boolean.reload
      - delay:
          milliseconds: 500
      - action: input_number.reload
      - delay:
          milliseconds: 500
      - action: input_select.reload
      - delay:
          milliseconds: 500
      - action: timer.reload
      - delay:
          milliseconds: 500
      - action: template.reload
      - delay:
          milliseconds: 500
      - action: automation.reload
      - delay:
          seconds: 1
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: persistent_notification.create
        data:
          title: "PWM Generator"
          message: "Entity generation and reload complete. All paddock entities are now active."
          notification_id: pwm_generator_complete
    mode: single

  pwm_add_paddock:
    alias: "PWM Add Paddock"
    description: "Add a new paddock"
    fields:
      name:
        description: "Paddock name"
        required: true
        selector:
          text:
      bay_count:
        description: "Number of bays"
        required: true
        selector:
          number:
            min: 1
            max: 20
      farm:
        description: "Farm ID"
        required: false
        selector:
          text:
      individual:
        description: "Individual automation mode"
        required: false
        selector:
          boolean:
    sequence:
      - action: shell_command.pwm_add_paddock
        data:
          name: "{{ name }}"
          bay_count: "{{ bay_count }}"
          farm: "{{ farm | default('farm_1') }}"
          individual: "{{ individual | default(false) }}"
          bay_prefix: "B-"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: script.pwm_update_paddock_dropdown
    mode: single

  pwm_delete_paddock:
    alias: "PWM Delete Paddock"
    description: "Delete a paddock and all its bays"
    fields:
      paddock_id:
        description: "Paddock ID to delete"
        required: true
        selector:
          text:
    sequence:
      - action: shell_command.pwm_delete_paddock
        data:
          paddock_id: "{{ paddock_id }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: script.pwm_update_paddock_dropdown
    mode: single

  pwm_enable_paddock:
    alias: "PWM Enable Paddock"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - action: shell_command.pwm_enable_paddock
        data:
          paddock_id: "{{ paddock_id }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_disable_paddock:
    alias: "PWM Disable Paddock"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - action: shell_command.pwm_disable_paddock
        data:
          paddock_id: "{{ paddock_id }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_toggle_paddock_enabled:
    alias: "PWM Toggle Paddock Enabled"
    description: "Toggle paddock enabled state"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
      enabled:
        description: "Enabled state (true/false)"
        required: true
        selector:
          boolean:
    sequence:
      - action: shell_command.pwm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"
          enabled: "{{ enabled }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_save_paddock_edit:
    alias: "PWM Save Paddock Edit"
    description: "Save paddock name and image URL changes"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
      name:
        description: "New paddock name"
        required: false
        selector:
          text:
      image_url:
        description: "Paddock image URL"
        required: false
        selector:
          text:
    sequence:
      - variables:
          final_image_url: >-
            {% if image_url is defined and image_url != '' %}
              {{ image_url }}
            {% else %}
              {{ states('input_text.pwm_edit_paddock_image') }}
            {% endif %}
      - action: shell_command.pwm_edit_paddock
        data:
          paddock_id: "{{ paddock_id }}"
          name: "{{ name | default('') }}"
          image_url: "{{ final_image_url }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: browser_mod.close_popup
    mode: single

  pwm_save_bay_position:
    alias: "PWM Save Bay Position"
    description: "Save bay badge position"
    fields:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
      badge_top:
        description: "Badge top position (0-100%)"
        required: true
        selector:
          number:
            min: 0
            max: 100
      badge_left:
        description: "Badge left position (0-100%)"
        required: true
        selector:
          number:
            min: 0
            max: 100
    sequence:
      - action: shell_command.pwm_set_bay_position
        data:
          bay_id: "{{ bay_id }}"
          badge_top: "{{ badge_top }}"
          badge_left: "{{ badge_left }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_generate_dashboard:
    alias: "PWM Generate Dashboard"
    description: "Generate dashboard views for all paddocks"
    sequence:
      - action: shell_command.pwm_generate_dashboard
      - delay:
          seconds: 2
      - action: persistent_notification.create
        data:
          title: "PWM Dashboard Generator"
          message: >
            Dashboard views have been generated.

            You may need to refresh your browser to see the updated views.
          notification_id: pwm_dashboard_complete
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_sync_from_registry:
    alias: "PWM Sync from Registry"
    description: "Sync paddock/bay structure from Farm Registry"
    fields:
      paddock:
        description: "Specific paddock ID to sync (optional)"
        required: false
        selector:
          text:
    sequence:
      - action: shell_command.pwm_sync_from_registry
        data:
          paddock: "{{ paddock | default('') }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: persistent_notification.create
        data:
          title: "PWM Registry Sync"
          message: "Synced paddock/bay structure from Farm Registry."
          notification_id: pwm_sync_complete
    mode: single

  pwm_assign_device:
    alias: "PWM Assign Device to Bay"
    fields:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
      slot:
        description: "Device slot (supply_1, supply_2, drain_1, drain_2)"
        required: true
        selector:
          select:
            options:
              - supply_1
              - supply_2
              - drain_1
              - drain_2
      device:
        description: "Device name"
        required: true
        selector:
          text:
      device_type:
        description: "Device type"
        required: false
        selector:
          select:
            options:
              - door
              - valve
              - spur
              - channel_supply
      label:
        description: "Custom label"
        required: false
        selector:
          text:
    sequence:
      - action: shell_command.pwm_assign_device
        data:
          bay_id: "{{ bay_id }}"
          slot: "{{ slot }}"
          device: "{{ device }}"
          device_type: "{{ device_type | default('door') }}"
          label: "{{ label | default('') }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_update_bay_device:
    alias: "PWM Update Bay Device (from popup)"
    description: "Update device assignment for a bay - called from browser_mod popup"
    fields:
      paddock:
        description: "Paddock ID"
        required: true
        selector:
          text:
      bay:
        description: "Bay name (e.g. B-01)"
        required: true
        selector:
          text:
      new_device:
        description: "HA Device ID from selector"
        required: false
        selector:
          device:
            filter:
              integration: esphome
    sequence:
      - variables:
          # Convert bay name to slug format: "B-01" -> "b_01"
          bay_slug: >-
            {{ bay | slugify }}
          # Construct the full bay_id: paddock_bay_slug (e.g., sw4_e_b_01)
          bay_id: >-
            {{ paddock ~ '_' ~ bay_slug }}
          # Get device name from HA device ID
          device_name: >-
            {% if new_device %}
              {% set name = device_attr(new_device, 'name') | default('') %}
              {% if name %}
                {{ name | slugify }}
              {% else %}
                {{ '' }}
              {% endif %}
            {% else %}
              {{ '' }}
            {% endif %}
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ device_name != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "supply_1"
                  device: "{{ device_name }}"
                  device_type: "door"
              - delay:
                  milliseconds: 500
              - action: homeassistant.update_entity
                target:
                  entity_id: sensor.pwm_data
              - action: browser_mod.close_popup
                data:
                  tag: baydevice
              - action: persistent_notification.create
                data:
                  title: "PWM Device Assignment"
                  message: "Assigned {{ device_name }} to {{ bay }} in {{ paddock }}"
                  notification_id: pwm_device_assigned
        default:
          - action: persistent_notification.create
            data:
              title: "PWM Device Assignment"
              message: "No device selected. Please select an ESPHome device."
              notification_id: pwm_device_error
    mode: single

  pwm_assign_bay_slot:
    alias: "PWM Assign Device to Bay Slot"
    description: "Assign a device to a specific slot (supply_1, supply_2, drain_1, drain_2)"
    fields:
      paddock:
        description: "Paddock ID"
        required: true
        selector:
          text:
      bay:
        description: "Bay name (e.g. B-01)"
        required: true
        selector:
          text:
      slot:
        description: "Device slot"
        required: true
        selector:
          select:
            options:
              - supply_1
              - supply_2
              - drain_1
              - drain_2
      new_device:
        description: "HA Device ID from selector"
        required: false
        selector:
          device:
            filter:
              integration: esphome
    sequence:
      - variables:
          bay_slug: "{{ bay | slugify }}"
          bay_id: "{{ paddock ~ '_' ~ bay_slug }}"
          device_name: >-
            {% if new_device %}
              {% set name = device_attr(new_device, 'name') | default('') %}
              {{ name | slugify if name else '' }}
            {% else %}
              {{ '' }}
            {% endif %}
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ device_name != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "{{ slot }}"
                  device: "{{ device_name }}"
                  device_type: "door"
              - delay:
                  milliseconds: 500
              - action: homeassistant.update_entity
                target:
                  entity_id: sensor.pwm_data
              - action: browser_mod.close_popup
                data:
                  tag: slotconfig
              - action: persistent_notification.create
                data:
                  title: "PWM Device Assignment"
                  message: "Assigned {{ device_name }} to {{ slot }} of {{ bay }} in {{ paddock }}"
                  notification_id: pwm_device_assigned
        default:
          - action: persistent_notification.create
            data:
              title: "PWM Device Assignment"
              message: "No device selected. Please select an ESPHome device."
              notification_id: pwm_device_error
    mode: single

  pwm_edit_bay_settings:
    alias: "PWM Edit Bay Settings"
    fields:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
      level_sensor:
        description: "Level sensor device"
        required: false
        selector:
          text:
      water_level_min:
        description: "Min water level (cm)"
        required: false
        selector:
          number:
            min: 0
            max: 50
      water_level_max:
        description: "Max water level (cm)"
        required: false
        selector:
          number:
            min: 0
            max: 50
      water_level_offset:
        description: "Water level offset (cm)"
        required: false
        selector:
          number:
            min: -20
            max: 20
            step: 0.5
      flush_time:
        description: "Flush time (seconds)"
        required: false
        selector:
          number:
            min: 600
            max: 14400
    sequence:
      - action: shell_command.pwm_edit_bay
        data:
          bay_id: "{{ bay_id }}"
          level_sensor: "{{ level_sensor | default('') }}"
          water_level_min: "{{ water_level_min | default('') }}"
          water_level_max: "{{ water_level_max | default('') }}"
          water_level_offset: "{{ water_level_offset | default('') }}"
          flush_time: "{{ flush_time | default('') }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
    mode: single

  pwm_update_paddock_dropdown:
    alias: "PWM Update Paddock Dropdown"
    description: "Update paddock selector options from sensor data"
    sequence:
      - action: input_select.set_options
        target:
          entity_id: input_select.pwm_selected_paddock
        data:
          options: >-
            {% set names = state_attr('sensor.pwm_data', 'paddock_names') or [] %}
            {{ ['Select Paddock'] + names }}
    mode: single

  # ---------------------------------------------------------------------------
  # DOOR CONTROL SCRIPTS - Interface with ESPHome devices
  # ---------------------------------------------------------------------------
  pwm_set_door:
    alias: "PWM Set Door State"
    description: "Set a door/valve to Open or Close via ESPHome input_select"
    fields:
      device:
        description: "ESPHome device name"
        required: true
        selector:
          text:
      state:
        description: "Target state: Open or Close"
        required: true
        selector:
          select:
            options:
              - Open
              - Close
    sequence:
      - action: input_select.select_option
        target:
          entity_id: "input_select.{{ device }}_actuator_state"
        data:
          option: "{{ state }}"
    mode: queued
    max: 20

  pwm_open_supply:
    alias: "PWM Open Supply Door"
    description: "Open the supply door for a bay"
    fields:
      bay_id:
        description: "Bay ID (e.g., sw5_b_01)"
        required: true
        selector:
          text:
    sequence:
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          bay: "{{ bays.get(bay_id, {}) }}"
          device: "{{ bay.get('supply_1', {}).get('device', '') }}"
      - condition: template
        value_template: "{{ device != '' and device is not none }}"
      - action: script.pwm_set_door
        data:
          device: "{{ device }}"
          state: "Open"
    mode: queued
    max: 20

  pwm_close_supply:
    alias: "PWM Close Supply Door"
    description: "Close the supply door for a bay"
    fields:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
    sequence:
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          bay: "{{ bays.get(bay_id, {}) }}"
          device: "{{ bay.get('supply_1', {}).get('device', '') }}"
      - condition: template
        value_template: "{{ device != '' and device is not none }}"
      - action: script.pwm_set_door
        data:
          device: "{{ device }}"
          state: "Close"
    mode: queued
    max: 20

  pwm_open_drain:
    alias: "PWM Open Drain Door"
    description: "Open the drain door for a paddock's last bay"
    fields:
      paddock_id:
        description: "Paddock ID (e.g., sw5)"
        required: true
        selector:
          text:
    sequence:
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          drain_device: >-
            {% for bid, b in bays.items() if b.paddock_id == paddock_id and b.get('is_last_bay') %}
              {{ b.get('drain_1', {}).get('device', '') }}
            {% endfor %}
      - condition: template
        value_template: "{{ drain_device != '' and drain_device is not none }}"
      - action: script.pwm_set_door
        data:
          device: "{{ drain_device | trim }}"
          state: "Open"
    mode: queued
    max: 10

  pwm_close_drain:
    alias: "PWM Close Drain Door"
    description: "Close the drain door for a paddock's last bay"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          drain_device: >-
            {% for bid, b in bays.items() if b.paddock_id == paddock_id and b.get('is_last_bay') %}
              {{ b.get('drain_1', {}).get('device', '') }}
            {% endfor %}
      - condition: template
        value_template: "{{ drain_device != '' and drain_device is not none }}"
      - action: script.pwm_set_door
        data:
          device: "{{ drain_device | trim }}"
          state: "Close"
    mode: queued
    max: 10

  pwm_start_flush:
    alias: "PWM Start Flush for Bay"
    description: "Start flush cycle for a specific bay"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
      bay_num:
        description: "Bay number (01, 02, etc.)"
        required: true
        selector:
          text:
    sequence:
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          bay: "{{ bays.get(bay_id, {}) }}"
          flush_time: "{{ bay.get('settings', {}).get('flush_time_on_water', 3600) }}"
          timer_id: "timer.{{ paddock_id }}_b_{{ bay_num }}_flushtimeonwater"
          flush_flag: "input_boolean.{{ paddock_id }}_b_{{ bay_num }}_flushactive"
      - action: input_boolean.turn_on
        target:
          entity_id: "{{ flush_flag }}"
      - action: timer.start
        target:
          entity_id: "{{ timer_id }}"
        data:
          duration: "{{ flush_time }}"
    mode: queued
    max: 20

  pwm_stop_flush:
    alias: "PWM Stop Flush for Bay"
    description: "Stop flush cycle for a specific bay"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
      bay_num:
        description: "Bay number (01, 02, etc.)"
        required: true
        selector:
          text:
    sequence:
      - variables:
          timer_id: "timer.{{ paddock_id }}_b_{{ bay_num }}_flushtimeonwater"
          flush_flag: "input_boolean.{{ paddock_id }}_b_{{ bay_num }}_flushactive"
      - action: timer.cancel
        target:
          entity_id: "{{ timer_id }}"
      - action: input_boolean.turn_off
        target:
          entity_id: "{{ flush_flag }}"
    mode: queued
    max: 20

  # ---------------------------------------------------------------------------
  # DEVICE ASSIGNMENT WIZARD SCRIPTS
  # ---------------------------------------------------------------------------
  pwm_wizard_open_paddock:
    alias: "PWM Wizard Open Paddock Config"
    description: "Open device assignment wizard for a paddock"
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_wizard_paddock_id
        data:
          value: "{{ paddock_id }}"
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.pwm_wizard_active
      - action: browser_mod.popup
        data:
          title: "Configure Paddock Devices"
          size: wide
          content:
            type: vertical-stack
            cards:
              # Paddock header
              - type: markdown
                content: >
                  {% set pid = paddock_id %}
                  {% set paddocks = state_attr('sensor.pwm_data', 'paddocks') or {} %}
                  {% set p = paddocks.get(pid, {}) %}
                  ## {{ p.get('name', pid) }}

                  **Bays:** {{ p.get('bay_count', 0) }} |
                  **Mode:** {{ 'Individual' if p.get('automation_state_individual') else 'Paddock' }} |
                  **Status:** {{ 'Enabled' if p.get('enabled') else 'Disabled' }}

                  ---
                  Select a bay below to configure its devices.
              # Bay list with configure buttons
              - type: custom:auto-entities
                filter:
                  template: |
                    {% set pid = states('input_text.pwm_wizard_paddock_id') %}
                    {% set bays = state_attr('sensor.pwm_data', 'bay_summary') or [] %}
                    {% set device_status = state_attr('sensor.pwm_available_esphome_devices', 'device_status') or {} %}
                    {% for b in bays if b.paddock_id == pid %}
                    {% set supply_status = device_status.get(b.supply_1, 'unknown') if b.supply_1 else 'none' %}
                    {% set has_drain = b.drain_1 if b.is_last_bay else true %}
                    {% set status_icon = 'ðŸŸ¢' if supply_status == 'online' else 'ðŸ”´' if supply_status == 'offline' else 'âšª' %}
                    {{ {
                      'type': 'custom:button-card',
                      'entity': 'input_text.pwm_wizard_paddock_id',
                      'name': b.name ~ (' (DRAIN)' if b.is_last_bay else ''),
                      'icon': 'mdi:gate' if b.has_device else 'mdi:gate-open',
                      'show_state': false,
                      'show_icon': true,
                      'show_name': true,
                      'label': status_icon ~ ' ' ~ (b.supply_1 or 'not set') ~ ('' if has_drain else ' âš ï¸ needs drain'),
                      'show_label': true,
                      'color': 'rgb(46, 125, 50)' if (b.has_device and has_drain) else 'rgb(255, 152, 0)' if b.has_device else 'rgb(117, 117, 117)',
                      'styles': {
                        'card': [{'height': '80px'}, {'border-radius': '8px'}],
                        'name': [{'font-size': '14px'}, {'font-weight': '600'}],
                        'label': [{'font-size': '11px'}, {'color': 'var(--secondary-text-color)'}]
                      },
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'script.pwm_wizard_edit_bay',
                        'service_data': {'bay_id': b.id}
                      }
                    } | tojson }},
                    {% endfor %}
                sort:
                  method: none
                card:
                  type: grid
                  columns: 2
              # Close button
              - type: button
                name: Close
                icon: mdi:close
                tap_action:
                  action: call-service
                  service: browser_mod.close_popup
    mode: single

  pwm_wizard_edit_bay:
    alias: "PWM Wizard Edit Bay"
    description: "Open bay device editor popup"
    fields:
      bay_id:
        description: "Bay ID"
        required: true
        selector:
          text:
    sequence:
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_wizard_bay_id
        data:
          value: "{{ bay_id }}"
      # Load current bay values into input fields
      - variables:
          bays: "{{ state_attr('sensor.pwm_data', 'bays') or {} }}"
          bay: "{{ bays.get(bay_id, {}) }}"
          supply_1: "{{ (bay.get('supply_1') or {}).get('device', '') }}"
          supply_2: "{{ (bay.get('supply_2') or {}).get('device', '') }}"
          drain_1: "{{ (bay.get('drain_1') or {}).get('device', '') }}"
          drain_2: "{{ (bay.get('drain_2') or {}).get('device', '') }}"
          level_sensor: "{{ bay.get('level_sensor', '') }}"
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_device_supply_1
        data:
          value: "{{ supply_1 }}"
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_device_supply_2
        data:
          value: "{{ supply_2 }}"
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_device_drain_1
        data:
          value: "{{ drain_1 }}"
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_device_drain_2
        data:
          value: "{{ drain_2 }}"
      - action: input_text.set_value
        target:
          entity_id: input_text.pwm_device_level_sensor
        data:
          value: "{{ level_sensor }}"
      # Load water level settings
      - action: input_number.set_value
        target:
          entity_id: input_number.pwm_bay_water_level_min
        data:
          value: "{{ bay.get('settings', {}).get('water_level_min', 5) }}"
      - action: input_number.set_value
        target:
          entity_id: input_number.pwm_bay_water_level_max
        data:
          value: "{{ bay.get('settings', {}).get('water_level_max', 15) }}"
      - action: input_number.set_value
        target:
          entity_id: input_number.pwm_bay_water_level_offset
        data:
          value: "{{ bay.get('settings', {}).get('water_level_offset', 0) }}"
      - action: input_number.set_value
        target:
          entity_id: input_number.pwm_bay_flush_time
        data:
          value: "{{ bay.get('settings', {}).get('flush_time_on_water', 3600) }}"
      # Open bay editor popup
      - action: browser_mod.popup
        data:
          title: "Edit Bay Devices"
          size: normal
          content:
            type: vertical-stack
            cards:
              - type: markdown
                content: >
                  {% set bid = bay_id %}
                  {% set bays = state_attr('sensor.pwm_data', 'bays') or {} %}
                  {% set bay = bays.get(bid, {}) %}
                  ## {{ bay.get('name', bid) }}

                  **Paddock:** {{ bay.get('paddock_id', 'Unknown') }} |
                  {% if bay.get('is_last_bay') %}**Last Bay** (needs drain){% else %}**Bay {{ bay.get('order', '?') }}**{% endif %}

                  Enter device names (e.g. `rb_001`) or select from available devices below.
              - type: custom:fold-entity-row
                head:
                  type: section
                  label: "Available Devices"
                open: false
                entities:
                  - type: custom:hui-element
                    card_type: markdown
                    content: >
                      {% set device_status = state_attr('sensor.pwm_available_esphome_devices', 'device_status') or {} %}
                      {% set available = state_attr('sensor.pwm_available_esphome_devices', 'available_devices') or [] %}
                      {% set all_devices = state_attr('sensor.pwm_available_esphome_devices', 'device_list') or [] %}

                      {% if all_devices %}
                      | Device | Status | Assigned |
                      |--------|--------|----------|
                      {% for d in all_devices %}
                      | `{{ d }}` | {{ 'ðŸŸ¢' if device_status.get(d) == 'online' else 'ðŸ”´' }} | {{ 'âœ“' if d not in available else '' }} |
                      {% endfor %}
                      {% else %}
                      No ESPHome devices found. Devices should have restart buttons named like `button.rb_001_restart`.
                      {% endif %}
              - type: entities
                title: "Supply Devices"
                show_header_toggle: false
                entities:
                  - entity: input_text.pwm_device_supply_1
                    name: "Supply 1 (Primary Door)"
                  - entity: input_text.pwm_device_supply_2
                    name: "Supply 2 (Secondary/Spur)"
              - type: entities
                title: "Drain Devices"
                show_header_toggle: false
                entities:
                  - entity: input_text.pwm_device_drain_1
                    name: "Drain 1 (Primary)"
                  - entity: input_text.pwm_device_drain_2
                    name: "Drain 2 (Secondary)"
              - type: horizontal-stack
                cards:
                  - type: entities
                    title: "Level Sensor"
                    show_header_toggle: false
                    entities:
                      - entity: input_text.pwm_device_level_sensor
                        name: "Water Level Sensor"
                  - type: button
                    name: "Copy from Supply 1"
                    icon: mdi:content-copy
                    icon_height: 30px
                    tap_action:
                      action: call-service
                      service: input_text.set_value
                      service_data:
                        entity_id: input_text.pwm_device_level_sensor
                        value: "{{ states('input_text.pwm_device_supply_1') }}"
              - type: entities
                title: "Water Level Settings"
                show_header_toggle: false
                entities:
                  - entity: input_number.pwm_bay_water_level_min
                    name: "Min Level (cm)"
                  - entity: input_number.pwm_bay_water_level_max
                    name: "Max Level (cm)"
                  - entity: input_number.pwm_bay_water_level_offset
                    name: "Offset (cm)"
                  - entity: input_number.pwm_bay_flush_time
                    name: "Flush Time (sec)"
              - type: horizontal-stack
                cards:
                  - type: button
                    name: Cancel
                    icon: mdi:close
                    tap_action:
                      action: call-service
                      service: browser_mod.close_popup
                  - type: button
                    name: Save Bay
                    icon: mdi:content-save
                    tap_action:
                      action: call-service
                      service: script.pwm_wizard_save_bay
    mode: single

  pwm_wizard_save_bay:
    alias: "PWM Wizard Save Bay Devices"
    description: "Save device assignments for the current bay"
    sequence:
      - variables:
          bay_id: "{{ states('input_text.pwm_wizard_bay_id') }}"
          supply_1: "{{ states('input_text.pwm_device_supply_1') }}"
          supply_2: "{{ states('input_text.pwm_device_supply_2') }}"
          drain_1: "{{ states('input_text.pwm_device_drain_1') }}"
          drain_2: "{{ states('input_text.pwm_device_drain_2') }}"
          level_sensor: "{{ states('input_text.pwm_device_level_sensor') }}"
          water_min: "{{ states('input_number.pwm_bay_water_level_min') | int }}"
          water_max: "{{ states('input_number.pwm_bay_water_level_max') | int }}"
          water_offset: "{{ states('input_number.pwm_bay_water_level_offset') | float }}"
          flush_time: "{{ states('input_number.pwm_bay_flush_time') | int }}"
      # Save supply_1 if provided
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ supply_1 != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "supply_1"
                  device: "{{ supply_1 }}"
                  device_type: "door"
      # Save supply_2 if provided
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ supply_2 != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "supply_2"
                  device: "{{ supply_2 }}"
                  device_type: "door"
      # Save drain_1 if provided
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ drain_1 != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "drain_1"
                  device: "{{ drain_1 }}"
                  device_type: "door"
      # Save drain_2 if provided
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ drain_2 != '' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "drain_2"
                  device: "{{ drain_2 }}"
                  device_type: "door"
      # Save bay settings (level sensor and water levels)
      - action: shell_command.pwm_edit_bay
        data:
          bay_id: "{{ bay_id }}"
          level_sensor: "{{ level_sensor }}"
          water_level_min: "{{ water_min }}"
          water_level_max: "{{ water_max }}"
          water_level_offset: "{{ water_offset }}"
          flush_time: "{{ flush_time }}"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: browser_mod.close_popup
      - action: persistent_notification.create
        data:
          title: "PWM Device Assignment"
          message: "Bay {{ bay_id }} devices saved successfully."
          notification_id: pwm_wizard_save
    mode: single

  # ---------------------------------------------------------------------------
  # PADDOCK CONFIG POPUP SCRIPTS
  # These scripts are used by the browser_mod popups in the dashboard
  # ---------------------------------------------------------------------------
  pwm_update_bay_device:
    alias: "PWM Update Bay Device from Popup"
    description: "Update device assignment from paddock config popup"
    fields:
      paddock:
        description: "Paddock ID"
        required: true
        selector:
          text:
      bay:
        description: "Bay name (e.g., B-01)"
        required: true
        selector:
          text:
      new_device:
        description: "New device ID from browser_mod form (HA device registry ID)"
        required: false
        selector:
          device:
    sequence:
      - variables:
          # Convert bay name to bay_id format: paddock_b_01
          bay_slug: "{{ bay | lower | replace(' ', '_') | replace('-', '_') }}"
          bay_id: "{{ paddock }}_{{ bay_slug }}"
          # Get the new device from browser_mod form - passed directly as field
          new_device_id: "{{ new_device | default('') }}"
      # Get device name from device registry
      - variables:
          device_name: >-
            {% if new_device_id and new_device_id != '' %}
              {% set name = device_attr(new_device_id, 'name') %}
              {% if name %}
                {{ name | lower | replace('-', '_') | replace(' ', '_') }}
              {% else %}
                {{ new_device_id }}
              {% endif %}
            {% else %}
              unset
            {% endif %}
      # Assign the device to supply_1 slot (primary supply door)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ device_name != '' and device_name != 'unset' }}"
            sequence:
              - action: shell_command.pwm_assign_device
                data:
                  bay_id: "{{ bay_id }}"
                  slot: "supply_1"
                  device: "{{ device_name }}"
                  device_type: "door"
        default:
          # Clear the device assignment if no device selected
          - action: shell_command.pwm_assign_device
            data:
              bay_id: "{{ bay_id }}"
              slot: "supply_1"
              device: "null"
              device_type: "door"
      - delay:
          milliseconds: 500
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.pwm_data
      - action: browser_mod.close_popup
        data:
          tag: bayconfig
    mode: single
