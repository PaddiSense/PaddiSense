##############################################################################
# IPM - Inventory Product Manager
# PaddiSense Farm Management System
#
# This package provides complete inventory management for:
#   - Chemicals (herbicides, fungicides, etc.)
#   - Fertilisers
#   - Seeds
#   - Lubricants
#
# Features:
#   - Multi-location stock tracking
#   - User-friendly product selection by name (not ID)
#   - Category/subcategory filtering
#   - Stock movement with +/- buttons
#   - Product add/edit functionality
#   - Stock overview reports
##############################################################################

#=============================================================================
# COMMAND LINE SENSOR - Main data source
#=============================================================================
command_line:
  - sensor:
      name: IPM Products
      unique_id: ipm_products
      command: 'python3 /config/PaddiSense/ipm/python/ipm_sensor.py'
      command_timeout: 30
      scan_interval: 300
      value_template: '{{ value_json.total_products | default(0) }}'
      json_attributes:
        - products
        - product_names
        - product_locations
        - categories
        - category_subcategories
        - chemical_groups
        - units
        - locations
        - active_names
        - system_status
        - config_exists
        - database_exists
        - locations_with_stock
        - custom_actives_count
        - all_actives_list
        - active_products_map
        - backup_count
        - last_backup
        - backup_filenames
        - version
        - low_stock_count
        - low_stock_products

  # Report data sensor - reads generated report from JSON file
  - sensor:
      name: IPM Report Data
      unique_id: ipm_report_data
      command: 'cat /config/local_data/ipm/report_data.json 2>/dev/null || echo "{\"summary\":null}"'
      command_timeout: 10
      scan_interval: 86400
      value_template: >
        {% if value_json.summary %}
          {{ value_json.summary.total_transactions | default(0) }} transactions
        {% else %}
          No report
        {% endif %}
      json_attributes:
        - summary
        - by_category
        - by_product
        - transactions
        - generated_at

  # Lock result sensor - reads lock operation result
  - sensor:
      name: IPM Lock Result
      unique_id: ipm_lock_result
      command: 'cat /config/local_data/ipm/lock_result.json 2>/dev/null || echo "No result"'
      command_timeout: 5
      scan_interval: 86400
      value_template: "{{ value }}"

#=============================================================================
# SHELL COMMANDS - Python backend calls
#=============================================================================
shell_command:
  ipm_add_product: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_product
    --name "{{ name }}"
    --category "{{ category }}"
    --subcategory "{{ subcategory }}"
    --unit "{{ unit }}"
    --container_size "{{ container_size }}"
    --min_stock "{{ min_stock }}"
    --application_unit "{{ application_unit }}"
    --location "{{ location }}"
    --initial_stock "{{ initial_stock }}"
    --actives '{{ actives }}'

  ipm_edit_product: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py edit_product
    --id "{{ product_id }}"
    --session "{{ session | default('') }}"
    --name "{{ name }}"
    --category "{{ category }}"
    --subcategory "{{ subcategory }}"
    --unit "{{ unit }}"
    --container_size "{{ container_size }}"
    --min_stock "{{ min_stock }}"
    --application_unit "{{ application_unit }}"
    --actives '{{ actives }}'

  ipm_move_stock: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py move_stock
    --id "{{ product_id }}"
    --location "{{ location }}"
    --delta "{{ delta }}"
    --note "{{ note }}"

  ipm_delete_product: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py delete_product
    --id "{{ product_id }}"

  # ----- Settings Commands -----
  ipm_init: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py init

  ipm_status: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py status

  ipm_add_location: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_location
    --name "{{ name }}"

  ipm_remove_location: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_location
    --name "{{ name }}"

  # ----- Active Constituents Commands -----
  ipm_list_actives: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py list_actives

  ipm_add_active: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_active
    --name "{{ name }}"
    --groups "{{ groups }}"

  ipm_remove_active: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_active
    --name "{{ name }}"

  # ----- Data Management Commands (Phase 3) -----
  ipm_export: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py export

  ipm_import_backup: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py import_backup
    --filename "{{ filename }}"

  ipm_reset: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py reset
    --token "{{ token }}"

  ipm_backup_list: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py backup_list

  # ----- Category Management Commands (Phase 4) -----
  ipm_add_category: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_category
    --name "{{ name }}"

  ipm_remove_category: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_category
    --name "{{ name }}"

  ipm_add_subcategory: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_subcategory
    --category "{{ category }}"
    --name "{{ name }}"

  ipm_remove_subcategory: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_subcategory
    --category "{{ category }}"
    --name "{{ name }}"

  # ----- Chemical Group Management Commands -----
  ipm_add_chemical_group: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_chemical_group
    --name "{{ name }}"

  ipm_remove_chemical_group: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_chemical_group
    --name "{{ name }}"

  # ----- Unit Management Commands -----
  ipm_add_unit: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py add_unit
    --type "{{ unit_type }}"
    --value "{{ value }}"

  ipm_remove_unit: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py remove_unit
    --type "{{ unit_type }}"
    --value "{{ value }}"

  # ----- Lock Management Commands -----
  ipm_lock_acquire: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_acquire
    --type "{{ entity_type }}"
    --id "{{ entity_id }}"
    --session "{{ session }}"

  ipm_lock_release: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_release
    --type "{{ entity_type }}"
    --id "{{ entity_id }}"
    --session "{{ session }}"

  ipm_lock_check: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_check
    --type "{{ entity_type }}"
    --id "{{ entity_id }}"

  ipm_lock_cleanup: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_cleanup

  ipm_lock_list: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_list

  # Lock commands with file output for result checking
  ipm_lock_acquire_movement: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_acquire
    --type "stock_movement"
    --id "{{ product_id }}"
    --session "{{ session }}"
    > /config/local_data/ipm/lock_result.json 2>&1

  ipm_lock_release_movement: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_release
    --type "stock_movement"
    --id "{{ product_id }}"
    --session "{{ session }}"

  ipm_lock_acquire_editor: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_acquire
    --type "product_edit"
    --id "{{ product_id }}"
    --session "{{ session }}"
    > /config/local_data/ipm/lock_result.json 2>&1

  ipm_lock_release_editor: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py lock_release
    --type "product_edit"
    --id "{{ product_id }}"
    --session "{{ session }}"

  # ----- Report Commands -----
  ipm_usage_report: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py usage_report
    {% if start is defined and start %}--start "{{ start }}"{% endif %}
    {% if end is defined and end %}--end "{{ end }}"{% endif %}

  ipm_transaction_history: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py transaction_history
    {% if start is defined and start %}--start "{{ start }}"{% endif %}
    {% if end is defined and end %}--end "{{ end }}"{% endif %}
    {% if product is defined and product %}--product "{{ product }}"{% endif %}
    {% if action is defined and action %}--action "{{ action }}"{% endif %}
    {% if limit is defined and limit %}--limit "{{ limit }}"{% endif %}

  # Generate report data to JSON file for dashboard
  ipm_generate_report_file: >-
    python3 /config/PaddiSense/ipm/python/ipm_backend.py generate_report_file
    --output "/config/local_data/ipm/report_data.json"
    {% if start is defined and start %}--start "{{ start }}"{% endif %}
    {% if end is defined and end %}--end "{{ end }}"{% endif %}
    {% if action is defined and action %}--action "{{ action }}"{% endif %}

#=============================================================================
# INPUT HELPERS - User interface controls
#=============================================================================
input_select:
  # ----- Movement View Filters -----
  ipm_category:
    name: IPM Category Filter
    icon: mdi:shape
    options:
      - All
      - Chemical
      - Fertiliser
      - Seed
      - Lubricant
      - Hay

  ipm_subcategory:
    name: IPM Subcategory Filter
    icon: mdi:shape-outline
    options:
      - All

  ipm_active_filter:
    name: IPM Active Filter
    icon: mdi:flask-outline
    options:
      - All

  # Product selection by NAME (user-friendly)
  ipm_product:
    name: IPM Product
    icon: mdi:package-variant
    options:
      - Select Product

  # Location selection (for stock movement - uses same fixed list as editor)
  ipm_location:
    name: IPM Location
    icon: mdi:map-marker
    options:
      - Select Location
      - Chem Shed
      - Seed Shed
      - Oil Shed
      - Silo 1
      - Silo 2
      - Silo 3
      - Silo 4
      - Silo 5
      - Silo 6
      - Silo 7
      - Silo 8
      - Silo 9
      - Silo 10
      - Silo 11
      - Silo 12
      - Silo 13
      - Paddock 1
      - Paddock 2

  # ----- Product Editor -----
  ipm_editor_mode:
    name: IPM Editor Mode
    icon: mdi:pencil
    options:
      - Add New Product
      - Edit Existing Product

  ipm_edit_category:
    name: IPM Edit Category
    icon: mdi:shape
    options:
      - Chemical
      - Fertiliser
      - Seed
      - Lubricant
      - Hay

  ipm_edit_subcategory:
    name: IPM Edit Subcategory
    icon: mdi:shape-outline
    options:
      - Select Subcategory

  ipm_edit_unit:
    name: IPM Edit Unit
    icon: mdi:scale
    options:
      - None
      - L
      - kg
      - ea

  ipm_edit_container:
    name: IPM Edit Container Size
    icon: mdi:cube-outline
    options:
      - "1"
      - "5"
      - "10"
      - "20"
      - "110"
      - "200"
      - "1000"
      - "400"
      - bulk

  ipm_edit_location:
    name: IPM Edit Storage Location
    icon: mdi:warehouse
    options:
      - Chem Shed
      - Seed Shed
      - Oil Shed
      - Silo 1
      - Silo 2
      - Silo 3
      - Silo 4
      - Silo 5
      - Silo 6
      - Silo 7
      - Silo 8
      - Silo 9
      - Silo 10
      - Silo 11
      - Silo 12
      - Silo 13
      - Paddock 1
      - Paddock 2

  ipm_edit_app_unit:
    name: IPM Edit Application Unit
    icon: mdi:ruler
    options:
      - L/ha
      - mL/ha
      - kg/ha
      - g/ha
      - t/ha
      - mL/100L
      - g/100L

  # Active constituent units
  ipm_active_1_unit:
    name: IPM Active 1 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  ipm_active_2_unit:
    name: IPM Active 2 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  ipm_active_3_unit:
    name: IPM Active 3 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  ipm_active_4_unit:
    name: IPM Active 4 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  ipm_active_5_unit:
    name: IPM Active 5 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  ipm_active_6_unit:
    name: IPM Active 6 Unit
    icon: mdi:scale
    options:
      - g/L
      - g/kg
      - ml/L
      - "%"

  # Chemical group per active constituent
  ipm_active_1_group:
    name: IPM Active 1 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"
      

  ipm_active_2_group:
    name: IPM Active 2 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"
      

  ipm_active_3_group:
    name: IPM Active 3 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"
      

  ipm_active_4_group:
    name: IPM Active 4 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"

  ipm_active_5_group:
    name: IPM Active 5 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"

  ipm_active_6_group:
    name: IPM Active 6 Group
    icon: mdi:flask
    options:
      - None
      - "N/A"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "22"
      - "M"

  # Active constituent names (dropdown selection)
  ipm_active_1_name:
    name: IPM Active 1 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  ipm_active_2_name:
    name: IPM Active 2 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  ipm_active_3_name:
    name: IPM Active 3 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  ipm_active_4_name:
    name: IPM Active 4 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  ipm_active_5_name:
    name: IPM Active 5 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  ipm_active_6_name:
    name: IPM Active 6 Name
    icon: mdi:flask
    options:
      - Select Active
      # Herbicides
      - 2,4-D
      - Atrazine
      - Bromoxynil
      - Carfentrazone-ethyl
      - Clethodim
      - Clodinafop-propargyl
      - Clopyralid
      - Dicamba
      - Diflufenican
      - Diquat
      - Fenoxaprop-P-ethyl
      - Florasulam
      - Fluazifop-P-butyl
      - Flumetsulam
      - Fluroxypyr
      - Glufosinate-ammonium
      - Glyphosate
      - Haloxyfop
      - Imazamox
      - Imazapic
      - Imazapyr
      - Imazethapyr
      - MCPA
      - Mesotrione
      - Metolachlor
      - Metsulfuron-methyl
      - Paraquat
      - Pendimethalin
      - Picloram
      - Pinoxaden
      - Propaquizafop
      - Prosulfocarb
      - Pyroxasulfone
      - Pyroxsulam
      - Quizalofop-P-ethyl
      - Sethoxydim
      - Simazine
      - Sulfometuron-methyl
      - Sulfosulfuron
      - Terbuthylazine
      - Triallate
      - Tribenuron-methyl
      - Triclopyr
      - Trifluralin
      - Trifloxysulfuron
      # Fungicides
      - Azoxystrobin
      - Bixafen
      - Boscalid
      - Carbendazim
      - Chlorothalonil
      - Cyproconazole
      - Difenoconazole
      - Epoxiconazole
      - Fludioxonil
      - Fluopyram
      - Flutriafol
      - Fluxapyroxad
      - Iprodione
      - Isopyrazam
      - Mancozeb
      - Metalaxyl
      - Propiconazole
      - Prothioconazole
      - Pyraclostrobin
      - Tebuconazole
      - Thiram
      - Triadimefon
      - Triadimenol
      - Trifloxystrobin
      # Insecticides
      - Abamectin
      - Acetamiprid
      - Alpha-cypermethrin
      - Bifenthrin
      - Chlorantraniliprole
      - Chlorpyrifos
      - Clothianidin
      - Cyantraniliprole
      - Cypermethrin
      - Deltamethrin
      - Dimethoate
      - Emamectin benzoate
      - Esfenvalerate
      - Fipronil
      - Imidacloprid
      - Indoxacarb
      - Lambda-cyhalothrin
      - Malathion
      - Methomyl
      - Omethoate
      - Pirimicarb
      - Spinetoram
      - Spinosad
      - Sulfoxaflor
      - Thiacloprid
      - Thiamethoxam
      # Seed Treatments
      - Fludioxonil
      - Ipconazole
      - Metalaxyl-M
      - Sedaxane
      - Thiamethoxam
      - Triticonazole
      # Fertiliser Elements
      - Boron
      - Calcium
      - Copper
      - Iron
      - Magnesium
      - Manganese
      - Molybdenum
      - Nitrogen
      - Phosphorus
      - Potassium
      - Sulfur
      - Zinc
      # Adjuvants
      - Alcohol ethoxylate
      - Ammonium sulfate
      - Methylated seed oil
      - Organosilicone
      - Paraffin oil
      - Petroleum oil

  # ----- Settings View -----
  ipm_manage_location:
    name: IPM Manage Location
    icon: mdi:map-marker-remove
    options:
      - Select Location

  ipm_manage_active:
    name: IPM Manage Active
    icon: mdi:flask-remove
    options:
      - Select Active

  # ----- Data Management (Phase 3) -----
  ipm_import_backup:
    name: IPM Import Backup
    icon: mdi:backup-restore
    options:
      - Select Backup

  # ----- Category Management (Phase 4) -----
  ipm_manage_category:
    name: IPM Manage Category
    icon: mdi:shape-outline
    options:
      - Select Category

  ipm_manage_subcategory_parent:
    name: IPM Subcategory Parent
    icon: mdi:shape
    options:
      - Select Category

  ipm_manage_subcategory:
    name: IPM Manage Subcategory
    icon: mdi:shape-outline
    options:
      - Select Subcategory

  ipm_manage_chemical_group:
    name: IPM Manage Chemical Group
    icon: mdi:flask-remove
    options:
      - Select Group

  ipm_manage_unit_type:
    name: IPM Unit Type
    icon: mdi:ruler
    options:
      - product
      - container
      - application
      - concentration

  ipm_manage_unit_value:
    name: IPM Manage Unit Value
    icon: mdi:ruler-square
    options:
      - Select Unit

  # ----- Report Filters -----
  ipm_report_season:
    name: IPM Report Season
    icon: mdi:calendar-range
    options:
      - Custom Date Range
      - CY26

  ipm_report_action:
    name: IPM Report Action Filter
    icon: mdi:filter-variant
    options:
      - All
      - stock_in
      - stock_out
      - initial_stock
      - edit_product
      - delete_product

input_number:
  # Stock movement quantity
  ipm_quantity:
    name: IPM Quantity Change
    icon: mdi:plus-minus
    min: -99999
    max: 99999
    step: 1
    mode: box

  # Product editor fields
  ipm_edit_min_stock:
    name: IPM Edit Min Stock
    icon: mdi:alert-outline
    min: 0
    max: 99999
    step: 1
    mode: box

  ipm_edit_initial_stock:
    name: IPM Edit Initial Stock
    icon: mdi:package-variant-plus
    min: 0
    max: 99999
    step: 1
    mode: box

  # Active constituent concentrations (number only)
  ipm_active_1_conc:
    name: IPM Active 1 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

  ipm_active_2_conc:
    name: IPM Active 2 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

  ipm_active_3_conc:
    name: IPM Active 3 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

  ipm_active_4_conc:
    name: IPM Active 4 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

  ipm_active_5_conc:
    name: IPM Active 5 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

  ipm_active_6_conc:
    name: IPM Active 6 Concentration
    icon: mdi:percent
    min: 0
    max: 9999
    step: 0.1
    mode: box

input_text:
  # Session ID for multi-user locking (auto-generated)
  ipm_session_id:
    name: IPM Session ID
    icon: mdi:identifier
    max: 50
    mode: text

  # Lock holder info (who has the lock if not us)
  ipm_locked_by:
    name: IPM Locked By
    icon: mdi:account-lock
    max: 100
    mode: text

  # Currently locked product ID (for tracking)
  ipm_movement_locked_product:
    name: IPM Movement Locked Product
    icon: mdi:package-variant-closed
    max: 50
    mode: text

  ipm_editor_locked_product:
    name: IPM Editor Locked Product
    icon: mdi:package-variant-closed
    max: 50
    mode: text

  # Search filter
  ipm_search:
    name: IPM Search
    icon: mdi:magnify
    max: 50

  # Product editor name field
  ipm_edit_name:
    name: IPM Edit Product Name
    icon: mdi:rename
    max: 80

  # Settings - new location name
  ipm_new_location:
    name: IPM New Location
    icon: mdi:map-marker-plus
    max: 50

  # Settings - new active constituent name
  ipm_new_active:
    name: IPM New Active
    icon: mdi:flask-plus
    max: 80

  # Settings - new active constituent groups (comma-separated)
  ipm_new_active_groups:
    name: IPM New Active Groups
    icon: mdi:flask-outline
    max: 50

  # ----- Category Management (Phase 4) -----
  ipm_new_category:
    name: IPM New Category
    icon: mdi:shape-plus
    max: 50

  ipm_new_subcategory:
    name: IPM New Subcategory
    icon: mdi:shape-plus-outline
    max: 50

  ipm_new_chemical_group:
    name: IPM New Chemical Group
    icon: mdi:flask-plus
    max: 20

  ipm_new_unit_value:
    name: IPM New Unit Value
    icon: mdi:ruler-square
    max: 20

#=============================================================================
# INPUT DATETIME - Date pickers for reports
#=============================================================================
input_datetime:
  # Report date range
  ipm_report_start:
    name: IPM Report Start Date
    has_date: true
    has_time: false
    icon: mdi:calendar-start

  ipm_report_end:
    name: IPM Report End Date
    has_date: true
    has_time: false
    icon: mdi:calendar-end

input_boolean:
  # ----- Data Management (Phase 3) -----
  ipm_confirm_reset:
    name: IPM Confirm Reset
    icon: mdi:alert-octagon

  # Toggle to show additional active constituent fields
  ipm_show_active_2:
    name: IPM Show Active 2
    icon: mdi:plus-circle-outline

  ipm_show_active_3:
    name: IPM Show Active 3
    icon: mdi:plus-circle-outline

  ipm_show_active_4:
    name: IPM Show Active 4
    icon: mdi:plus-circle-outline

  ipm_show_active_5:
    name: IPM Show Active 5
    icon: mdi:plus-circle-outline

  ipm_show_active_6:
    name: IPM Show Active 6
    icon: mdi:plus-circle-outline

  # Toggle to show/hide form after save
  ipm_show_form:
    name: IPM Show Form
    icon: mdi:form-select
    initial: true

  # Flag to prevent automation reset during product load
  ipm_loading_product:
    name: IPM Loading Product
    icon: mdi:loading
    initial: false

  # Multi-user locking flags
  ipm_product_locked:
    name: IPM Product Locked
    icon: mdi:lock
    initial: false

  ipm_has_movement_lock:
    name: IPM Has Movement Lock
    icon: mdi:lock-check
    initial: false

  ipm_has_editor_lock:
    name: IPM Has Editor Lock
    icon: mdi:lock-check
    initial: false

#=============================================================================
# TEMPLATE SENSORS - Computed values for UI
#=============================================================================
template:
  - sensor:
      #-----------------------------------------------------------------------
      # Filtered product list based on category, subcategory, and search
      #-----------------------------------------------------------------------
      - name: IPM Filtered Products
        unique_id: ipm_filtered_products
        state: >
          {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
          {% set category = states('input_select.ipm_category') %}
          {% set subcategory = states('input_select.ipm_subcategory') %}
          {% set search = states('input_text.ipm_search') | lower | trim %}

          {% set ns = namespace(count=0) %}
          {% for pid, p in products.items() %}
            {% set cat_match = (category == 'All' or p.category == category) %}
            {% set sub_match = (subcategory == 'All' or p.subcategory == subcategory) %}
            {% set search_match = (search == '' or search in (p.name | lower) or search in (pid | lower)) %}
            {% if cat_match and sub_match and search_match %}
              {% set ns.count = ns.count + 1 %}
            {% endif %}
          {% endfor %}
          {{ ns.count }}
        attributes:
          product_names: >
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set category = states('input_select.ipm_category') %}
            {% set subcategory = states('input_select.ipm_subcategory') %}
            {% set search = states('input_text.ipm_search') | lower | trim %}

            {% set ns = namespace(names=[]) %}
            {% for pid, p in products.items() %}
              {% set cat_match = (category == 'All' or p.category == category) %}
              {% set sub_match = (subcategory == 'All' or p.subcategory == subcategory) %}
              {% set search_match = (search == '' or search in (p.name | lower) or search in (pid | lower)) %}
              {% if cat_match and sub_match and search_match %}
                {% set ns.names = ns.names + [p.name] %}
              {% endif %}
            {% endfor %}
            {{ ns.names | sort }}

      #-----------------------------------------------------------------------
      # Count of products below minimum stock (using pre-calculated data)
      #-----------------------------------------------------------------------
      - name: IPM Low Stock Count
        unique_id: ipm_low_stock_count
        icon: mdi:alert
        state: "{{ state_attr('sensor.ipm_products', 'low_stock_count') | default(0) }}"
        unit_of_measurement: "products"
        attributes:
          low_stock_products: "{{ state_attr('sensor.ipm_products', 'low_stock_products') | default([]) }}"

      #-----------------------------------------------------------------------
      # Low stock product list formatted for display
      #-----------------------------------------------------------------------
      - name: IPM Low Stock List
        unique_id: ipm_low_stock_list
        icon: mdi:alert-circle
        state: >
          {% set count = state_attr('sensor.ipm_products', 'low_stock_count') | default(0) %}
          {% if count == 0 %}
            All stock OK
          {% elif count == 1 %}
            1 product low
          {% else %}
            {{ count }} products low
          {% endif %}
        attributes:
          products: "{{ state_attr('sensor.ipm_products', 'low_stock_products') | default([]) }}"
          summary: >
            {% set items = state_attr('sensor.ipm_products', 'low_stock_products') | default([]) %}
            {% set ns = namespace(lines=[]) %}
            {% for item in items[:5] %}
              {% set ns.lines = ns.lines + [item.name ~ ': ' ~ item.total_stock ~ '/' ~ item.min_stock ~ ' ' ~ item.unit] %}
            {% endfor %}
            {% if items | length > 5 %}
              {% set ns.lines = ns.lines + ['... and ' ~ (items | length - 5) ~ ' more'] %}
            {% endif %}
            {{ ns.lines | join('\n') if ns.lines else 'All stock OK' }}

      #-----------------------------------------------------------------------
      # Subcategory options based on selected category
      #-----------------------------------------------------------------------
      - name: IPM Subcategory Options
        unique_id: ipm_subcategory_options
        state: "ok"
        attributes:
          options: >
            {% set category = states('input_select.ipm_category') %}
            {% set mapping = state_attr('sensor.ipm_products', 'category_subcategories') or {} %}
            {% if category == 'All' %}
              {{ ['All'] }}
            {% elif category in mapping %}
              {{ ['All'] + mapping[category] }}
            {% else %}
              {{ ['All'] }}
            {% endif %}

      #-----------------------------------------------------------------------
      # Selected product details (lookup by name)
      #-----------------------------------------------------------------------
      - name: IPM Selected Product
        unique_id: ipm_selected_product
        state: >
          {% set selected_name = states('input_select.ipm_product') %}
          {% if selected_name in ['Select Product', 'unknown', 'unavailable', ''] %}
            none
          {% else %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% for pid, p in products.items() %}
              {% if p.name == selected_name %}
                {{ pid }}
              {% endif %}
            {% endfor %}
          {% endif %}
        attributes:
          id: >
            {% set selected_name = states('input_select.ipm_product') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% for pid, p in products.items() %}
              {% if p.name == selected_name %}
                {{ pid }}
              {% endif %}
            {% endfor %}
          name: >
            {{ states('input_select.ipm_product') }}
          product: >
            {% set selected_name = states('input_select.ipm_product') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% for pid, p in products.items() %}
              {% if p.name == selected_name %}
                {{ p | tojson }}
              {% endif %}
            {% endfor %}

      #-----------------------------------------------------------------------
      # Locations for selected product (for multi-location dropdown)
      #-----------------------------------------------------------------------
      - name: IPM Product Locations
        unique_id: ipm_product_locations
        state: >
          {% set product_id = states('sensor.ipm_selected_product') %}
          {% set locations = state_attr('sensor.ipm_products', 'product_locations') or {} %}
          {% if product_id in locations %}
            {{ locations[product_id] | length }}
          {% else %}
            0
          {% endif %}
        attributes:
          locations: >
            {% set product_id = states('sensor.ipm_selected_product') %}
            {% set locations = state_attr('sensor.ipm_products', 'product_locations') or {} %}
            {% if product_id in locations %}
              {{ locations[product_id] }}
            {% else %}
              []
            {% endif %}
          needs_location_select: >
            {% set product_id = states('sensor.ipm_selected_product') %}
            {% set locations = state_attr('sensor.ipm_products', 'product_locations') or {} %}
            {{ product_id in locations and locations[product_id] | length > 1 }}

      #-----------------------------------------------------------------------
      # Current stock at selected product + location
      #-----------------------------------------------------------------------
      - name: IPM Current Stock
        unique_id: ipm_current_stock
        unit_of_measurement: ""
        state: >
          {% set product_id = states('sensor.ipm_selected_product') %}
          {% set location = states('input_select.ipm_location') %}
          {% set products = state_attr('sensor.ipm_products', 'products') or {} %}

          {% if product_id in ['none', 'unknown', 'unavailable', ''] %}
            0
          {% elif product_id in products %}
            {% set p = products[product_id] %}
            {% set sbl = p.stock_by_location if p.stock_by_location is defined else {} %}
            {% if location in ['Select Location', 'unknown', 'unavailable', ''] %}
              {# If no location selected but product only has one location, use that #}
              {% if sbl | length == 1 %}
                {{ (sbl.values() | list)[0] | float(0) }}
              {% else %}
                {{ p.total_stock | default(0) }}
              {% endif %}
            {% else %}
              {{ sbl.get(location, 0) | float(0) }}
            {% endif %}
          {% else %}
            0
          {% endif %}
        attributes:
          unit: >
            {% set product_id = states('sensor.ipm_selected_product') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% if product_id in products %}
              {{ products[product_id].unit | default('') }}
            {% else %}

            {% endif %}
          location: >
            {{ states('input_select.ipm_location') }}

      #-----------------------------------------------------------------------
      # New stock after applying quantity change
      #-----------------------------------------------------------------------
      - name: IPM New Stock
        unique_id: ipm_new_stock
        state: >
          {% set current = states('sensor.ipm_current_stock') | float(0) %}
          {% set delta = states('input_number.ipm_quantity') | float(0) %}
          {{ [0, current + delta] | max | round(2) }}
        attributes:
          unit: >
            {{ state_attr('sensor.ipm_current_stock', 'unit') }}

      #-----------------------------------------------------------------------
      # Edit subcategory options based on selected edit category
      #-----------------------------------------------------------------------
      - name: IPM Edit Subcategory Options
        unique_id: ipm_edit_subcategory_options
        state: "ok"
        attributes:
          options: >
            {% set category = states('input_select.ipm_edit_category') %}
            {% set mapping = state_attr('sensor.ipm_products', 'category_subcategories') or {} %}
            {% if category in mapping %}
              {{ mapping[category] }}
            {% else %}
              []
            {% endif %}

  #---------------------------------------------------------------------------
  # Binary Sensors for alerts
  #---------------------------------------------------------------------------
  - binary_sensor:
      #-----------------------------------------------------------------------
      # Low stock alert - true when any product is below minimum
      #-----------------------------------------------------------------------
      - name: IPM Low Stock Alert
        unique_id: ipm_low_stock_alert
        device_class: problem
        state: >
          {{ (state_attr('sensor.ipm_products', 'low_stock_count') | default(0) | int) > 0 }}
        icon: >
          {% if (state_attr('sensor.ipm_products', 'low_stock_count') | default(0) | int) > 0 %}
            mdi:alert-circle
          {% else %}
            mdi:check-circle
          {% endif %}
        attributes:
          count: "{{ state_attr('sensor.ipm_products', 'low_stock_count') | default(0) }}"
          products: "{{ state_attr('sensor.ipm_products', 'low_stock_products') | default([]) }}"

#=============================================================================
# AUTOMATIONS - Keep dropdowns in sync
#=============================================================================
automation:
  #---------------------------------------------------------------------------
  # Generate session ID on HA start (for multi-user locking)
  #---------------------------------------------------------------------------
  - id: ipm_generate_session_id
    alias: "IPM: Generate Session ID"
    mode: single
    trigger:
      - platform: homeassistant
        event: start
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_session_id
        data:
          value: "ha_{{ now().strftime('%Y%m%d%H%M%S') }}_{{ range(1000, 9999) | random }}"
      # Cleanup any expired locks
      - service: shell_command.ipm_lock_cleanup

  #---------------------------------------------------------------------------
  # Acquire movement lock when product is selected
  #---------------------------------------------------------------------------
  - id: ipm_acquire_movement_lock_on_select
    alias: "IPM: Acquire Movement Lock on Product Select"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.ipm_product
    condition:
      - condition: template
        value_template: >
          {{ states('input_select.ipm_product') not in ['Select Product', 'unknown', 'unavailable', ''] }}
    action:
      - variables:
          product_id: "{{ states('sensor.ipm_selected_product') }}"
          session: "{{ states('input_text.ipm_session_id') }}"
          old_product: "{{ states('input_text.ipm_movement_locked_product') }}"

      # Wait for sensor to update
      - delay: "00:00:00.5"

      - variables:
          product_id: "{{ states('sensor.ipm_selected_product') }}"

      # Release lock on previous product if we had one
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ old_product not in ['', 'unknown', 'unavailable'] and old_product != product_id }}"
            sequence:
              - service: shell_command.ipm_lock_release_movement
                data:
                  product_id: "{{ old_product }}"
                  session: "{{ session }}"

      # Skip if no valid product
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ product_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ipm_has_movement_lock
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_movement_locked_product
                data:
                  value: ""
              - stop: "No product"

      # Try to acquire lock
      - service: shell_command.ipm_lock_acquire_movement
        data:
          product_id: "{{ product_id }}"
          session: "{{ session }}"

      - delay: "00:00:00.5"

      # Check if lock was acquired (read result file)
      - variables:
          lock_result: >
            {% set result = states('sensor.ipm_lock_result') | default('') %}
            {{ 'Lock acquired' in result or result == '' }}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ lock_result }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_has_movement_lock
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ipm_product_locked
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_movement_locked_product
                data:
                  value: "{{ product_id }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_locked_by
                data:
                  value: ""
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.ipm_has_movement_lock
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.ipm_product_locked
          - service: persistent_notification.create
            data:
              title: "IPM - Product Locked"
              message: "This product is currently being edited by another user. Your changes may conflict."

  #---------------------------------------------------------------------------
  # Release movement lock when product is deselected
  #---------------------------------------------------------------------------
  - id: ipm_release_movement_lock_on_deselect
    alias: "IPM: Release Movement Lock on Deselect"
    mode: single
    trigger:
      - platform: state
        entity_id: input_select.ipm_product
        to: "Select Product"
    action:
      - variables:
          old_product: "{{ states('input_text.ipm_movement_locked_product') }}"
          session: "{{ states('input_text.ipm_session_id') }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ old_product not in ['', 'unknown', 'unavailable'] }}"
            sequence:
              - service: shell_command.ipm_lock_release_movement
                data:
                  product_id: "{{ old_product }}"
                  session: "{{ session }}"

      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.ipm_has_movement_lock
            - input_boolean.ipm_product_locked
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_movement_locked_product
        data:
          value: ""

  #---------------------------------------------------------------------------
  # Update product dropdown when filters change
  #---------------------------------------------------------------------------
  - id: ipm_update_product_options
    alias: "IPM: Update Product Options"
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - input_select.ipm_category
          - input_select.ipm_subcategory
          - input_text.ipm_search
          - sensor.ipm_filtered_products
      - platform: homeassistant
        event: start
    action:
      - delay: "00:00:01"
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_product
        data:
          options: >
            {% set names = state_attr('sensor.ipm_filtered_products', 'product_names') or [] %}
            {{ ['Select Product'] + names }}
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_product
        data:
          option: "Select Product"

  #---------------------------------------------------------------------------
  # Update subcategory dropdown when category changes
  #---------------------------------------------------------------------------
  - id: ipm_update_subcategory_options
    alias: "IPM: Update Subcategory Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.ipm_category
      - platform: homeassistant
        event: start
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_subcategory
        data:
          options: >
            {% set category = states('input_select.ipm_category') %}
            {% set mapping = state_attr('sensor.ipm_products', 'category_subcategories') or {} %}
            {% if category == 'All' %}
              {{ ['All'] }}
            {% elif category in mapping %}
              {{ ['All'] + mapping[category] }}
            {% else %}
              {{ ['All'] }}
            {% endif %}
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_subcategory
        data:
          option: "All"

  #---------------------------------------------------------------------------
  # Update active filter dropdown when sensor updates
  #---------------------------------------------------------------------------
  - id: ipm_update_active_filter_options
    alias: "IPM: Update Active Filter Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.ipm_products
      - platform: homeassistant
        event: start
    action:
      - delay: "00:00:01"
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_active_filter
        data:
          options: >
            {% set active_names = state_attr('sensor.ipm_products', 'active_names') or [] %}
            {{ ['All'] + active_names }}
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_filter
        data:
          option: "All"

  #---------------------------------------------------------------------------
  # Update location dropdown when product changes (filter to product's locations)
  #---------------------------------------------------------------------------
  - id: ipm_update_location_options
    alias: "IPM: Update Location on Product Change"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.ipm_product
    action:
      - delay: "00:00:00.5"
      - variables:
          selected_product: "{{ states('input_select.ipm_product') }}"
          locations: "{{ state_attr('sensor.ipm_product_locations', 'locations') or [] }}"
      - choose:
          # If no product selected, show all locations
          - conditions:
              - condition: template
                value_template: "{{ selected_product in ['Select Product', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: input_select.set_options
                target:
                  entity_id: input_select.ipm_location
                data:
                  options:
                    - Select Location
                    - Chem Shed
                    - Seed Shed
                    - Oil Shed
                    - Silo 1
                    - Silo 2
                    - Silo 3
                    - Silo 4
                    - Silo 5
                    - Silo 6
                    - Silo 7
                    - Silo 8
                    - Silo 9
                    - Silo 10
                    - Silo 11
                    - Silo 12
                    - Silo 13
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_location
                data:
                  option: "Select Location"
          # If product has only one location, set options and auto-select it
          - conditions:
              - condition: template
                value_template: "{{ locations | length == 1 }}"
            sequence:
              - service: input_select.set_options
                target:
                  entity_id: input_select.ipm_location
                data:
                  options: "{{ locations }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_location
                data:
                  option: "{{ locations[0] }}"
          # If product has multiple locations, show only those locations
          - conditions:
              - condition: template
                value_template: "{{ locations | length > 1 }}"
            sequence:
              - service: input_select.set_options
                target:
                  entity_id: input_select.ipm_location
                data:
                  options: "{{ ['Select Location'] + locations }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_location
                data:
                  option: "Select Location"
        default:
          # Product has no locations (shouldn't happen normally)
          - service: input_select.set_options
            target:
              entity_id: input_select.ipm_location
            data:
              options:
                - Select Location
          - service: input_select.select_option
            target:
              entity_id: input_select.ipm_location
            data:
              option: "Select Location"

  #---------------------------------------------------------------------------
  # Update edit subcategory when edit category changes
  #---------------------------------------------------------------------------
  - id: ipm_update_edit_subcategory
    alias: "IPM: Update Edit Subcategory Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.ipm_edit_category
    condition:
      # Don't run during product load (script handles subcategory)
      - condition: state
        entity_id: input_boolean.ipm_loading_product
        state: "off"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_subcategory
        data:
          options: >
            {% set category = states('input_select.ipm_edit_category') %}
            {% set mapping = state_attr('sensor.ipm_products', 'category_subcategories') or {} %}
            {% if category in mapping %}
              {{ ['Select Subcategory'] + mapping[category] }}
            {% else %}
              {{ ['Select Subcategory'] }}
            {% endif %}
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_subcategory
        data:
          option: "Select Subcategory"

  #---------------------------------------------------------------------------
  # Reset quantity to 0 when product changes
  #---------------------------------------------------------------------------
  - id: ipm_reset_quantity_on_product_change
    alias: "IPM: Reset Quantity on Product Change"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.ipm_product
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_quantity
        data:
          value: 0

  #---------------------------------------------------------------------------
  # Sync report season dropdown with registry seasons
  #---------------------------------------------------------------------------
  - id: ipm_sync_report_seasons
    alias: "IPM: Sync Report Season Options"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'season_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_report_season
        data:
          options: >
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Custom Date Range'] + seasons }}

  #---------------------------------------------------------------------------
  # Sync config-based dropdowns (locations, units, chemical groups)
  #---------------------------------------------------------------------------
  - id: ipm_sync_config_dropdowns
    alias: "IPM: Sync Config Dropdowns"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.ipm_products
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.ipm_products', 'locations') is not none }}"
    action:
      - delay: "00:00:02"

      # Sync locations to ipm_location (movement view)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_location
        data:
          options: >
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      # Sync locations to ipm_edit_location (editor view)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_location
        data:
          options: >
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ locs if locs | length > 0 else ['Chem Shed'] }}

      # Sync product units
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_unit
        data:
          options: >
            {% set units = state_attr('sensor.ipm_products', 'units') or {} %}
            {% set product_units = units.get('product', ['L', 'kg', 'ea']) if units is mapping else ['L', 'kg', 'ea'] %}
            {{ product_units if product_units | length > 0 else ['L', 'kg', 'ea'] }}

      # Sync container sizes
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_container
        data:
          options: >
            {% set units = state_attr('sensor.ipm_products', 'units') or {} %}
            {% set containers = units.get('container', ['1', '5', '10', '20', '110', '200', '1000', 'bulk']) if units is mapping else ['1', '5', '10', '20', '110', '200', '1000', 'bulk'] %}
            {{ containers if containers | length > 0 else ['1', '5', '10', '20', '110', '200', '1000', 'bulk'] }}

      # Sync application units
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_app_unit
        data:
          options: >
            {% set units = state_attr('sensor.ipm_products', 'units') or {} %}
            {% set app_units = units.get('application', ['L/ha', 'mL/ha', 'kg/ha', 'g/ha', 't/ha', 'mL/100L', 'g/100L']) if units is mapping else ['L/ha', 'mL/ha', 'kg/ha', 'g/ha', 't/ha', 'mL/100L', 'g/100L'] %}
            {{ app_units if app_units | length > 0 else ['L/ha', 'mL/ha', 'kg/ha', 'g/ha', 't/ha', 'mL/100L', 'g/100L'] }}

      # Sync concentration units for all 6 active dropdowns
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.ipm_active_1_unit
            - input_select.ipm_active_2_unit
            - input_select.ipm_active_3_unit
            - input_select.ipm_active_4_unit
            - input_select.ipm_active_5_unit
            - input_select.ipm_active_6_unit
        data:
          options: >
            {% set units = state_attr('sensor.ipm_products', 'units') or {} %}
            {% set conc_units = units.get('concentration', ['g/L', 'g/kg', 'ml/L', '%']) if units is mapping else ['g/L', 'g/kg', 'ml/L', '%'] %}
            {{ conc_units if conc_units | length > 0 else ['g/L', 'g/kg', 'ml/L', '%'] }}

      # Sync chemical groups for all 6 active dropdowns
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.ipm_active_1_group
            - input_select.ipm_active_2_group
            - input_select.ipm_active_3_group
            - input_select.ipm_active_4_group
            - input_select.ipm_active_5_group
            - input_select.ipm_active_6_group
        data:
          options: >
            {% set groups = state_attr('sensor.ipm_products', 'chemical_groups') or [] %}
            {{ ['None'] + groups if groups | length > 0 else ['None', 'N/A', '1', '2', '3', '4', '5', '6', '7', '8', '9', '11', '12', '13', '14', '15', '22', 'M'] }}

      # Sync manage location dropdown (settings)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_location
        data:
          options: >
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      # Sync manage chemical group dropdown (settings)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_chemical_group
        data:
          options: >
            {% set groups = state_attr('sensor.ipm_products', 'chemical_groups') or [] %}
            {{ ['Select Group'] + groups }}

      # Sync manage category dropdown (settings)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_category
        data:
          options: >
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ ['Select Category'] + cats }}

      # Sync manage subcategory parent dropdown (settings)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_subcategory_parent
        data:
          options: >
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ ['Select Category'] + cats }}

      # Sync category filter dropdown (movement view)
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_category
        data:
          options: >
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ ['All'] + cats }}

      # Sync editor category dropdown
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_category
        data:
          options: >
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ cats if cats | length > 0 else ['Chemical', 'Fertiliser', 'Seed', 'Lubricant', 'Hay'] }}

#=============================================================================
# SCRIPTS - User actions
#=============================================================================
script:
  #---------------------------------------------------------------------------
  # Save stock movement
  #---------------------------------------------------------------------------
  ipm_save_movement:
    alias: "IPM: Save Stock Movement"
    mode: single
    sequence:
      - variables:
          product_id: "{{ states('sensor.ipm_selected_product') }}"
          location: "{{ states('input_select.ipm_location') }}"
          delta: "{{ states('input_number.ipm_quantity') | float(0) }}"
          products: "{{ state_attr('sensor.ipm_products', 'products') or {} }}"
          session: "{{ states('input_text.ipm_session_id') }}"
          has_lock: "{{ is_state('input_boolean.ipm_has_movement_lock', 'on') }}"

      # Warn if locked by another user (but allow save with warning)
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.ipm_product_locked
                state: "on"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Warning"
                  message: "This product may be locked by another user. Your changes might conflict."

      # Validate product selected
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ product_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Movement"
                  message: "Please select a product first."
              - stop: "No product selected"

      # Validate location (for multi-location products)
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {% set locs = state_attr('sensor.ipm_product_locations', 'locations') or [] %}
                  {{ locs | length > 1 and location in ['Select Location', 'unknown', 'unavailable', ''] }}
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Movement"
                  message: "This product is in multiple locations. Please select a location."
              - stop: "No location selected"

      # Validate quantity not zero
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ delta == 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Movement"
                  message: "Quantity is zero. Nothing to save."
              - stop: "Delta is zero"

      # Determine actual location
      - variables:
          actual_location: >
            {% set locs = state_attr('sensor.ipm_product_locations', 'locations') or [] %}
            {% if locs | length == 1 %}
              {{ locs[0] }}
            {% else %}
              {{ location }}
            {% endif %}

      # Execute the move
      - service: shell_command.ipm_move_stock
        data:
          product_id: "{{ product_id }}"
          location: "{{ actual_location }}"
          delta: "{{ delta }}"
          note: "HA Dashboard"

      # Reset quantity
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_quantity
        data:
          value: 0

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Release lock after successful save
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_lock }}"
            sequence:
              - service: shell_command.ipm_lock_release_movement
                data:
                  product_id: "{{ product_id }}"
                  session: "{{ session }}"
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ipm_has_movement_lock
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_movement_locked_product
                data:
                  value: ""

      # Confirmation
      - service: persistent_notification.create
        data:
          title: "IPM Movement"
          message: >
            {% set p = products.get(product_id, {}) %}
            Stock updated: {{ p.name | default(product_id) }} at {{ actual_location }}
            Change: {{ delta | float | round(1) }} {{ p.unit | default('') }}

  #---------------------------------------------------------------------------
  # Add new product
  #---------------------------------------------------------------------------
  ipm_add_product:
    alias: "IPM: Add New Product"
    mode: single
    sequence:
      - variables:
          name: "{{ states('input_text.ipm_edit_name') | trim }}"
          category: "{{ states('input_select.ipm_edit_category') }}"
          subcategory: "{{ states('input_select.ipm_edit_subcategory') }}"
          unit: "{{ states('input_select.ipm_edit_unit') }}"
          container_size: "{{ states('input_select.ipm_edit_container') }}"
          min_stock: "{{ states('input_number.ipm_edit_min_stock') | float(0) }}"
          initial_stock: "{{ states('input_number.ipm_edit_initial_stock') | float(0) }}"
          location: "{{ states('input_select.ipm_edit_location') }}"
          app_unit: "{{ states('input_select.ipm_edit_app_unit') }}"
          # Collect active constituents (name + concentration + unit + group)
          actives_json: >
            {% set actives = [] %}
            {% set a1_name = states('input_select.ipm_active_1_name') %}
            {% set a1_conc = states('input_number.ipm_active_1_conc') | float(0) %}
            {% set a1_unit = states('input_select.ipm_active_1_unit') %}
            {% set a1_group = states('input_select.ipm_active_1_group') %}
            {% if a1_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a1_name, "concentration": a1_conc, "unit": a1_unit, "group": a1_group if a1_group != 'None' else ''}] %}{% endif %}
            {% set a2_name = states('input_select.ipm_active_2_name') %}
            {% set a2_conc = states('input_number.ipm_active_2_conc') | float(0) %}
            {% set a2_unit = states('input_select.ipm_active_2_unit') %}
            {% set a2_group = states('input_select.ipm_active_2_group') %}
            {% if a2_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a2_name, "concentration": a2_conc, "unit": a2_unit, "group": a2_group if a2_group != 'None' else ''}] %}{% endif %}
            {% set a3_name = states('input_select.ipm_active_3_name') %}
            {% set a3_conc = states('input_number.ipm_active_3_conc') | float(0) %}
            {% set a3_unit = states('input_select.ipm_active_3_unit') %}
            {% set a3_group = states('input_select.ipm_active_3_group') %}
            {% if a3_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a3_name, "concentration": a3_conc, "unit": a3_unit, "group": a3_group if a3_group != 'None' else ''}] %}{% endif %}
            {% set a4_name = states('input_select.ipm_active_4_name') %}
            {% set a4_conc = states('input_number.ipm_active_4_conc') | float(0) %}
            {% set a4_unit = states('input_select.ipm_active_4_unit') %}
            {% set a4_group = states('input_select.ipm_active_4_group') %}
            {% if a4_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a4_name, "concentration": a4_conc, "unit": a4_unit, "group": a4_group if a4_group != 'None' else ''}] %}{% endif %}
            {% set a5_name = states('input_select.ipm_active_5_name') %}
            {% set a5_conc = states('input_number.ipm_active_5_conc') | float(0) %}
            {% set a5_unit = states('input_select.ipm_active_5_unit') %}
            {% set a5_group = states('input_select.ipm_active_5_group') %}
            {% if a5_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a5_name, "concentration": a5_conc, "unit": a5_unit, "group": a5_group if a5_group != 'None' else ''}] %}{% endif %}
            {% set a6_name = states('input_select.ipm_active_6_name') %}
            {% set a6_conc = states('input_number.ipm_active_6_conc') | float(0) %}
            {% set a6_unit = states('input_select.ipm_active_6_unit') %}
            {% set a6_group = states('input_select.ipm_active_6_group') %}
            {% if a6_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a6_name, "concentration": a6_conc, "unit": a6_unit, "group": a6_group if a6_group != 'None' else ''}] %}{% endif %}
            {{ actives | tojson }}

      # Validate name
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ name == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Add Product"
                  message: "Product name is required."
              - stop: "No product name"

      # Validate subcategory
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ subcategory in ['Select Subcategory', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Add Product"
                  message: "Please select a subcategory."
              - stop: "No subcategory"

      # Execute add
      - service: shell_command.ipm_add_product
        data:
          name: "{{ name }}"
          category: "{{ category }}"
          subcategory: "{{ subcategory }}"
          unit: "{{ unit }}"
          container_size: "{{ container_size }}"
          min_stock: "{{ min_stock }}"
          application_unit: "{{ app_unit }}"
          location: "{{ location }}"
          initial_stock: "{{ initial_stock }}"
          actives: "{{ actives_json }}"

      # Clear form (call the clear script)
      - service: script.ipm_clear_form

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Confirmation
      - service: persistent_notification.create
        data:
          title: "IPM Add Product"
          message: "Product '{{ name }}' added successfully."

  #---------------------------------------------------------------------------
  # Load product into editor
  #---------------------------------------------------------------------------
  ipm_load_product:
    alias: "IPM: Load Product into Editor"
    mode: single
    sequence:
      # Set loading flag to prevent automation interference
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.ipm_loading_product

      - variables:
          product_id: "{{ states('sensor.ipm_selected_product') }}"
          products: "{{ state_attr('sensor.ipm_products', 'products') | default({}, true) }}"
          mapping: "{{ state_attr('sensor.ipm_products', 'category_subcategories') | default({}, true) }}"
          session: "{{ states('input_text.ipm_session_id') }}"
          old_locked_product: "{{ states('input_text.ipm_editor_locked_product') }}"

          # Force every options attr into a real list (never None)
          mode_opts: "{{ state_attr('input_select.ipm_editor_mode', 'options') | default([], true) }}"
          cat_opts: "{{ state_attr('input_select.ipm_edit_category', 'options') | default([], true) }}"
          unit_opts: "{{ state_attr('input_select.ipm_edit_unit', 'options') | default([], true) }}"
          container_opts: "{{ state_attr('input_select.ipm_edit_container', 'options') | default([], true) }}"
          chem_group_opts: "{{ state_attr('input_select.ipm_edit_chem_group', 'options') | default([], true) }}"
          app_unit_opts: "{{ state_attr('input_select.ipm_edit_app_unit', 'options') | default([], true) }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ product_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ipm_loading_product
              - service: persistent_notification.create
                data:
                  title: "IPM Load Product"
                  message: "Please select a product first."
              - stop: "No product selected"

      # Release lock on previously edited product if different
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ old_locked_product not in ['', 'unknown', 'unavailable'] and old_locked_product != product_id }}"
            sequence:
              - service: shell_command.ipm_lock_release_editor
                data:
                  product_id: "{{ old_locked_product }}"
                  session: "{{ session }}"

      # Try to acquire editor lock
      - service: shell_command.ipm_lock_acquire_editor
        data:
          product_id: "{{ product_id }}"
          session: "{{ session }}"

      - delay: "00:00:00.5"

      # Update lock status
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_editor_locked_product
        data:
          value: "{{ product_id }}"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.ipm_has_editor_lock

      # Pull record safely
      - variables:
          p: "{{ products.get(product_id, {}) if products is mapping else {} }}"

          # Extract fields as strings (never None)
          p_name: "{{ (p.get('name') | default('', true) | string | trim) }}"
          p_category_raw: "{{ (p.get('category') | default('', true) | string | trim) }}"
          p_subcategory_raw: "{{ (p.get('subcategory') | default('', true) | string | trim) }}"
          p_unit_raw: "{{ (p.get('unit') | default('', true) | string | trim) }}"
          p_container_raw: "{{ (p.get('container_size') | default('', true) | string | trim) }}"
          p_chem_group_raw: "{{ (p.get('chemical_group') | default('', true) | string | trim) }}"
          p_app_unit_raw: "{{ (p.get('application_unit') | default('', true) | string | trim) }}"
          p_min_stock: "{{ p.get('min_stock') | default(0, true) | float(0) }}"

          # Category: default Chemical; if options list exists, enforce membership
          p_category: >-
            {% set v = p_category_raw if p_category_raw != '' else 'Chemical' %}
            {% set opts = cat_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else ('Chemical' if 'Chemical' in opts else (opts[0] if (opts | count) > 0 else 'Chemical')) }}

          # Unit: default L; enforce membership if options exist
          p_unit: >-
            {% set v = p_unit_raw if p_unit_raw != '' else 'L' %}
            {% set opts = unit_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else ('L' if 'L' in opts else (opts[0] if (opts | count) > 0 else 'L')) }}

          # Container: normalize then enforce membership
          p_container: >-
            {% set cs = p_container_raw %}
            {% set v = cs if cs in ['1','5','10','20','110','200','1000','bulk'] else '20' %}
            {% set opts = container_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else ('20' if '20' in opts else (opts[0] if (opts | count) > 0 else '20')) }}

          # Chemical group: default None; enforce membership if options exist
          p_chem_group: >-
            {% set v = p_chem_group_raw if p_chem_group_raw != '' else 'None' %}
            {% set opts = chem_group_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else 'None' }}

          # App unit: default L/ha; enforce membership if options exist
          p_app_unit: >-
            {% set v = p_app_unit_raw if p_app_unit_raw != '' else 'L/ha' %}
            {% set opts = app_unit_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else 'L/ha' }}

      # Set editor mode (safe)
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_editor_mode
        data:
          option: >-
            {% set v = 'Edit Existing Product' %}
            {% set opts = mode_opts | default([], true) %}
            {{ v if (opts | count == 0) or (v in opts) else (opts[0] if (opts | count) > 0 else v) }}

      # Set category
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_category
        data:
          option: "{{ p_category }}"

      # Set subcategory options for this category immediately
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_subcategory
        data:
          options: >-
            {% set subs = mapping.get(p_category, []) if mapping is mapping else [] %}
            {{ ['Select Subcategory'] + subs if subs else ['Select Subcategory'] }}

      # Read back subcategory options and validate chosen value
      - variables:
          subcat_opts: "{{ state_attr('input_select.ipm_edit_subcategory', 'options') | default(['Select Subcategory'], true) }}"
          p_subcategory: >-
            {% set opts = subcat_opts | default(['Select Subcategory'], true) %}
            {% set v = p_subcategory_raw if p_subcategory_raw != '' else 'Select Subcategory' %}
            {{ v if v in opts else 'Select Subcategory' }}

      # Set name
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_edit_name
        data:
          value: "{{ p_name }}"

      # Set subcategory
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_subcategory
        data:
          option: "{{ p_subcategory }}"

      # Set unit
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_unit
        data:
          option: "{{ p_unit }}"

      # Set container
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_container
        data:
          option: "{{ p_container }}"

      # Set min stock
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_edit_min_stock
        data:
          value: "{{ p_min_stock | float(0) }}"

      # Set application unit (string-safe)
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_app_unit
        data:
          option: "{{ p_app_unit }}"

      # Load active constituents (for Chemical/Fertiliser)
      - variables:
          actives: "{{ p.get('active_constituents', []) if p is mapping else [] }}"
          a1: "{{ actives[0] if actives | length > 0 else {} }}"
          a2: "{{ actives[1] if actives | length > 1 else {} }}"
          a3: "{{ actives[2] if actives | length > 2 else {} }}"
          a4: "{{ actives[3] if actives | length > 3 else {} }}"
          a5: "{{ actives[4] if actives | length > 4 else {} }}"
          a6: "{{ actives[5] if actives | length > 5 else {} }}"

      # Clear existing active name fields
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_name
            - input_select.ipm_active_2_name
            - input_select.ipm_active_3_name
            - input_select.ipm_active_4_name
            - input_select.ipm_active_5_name
            - input_select.ipm_active_6_name
        data:
          option: "Select Active"

      # Clear existing active concentration fields
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.ipm_active_1_conc
            - input_number.ipm_active_2_conc
            - input_number.ipm_active_3_conc
            - input_number.ipm_active_4_conc
            - input_number.ipm_active_5_conc
            - input_number.ipm_active_6_conc
        data:
          value: 0

      # Reset active unit dropdowns to default
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_unit
            - input_select.ipm_active_2_unit
            - input_select.ipm_active_3_unit
            - input_select.ipm_active_4_unit
            - input_select.ipm_active_5_unit
            - input_select.ipm_active_6_unit
        data:
          option: "g/L"

      # Reset active group dropdowns to default
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_group
            - input_select.ipm_active_2_group
            - input_select.ipm_active_3_group
            - input_select.ipm_active_4_group
            - input_select.ipm_active_5_group
            - input_select.ipm_active_6_group
        data:
          option: "None"

      # Hide all additional active toggles first
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.ipm_show_active_2
            - input_boolean.ipm_show_active_3
            - input_boolean.ipm_show_active_4
            - input_boolean.ipm_show_active_5
            - input_boolean.ipm_show_active_6

      # Set active 1 (if exists)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 0 and a1.get('name', '') | trim != '' }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_1_name
                data:
                  option: "{{ a1.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_1_conc
                data:
                  value: "{{ a1.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_1_unit
                data:
                  option: "{{ a1.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_1_group
                data:
                  option: "{{ a1.get('group', '') | default('', true) if a1.get('group', '') | default('', true) != '' else 'None' }}"

      # Set active 2 if exists
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 1 and a2.get('name', '') | trim != '' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_show_active_2
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_2_name
                data:
                  option: "{{ a2.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_2_conc
                data:
                  value: "{{ a2.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_2_unit
                data:
                  option: "{{ a2.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_2_group
                data:
                  option: "{{ a2.get('group', '') | default('', true) if a2.get('group', '') | default('', true) != '' else 'None' }}"

      # Set active 3 if exists
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 2 and a3.get('name', '') | trim != '' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_show_active_3
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_3_name
                data:
                  option: "{{ a3.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_3_conc
                data:
                  value: "{{ a3.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_3_unit
                data:
                  option: "{{ a3.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_3_group
                data:
                  option: "{{ a3.get('group', '') | default('', true) if a3.get('group', '') | default('', true) != '' else 'None' }}"

      # Set active 4 if exists
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 3 and a4.get('name', '') | trim != '' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_show_active_4
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_4_name
                data:
                  option: "{{ a4.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_4_conc
                data:
                  value: "{{ a4.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_4_unit
                data:
                  option: "{{ a4.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_4_group
                data:
                  option: "{{ a4.get('group', '') | default('', true) if a4.get('group', '') | default('', true) != '' else 'None' }}"

      # Set active 5 if exists
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 4 and a5.get('name', '') | trim != '' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_show_active_5
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_5_name
                data:
                  option: "{{ a5.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_5_conc
                data:
                  value: "{{ a5.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_5_unit
                data:
                  option: "{{ a5.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_5_group
                data:
                  option: "{{ a5.get('group', '') | default('', true) if a5.get('group', '') | default('', true) != '' else 'None' }}"

      # Set active 6 if exists
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ actives | length > 5 and a6.get('name', '') | trim != '' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.ipm_show_active_6
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_6_name
                data:
                  option: "{{ a6.get('name', 'Select Active') | default('Select Active', true) }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.ipm_active_6_conc
                data:
                  value: "{{ a6.get('concentration', 0) | float(0) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_6_unit
                data:
                  option: "{{ a6.get('unit', 'g/L') | default('g/L', true) }}"
              - service: input_select.select_option
                target:
                  entity_id: input_select.ipm_active_6_group
                data:
                  option: "{{ a6.get('group', '') | default('', true) if a6.get('group', '') | default('', true) != '' else 'None' }}"

      # Clear loading flag
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_loading_product

      - service: persistent_notification.create
        data:
          title: "IPM Load Product"
          message: >-
            Loaded '{{ (p_name | default('', true) | string) if (p_name | default('', true) | string) != '' else (product_id | string) }}' into editor.

  #---------------------------------------------------------------------------
  # Edit/Save existing product
  #---------------------------------------------------------------------------
  ipm_save_product:
    alias: "IPM: Save Product Changes"
    mode: single
    sequence:
      - variables:
          mode: "{{ states('input_select.ipm_editor_mode') }}"
          product_id: "{{ states('sensor.ipm_selected_product') }}"
          name: "{{ states('input_text.ipm_edit_name') | trim }}"
          category: "{{ states('input_select.ipm_edit_category') }}"
          subcategory: "{{ states('input_select.ipm_edit_subcategory') }}"
          unit: "{{ states('input_select.ipm_edit_unit') }}"
          container_size: "{{ states('input_select.ipm_edit_container') }}"
          min_stock: "{{ states('input_number.ipm_edit_min_stock') | float(0) }}"
          app_unit: "{{ states('input_select.ipm_edit_app_unit') }}"
          # Collect active constituents (name + concentration + unit + group)
          actives_json: >
            {% set actives = [] %}
            {% set a1_name = states('input_select.ipm_active_1_name') %}
            {% set a1_conc = states('input_number.ipm_active_1_conc') | float(0) %}
            {% set a1_unit = states('input_select.ipm_active_1_unit') %}
            {% set a1_group = states('input_select.ipm_active_1_group') %}
            {% if a1_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a1_name, "concentration": a1_conc, "unit": a1_unit, "group": a1_group if a1_group != 'None' else ''}] %}{% endif %}
            {% set a2_name = states('input_select.ipm_active_2_name') %}
            {% set a2_conc = states('input_number.ipm_active_2_conc') | float(0) %}
            {% set a2_unit = states('input_select.ipm_active_2_unit') %}
            {% set a2_group = states('input_select.ipm_active_2_group') %}
            {% if a2_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a2_name, "concentration": a2_conc, "unit": a2_unit, "group": a2_group if a2_group != 'None' else ''}] %}{% endif %}
            {% set a3_name = states('input_select.ipm_active_3_name') %}
            {% set a3_conc = states('input_number.ipm_active_3_conc') | float(0) %}
            {% set a3_unit = states('input_select.ipm_active_3_unit') %}
            {% set a3_group = states('input_select.ipm_active_3_group') %}
            {% if a3_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a3_name, "concentration": a3_conc, "unit": a3_unit, "group": a3_group if a3_group != 'None' else ''}] %}{% endif %}
            {% set a4_name = states('input_select.ipm_active_4_name') %}
            {% set a4_conc = states('input_number.ipm_active_4_conc') | float(0) %}
            {% set a4_unit = states('input_select.ipm_active_4_unit') %}
            {% set a4_group = states('input_select.ipm_active_4_group') %}
            {% if a4_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a4_name, "concentration": a4_conc, "unit": a4_unit, "group": a4_group if a4_group != 'None' else ''}] %}{% endif %}
            {% set a5_name = states('input_select.ipm_active_5_name') %}
            {% set a5_conc = states('input_number.ipm_active_5_conc') | float(0) %}
            {% set a5_unit = states('input_select.ipm_active_5_unit') %}
            {% set a5_group = states('input_select.ipm_active_5_group') %}
            {% if a5_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a5_name, "concentration": a5_conc, "unit": a5_unit, "group": a5_group if a5_group != 'None' else ''}] %}{% endif %}
            {% set a6_name = states('input_select.ipm_active_6_name') %}
            {% set a6_conc = states('input_number.ipm_active_6_conc') | float(0) %}
            {% set a6_unit = states('input_select.ipm_active_6_unit') %}
            {% set a6_group = states('input_select.ipm_active_6_group') %}
            {% if a6_name not in ['Select Active', '', 'unknown', 'unavailable'] %}{% set actives = actives + [{"name": a6_name, "concentration": a6_conc, "unit": a6_unit, "group": a6_group if a6_group != 'None' else ''}] %}{% endif %}
            {{ actives | tojson }}

      # If adding new, use the add script
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ 'Add' in mode }}"
            sequence:
              - service: script.ipm_add_product
              - stop: "Delegated to add script"

      # Editing existing - validate product selected
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ product_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Save Product"
                  message: "No product loaded. Use 'Load Product' first."
              - stop: "No product to edit"

      # Execute edit
      - service: shell_command.ipm_edit_product
        data:
          product_id: "{{ product_id }}"
          name: "{{ name }}"
          category: "{{ category }}"
          subcategory: "{{ subcategory if subcategory != 'Select Subcategory' else '' }}"
          unit: "{{ unit }}"
          container_size: "{{ container_size }}"
          min_stock: "{{ min_stock }}"
          application_unit: "{{ app_unit }}"
          actives: "{{ actives_json }}"

      # Clear form after successful edit
      - service: script.ipm_clear_form

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Confirmation
      - service: persistent_notification.create
        data:
          title: "IPM Save Product"
          message: "Product '{{ name }}' updated successfully."

  #---------------------------------------------------------------------------
  # Clear editor form
  #---------------------------------------------------------------------------
  ipm_clear_form:
    alias: "IPM: Clear Editor Form"
    mode: single
    sequence:
      # Release editor lock if held
      - variables:
          locked_product: "{{ states('input_text.ipm_editor_locked_product') }}"
          session: "{{ states('input_text.ipm_session_id') }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ locked_product not in ['', 'unknown', 'unavailable'] }}"
            sequence:
              - service: shell_command.ipm_lock_release_editor
                data:
                  product_id: "{{ locked_product }}"
                  session: "{{ session }}"
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ipm_has_editor_lock
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_editor_locked_product
                data:
                  value: ""

      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_edit_name
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_edit_initial_stock
        data:
          value: 0
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_edit_min_stock
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_editor_mode
        data:
          option: "Add New Product"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_edit_subcategory
        data:
          option: "Select Subcategory"
      # Clear all active constituent name fields
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_name
            - input_select.ipm_active_2_name
            - input_select.ipm_active_3_name
            - input_select.ipm_active_4_name
            - input_select.ipm_active_5_name
            - input_select.ipm_active_6_name
        data:
          option: "Select Active"
      # Clear all active concentration fields
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.ipm_active_1_conc
            - input_number.ipm_active_2_conc
            - input_number.ipm_active_3_conc
            - input_number.ipm_active_4_conc
            - input_number.ipm_active_5_conc
            - input_number.ipm_active_6_conc
        data:
          value: 0
      # Reset all active unit fields to default
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_unit
            - input_select.ipm_active_2_unit
            - input_select.ipm_active_3_unit
            - input_select.ipm_active_4_unit
            - input_select.ipm_active_5_unit
            - input_select.ipm_active_6_unit
        data:
          option: "g/L"
      # Reset all active group fields to default
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.ipm_active_1_group
            - input_select.ipm_active_2_group
            - input_select.ipm_active_3_group
            - input_select.ipm_active_4_group
            - input_select.ipm_active_5_group
            - input_select.ipm_active_6_group
        data:
          option: "None"
      # Hide additional active toggles
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.ipm_show_active_2
            - input_boolean.ipm_show_active_3
            - input_boolean.ipm_show_active_4
            - input_boolean.ipm_show_active_5
            - input_boolean.ipm_show_active_6

  #---------------------------------------------------------------------------
  # Clear individual active constituent fields
  #---------------------------------------------------------------------------
  ipm_clear_active_1:
    alias: "IPM: Clear Active 1"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_1_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_1_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_1_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_1_group
        data:
          option: "None"

  ipm_clear_active_2:
    alias: "IPM: Clear Active 2"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_2_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_2_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_2_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_2_group
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_show_active_2

  ipm_clear_active_3:
    alias: "IPM: Clear Active 3"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_3_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_3_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_3_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_3_group
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_show_active_3

  ipm_clear_active_4:
    alias: "IPM: Clear Active 4"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_4_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_4_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_4_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_4_group
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_show_active_4

  ipm_clear_active_5:
    alias: "IPM: Clear Active 5"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_5_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_5_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_5_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_5_group
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_show_active_5

  ipm_clear_active_6:
    alias: "IPM: Clear Active 6"
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_6_name
        data:
          option: "Select Active"
      - service: input_number.set_value
        target:
          entity_id: input_number.ipm_active_6_conc
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_6_unit
        data:
          option: "g/L"
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_active_6_group
        data:
          option: "None"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_show_active_6

  #---------------------------------------------------------------------------
  # Delete selected product
  #---------------------------------------------------------------------------
  ipm_delete_selected_product:
    alias: "IPM: Delete Selected Product"
    mode: single
    sequence:
      - variables:
          product_id: "{{ states('sensor.ipm_selected_product') }}"
          products: "{{ state_attr('sensor.ipm_products', 'products') | default({}, true) }}"

      # Validate product selected
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ product_id in ['none', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Delete Product"
                  message: "No product selected. Please load a product first."
              - stop: "No product selected"

      # Get product name for confirmation message
      - variables:
          product_name: >-
            {% set p = products.get(product_id, {}) if products is mapping else {} %}
            {{ p.get('name', product_id) | default(product_id, true) }}

      # Execute delete
      - service: shell_command.ipm_delete_product
        data:
          product_id: "{{ product_id }}"

      # Clear the editor form
      - service: script.ipm_clear_form

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Reset product dropdown
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_product
        data:
          option: "Select Product"

      # Confirmation
      - service: persistent_notification.create
        data:
          title: "IPM Delete Product"
          message: "Product '{{ product_name }}' has been deleted."

  #---------------------------------------------------------------------------
  # Settings: Initialize System
  #---------------------------------------------------------------------------
  ipm_initialize_system:
    alias: "IPM: Initialize System"
    mode: single
    sequence:
      - service: shell_command.ipm_init
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products
      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "System initialized successfully. Database and configuration files created."

  #---------------------------------------------------------------------------
  # Settings: Add Location
  #---------------------------------------------------------------------------
  ipm_add_new_location:
    alias: "IPM: Add New Location"
    mode: single
    sequence:
      - variables:
          new_location: "{{ states('input_text.ipm_new_location') | trim }}"

      # Validate not empty
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_location == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter a location name."
              - stop: "No location name"

      # Add location
      - service: shell_command.ipm_add_location
        data:
          name: "{{ new_location }}"

      # Clear input
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_location
        data:
          value: ""

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Update location dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ locs if locs else ['Chem Shed'] }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Location '{{ new_location }}' added successfully."

  #---------------------------------------------------------------------------
  # Settings: Remove Location
  #---------------------------------------------------------------------------
  ipm_remove_selected_location:
    alias: "IPM: Remove Selected Location"
    mode: single
    sequence:
      - variables:
          location: "{{ states('input_select.ipm_manage_location') }}"
          locations_with_stock: "{{ state_attr('sensor.ipm_products', 'locations_with_stock') or [] }}"

      # Validate selection
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ location in ['Select Location', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a location to remove."
              - stop: "No location selected"

      # Check if location has stock
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ location in locations_with_stock }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Cannot remove '{{ location }}' - it has stock. Move or deplete stock first."
              - stop: "Location has stock"

      # Remove location
      - service: shell_command.ipm_remove_location
        data:
          name: "{{ location }}"

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Update location dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ locs if locs else ['Chem Shed'] }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Location '{{ location }}' removed successfully."

  #---------------------------------------------------------------------------
  # Settings: Refresh Locations (update all dropdowns from config)
  #---------------------------------------------------------------------------
  ipm_refresh_locations:
    alias: "IPM: Refresh Locations"
    mode: single
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - delay: "00:00:01"

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_edit_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ locs if locs else ['Chem Shed'] }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_location
        data:
          options: >-
            {% set locs = state_attr('sensor.ipm_products', 'locations') or [] %}
            {{ ['Select Location'] + locs }}

  #---------------------------------------------------------------------------
  # Settings: Add Custom Active Constituent
  #---------------------------------------------------------------------------
  ipm_add_new_active:
    alias: "IPM: Add New Active Constituent"
    mode: single
    sequence:
      - variables:
          new_active: "{{ states('input_text.ipm_new_active') | trim }}"
          new_groups: "{{ states('input_text.ipm_new_active_groups') | trim }}"

      # Validate not empty
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_active == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter an active constituent name."
              - stop: "No active name"

      # Add active
      - service: shell_command.ipm_add_active
        data:
          name: "{{ new_active }}"
          groups: "{{ new_groups }}"

      # Clear inputs
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_active
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_active_groups
        data:
          value: ""

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Update manage active dropdown with custom actives only
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_active
        data:
          options: >-
            {% set all_actives = state_attr('sensor.ipm_products', 'all_actives_list') or [] %}
            {% set custom = all_actives | selectattr('type', 'eq', 'custom') | map(attribute='name') | list %}
            {{ ['Select Active'] + custom }}

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Active constituent '{{ new_active }}' added successfully."

  #---------------------------------------------------------------------------
  # Settings: Remove Custom Active Constituent
  #---------------------------------------------------------------------------
  ipm_remove_selected_active:
    alias: "IPM: Remove Selected Active Constituent"
    mode: single
    sequence:
      - variables:
          active_name: "{{ states('input_select.ipm_manage_active') }}"
          active_products_map: "{{ state_attr('sensor.ipm_products', 'active_products_map') or {} }}"

      # Validate selection
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ active_name in ['Select Active', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select an active constituent to remove."
              - stop: "No active selected"

      # Check if active is in use
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ active_name in active_products_map and active_products_map[active_name] | length > 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: >
                    Cannot remove '{{ active_name }}' - it is used by:
                    {{ (active_products_map[active_name] | list)[:3] | join(', ') }}
                    {% if active_products_map[active_name] | length > 3 %}...{% endif %}
              - stop: "Active in use"

      # Remove active
      - service: shell_command.ipm_remove_active
        data:
          name: "{{ active_name }}"

      # Refresh data
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      # Update manage active dropdown
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_active
        data:
          options: >-
            {% set all_actives = state_attr('sensor.ipm_products', 'all_actives_list') or [] %}
            {% set custom = all_actives | selectattr('type', 'eq', 'custom') | map(attribute='name') | list %}
            {{ ['Select Active'] + custom }}

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Active constituent '{{ active_name }}' removed successfully."

  #---------------------------------------------------------------------------
  # Category Management: Add Category
  #---------------------------------------------------------------------------
  ipm_add_new_category:
    alias: "IPM: Add New Category"
    mode: single
    sequence:
      - variables:
          new_category: "{{ states('input_text.ipm_new_category') | trim }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_category == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter a category name."
              - stop: "Empty name"

      - service: shell_command.ipm_add_category
        data:
          name: "{{ new_category }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_category
        data:
          value: ""

      - service: script.ipm_refresh_category_dropdowns

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Category '{{ new_category }}' added successfully."

  #---------------------------------------------------------------------------
  # Category Management: Remove Category
  #---------------------------------------------------------------------------
  ipm_remove_selected_category:
    alias: "IPM: Remove Selected Category"
    mode: single
    sequence:
      - variables:
          category: "{{ states('input_select.ipm_manage_category') }}"
          products: "{{ state_attr('sensor.ipm_products', 'products') | default({}) | dict2items | selectattr('value.category', 'eq', category) | list }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ category in ['Select Category', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a category to remove."
              - stop: "No category selected"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ products | length > 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Cannot remove '{{ category }}' - {{ products | length }} product(s) are using it."
              - stop: "Category in use"

      - service: shell_command.ipm_remove_category
        data:
          name: "{{ category }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: script.ipm_refresh_category_dropdowns

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Category '{{ category }}' removed successfully."

  #---------------------------------------------------------------------------
  # Subcategory Management: Add Subcategory
  #---------------------------------------------------------------------------
  ipm_add_new_subcategory:
    alias: "IPM: Add New Subcategory"
    mode: single
    sequence:
      - variables:
          parent: "{{ states('input_select.ipm_manage_subcategory_parent') }}"
          new_subcategory: "{{ states('input_text.ipm_new_subcategory') | trim }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ parent in ['Select Category', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a parent category."
              - stop: "No parent selected"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_subcategory == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter a subcategory name."
              - stop: "Empty name"

      - service: shell_command.ipm_add_subcategory
        data:
          category: "{{ parent }}"
          name: "{{ new_subcategory }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_subcategory
        data:
          value: ""

      - service: script.ipm_refresh_subcategory_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Subcategory '{{ new_subcategory }}' added to '{{ parent }}'."

  #---------------------------------------------------------------------------
  # Subcategory Management: Remove Subcategory
  #---------------------------------------------------------------------------
  ipm_remove_selected_subcategory:
    alias: "IPM: Remove Selected Subcategory"
    mode: single
    sequence:
      - variables:
          parent: "{{ states('input_select.ipm_manage_subcategory_parent') }}"
          subcategory: "{{ states('input_select.ipm_manage_subcategory') }}"
          products: "{{ state_attr('sensor.ipm_products', 'products') | default({}) | dict2items | selectattr('value.subcategory', 'eq', subcategory) | list }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ subcategory in ['Select Subcategory', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a subcategory to remove."
              - stop: "No subcategory selected"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ products | length > 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Cannot remove '{{ subcategory }}' - {{ products | length }} product(s) are using it."
              - stop: "Subcategory in use"

      - service: shell_command.ipm_remove_subcategory
        data:
          category: "{{ parent }}"
          name: "{{ subcategory }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: script.ipm_refresh_subcategory_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Subcategory '{{ subcategory }}' removed from '{{ parent }}'."

  #---------------------------------------------------------------------------
  # Chemical Group Management: Add Chemical Group
  #---------------------------------------------------------------------------
  ipm_add_new_chemical_group:
    alias: "IPM: Add New Chemical Group"
    mode: single
    sequence:
      - variables:
          new_group: "{{ states('input_text.ipm_new_chemical_group') | trim }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_group == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter a chemical group name."
              - stop: "Empty name"

      - service: shell_command.ipm_add_chemical_group
        data:
          name: "{{ new_group }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_chemical_group
        data:
          value: ""

      - service: script.ipm_refresh_chemical_group_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Chemical group '{{ new_group }}' added successfully."

  #---------------------------------------------------------------------------
  # Chemical Group Management: Remove Chemical Group
  #---------------------------------------------------------------------------
  ipm_remove_selected_chemical_group:
    alias: "IPM: Remove Selected Chemical Group"
    mode: single
    sequence:
      - variables:
          group: "{{ states('input_select.ipm_manage_chemical_group') }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ group in ['Select Group', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a chemical group to remove."
              - stop: "No group selected"

      - service: shell_command.ipm_remove_chemical_group
        data:
          name: "{{ group }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: script.ipm_refresh_chemical_group_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Chemical group '{{ group }}' removed successfully."

  #---------------------------------------------------------------------------
  # Unit Management: Add Unit
  #---------------------------------------------------------------------------
  ipm_add_new_unit:
    alias: "IPM: Add New Unit"
    mode: single
    sequence:
      - variables:
          unit_type: "{{ states('input_select.ipm_manage_unit_type') }}"
          new_value: "{{ states('input_text.ipm_new_unit_value') | trim }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ new_value == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please enter a unit value."
              - stop: "Empty value"

      - service: shell_command.ipm_add_unit
        data:
          unit_type: "{{ unit_type }}"
          value: "{{ new_value }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: input_text.set_value
        target:
          entity_id: input_text.ipm_new_unit_value
        data:
          value: ""

      - service: script.ipm_refresh_unit_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Unit '{{ new_value }}' added to {{ unit_type }} units."

  #---------------------------------------------------------------------------
  # Unit Management: Remove Unit
  #---------------------------------------------------------------------------
  ipm_remove_selected_unit:
    alias: "IPM: Remove Selected Unit"
    mode: single
    sequence:
      - variables:
          unit_type: "{{ states('input_select.ipm_manage_unit_type') }}"
          unit_value: "{{ states('input_select.ipm_manage_unit_value') }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ unit_value in ['Select Unit', 'unknown', 'unavailable', ''] }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Settings"
                  message: "Please select a unit to remove."
              - stop: "No unit selected"

      - service: shell_command.ipm_remove_unit
        data:
          unit_type: "{{ unit_type }}"
          value: "{{ unit_value }}"

      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - service: script.ipm_refresh_unit_dropdown

      - service: persistent_notification.create
        data:
          title: "IPM Settings"
          message: "Unit '{{ unit_value }}' removed from {{ unit_type }} units."

  #---------------------------------------------------------------------------
  # Refresh Dropdowns: Categories
  #---------------------------------------------------------------------------
  ipm_refresh_category_dropdowns:
    alias: "IPM: Refresh Category Dropdowns"
    mode: single
    sequence:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_category
        data:
          options: >-
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ ['Select Category'] + cats }}

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_subcategory_parent
        data:
          options: >-
            {% set cats = state_attr('sensor.ipm_products', 'categories') or [] %}
            {{ ['Select Category'] + cats }}

  #---------------------------------------------------------------------------
  # Refresh Dropdowns: Subcategories (based on parent)
  #---------------------------------------------------------------------------
  ipm_refresh_subcategory_dropdown:
    alias: "IPM: Refresh Subcategory Dropdown"
    mode: single
    sequence:
      - variables:
          parent: "{{ states('input_select.ipm_manage_subcategory_parent') }}"

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_subcategory
        data:
          options: >-
            {% set cat_subs = state_attr('sensor.ipm_products', 'category_subcategories') or {} %}
            {% if parent in cat_subs %}
              {{ ['Select Subcategory'] + cat_subs[parent] }}
            {% else %}
              {{ ['Select Subcategory'] }}
            {% endif %}

  #---------------------------------------------------------------------------
  # Refresh Dropdowns: Chemical Groups
  #---------------------------------------------------------------------------
  ipm_refresh_chemical_group_dropdown:
    alias: "IPM: Refresh Chemical Group Dropdown"
    mode: single
    sequence:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_chemical_group
        data:
          options: >-
            {% set groups = state_attr('sensor.ipm_products', 'chemical_groups') or [] %}
            {{ ['Select Group'] + groups }}

  #---------------------------------------------------------------------------
  # Refresh Dropdowns: Units
  #---------------------------------------------------------------------------
  ipm_refresh_unit_dropdown:
    alias: "IPM: Refresh Unit Dropdown"
    mode: single
    sequence:
      - variables:
          unit_type: "{{ states('input_select.ipm_manage_unit_type') }}"

      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_unit_value
        data:
          options: >-
            {% set units = state_attr('sensor.ipm_products', 'units') or {} %}
            {% if unit_type in units %}
              {{ ['Select Unit'] + (units[unit_type] | list) }}
            {% else %}
              {{ ['Select Unit'] }}
            {% endif %}

  #---------------------------------------------------------------------------
  # Settings: Refresh Actives dropdown
  #---------------------------------------------------------------------------
  ipm_refresh_actives:
    alias: "IPM: Refresh Actives"
    mode: single
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - delay: "00:00:01"

      # Update manage active dropdown with custom actives only
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_manage_active
        data:
          options: >-
            {% set all_actives = state_attr('sensor.ipm_products', 'all_actives_list') or [] %}
            {% set custom = all_actives | selectattr('type', 'eq', 'custom') | map(attribute='name') | list %}
            {{ ['Select Active'] + custom }}

  #---------------------------------------------------------------------------
  # Data Management: Export Backup
  #---------------------------------------------------------------------------
  ipm_export_backup:
    alias: "IPM: Export Backup"
    mode: single
    sequence:
      - service: shell_command.ipm_export

      - delay: "00:00:01"

      # Refresh sensor to update backup list
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - delay: "00:00:01"

      # Refresh import dropdown
      - service: script.ipm_refresh_backups

      - service: persistent_notification.create
        data:
          title: "IPM Backup"
          message: >
            Backup created successfully.
            {% set last = state_attr('sensor.ipm_products', 'last_backup') %}
            {% if last %}File: {{ last.filename }}{% endif %}

  #---------------------------------------------------------------------------
  # Data Management: Refresh Backups dropdown
  #---------------------------------------------------------------------------
  ipm_refresh_backups:
    alias: "IPM: Refresh Backups"
    mode: single
    sequence:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_import_backup
        data:
          options: >-
            {% set filenames = state_attr('sensor.ipm_products', 'backup_filenames') or [] %}
            {{ ['Select Backup'] + filenames }}

  #---------------------------------------------------------------------------
  # Data Management: Import Backup
  #---------------------------------------------------------------------------
  ipm_import_selected_backup:
    alias: "IPM: Import Selected Backup"
    mode: single
    sequence:
      - variables:
          backup_file: "{{ states('input_select.ipm_import_backup') }}"

      # Validate selection
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ backup_file == 'Select Backup' or not backup_file }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Import"
                  message: "Please select a backup file to import."
              - stop: "No backup selected"

      # Import the backup
      - service: shell_command.ipm_import_backup
        data:
          filename: "{{ backup_file }}"

      - delay: "00:00:01"

      # Refresh sensor
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - delay: "00:00:01"

      # Refresh all dropdowns
      - service: script.ipm_refresh_locations
      - service: script.ipm_refresh_actives
      - service: script.ipm_refresh_backups

      - service: persistent_notification.create
        data:
          title: "IPM Import"
          message: "Backup '{{ backup_file }}' imported successfully. A pre-import backup was created automatically."

      # Reset selection
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_import_backup
        data:
          option: "Select Backup"

  #---------------------------------------------------------------------------
  # Data Management: Reset System
  #---------------------------------------------------------------------------
  ipm_reset_system:
    alias: "IPM: Reset System"
    mode: single
    sequence:
      - variables:
          confirmed: "{{ states('input_boolean.ipm_confirm_reset') }}"

      # Validate confirmation
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ confirmed != 'on' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Reset"
                  message: "You must check the confirmation box to reset all IPM data."
              - stop: "Reset not confirmed"

      # Reset the system
      - service: shell_command.ipm_reset
        data:
          token: "CONFIRM_RESET"

      - delay: "00:00:01"

      # Turn off confirmation toggle
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ipm_confirm_reset

      # Refresh sensor
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_products

      - delay: "00:00:01"

      # Refresh all dropdowns
      - service: script.ipm_refresh_locations
      - service: script.ipm_refresh_actives
      - service: script.ipm_refresh_backups

      - service: persistent_notification.create
        data:
          title: "IPM Reset"
          message: "All IPM data has been reset. A pre-reset backup was created automatically."

  #---------------------------------------------------------------------------
  # Lock Management: Acquire Lock
  #---------------------------------------------------------------------------
  ipm_acquire_lock:
    alias: "IPM: Acquire Lock"
    mode: single
    fields:
      entity_type:
        description: "Entity type (product, category, etc.)"
        required: true
        selector:
          text:
      entity_id:
        description: "Entity ID"
        required: true
        selector:
          text:
      session:
        description: "Session ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.ipm_lock_acquire
        data:
          entity_type: "{{ entity_type }}"
          entity_id: "{{ entity_id }}"
          session: "{{ session }}"

  #---------------------------------------------------------------------------
  # Lock Management: Release Lock
  #---------------------------------------------------------------------------
  ipm_release_lock:
    alias: "IPM: Release Lock"
    mode: single
    fields:
      entity_type:
        description: "Entity type (product, category, etc.)"
        required: true
        selector:
          text:
      entity_id:
        description: "Entity ID"
        required: true
        selector:
          text:
      session:
        description: "Session ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.ipm_lock_release
        data:
          entity_type: "{{ entity_type }}"
          entity_id: "{{ entity_id }}"
          session: "{{ session }}"

  #---------------------------------------------------------------------------
  # Lock Management: Cleanup Expired Locks
  #---------------------------------------------------------------------------
  ipm_cleanup_locks:
    alias: "IPM: Cleanup Expired Locks"
    mode: single
    sequence:
      - service: shell_command.ipm_lock_cleanup

  #---------------------------------------------------------------------------
  # Report: Set Date Range from Season
  #---------------------------------------------------------------------------
  ipm_set_report_dates_from_season:
    alias: "IPM: Set Report Dates from Season"
    mode: single
    sequence:
      - variables:
          season_name: "{{ states('input_select.ipm_report_season') }}"
          seasons: "{{ state_attr('sensor.farm_registry_data', 'seasons') or {} }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ season_name == 'Custom Date Range' }}"
            sequence:
              - stop: "Custom date range selected - no auto-fill"
        default:
          # Find the season by name and set dates
          - variables:
              season_data: >
                {% for sid, s in seasons.items() %}
                  {% if s.name == season_name %}
                    {{ s }}
                  {% endif %}
                {% endfor %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ season_data | length > 0 }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: input_datetime.ipm_report_start
                    data:
                      date: >
                        {% for sid, s in seasons.items() %}
                          {% if s.name == season_name %}{{ s.start_date }}{% endif %}
                        {% endfor %}
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: input_datetime.ipm_report_end
                    data:
                      date: >
                        {% for sid, s in seasons.items() %}
                          {% if s.name == season_name %}{{ s.end_date }}{% endif %}
                        {% endfor %}

  #---------------------------------------------------------------------------
  # Report: Generate Usage Report
  #---------------------------------------------------------------------------
  ipm_generate_report:
    alias: "IPM: Generate Usage Report"
    mode: single
    sequence:
      - variables:
          start_date: "{{ states('input_datetime.ipm_report_start') }}"
          end_date: "{{ states('input_datetime.ipm_report_end') }}"
          action_filter: "{{ states('input_select.ipm_report_action') }}"

      # Generate report data to JSON file
      - service: shell_command.ipm_generate_report_file
        data:
          start: "{{ start_date }}"
          end: "{{ end_date }}"
          action: "{{ action_filter if action_filter != 'All' else '' }}"

      # Wait for file to be written
      - delay: "00:00:01"

      # Refresh the report data sensor
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_report_data

      # Notify user
      - service: persistent_notification.create
        data:
          title: "IPM Usage Report"
          message: >
            Report generated for period:
            {{ start_date }} to {{ end_date }}
            {% if action_filter != 'All' %}({{ action_filter }} only){% endif %}
