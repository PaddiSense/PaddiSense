script:
  ##########################################
  # Commit stock change (IPM v2 - product_key)
  # Preserves selected product/location after save
  ##########################################
  ipm_commit:
    alias: "IPM – Commit Stock Movement"
    mode: restart
    sequence:
      # ----------------------------------------------------------
      # 1) Read UI values + derive product_id/location
      # ----------------------------------------------------------
      - variables:
          delta: "{{ states('input_number.ipm_quantity') | float(0) }}"
          product_key: "{{ states('input_select.ipm_product_key') | string }}"
          fallback_location: "{{ states('input_select.ipm_location') | string }}"
          note: "HA UI Commit"

          product_id: >
            {% if '|' in product_key %}
              {{ product_key.split('|')[0] | trim }}
            {% else %}
              {{ product_key | trim }}
            {% endif %}

          location: >
            {% if '|' in product_key %}
              {{ product_key.split('|')[1] | trim }}
            {% else %}
              {{ fallback_location | trim }}
            {% endif %}

          invalid_product: >
            {{ product_key in ['Select Product', 'Select Product Key', '', 'unknown', 'unavailable', None]
               or product_id in ['Select Product', 'Select Product Key', '', 'unknown', 'unavailable', None] }}

          invalid_location: >
            {{ location in ['Select Location', '', 'unknown', 'unavailable', None] }}

      # ----------------------------------------------------------
      # 2) Validate (stop early with a clear message)
      # ----------------------------------------------------------
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ delta | float(0) == 0 }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Commit skipped"
                  message: "Quantity is zero. Nothing to commit."
              - stop: "delta is zero"

          - conditions:
              - condition: template
                value_template: "{{ invalid_product }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Commit blocked"
                  message: >
                    No valid product selected.
                    product_key={{ product_key }}, product_id={{ product_id }}
              - stop: "invalid product"

          - conditions:
              - condition: template
                value_template: "{{ invalid_location }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Commit blocked"
                  message: >
                    No valid location selected or derived.
                    product_key={{ product_key }}, location={{ location }}
              - stop: "invalid location"

      # ----------------------------------------------------------
      # 3) Apply movement in backend
      # ----------------------------------------------------------
      - service: shell_command.ipm_move_stock
        data:
          id: "{{ product_id }}"
          location: "{{ location }}"
          delta: "{{ delta }}"
          note: "{{ note }}"

      # ----------------------------------------------------------
      # 4) Reset ONLY the quantity (preserve selection + filters)
      # ----------------------------------------------------------
      - service: input_number.set_value
        data:
          entity_id: input_number.ipm_quantity
          value: 0

      # ----------------------------------------------------------
      # 5) Refresh source sensor (templates will follow automatically)
      # ----------------------------------------------------------
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.ipm_inventory_products




  ##################################################
  # IPM v2 – Load selected product into editor form
  ##################################################
  ipm_load_product_form:
    alias: "IPM – Load Product Into Form"
    mode: single
    sequence:
      - variables:
          product_key: "{{ states('input_select.ipm_product_key') | string }}"
          product_id: >
            {% if '|' in product_key %}
              {{ product_key.split('|')[0] | trim }}
            {% else %}
              {{ product_key | trim }}
            {% endif %}
          pmap: "{{ state_attr('sensor.ipm_inventory_products','products') or {} }}"
          p: "{{ pmap.get(product_id) }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ p is none }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Load blocked"
                  message: "No product found for product_id={{ product_id }} (key={{ product_key }})"
              - stop: "No product to load"

      # Force mode
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_mode
          option: "Edit existing"

      # Basic identity
      - service: input_text.set_value
        data:
          entity_id: input_text.ipm_new_id
          value: "{{ p.id | default(product_id) }}"

      - service: input_text.set_value
        data:
          entity_id: input_text.ipm_new_name
          value: "{{ p.name | default('') }}"

      # Category / subcategory
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_category
          option: >
            {% set v = p.category | default('Chemical') | string %}
            {{ v if v in ['Chemical','Fertiliser','Seed','Lubricant'] else 'Chemical' }}

      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_subcategory
          option: >
            {% set v = p.subcategory | default('Other') | string %}
            {{ v if v != '' else 'Other' }}

      # Storage location (IMPORTANT: this is a SELECT in your UI)
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_storage_location
          option: >
            {% set sb = p.stock_by_location if p.stock_by_location is defined else {} %}
            {% set loc = (sb.keys() | list | first) if sb else 'Chem Shed' %}
            {{ loc }}

      # Unit
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_product_unit
          option: >
            {% set v = p.unit | default('L') | string %}
            {{ v if v in ['L','kg','t'] else 'L' }}

      # Container size (dropdown options are strings; convert numeric to string)
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_container_size
          option: >
            {% set raw = p.container_size | default(20) %}
            {% set s = (raw | int) | string %}
            {{ s if s in ['1','5','10','20','110','1000','bulk'] else '20' }}

      # Application unit
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_application_unit
          option: >
            {% set v = p.application_unit | default('L/ha') | string %}
            {{ v if v != '' else 'L/ha' }}

      # Chemical group
      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_chemical_group
          option: >
            {% set v = p.chemical_group | default('None / Unknown') | string %}
            {{ v if v != '' else 'None / Unknown' }}

      # Numeric fields
      - service: input_number.set_value
        data:
          entity_id: input_number.ipm_new_min_stock
          value: "{{ p.min_stock | default(0) | float(0) }}"

      # Initial stock should NOT be overwritten on edit
      - service: input_number.set_value
        data:
          entity_id: input_number.ipm_new_initial_stock
          value: 0

      # Actives array -> up to 6 actives
      - variables:
          actives: "{{ p.actives if p.actives is defined else [] }}"

      # Active 1
      - service: input_text.set_value
        data:
          entity_id: input_text.ipm_new_active_1
          value: "{{ (actives[0].name if actives|length > 0 and actives[0].name is defined else '') }}"

      - service: input_number.set_value
        data:
          entity_id: input_number.ipm_new_active_concentration
          value: "{{ (actives[0].concentration if actives|length > 0 and actives[0].concentration is defined else 0) | float(0) }}"

      - service: input_select.select_option
        data:
          entity_id: input_select.ipm_new_active_unit
          option: >
            {% set v = (actives[0].concentration_unit if actives|length > 0 and actives[0].concentration_unit is defined else 'None / Unknown') | string %}
            {{ v if v != '' else 'None / Unknown' }}

      # Show/hide + Active 2..6 (set booleans and fields)
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.ipm_new_show_active_2
            - input_boolean.ipm_new_show_active_3
            - input_boolean.ipm_new_show_active_4
            - input_boolean.ipm_new_show_active_5
            - input_boolean.ipm_new_show_active_6

      - choose:
          - conditions: "{{ actives|length > 1 }}"
            sequence:
              - service: input_boolean.turn_on
                target: { entity_id: input_boolean.ipm_new_show_active_2 }
              - service: input_text.set_value
                data: { entity_id: input_text.ipm_new_active_2, value: "{{ actives[1].name | default('') }}" }
              - service: input_number.set_value
                data: { entity_id: input_number.ipm_new_active_concentration_2, value: "{{ actives[1].concentration | default(0) | float(0) }}" }
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_new_active_unit_2
                  option: "{{ actives[1].concentration_unit | default('None / Unknown') }}"

      - choose:
          - conditions: "{{ actives|length > 2 }}"
            sequence:
              - service: input_boolean.turn_on
                target: { entity_id: input_boolean.ipm_new_show_active_3 }
              - service: input_text.set_value
                data: { entity_id: input_text.ipm_new_active_3, value: "{{ actives[2].name | default('') }}" }
              - service: input_number.set_value
                data: { entity_id: input_number.ipm_new_active_concentration_3, value: "{{ actives[2].concentration | default(0) | float(0) }}" }
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_new_active_unit_3
                  option: "{{ actives[2].concentration_unit | default('None / Unknown') }}"

      - choose:
          - conditions: "{{ actives|length > 3 }}"
            sequence:
              - service: input_boolean.turn_on
                target: { entity_id: input_boolean.ipm_new_show_active_4 }
              - service: input_text.set_value
                data: { entity_id: input_text.ipm_new_active_4, value: "{{ actives[3].name | default('') }}" }
              - service: input_number.set_value
                data: { entity_id: input_number.ipm_new_active_concentration_4, value: "{{ actives[3].concentration | default(0) | float(0) }}" }
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_new_active_unit_4
                  option: "{{ actives[3].concentration_unit | default('None / Unknown') }}"

      - choose:
          - conditions: "{{ actives|length > 4 }}"
            sequence:
              - service: input_boolean.turn_on
                target: { entity_id: input_boolean.ipm_new_show_active_5 }
              - service: input_text.set_value
                data: { entity_id: input_text.ipm_new_active_5, value: "{{ actives[4].name | default('') }}" }
              - service: input_number.set_value
                data: { entity_id: input_number.ipm_new_active_concentration_5, value: "{{ actives[4].concentration | default(0) | float(0) }}" }
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_new_active_unit_5
                  option: "{{ actives[4].concentration_unit | default('None / Unknown') }}"

      - choose:
          - conditions: "{{ actives|length > 5 }}"
            sequence:
              - service: input_boolean.turn_on
                target: { entity_id: input_boolean.ipm_new_show_active_6 }
              - service: input_text.set_value
                data: { entity_id: input_text.ipm_new_active_6, value: "{{ actives[5].name | default('') }}" }
              - service: input_number.set_value
                data: { entity_id: input_number.ipm_new_active_concentration_6, value: "{{ actives[5].concentration | default(0) | float(0) }}" }
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_new_active_unit_6
                  option: "{{ actives[5].concentration_unit | default('None / Unknown') }}"






  ######################################################################
  # IPM v2.4 – Save product (Add new / Edit existing)
  # - Auto-generates ID from name in Add mode
  # - Uses selected product_key ID in Edit mode
  # - Calls shell_command.ipm_upsert_product (your python backend)
  # - Refreshes inventory sensor
  # - Clears the form after successful save:
  #     - Name + actives cleared
  #     - Numbers zeroed
  #     - Dropdowns set to "please update" IF that option exists
  #       (otherwise they are left unchanged to avoid script failure)
  ######################################################################
  ipm_save_product:
    alias: "IPM – Save Product"
    mode: single
    sequence:
      # ---------------------------------------------------------
      # 0) Refresh sensor (best-effort)
      # ---------------------------------------------------------
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_inventory_products
      - delay: "00:00:01"

      # ---------------------------------------------------------
      # 1) Gather UI values + derive ID + normalize mode for CLI
      # ---------------------------------------------------------
      - variables:
          # UI mode (your helper uses "Add new" / "Edit existing")
          mode_ui: "{{ states('input_select.ipm_new_mode') | default('Add new') }}"
          mode_cli: >
            {% set m = (mode_ui | lower) %}
            {% if 'edit' in m %}
              edit
            {% else %}
              add
            {% endif %}

          # Fields from form
          category: "{{ states('input_select.ipm_new_category') | trim }}"
          subcategory: "{{ states('input_select.ipm_new_subcategory') | trim }}"
          name: "{{ states('input_text.ipm_new_name') | default('') | trim }}"
          unit: "{{ states('input_select.ipm_new_product_unit') | trim }}"
          container_size: "{{ states('input_select.ipm_new_container_size') | trim }}"
          min_stock: "{{ states('input_number.ipm_new_min_stock') | float(0) }}"
          initial_stock: "{{ states('input_number.ipm_new_initial_stock') | float(0) }}"
          storage_location: "{{ states('input_select.ipm_new_storage_location') | trim }}"
          chemical_group: "{{ states('input_select.ipm_new_chemical_group') | trim }}"
          application_unit: "{{ states('input_select.ipm_new_application_unit') | trim }}"

          # Current products map (used only to block accidental overwrite on add)
          products: "{{ state_attr('sensor.ipm_inventory_products','products') or {} }}"

          # Selected key used for edit mode (ID|Location)
          selected_key: "{{ states('input_select.ipm_product_key') | default('') }}"
          selected_id: >
            {% if '|' in selected_key %}
              {{ selected_key.split('|')[0] | trim }}
            {% else %}
              {{ '' }}
            {% endif %}

          # Generate ID from name (add mode)
          gen_id: >
            {% set s = (name | upper) %}
            {% set s = s | regex_replace('[^A-Z0-9]+','_') %}
            {% set s = s | regex_replace('(^_+|_+$)','') %}
            {{ s[0:16] }}

          # Final ID
          id: >
            {% if mode_cli == 'edit' %}
              {{ selected_id }}
            {% else %}
              {{ gen_id }}
            {% endif %}

          # Snap-to product key (optional)
          new_key: "{{ id ~ '|' ~ storage_location }}"
          key_options: "{{ state_attr('input_select.ipm_product_key','options') or [] }}"

      # ---------------------------------------------------------
      # 2) Validate inputs
      # ---------------------------------------------------------
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ name == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Save blocked"
                  message: "Product Name is required."
              - stop: "Missing product name"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ id == '' }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Save blocked"
                  message: >
                    Unable to determine Product ID.
                    mode_ui='{{ mode_ui }}' mode_cli='{{ mode_cli }}'
                    selected_key='{{ selected_key }}'
                    gen_id='{{ gen_id }}'
              - stop: "Missing product id"

      # Prevent accidental overwrite when adding (optional safety)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ mode_cli == 'add' and (products[id] is defined) }}"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "IPM Save blocked"
                  message: >
                    A product with generated ID '{{ id }}' already exists
                    (existing name='{{ products[id].name if products[id] is defined else '' }}').
                    Rename the product so a different ID is generated.
              - stop: "Duplicate generated ID"

      # ---------------------------------------------------------
      # 3) Save via python backend (shell_command)
      # ---------------------------------------------------------
      - service: shell_command.ipm_upsert_product
        data:
          mode: "{{ mode_cli }}"
          category: "{{ category }}"
          id: "{{ id }}"
          name: "{{ name }}"
          subcategory: "{{ subcategory }}"
          unit: "{{ unit }}"
          container_size: "{{ container_size }}"
          min_stock: "{{ min_stock }}"
          initial_stock: >
            {% if mode_cli == 'add' %}
              {{ initial_stock }}
            {% else %}
              0
            {% endif %}
          storage_location: "{{ storage_location }}"
          chemical_group: "{{ chemical_group }}"
          application_unit: "{{ application_unit }}"

      # ---------------------------------------------------------
      # 4) Refresh inventory sensor so UI options update
      # ---------------------------------------------------------
      - delay: "00:00:01"
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.ipm_inventory_products

      # ---------------------------------------------------------
      # 5) Optional: snap selection if the option exists
      #     (prevents "Invalid option" errors)
      # ---------------------------------------------------------
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ storage_location != '' and new_key in key_options }}"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.ipm_product_key
                  option: "{{ new_key }}"

      # ---------------------------------------------------------
      # 6) Clear / reset form after save (Add mode only)
      #    - input_select cannot be blank, so we set them to
      #      "please update" IF that option exists.
      # ---------------------------------------------------------
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ mode_cli == 'add' }}"
            sequence:
              # --- Clear text fields
              - service: input_text.set_value
                target:
                  entity_id: input_text.ipm_new_name
                data:
                  value: ""

              - service: input_text.set_value
                target:
                  entity_id:
                    - input_text.ipm_new_active_1
                    - input_text.ipm_new_active_2
                    - input_text.ipm_new_active_3
                    - input_text.ipm_new_active_4
                    - input_text.ipm_new_active_5
                    - input_text.ipm_new_active_6
                data:
                  value: ""

              # --- Zero numeric fields
              - service: input_number.set_value
                target:
                  entity_id:
                    - input_number.ipm_new_initial_stock
                    - input_number.ipm_new_min_stock
                    - input_number.ipm_new_active_concentration
                    - input_number.ipm_new_active_concentration_2
                    - input_number.ipm_new_active_concentration_3
                    - input_number.ipm_new_active_concentration_4
                    - input_number.ipm_new_active_concentration_5
                    - input_number.ipm_new_active_concentration_6
                data:
                  value: 0

              # --- Hide additional active rows
              - service: input_boolean.turn_off
                target:
                  entity_id:
                    - input_boolean.ipm_new_show_active_2
                    - input_boolean.ipm_new_show_active_3
                    - input_boolean.ipm_new_show_active_4
                    - input_boolean.ipm_new_show_active_5
                    - input_boolean.ipm_new_show_active_6

              # --- Set dropdowns to "please update" if available (safe-guarded)
              - variables:
                  cat_opts: "{{ state_attr('input_select.ipm_new_category','options') or [] }}"
                  sub_opts: "{{ state_attr('input_select.ipm_new_subcategory','options') or [] }}"
                  loc_opts: "{{ state_attr('input_select.ipm_new_storage_location','options') or [] }}"
                  unit_opts: "{{ state_attr('input_select.ipm_new_product_unit','options') or [] }}"
                  cs_opts: "{{ state_attr('input_select.ipm_new_container_size','options') or [] }}"
                  app_opts: "{{ state_attr('input_select.ipm_new_application_unit','options') or [] }}"
                  grp_opts: "{{ state_attr('input_select.ipm_new_chemical_group','options') or [] }}"
                  a1u_opts: "{{ state_attr('input_select.ipm_new_active_unit','options') or [] }}"
                  a2u_opts: "{{ state_attr('input_select.ipm_new_active_unit_2','options') or [] }}"
                  a3u_opts: "{{ state_attr('input_select.ipm_new_active_unit_3','options') or [] }}"
                  a4u_opts: "{{ state_attr('input_select.ipm_new_active_unit_4','options') or [] }}"
                  a5u_opts: "{{ state_attr('input_select.ipm_new_active_unit_5','options') or [] }}"
                  a6u_opts: "{{ state_attr('input_select.ipm_new_active_unit_6','options') or [] }}"

              - choose:
                  - conditions: "{{ 'please update' in cat_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_category, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in sub_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_subcategory, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in loc_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_storage_location, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in unit_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_product_unit, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in cs_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_container_size, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in app_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_application_unit, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in grp_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_chemical_group, option: "please update" }

              # Active unit dropdowns (also set to "please update" if you added it there)
              - choose:
                  - conditions: "{{ 'please update' in a1u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in a2u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit_2, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in a3u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit_3, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in a4u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit_4, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in a5u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit_5, option: "please update" }

              - choose:
                  - conditions: "{{ 'please update' in a6u_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data: { entity_id: input_select.ipm_new_active_unit_6, option: "please update" }

              # Optional: keep UI in Add new after save
              - variables:
                  mode_opts: "{{ state_attr('input_select.ipm_new_mode','options') or [] }}"
              - choose:
                  - conditions: "{{ 'Add new' in mode_opts }}"
                    sequence:
                      - service: input_select.select_option
                        data:
                          entity_id: input_select.ipm_new_mode
                          option: "Add new"

              - service: persistent_notification.create
                data:
                  title: "IPM"
                  message: >
                    Saved product '{{ name }}' as ID '{{ id }}' (mode={{ mode_cli }}).
                    Form reset to 'please update' where available.
