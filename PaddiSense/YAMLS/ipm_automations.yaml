automation:

  # 1) Update product_key list (ID|Location) based on filters
  - id: ipm_update_product_key_list
    alias: IPM – Update Product Key List
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - input_select.ipm_category
          - input_select.ipm_subcategory_filter
          - input_text.ipm_active_search
          - sensor.ipm_filtered_products
      - platform: homeassistant
        event: start
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_product_key
        data:
          options: >-
            {% set keys = state_attr('sensor.ipm_filtered_products', 'product_keys') or [] %}
            {{ ['Select Product'] + (keys | unique | list) }}

  # 2) Update subcategory filter options from catalog
  - id: ipm_update_subcategory_filter_options
    alias: IPM – Update Subcategory Filter Options
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.ipm_subcategory_choices
      - platform: homeassistant
        event: start
    action:
      - variables:
          subs: "{{ state_attr('sensor.ipm_subcategory_choices', 'options') or [] }}"
      - service: input_select.set_options
        target:
          entity_id: input_select.ipm_subcategory_filter
        data:
          options: >-
            {% if subs %}
              {{ ['All Categories'] + subs }}
            {% else %}
              {{ ['All Categories'] }}
            {% endif %}

  # 3) Reset product selection when category/subcategory changes
  - id: ipm_reset_product_on_filter_change
    alias: IPM – Reset Product on Filter Change
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - input_select.ipm_category
          - input_select.ipm_subcategory_filter
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.ipm_product_key
        data:
          option: "Select Product"
