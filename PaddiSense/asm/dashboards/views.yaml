##############################################################################
# ASM Dashboard - Asset Service Manager
# PaddiSense Farm Management System
#
# UI refactor to match IPM Dashboard styling
# Mechanics unchanged: entities, scripts, conditionals, logic are preserved.
##############################################################################

title: ASM - Asset Service Manager

button_card_templates:
  #---------------------------------------------------------------------------
  # Section title bar (dark)
  #---------------------------------------------------------------------------
  asm_title:
    color_type: label-card
    color: rgb(30, 30, 30)
    show_icon: false
    show_state: false
    styles:
      card:
        - height: 50px
        - border-radius: 12px
        - padding: 8px
      name:
        - font-size: 18px
        - font-weight: 700
        - text-align: center
        - color: white

  #---------------------------------------------------------------------------
  # Info display block (grey)
  #---------------------------------------------------------------------------
  asm_info_block:
    color_type: label-card
    color: rgb(100, 110, 130)
    show_icon: false
    show_state: true
    tap_action:
      action: none
    styles:
      card:
        - height: 80px
        - border-radius: 12px
        - padding: 10px
      state:
        - font-size: 28px
        - font-weight: 800
        - text-align: center
        - color: white
      name:
        - font-size: 14px
        - font-weight: 600
        - text-align: center
        - color: white

  #---------------------------------------------------------------------------
  # Primary action button (blue)
  #---------------------------------------------------------------------------
  asm_action:
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
        - background: "#1565c0"
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Secondary button (grey)
  #---------------------------------------------------------------------------
  asm_secondary:
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
        - background: "#555555"
      name:
        - font-size: 14px
        - font-weight: 600
        - color: white
      icon:
        - color: white
        - width: 24px

  #---------------------------------------------------------------------------
  # Stat chip (like IPM)
  #---------------------------------------------------------------------------
  asm_stat_chip:
    show_icon: true
    show_name: true
    show_state: true
    tap_action: null
    styles:
      card:
        - height: 50px
        - border-radius: 25px
        - padding: 0 16px
        - background: var(--chip-bg, #424242)
      grid:
        - grid-template-areas: '"i n s"'
        - grid-template-columns: 24px auto auto
        - grid-template-rows: 1fr
        - gap: 8px
        - align-items: center
      img_cell:
        - justify-self: start
        - align-items: center
        - justify-content: start
      name:
        - font-size: 12px
        - color: rgba(255,255,255,0.7)
        - justify-self: start
      state:
        - font-size: 18px
        - font-weight: 700
        - color: white
        - justify-self: end
      icon:
        - color: white
        - width: 22px
        - justify-self: start

##############################################################################
# VIEWS
##############################################################################
views:
  #===========================================================================
  # VIEW 1: ASSET MANAGER
  #===========================================================================
  - title: Assets
    path: asm-assets
    icon: mdi:tractor
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: asm_title
                name: ASSET MANAGER

              #----------------------------------------------------------------
              # SELECT ASSET
              #----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.asm_asset
                    name: Select Asset
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                      background: --card-background-color;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                      font-weight: 600;
                    }

              #----------------------------------------------------------------
              # ASSET INFO CARD (shows when asset is selected and mode is View)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_selected_asset
                    state_not: "none"
                  - entity: input_select.asm_editor_mode
                    state: "View"
                card:
                  type: custom:button-card
                  entity: sensor.asm_selected_asset
                  show_icon: false
                  show_name: false
                  show_state: false
                  styles:
                    card:
                      - background: var(--card-background-color, #fff)
                      - border-radius: 12px
                      - padding: 16px
                      - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                      - border-left: 4px solid #1565c0
                    grid:
                      - display: block
                    custom_fields:
                      info:
                        - width: 100%
                  custom_fields:
                    info: |
                      [[[
                        try {
                          const assetJson = entity.attributes.asset;
                          if (!assetJson) return '<div style="color:var(--secondary-text-color);">Select an asset to view details</div>';

                          let asset;
                          try {
                            asset = typeof assetJson === 'string' ? JSON.parse(assetJson) : assetJson;
                          } catch(e) {
                            return '<div style="color:var(--secondary-text-color);">Error parsing asset data</div>';
                          }

                          if (!asset || !asset.name) return '<div style="color:var(--secondary-text-color);">No asset data</div>';

                          const catIcons = {
                            'Tractor': 'mdi:tractor',
                            'Pump': 'mdi:pump',
                            'Harvester': 'mdi:corn',
                            'Vehicle': 'mdi:car-pickup'
                          };
                          const icon = catIcons[asset.category] || 'mdi:cog';

                          let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">`;
                          html += `<div style="width:50px;height:50px;border-radius:50%;background:#e3f2fd;display:flex;align-items:center;justify-content:center;">
                                    <ha-icon icon="${icon}" style="--mdc-icon-size:28px;color:#1565c0;"></ha-icon>
                                  </div>`;
                          html += `<div style="flex:1;">`;
                          html += `<div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">${asset.name}</div>`;
                          html += `<div style="font-size:14px;color:var(--secondary-text-color);">${asset.category || 'No category'}</div>`;
                          html += `</div></div>`;

                          // Attributes
                          const attrs = asset.attributes || {};
                          const attrKeys = Object.keys(attrs);
                          if (attrKeys.length > 0) {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;">`;
                            html += `<div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);margin-bottom:6px;text-transform:uppercase;">Attributes</div>`;
                            for (const key of attrKeys) {
                              html += `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:13px;">`;
                              html += `<span style="color:var(--secondary-text-color);">${key}</span>`;
                              html += `<span style="font-weight:600;color:var(--primary-text-color);">${attrs[key]}</span>`;
                              html += `</div>`;
                            }
                            html += `</div>`;
                          } else {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;font-size:13px;color:var(--secondary-text-color);font-style:italic;">No attributes defined</div>`;
                          }

                          // Created/Modified
                          if (asset.created || asset.modified) {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:8px;margin-top:8px;font-size:11px;color:var(--secondary-text-color);">`;
                            if (asset.created) html += `Created: ${asset.created.substring(0,10)}<br>`;
                            if (asset.modified) html += `Modified: ${asset.modified.substring(0,10)}`;
                            html += `</div>`;
                          }

                          return html;
                        } catch(e) {
                          return '<div style="color:#f44336;">Error: ' + e.message + '</div>';
                        }
                      ]]]

              #----------------------------------------------------------------
              # ACTION BUTTONS (View Mode): Edit / Add New / Delete
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_select.asm_editor_mode
                    state: "View"
                card:
                  type: horizontal-stack
                  cards:
                    - type: custom:button-card
                      template: asm_action
                      name: EDIT
                      icon: mdi:pencil
                      tap_action:
                        action: call-service
                        service: script.asm_load_asset
                      styles:
                        card:
                          - background: "#1565c0"

                    - type: custom:button-card
                      template: asm_action
                      name: ADD NEW
                      icon: mdi:plus
                      tap_action:
                        action: call-service
                        service: script.asm_start_add_asset
                      styles:
                        card:
                          - background: "#2e7d32"

                    - type: custom:button-card
                      template: asm_action
                      name: DELETE
                      icon: mdi:delete
                      tap_action:
                        action: call-service
                        service: script.asm_delete_asset
                        confirmation:
                          text: "Delete this asset? This cannot be undone."
                      styles:
                        card:
                          - background: "#c62828"

              #----------------------------------------------------------------
              # ASSET FORM (only visible in Add New or Edit Existing mode)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_select.asm_editor_mode
                    state_not: "View"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: asm_title
                      name: |
                        [[[
                          const mode = states['input_select.asm_editor_mode']?.state || 'ASSET FORM';
                          if (mode === 'Add New') return 'ADD NEW ASSET';
                          if (mode === 'Edit Existing') return 'EDIT ASSET';
                          return 'ASSET FORM';
                        ]]]
                      styles:
                        card:
                          - height: 40px
                          - background: |
                              [[[
                                const mode = states['input_select.asm_editor_mode']?.state || '';
                                if (mode === 'Add New') return '#2e7d32';
                                if (mode === 'Edit Existing') return '#1565c0';
                                return '#424242';
                              ]]]
                        name:
                          - font-size: 14px

                    - type: entities
                      entities:
                        - entity: input_text.asm_asset_name
                          name: Name
                        - entity: input_select.asm_asset_category
                          name: Category
                        - type: divider
                        - type: section
                          label: Attributes
                        - entity: input_text.asm_attr_1_name
                          name: Attribute 1
                        - entity: input_text.asm_attr_1_value
                          name: Value 1
                        - entity: input_boolean.asm_show_attr_2
                          name: Add More Attributes

                        # Attr 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_2
                              state: "on"
                          row:
                            entity: input_text.asm_attr_2_name
                            name: Attribute 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_2
                              state: "on"
                          row:
                            entity: input_text.asm_attr_2_value
                            name: Value 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_2
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_3
                            name: Add Attribute 3

                        # Attr 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_3
                              state: "on"
                          row:
                            entity: input_text.asm_attr_3_name
                            name: Attribute 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_3
                              state: "on"
                          row:
                            entity: input_text.asm_attr_3_value
                            name: Value 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_3
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_4
                            name: Add Attribute 4

                        # Attr 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_4
                              state: "on"
                          row:
                            entity: input_text.asm_attr_4_name
                            name: Attribute 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_4
                              state: "on"
                          row:
                            entity: input_text.asm_attr_4_value
                            name: Value 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_4
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_5
                            name: Add Attribute 5

                        # Attr 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_5
                              state: "on"
                          row:
                            entity: input_text.asm_attr_5_name
                            name: Attribute 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_5
                              state: "on"
                          row:
                            entity: input_text.asm_attr_5_value
                            name: Value 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_5
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_6
                            name: Add Attribute 6

                        # Attr 6-15 (collapsed for brevity but same pattern)
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_6
                              state: "on"
                          row:
                            entity: input_text.asm_attr_6_name
                            name: Attribute 6
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_6
                              state: "on"
                          row:
                            entity: input_text.asm_attr_6_value
                            name: Value 6
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_6
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_7
                            name: Add Attribute 7

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_7
                              state: "on"
                          row:
                            entity: input_text.asm_attr_7_name
                            name: Attribute 7
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_7
                              state: "on"
                          row:
                            entity: input_text.asm_attr_7_value
                            name: Value 7
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_7
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_8
                            name: Add Attribute 8

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_8
                              state: "on"
                          row:
                            entity: input_text.asm_attr_8_name
                            name: Attribute 8
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_8
                              state: "on"
                          row:
                            entity: input_text.asm_attr_8_value
                            name: Value 8
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_8
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_9
                            name: Add Attribute 9

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_9
                              state: "on"
                          row:
                            entity: input_text.asm_attr_9_name
                            name: Attribute 9
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_9
                              state: "on"
                          row:
                            entity: input_text.asm_attr_9_value
                            name: Value 9
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_9
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_attr_10
                            name: Add Attribute 10

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_10
                              state: "on"
                          row:
                            entity: input_text.asm_attr_10_name
                            name: Attribute 10
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_attr_10
                              state: "on"
                          row:
                            entity: input_text.asm_attr_10_value
                            name: Value 10

                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: --card-background-color;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.1rem !important;
                          }
                          .mdc-text-field__input {
                            font-size: 1.1rem !important;
                          }

                    # Form action buttons
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: asm_action
                          name: SAVE
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.asm_save_asset
                          styles:
                            card:
                              - background: "#2e7d32"

                        - type: custom:button-card
                          template: asm_secondary
                          name: CANCEL
                          icon: mdi:close
                          tap_action:
                            action: call-service
                            service: script.asm_clear_asset_form

              #----------------------------------------------------------------
              # ASSET LIST (always visible)
              #----------------------------------------------------------------
              - type: custom:button-card
                template: asm_title
                name: ASSET LIST

              - type: markdown
                content: |
                  {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}
                  {% if assets | length == 0 %}
                  *No assets yet. Click ADD NEW above to create one.*
                  {% else %}
                  | Asset | Category | Attributes |
                  |-------|----------|------------|
                  {% for aid, a in assets.items() %}
                  | {{ a.name }} | {{ a.category }} | {{ (a.attributes or {}) | length }} attrs |
                  {% endfor %}
                  {% endif %}
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 10px;
                      background: --card-background-color;
                    }
                    table {
                      width: 100%;
                      border-collapse: collapse;
                      font-size: 0.95rem;
                    }
                    th, td {
                      padding: 8px;
                      border-bottom: 1px solid var(--divider-color);
                    }
                    th {
                      text-align: left;
                      font-weight: 700;
                    }

  #===========================================================================
  # VIEW 2: PART MANAGER
  #===========================================================================
  - title: Parts
    path: asm-parts
    icon: mdi:cog
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: asm_title
                name: PART MANAGER

              #----------------------------------------------------------------
              # SELECT PART
              #----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.asm_part
                    name: Select Part
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                      background: --card-background-color;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                      font-weight: 600;
                    }

              #----------------------------------------------------------------
              # PART INFO (shows when part is selected AND mode is View)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_selected_part
                    state_not: "none"
                  - entity: input_select.asm_part_editor_mode
                    state: "View"
                card:
                  type: custom:button-card
                  entity: sensor.asm_selected_part
                  show_icon: false
                  show_name: false
                  show_state: false
                  styles:
                    card:
                      - background: var(--card-background-color, #fff)
                      - border-radius: 12px
                      - padding: 16px
                      - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                      - border-left: 4px solid #7b1fa2
                    grid:
                      - display: block
                    custom_fields:
                      info:
                        - width: 100%
                  custom_fields:
                    info: |
                      [[[
                        try {
                          const partJson = entity.attributes.part;
                          if (!partJson) return '<div style="color:var(--secondary-text-color);">Select a part to view details</div>';

                          let part;
                          try {
                            part = typeof partJson === 'string' ? JSON.parse(partJson) : partJson;
                          } catch(e) {
                            return '<div style="color:var(--secondary-text-color);">Error parsing part data</div>';
                          }

                          if (!part || !part.name) return '<div style="color:var(--secondary-text-color);">No part data</div>';

                          const catIcons = {
                            'Filter': 'mdi:air-filter',
                            'Belt': 'mdi:link-variant',
                            'Oil': 'mdi:oil',
                            'Grease': 'mdi:water',
                            'Battery': 'mdi:car-battery',
                            'Tyre': 'mdi:tire',
                            'Hose': 'mdi:pipe'
                          };
                          const icon = catIcons[part.category] || 'mdi:cog';

                          // Stock status
                          const stock = Number(part.stock) || 0;
                          const minStock = Number(part.min_stock) || 0;
                          const isLow = minStock > 0 && stock < minStock;
                          const stockColor = isLow ? '#f44336' : '#4caf50';

                          let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">`;
                          html += `<div style="width:50px;height:50px;border-radius:50%;background:#f3e5f5;display:flex;align-items:center;justify-content:center;">
                                    <ha-icon icon="${icon}" style="--mdc-icon-size:28px;color:#7b1fa2;"></ha-icon>
                                  </div>`;
                          html += `<div style="flex:1;">`;
                          html += `<div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">${part.name}</div>`;
                          html += `<div style="font-size:14px;color:var(--secondary-text-color);">${part.category || 'No category'}${part.part_number ? ' Â· ' + part.part_number : ''}</div>`;
                          html += `</div></div>`;

                          // Stock display
                          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:${isLow ? 'rgba(244,67,54,0.1)' : 'rgba(76,175,80,0.1)'};border-radius:8px;margin-bottom:10px;">`;
                          html += `<span style="font-size:14px;color:var(--secondary-text-color);">Stock</span>`;
                          html += `<span style="font-size:24px;font-weight:700;color:${stockColor};">${stock} ${part.unit || 'ea'}${minStock > 0 ? ' / min ' + minStock : ''}</span>`;
                          html += `</div>`;

                          // Universal or specific assets
                          if (part.universal) {
                            html += `<div style="font-size:13px;color:#1565c0;margin-bottom:8px;"><ha-icon icon="mdi:check-circle" style="--mdc-icon-size:16px;vertical-align:middle;"></ha-icon> Universal - fits all assets</div>`;
                          } else if (part.applicable_assets && part.applicable_assets.length > 0) {
                            html += `<div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:4px;">Fits: ${part.applicable_assets.join(', ')}</div>`;
                          }

                          // Attributes
                          const attrs = part.attributes || {};
                          const attrKeys = Object.keys(attrs);
                          if (attrKeys.length > 0) {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;">`;
                            html += `<div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);margin-bottom:6px;text-transform:uppercase;">Attributes</div>`;
                            for (const key of attrKeys) {
                              html += `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:13px;">`;
                              html += `<span style="color:var(--secondary-text-color);">${key}</span>`;
                              html += `<span style="font-weight:600;color:var(--primary-text-color);">${attrs[key]}</span>`;
                              html += `</div>`;
                            }
                            html += `</div>`;
                          }

                          return html;
                        } catch(e) {
                          return '<div style="color:#f44336;">Error: ' + e.message + '</div>';
                        }
                      ]]]

              #----------------------------------------------------------------
              # ACTION BUTTONS (View Mode): Edit / Add New / Delete
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_select.asm_part_editor_mode
                    state: "View"
                card:
                  type: horizontal-stack
                  cards:
                    - type: custom:button-card
                      template: asm_action
                      name: EDIT
                      icon: mdi:pencil
                      tap_action:
                        action: call-service
                        service: script.asm_load_part
                      styles:
                        card:
                          - background: "#7b1fa2"

                    - type: custom:button-card
                      template: asm_action
                      name: ADD NEW
                      icon: mdi:plus
                      tap_action:
                        action: call-service
                        service: script.asm_start_add_part
                      styles:
                        card:
                          - background: "#2e7d32"

                    - type: custom:button-card
                      template: asm_action
                      name: DELETE
                      icon: mdi:delete
                      tap_action:
                        action: call-service
                        service: script.asm_delete_part
                        confirmation:
                          text: "Delete this part? This cannot be undone."
                      styles:
                        card:
                          - background: "#c62828"

              #----------------------------------------------------------------
              # PART FORM (only visible in Add New or Edit Existing mode)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_select.asm_part_editor_mode
                    state_not: "View"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: asm_title
                      name: |
                        [[[
                          const mode = states['input_select.asm_part_editor_mode']?.state || 'PART FORM';
                          if (mode === 'Add New') return 'ADD NEW PART';
                          if (mode === 'Edit Existing') return 'EDIT PART';
                          return 'PART FORM';
                        ]]]
                      styles:
                        card:
                          - height: 40px
                          - background: |
                              [[[
                                const mode = states['input_select.asm_part_editor_mode']?.state || '';
                                if (mode === 'Add New') return '#2e7d32';
                                if (mode === 'Edit Existing') return '#7b1fa2';
                                return '#424242';
                              ]]]
                        name:
                          - font-size: 14px

                    - type: entities
                      entities:
                        - entity: input_text.asm_part_name
                          name: Name
                        - entity: input_text.asm_part_number
                          name: Part Number
                        - entity: input_select.asm_part_category
                          name: Category
                        - entity: input_select.asm_part_unit
                          name: Unit
                        - entity: input_number.asm_part_stock
                          name: Initial Stock
                        - entity: input_number.asm_part_min_stock
                          name: Min Stock
                        - type: divider
                        - type: section
                          label: Applies To Assets
                        - entity: input_boolean.asm_universal_part
                          name: Universal (All Assets)
                        - entity: input_select.asm_part_asset_1
                          name: Asset 1

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_2
                              state: "on"
                          row:
                            entity: input_select.asm_part_asset_2
                            name: Asset 2
                        - entity: input_boolean.asm_show_asset_2
                          name: Add Asset 2

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_3
                              state: "on"
                          row:
                            entity: input_select.asm_part_asset_3
                            name: Asset 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_2
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_asset_3
                            name: Add Asset 3

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_4
                              state: "on"
                          row:
                            entity: input_select.asm_part_asset_4
                            name: Asset 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_3
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_asset_4
                            name: Add Asset 4

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_5
                              state: "on"
                          row:
                            entity: input_select.asm_part_asset_5
                            name: Asset 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_asset_4
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_asset_5
                            name: Add Asset 5
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: --card-background-color;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.1rem !important;
                          }
                          .mdc-text-field__input {
                            font-size: 1.1rem !important;
                          }

                    - type: entities
                      entities:
                        - type: section
                          label: Part Attributes
                        - entity: input_text.asm_part_attr_1_name
                          name: Attribute 1
                        - entity: input_text.asm_part_attr_1_value
                          name: Value 1
                        - entity: input_boolean.asm_show_part_attr_2
                          name: Add More Attributes
                        # Part Attr 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_2
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_2_name
                            name: Attribute 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_2
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_2_value
                            name: Value 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_2
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_part_attr_3
                            name: Add Attribute 3
                        # Part Attr 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_3
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_3_name
                            name: Attribute 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_3
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_3_value
                            name: Value 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_3
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_part_attr_4
                            name: Add Attribute 4
                        # Part Attr 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_4
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_4_name
                            name: Attribute 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_4
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_4_value
                            name: Value 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_4
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_part_attr_5
                            name: Add Attribute 5
                        # Part Attr 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_5
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_5_name
                            name: Attribute 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_part_attr_5
                              state: "on"
                          row:
                            entity: input_text.asm_part_attr_5_value
                            name: Value 5
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: --card-background-color;
                          }

                    # Form action buttons
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: asm_action
                          name: SAVE
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.asm_save_part
                          styles:
                            card:
                              - background: "#2e7d32"

                        - type: custom:button-card
                          template: asm_secondary
                          name: CANCEL
                          icon: mdi:close
                          tap_action:
                            action: call-service
                            service: script.asm_clear_part_form

              #----------------------------------------------------------------
              # ADJUST STOCK (always visible when part selected)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_selected_part
                    state_not: "none"
                  - entity: input_select.asm_part_editor_mode
                    state: "View"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: asm_title
                      name: ADJUST STOCK

                    - type: entities
                      entities:
                        - entity: input_number.asm_stock_delta
                          name: Adjustment (+/-)
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: --card-background-color;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: custom:button-card
                      template: asm_action
                      name: APPLY ADJUSTMENT
                      icon: mdi:check
                      tap_action:
                        action: call-service
                        service: script.asm_adjust_stock
                      styles:
                        card:
                          - height: 60px
                          - background: "#1565c0"

  #===========================================================================
  # VIEW 3: REPORT
  #===========================================================================
  - title: Report
    path: asm-report
    icon: mdi:chart-box
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: asm_title
                name: PARTS REPORT

              # Summary chips (mechanics unchanged)
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: asm_stat_chip
                    entity: sensor.asm_data
                    icon: mdi:cog-outline
                    name: Total Parts
                    styles:
                      card:
                        - background: "#455a64"

                  - type: custom:button-card
                    template: asm_stat_chip
                    entity: sensor.asm_low_stock_count
                    icon: mdi:alert
                    name: Low Stock
                    styles:
                      card:
                        - background: |
                            [[[
                              return Number(entity.state) > 0 ? '#d32f2f' : '#388e3c';
                            ]]]

              - type: entities
                entities:
                  - entity: input_select.asm_report_asset
                    name: Asset
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 6px;
                      background: --card-background-color;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                      font-weight: 600;
                    }

              # Parts table (logic unchanged; styled wrapper)
              - type: markdown
                content: |
                  {% set filter_asset = states('input_select.asm_report_asset') %}
                  {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
                  {% set assets = state_attr('sensor.asm_data', 'assets') or {} %}
                  {% set asset_id_to_name = state_attr('sensor.asm_data', 'asset_id_to_name') or {} %}

                  {% set ns = namespace(asset_id='') %}
                  {% if filter_asset not in ['All Assets', 'unknown', 'unavailable', ''] %}
                    {% for aid, a in assets.items() %}
                      {% if a.name == filter_asset %}
                        {% set ns.asset_id = aid %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                  | Part | Category | Stock | Min | Status | Assets |
                  |------|----------|-------|-----|--------|--------|
                  {% for pid, p in parts.items() %}
                    {% set show = (filter_asset in ['All Assets', ''] or p.universal or ns.asset_id in (p.applicable_assets | default([]))) %}
                    {% if show %}
                      {% set status = 'OK' if p.stock >= p.min_stock or p.min_stock == 0 else 'LOW' %}
                      {% set asset_names = [] %}
                      {% if p.universal %}
                        {% set asset_names = ['Universal'] %}
                      {% else %}
                        {% for aid in p.applicable_assets | default([]) %}
                          {% set asset_names = asset_names + [asset_id_to_name.get(aid, aid)] %}
                        {% endfor %}
                      {% endif %}
                  | {{ p.name }} | {{ p.category }} | {{ p.stock }} {{ p.unit }} | {{ p.min_stock }} | {{ status }} | {{ asset_names | join(', ') }} |
                    {% endif %}
                  {% endfor %}
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 10px;
                      background: --card-background-color;
                    }
                    table {
                      width: 100%;
                      border-collapse: collapse;
                      font-size: 0.95rem;
                    }
                    th, td {
                      padding: 8px;
                      border-bottom: 1px solid var(--divider-color);
                    }
                    th {
                      text-align: left;
                      font-weight: 700;
                    }

              # Low stock alert (logic unchanged; styled)
              - type: conditional
                conditions:
                  - entity: sensor.asm_low_stock_count
                    state_not: "0"
                card:
                  type: markdown
                  content: |
                    ### Low Stock Alert
                    {% set parts = state_attr('sensor.asm_data', 'parts') or {} %}
                    {% for pid, p in parts.items() %}
                      {% if p.min_stock > 0 and p.stock < p.min_stock %}
                    - **{{ p.name }}**: {{ p.stock }} {{ p.unit }} (min: {{ p.min_stock }})
                      {% endif %}
                    {% endfor %}
                  card_mod:
                    style: |
                      ha-card {
                        border-radius: 12px;
                        padding: 10px;
                        background: rgba(244, 67, 54, 0.10);
                      }

  #===========================================================================
  # VIEW 4: SERVICE
  #===========================================================================
  - title: Service
    path: asm-service
    icon: mdi:wrench
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: asm_title
                name: RECORD SERVICE EVENT

              #----------------------------------------------------------------
              # SELECT ASSET (always visible)
              #----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.asm_service_asset
                    name: Select Asset
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                      background: --card-background-color;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                      font-weight: 600;
                    }

              #----------------------------------------------------------------
              # SERVICE FORM (only visible when asset is selected)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_select.asm_service_asset
                    state_not: "Select Asset"
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: input_select.asm_service_type
                          name: Service Type
                        - entity: input_text.asm_service_hours
                          name: Engine Hours
                        - entity: input_text.asm_service_notes
                          name: Notes
                        - type: divider
                        - type: section
                          label: Parts Consumed
                        - entity: input_select.asm_consume_part_1
                          name: Part 1
                        - entity: input_number.asm_consume_qty_1
                          name: Qty 1

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_2
                              state: "on"
                          row:
                            entity: input_select.asm_consume_part_2
                            name: Part 2
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_2
                              state: "on"
                          row:
                            entity: input_number.asm_consume_qty_2
                            name: Qty 2
                        - entity: input_boolean.asm_show_consume_2
                          name: Add Part 2

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_3
                              state: "on"
                          row:
                            entity: input_select.asm_consume_part_3
                            name: Part 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_3
                              state: "on"
                          row:
                            entity: input_number.asm_consume_qty_3
                            name: Qty 3
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_2
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_consume_3
                            name: Add Part 3

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_4
                              state: "on"
                          row:
                            entity: input_select.asm_consume_part_4
                            name: Part 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_4
                              state: "on"
                          row:
                            entity: input_number.asm_consume_qty_4
                            name: Qty 4
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_3
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_consume_4
                            name: Add Part 4

                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_5
                              state: "on"
                          row:
                            entity: input_select.asm_consume_part_5
                            name: Part 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_5
                              state: "on"
                          row:
                            entity: input_number.asm_consume_qty_5
                            name: Qty 5
                        - type: conditional
                          conditions:
                            - entity: input_boolean.asm_show_consume_4
                              state: "on"
                          row:
                            entity: input_boolean.asm_show_consume_5
                            name: Add Part 5
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: --card-background-color;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.1rem !important;
                          }
                          .mdc-text-field__input {
                            font-size: 1.1rem !important;
                          }

                    # Action buttons
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: asm_action
                          name: RECORD SERVICE
                          icon: mdi:check
                          tap_action:
                            action: call-service
                            service: script.asm_record_service
                          styles:
                            card:
                              - height: 80px
                              - background: "#1565c0"

                        - type: custom:button-card
                          template: asm_secondary
                          name: CLEAR
                          icon: mdi:eraser
                          tap_action:
                            action: call-service
                            service: script.asm_clear_service_form

              # Recent service history
              - type: custom:button-card
                template: asm_title
                name: SERVICE HISTORY

              #----------------------------------------------------------------
              # SELECT SERVICE EVENT TO VIEW DETAILS
              #----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.asm_service_event
                    name: Select Event to View
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                      background: --card-background-color;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.2rem !important;
                      font-weight: 600;
                    }

              #----------------------------------------------------------------
              # SERVICE EVENT DETAIL CARD (shows when event is selected)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_selected_service_event
                    state_not: "none"
                card:
                  type: custom:button-card
                  entity: sensor.asm_selected_service_event
                  show_icon: false
                  show_name: false
                  show_state: false
                  styles:
                    card:
                      - background: var(--card-background-color, #fff)
                      - border-radius: 12px
                      - padding: 16px
                      - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                      - border-left: 4px solid #ff9800
                    grid:
                      - display: block
                    custom_fields:
                      info:
                        - width: 100%
                  custom_fields:
                    info: |
                      [[[
                        try {
                          const eventJson = entity.attributes.event;
                          if (!eventJson) return '<div style="color:var(--secondary-text-color);">Select an event to view details</div>';

                          let event;
                          try {
                            event = typeof eventJson === 'string' ? JSON.parse(eventJson) : eventJson;
                          } catch(e) {
                            return '<div style="color:var(--secondary-text-color);">Error parsing event data</div>';
                          }

                          if (!event || !event.id) return '<div style="color:var(--secondary-text-color);">No event data</div>';

                          const svcIcons = {
                            '250 Hr Service': 'mdi:oil',
                            '500 Hr Service': 'mdi:oil',
                            '1000 Hr Service': 'mdi:engine',
                            'Annual Service': 'mdi:calendar-check',
                            'Repair': 'mdi:wrench',
                            'Inspection': 'mdi:clipboard-check',
                            'Other': 'mdi:cog'
                          };
                          const icon = svcIcons[event.service_type] || 'mdi:wrench';

                          // Format date nicely
                          const ts = event.timestamp || '';
                          const dateStr = ts.substring(0, 10);
                          const timeStr = ts.substring(11, 16);

                          let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">`;
                          html += `<div style="width:50px;height:50px;border-radius:50%;background:#fff3e0;display:flex;align-items:center;justify-content:center;">
                                    <ha-icon icon="${icon}" style="--mdc-icon-size:28px;color:#ff9800;"></ha-icon>
                                  </div>`;
                          html += `<div style="flex:1;">`;
                          html += `<div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">${event.service_type}</div>`;
                          html += `<div style="font-size:14px;color:var(--secondary-text-color);">${event.asset_name || event.asset_id}</div>`;
                          html += `</div></div>`;

                          // Date/Time and Hours
                          html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">`;
                          html += `<div style="padding:10px;background:rgba(255,152,0,0.1);border-radius:8px;">`;
                          html += `<div style="font-size:11px;color:var(--secondary-text-color);text-transform:uppercase;">Date</div>`;
                          html += `<div style="font-size:16px;font-weight:600;">${dateStr}${timeStr ? ' ' + timeStr : ''}</div>`;
                          html += `</div>`;
                          html += `<div style="padding:10px;background:rgba(255,152,0,0.1);border-radius:8px;">`;
                          html += `<div style="font-size:11px;color:var(--secondary-text-color);text-transform:uppercase;">Engine Hours</div>`;
                          html += `<div style="font-size:16px;font-weight:600;">${event.engine_hours || '-'}</div>`;
                          html += `</div></div>`;

                          // Parts consumed
                          const parts = event.parts_consumed || [];
                          if (parts.length > 0) {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;">`;
                            html += `<div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);margin-bottom:6px;text-transform:uppercase;">Parts Consumed</div>`;

                            // Get part names from HA
                            const partIdToName = hass.states['sensor.asm_data']?.attributes?.part_id_to_name || {};

                            for (const p of parts) {
                              const pname = partIdToName[p.part_id] || p.part_id;
                              html += `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;">`;
                              html += `<span style="color:var(--primary-text-color);">${pname}</span>`;
                              html += `<span style="font-weight:600;color:#ff9800;">x${p.quantity}</span>`;
                              html += `</div>`;
                            }
                            html += `</div>`;
                          } else {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;font-size:13px;color:var(--secondary-text-color);font-style:italic;">No parts consumed</div>`;
                          }

                          // Notes
                          if (event.notes) {
                            html += `<div style="border-top:1px solid var(--divider-color,#e0e0e0);padding-top:10px;margin-top:8px;">`;
                            html += `<div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);margin-bottom:4px;text-transform:uppercase;">Notes</div>`;
                            html += `<div style="font-size:13px;color:var(--primary-text-color);white-space:pre-wrap;">${event.notes}</div>`;
                            html += `</div>`;
                          }

                          // Event ID
                          html += `<div style="margin-top:10px;font-size:10px;color:var(--secondary-text-color);">ID: ${event.id}</div>`;

                          return html;
                        } catch(e) {
                          return '<div style="color:#f44336;">Error: ' + e.message + '</div>';
                        }
                      ]]]

              #----------------------------------------------------------------
              # DELETE SERVICE EVENT BUTTON (shows when event is selected)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_selected_service_event
                    state_not: "none"
                card:
                  type: custom:button-card
                  template: asm_action
                  name: DELETE SERVICE EVENT
                  icon: mdi:delete
                  tap_action:
                    action: call-service
                    service: script.asm_delete_service
                    confirmation:
                      text: "Delete this service event? This cannot be undone."
                  styles:
                    card:
                      - height: 60px
                      - background: "#c62828"

              # History table (summary view)
              - type: markdown
                content: |
                  {% set events = state_attr('sensor.asm_data', 'recent_events') or [] %}
                  {% set part_id_to_name = state_attr('sensor.asm_data', 'part_id_to_name') or {} %}
                  {% if events | length == 0 %}
                  *No service events recorded yet.*
                  {% else %}
                  | Date | Asset | Service | Parts |
                  |------|-------|---------|-------|
                  {% for e in events[:10] %}
                    {% set parts_list = [] %}
                    {% for pc in e.parts_consumed | default([]) %}
                      {% set pname = part_id_to_name.get(pc.part_id, pc.part_id) %}
                      {% set parts_list = parts_list + [pname ~ ' x' ~ pc.quantity] %}
                    {% endfor %}
                  | {{ e.timestamp[:10] }} | {{ e.asset_name | default(e.asset_id) }} | {{ e.service_type }} | {{ parts_list | join(', ') if parts_list else '-' }} |
                  {% endfor %}
                  {% endif %}
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 10px;
                      background: --card-background-color;
                    }
                    table {
                      width: 100%;
                      border-collapse: collapse;
                      font-size: 0.95rem;
                    }
                    th, td {
                      padding: 8px;
                      border-bottom: 1px solid var(--divider-color);
                    }
                    th {
                      text-align: left;
                      font-weight: 700;
                    }
#===========================================================================
# VIEW 5: SETTINGS
#===========================================================================
  - title: Settings
    path: asm-settings
    icon: mdi:cog
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: asm_title
                name: ASM SETTINGS

              #----------------------------------------------------------------
              # SYSTEM STATUS
              #----------------------------------------------------------------
              - type: custom:button-card
                entity: sensor.asm_data
                show_icon: false
                show_name: false
                show_state: false
                tap_action: null
                styles:
                  card:
                    - background: var(--card-background-color, #fff)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                    - border-left: 4px solid #1565c0
                  grid:
                    - display: block
                  custom_fields:
                    info:
                      - width: 100%
                custom_fields:
                  info: |
                    [[[
                      try {
                        const e = entity;
                        const a = (e && e.attributes) ? e.attributes : {};

                        const state = (e && typeof e.state === 'string') ? e.state : 'unavailable';
                        const isAvail = (state !== 'unavailable' && state !== 'unknown' && state !== null && state !== undefined);

                        const initialized = Boolean(a.initialized);
                        const configOk = Boolean(a.config_ok);
                        const databaseOk = Boolean(a.database_ok);
                        const status = (a.status ?? 'unknown');
                        const version = (a.version ?? 'unknown');

                        const assets = Number(a.total_assets ?? 0);
                        const parts = Number(a.total_parts ?? 0);
                        const services = Number(a.total_services ?? 0);
                        const backups = Number(a.backup_count ?? 0);

                        let statusColor = '#4caf50';
                        let statusText = 'Ready';

                        if (!isAvail) {
                          statusColor = '#9e9e9e';
                          statusText = 'Unavailable';
                        } else if (!initialized) {
                          statusColor = '#ff9800';
                          statusText = 'Not Initialized';
                        } else if (status === 'error') {
                          statusColor = '#f44336';
                          statusText = 'Error';
                        }

                        // MDI icon (robust): CSS mask using mdi:cog path (no ha-icon dependency)
                        const cogSvgPath = "M12 8.5A3.5 3.5 0 1 0 15.5 12A3.5 3.5 0 0 0 12 8.5M19.43 12.98C19.47 12.66 19.5 12.33 19.5 12S19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.28 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.47 2.18 14.26 2 14 2H10C9.74 2 9.53 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.72 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.67 4.5 12S4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.72 19.04 4.95 18.95L7.44 17.95C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.53 21.82 9.74 22 10 22H14C14.26 22 14.47 21.82 14.5 21.58L14.87 18.93C15.5 18.68 16.04 18.34 16.56 17.95L19.05 18.95C19.28 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98Z";

                        let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">`;

                        html += `
                          <div style="width:50px;height:50px;border-radius:50%;background:#e3f2fd;display:flex;align-items:center;justify-content:center;">
                            <span style="
                              width:28px;height:28px;display:inline-block;
                              background:#1565c0;
                              -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 24 24&quot;><path d=&quot;${cogSvgPath}&quot; /></svg>') no-repeat center / contain;
                              mask: url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 24 24&quot;><path d=&quot;${cogSvgPath}&quot; /></svg>') no-repeat center / contain;
                            "></span>
                          </div>
                        `;

                        html += `<div style="flex:1;">`;
                        html += `<div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">System Status</div>`;
                        html += `<div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:4px;">ASM v${version}</div>`;
                        html += `<div style="font-size:14px;padding:4px 12px;border-radius:12px;display:inline-block;background:${statusColor};color:white;font-weight:600;">${statusText}</div>`;
                        html += `</div></div>`;

                        // Status grid
                        html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">`;
                        html += `<div style="padding:10px;background:${configOk ? 'rgba(76,175,80,0.1)' : 'rgba(244,67,54,0.1)'};border-radius:8px;">`;
                        html += `<div style="font-size:11px;color:var(--secondary-text-color);text-transform:uppercase;">Config</div>`;
                        html += `<div style="font-size:16px;font-weight:600;color:${configOk ? '#4caf50' : '#f44336'};">${configOk ? 'OK' : 'Missing'}</div>`;
                        html += `</div>`;
                        html += `<div style="padding:10px;background:${databaseOk ? 'rgba(76,175,80,0.1)' : 'rgba(244,67,54,0.1)'};border-radius:8px;">`;
                        html += `<div style="font-size:11px;color:var(--secondary-text-color);text-transform:uppercase;">Database</div>`;
                        html += `<div style="font-size:16px;font-weight:600;color:${databaseOk ? '#4caf50' : '#f44336'};">${databaseOk ? 'OK' : 'Missing'}</div>`;
                        html += `</div></div>`;

                        // Counts
                        html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">`;
                        html += `<div style="text-align:center;padding:8px;background:rgba(0,0,0,0.05);border-radius:8px;">`;
                        html += `<div style="font-size:20px;font-weight:700;color:#1565c0;">${assets}</div>`;
                        html += `<div style="font-size:10px;color:var(--secondary-text-color);">Assets</div></div>`;
                        html += `<div style="text-align:center;padding:8px;background:rgba(0,0,0,0.05);border-radius:8px;">`;
                        html += `<div style="font-size:20px;font-weight:700;color:#7b1fa2;">${parts}</div>`;
                        html += `<div style="font-size:10px;color:var(--secondary-text-color);">Parts</div></div>`;
                        html += `<div style="text-align:center;padding:8px;background:rgba(0,0,0,0.05);border-radius:8px;">`;
                        html += `<div style="font-size:20px;font-weight:700;color:#ff9800;">${services}</div>`;
                        html += `<div style="font-size:10px;color:var(--secondary-text-color);">Services</div></div>`;
                        html += `<div style="text-align:center;padding:8px;background:rgba(0,0,0,0.05);border-radius:8px;">`;
                        html += `<div style="font-size:20px;font-weight:700;color:#455a64;">${backups}</div>`;
                        html += `<div style="font-size:10px;color:var(--secondary-text-color);">Backups</div></div>`;
                        html += `</div>`;

                        return html;
                      } catch (err) {
                        // Never crash the card. Show something instead.
                        return `
                          <div style="padding:12px;border-radius:10px;background:rgba(244,67,54,0.10);border:1px solid rgba(244,67,54,0.35);">
                            <div style="font-weight:700;color:var(--primary-text-color);">System Status</div>
                            <div style="margin-top:6px;color:var(--secondary-text-color);font-size:12px;">
                              JS template error (safe-caught): ${err && err.message ? err.message : err}
                            </div>
                          </div>
                        `;
                      }
                    ]]]


              # INITIALIZE BUTTON (only shows if not initialized)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: sensor.asm_data
                    state_not: "initialized"
                card:
                  type: custom:button-card
                  template: asm_action
                  name: INITIALIZE SYSTEM
                  icon: mdi:database-plus
                  tap_action:
                    action: call-service
                    service: script.asm_init_system
                  styles:
                    card:
                      - height: 80px
                      - background: "#2e7d32"


              #----------------------------------------------------------------
              # DATA MANAGEMENT (export, refresh)
              #----------------------------------------------------------------
              - type: custom:button-card
                template: asm_title
                name: DATA MANAGEMENT

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: asm_action
                    name: EXPORT BACKUP
                    icon: mdi:content-save
                    tap_action:
                      action: call-service
                      service: script.asm_export_data
                    styles:
                      card:
                        - background: "#1565c0"

                  - type: custom:button-card
                    template: asm_action
                    name: REFRESH DATA
                    icon: mdi:refresh
                    tap_action:
                      action: call-service
                      service: script.asm_refresh_data
                    styles:
                      card:
                        - background: "#455a64"

              #----------------------------------------------------------------
              # CATEGORIES INFO (read-only display)
              #----------------------------------------------------------------
              - type: custom:button-card
                template: asm_title
                name: CATEGORIES

              - type: markdown
                content: |
                  {% set asset_cats = state_attr('sensor.asm_data', 'asset_categories') or [] %}
                  {% set part_cats = state_attr('sensor.asm_data', 'part_categories') or [] %}
                  {% set service_types = state_attr('sensor.asm_data', 'service_types') or [] %}

                  **Asset Categories:** {{ asset_cats | join(', ') }}

                  **Part Categories:** {{ part_cats | join(', ') }}

                  **Service Types:** {{ service_types | join(', ') }}
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 12px;
                      background: --card-background-color;
                    }

              #----------------------------------------------------------------
              # ABOUT
              #----------------------------------------------------------------
              - type: custom:button-card
                template: asm_title
                name: ABOUT

              - type: markdown
                content: |
                  **ASM - Asset Service Manager**
                  Part of the PaddiSense Farm Management System

                  Manage your farm assets, parts inventory, and service records.

                  - **Assets:** Tractors, pumps, harvesters, vehicles
                  - **Parts:** Filters, belts, oils, tyres, and more
                  - **Services:** Track maintenance with automatic parts deduction

                  Data is stored locally in `/config/local_data/asm/`
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 12px;
                      background: --card-background-color;
                    }
