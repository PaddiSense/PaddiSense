button_card_templates:
  ############################################################
  # Simple title block
  ############################################################
  template_titleblock:
    color_type: label-card
    color: rgb(0,0,0)
    show_icon: false
    show_state: false
    styles:
      card:
        - height: 52px
        - border-radius: 14px
        - padding: 10px
      name:
        - font-size: 18px
        - font-weight: 700
        - text-align: center
        - color: white

  ############################################################
  # Simple label block (yellow)
  ############################################################
  template_textblock:
    color_type: label-card
    color: rgb(255,255,51)
    show_icon: false
    show_state: false
    styles:
      card:
        - height: 80px
        - border-radius: 14px
        - padding: 10px
      name:
        - font-size: 16px
        - font-weight: 800
        - text-align: center
        - color: black

  ############################################################
  # Number display block
  ############################################################
  template_numberblock:
    color_type: label-card
    color: rgb(140,146,172)
    show_icon: false
    show_state: true
    tap_action:
      action: none
    styles:
      card:
        - height: 80px
        - border-radius: 14px
        - padding: 10px
      state:
        - font-size: 34px
        - font-weight: 900
        - text-align: center
        - color: white
      name:
        - font-size: 14px
        - font-weight: 800
        - text-align: center
        - color: white

  ############################################################
  # Minus buttons
  ############################################################
  template_numberblock_minus:
    variables:
      amount: 1
      label: "-1"
    show_icon: false
    show_name: true
    show_state: false
    name: '[[[ return variables.label ]]]'
    tap_action:
      action: call-service
      service: input_number.set_value
      service_data:
        entity_id: input_number.ipm_quantity
        value: |
          [[[ return Number(entity.state) - Number(variables.amount); ]]]
    styles:
      card:
        - height: 80px
        - border-radius: 14px
        - padding: 10px
        - background: "#ff1940"
      name:
        - font-size: 20px
        - font-weight: 900
        - text-align: center
        - color: "#000000"

  ############################################################
  # Plus buttons
  ############################################################
  template_numberblock_plus:
    variables:
      amount: 1
      label: "+1"
    show_icon: false
    show_name: true
    show_state: false
    name: '[[[ return variables.label ]]]'
    tap_action:
      action: call-service
      service: input_number.set_value
      service_data:
        entity_id: input_number.ipm_quantity
        value: |
          [[[ return Number(entity.state) + Number(variables.amount); ]]]
    styles:
      card:
        - height: 80px
        - border-radius: 14px
        - padding: 10px
        - background: "#19ff19"
      name:
        - font-size: 20px
        - font-weight: 900
        - text-align: center
        - color: "#000000"


browser_mod:
  style:
    select:
      font-size: 2.2rem !important
      min-height: 68px !important
      padding: 10px !important
    input:
      font-size: 2.2rem !important
      padding: 12px !important


#################################################################
# Views
#################################################################
views:
  #################################################################
  # VIEW 1: Movement
  #################################################################

  - type: sections
    max_columns: 1
    title: Movement
    path: inventory-movement
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                name: FIND PRODUCT

              # Category
              - type: entities
                entities:
                  - entity: input_select.ipm_category
                    name: Product Type
                    icon: mdi:playlist-edit
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px; }
                    .mdc-list-item__primary-text { font-size: 1.6rem !important; }

              # Subcategory filter
              - type: entities
                entities:
                  - entity: input_select.ipm_subcategory_filter
                    name: Subcategory
                    icon: mdi:shape-outline
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px; }
                    .mdc-list-item__primary-text { font-size: 1.6rem !important; }

              # Search
              - type: entities
                entities:
                  - entity: input_text.ipm_active_search
                    name: Search
                    icon: mdi:magnify
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px; }
                    .mdc-text-field__input { font-size: 1.6rem !important; padding: 16px !important; }

              # Product selection (stores ID|Location)
              - type: entities
                entities:
                  - entity: input_select.ipm_product_key
                    name: Select Product (ID|Location)
                    icon: mdi:flask-outline
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px 8px 10px; }
                    .mdc-list-item__primary-text { font-size: 1.6rem !important; }

              # Display selected product name + location clearly
              - type: entities
                entities:
                  - entity: sensor.ipm_selected_product_label
                    name: Selected
                    icon: mdi:tag-text-outline
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px 8px 10px; }
                    .mdc-list-item__primary-text { font-size: 1.6rem !important; }

              # Stock on hand at selected location
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    name: STOCK ON HAND
                    template: template_textblock

                  - type: custom:button-card
                    template: template_numberblock
                    entity: sensor.ipm_inventory_products
                    show_name: false
                    show_icon: false
                    show_state: true
                    tap_action:
                      action: none
                    state_display: |
                      [[[
                        const key = states['input_select.ipm_product_key']?.state || "";
                        if (!key || key.includes("Select")) return "—";

                        const [id, loc] = key.split("|").map(s => (s || "").trim());
                        const products = states['sensor.ipm_inventory_products']?.attributes?.products || {};
                        const p = products[id];
                        if (!p) return "0";

                        const unit = p.unit || "";
                        const current = (p.stock_by_location && loc) ? Number(p.stock_by_location[loc] || 0) : 0;
                        return current.toFixed(0) + " " + unit;
                      ]]]

              - type: custom:button-card
                template: template_titleblock
                name: ADJUST STOCK

              # Minus buttons
              - square: false
                type: grid
                columns: 3
                cards:
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 1, label: "- 1" }
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 5, label: "- 5" }
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 20, label: "- 20" }
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 100, label: "- 100" }
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 500, label: "- 500" }
                  - type: custom:button-card
                    template: template_numberblock_minus
                    entity: input_number.ipm_quantity
                    variables: { amount: 2000, label: "- 2000" }

              # Change amount + Clear
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_numberblock
                    entity: input_number.ipm_quantity
                    name: CHANGE AMOUNT
                    styles:
                      card:
                        - padding: 10px
                      name:
                        - font-size: 16px
                        - font-weight: bold
                        - text-align: center
                      state:
                        - font-size: 32px
                        - font-weight: bold
                        - text-align: center
                        - color: |
                            [[[
                              const v = Number(entity.state);
                              if (v > 0) return "#15F70A";
                              if (v < 0) return "#f90709";
                              return "#FFFFFF";
                            ]]]

                  - type: custom:button-card
                    name: CLEAR
                    icon: mdi:backspace
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.ipm_quantity
                      data:
                        value: 0
                    styles:
                      card:
                        - background: "#444444"
                        - border-radius: 12px
                        - padding: 10px
                        - height: 80px
                        - width: 110px
                      name:
                        - font-size: 18px
                        - font-weight: bold
                        - color: white
                      icon:
                        - width: 28px
                        - color: white

              # Plus buttons
              - square: false
                type: grid
                columns: 3
                cards:
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 1, label: "+ 1" }
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 5, label: "+ 5" }
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 20, label: "+ 20" }
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 100, label: "+ 100" }
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 500, label: "+ 500" }
                  - type: custom:button-card
                    template: template_numberblock_plus
                    entity: input_number.ipm_quantity
                    variables: { amount: 2000, label: "+ 2000" }

              # New amount (current + delta at selected location)
              - type: custom:button-card
                template: template_numberblock
                entity: sensor.ipm_inventory_products
                name: NEW AMOUNT
                show_name: true
                show_icon: false
                show_state: true
                tap_action:
                  action: none
                state_display: |
                  [[[
                    const key = states['input_select.ipm_product_key']?.state || "";
                    const delta = Number(states['input_number.ipm_quantity']?.state || 0);
                    if (!key || key.includes("Select")) return "—";

                    const [id, loc] = key.split("|").map(s => (s || "").trim());
                    const products = states['sensor.ipm_inventory_products']?.attributes?.products || {};
                    const p = products[id];
                    if (!p) return "—";

                    const unit = p.unit || "";
                    const current = (p.stock_by_location && loc) ? Number(p.stock_by_location[loc] || 0) : 0;
                    const next = Math.max(0, current + delta);
                    return next.toFixed(0) + " " + unit;
                  ]]]

              - type: custom:button-card
                name: SAVE CHANGE
                icon: mdi:content-save
                tap_action:
                  action: call-service
                  service: script.ipm_commit
                styles:
                  card:
                    - background: "#0047FF"
                    - border-radius: 14px
                    - padding: 20px
                    - height: 90px
                  name:
                    - color: white
                    - font-size: 18px
                    - font-weight: bold
                  icon:
                    - color: white
                    - width: 34px



  #################################################################
  # VIEW 2: Manage Products
  #################################################################
  - type: sections
    max_columns: 1
    title: Manage Products
    path: ipm-manage
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                name: PRODUCT EDITOR

              - type: markdown
                content: >
                  Use **Add new** to create a product.  
                  Use **Edit existing** to load by **ID|Location** and edit metadata.  
                  Stock by location is **preserved** unless you do a stock movement.
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 12px; font-size: 1.05rem; line-height: 1.45; }

              - type: entities
                entities:
                  - entity: input_select.ipm_new_mode
                    name: Editor mode
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px; }
                    .mdc-list-item__primary-text { font-size: 1.4rem !important; }

              # When editing, select via filters + product key, then "Load Product"
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.ipm_new_mode
                    state: "Edit existing"
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: input_select.ipm_category
                          name: Product Type
                          icon: mdi:playlist-edit
                        - entity: input_select.ipm_subcategory_filter
                          name: Subcategory
                          icon: mdi:shape-outline
                        - entity: input_text.ipm_active_search
                          name: Search
                          icon: mdi:magnify
                      card_mod:
                        style: |
                          ha-card { border-radius: 14px; padding: 6px; }
                          .mdc-list-item__primary-text { font-size: 1.4rem !important; }
                          .mdc-text-field__input { font-size: 1.4rem !important; }

                    - type: entities
                      entities:
                        - entity: input_select.ipm_product_key
                          name: Select Product (ID|Location)
                          icon: mdi:flask-outline
                      card_mod:
                        style: |
                          ha-card { border-radius: 14px; padding: 6px 8px 10px; }
                          .mdc-list-item__primary-text { font-size: 1.4rem !important; }
#################### Load Product Button
                    - type: custom:button-card
                      name: LOAD PRODUCT
                      icon: mdi:download
                      tap_action:
                        action: call-service
                        service: script.ipm_load_product_form
                      styles:
                        card:
                          - background: "#0047FF"
                          - border-radius: 14px
                          - padding: 20px
                          - height: 90px
                        name:
                          - color: white
                          - font-size: 18px
                          - font-weight: 900
                        icon:
                          - color: white
                          - height: 34px

              # Required fields
              - type: entities
                title: Required Details
                entities:
                  - entity: input_select.ipm_new_category
                    name: Product category
                  - entity: input_select.ipm_new_subcategory
                    name: Subcategory
                  - entity: input_text.ipm_new_name
                    name: Product name
                  - entity: input_select.ipm_new_storage_location
                    name: Default storage location
                  - entity: input_select.ipm_new_product_unit
                    name: Product unit
                  - entity: input_select.ipm_new_container_size
                    name: Container size
                  - entity: input_select.ipm_new_application_unit
                    name: Application unit
                  - entity: input_select.ipm_new_chemical_group
                    name: Chemical group
                  - entity: input_number.ipm_new_min_stock
                    name: Minimum stock
                  - entity: input_number.ipm_new_initial_stock
                    name: Initial stock (new product only)
                card_mod:
                  style: |
                    ha-card { --ha-card-background: #E9FBE9; border-radius: 14px; padding: 6px; }
                    .mdc-list-item__primary-text { font-size: 1.35rem !important; }
                    .mdc-text-field__input { font-size: 1.35rem !important; }

              # Chemistry (Active 1)
              - type: entities
                title: Chemistry
                entities:
                  - entity: input_text.ipm_new_active_1
                    name: Active 1
                  - entity: input_number.ipm_new_active_concentration
                    name: Active 1 – conc.
                  - entity: input_select.ipm_new_active_unit
                    name: Active 1 – unit
                  - entity: input_boolean.ipm_new_show_active_2
                    name: Show 2nd Active
                card_mod:
                  style: |
                    ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }
                    .mdc-list-item__primary-text { font-size: 1.35rem !important; }
                    .mdc-text-field__input { font-size: 1.35rem !important; }

              # Active 2
              - type: conditional
                conditions:
                  - entity: input_boolean.ipm_new_show_active_2
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.ipm_new_active_2
                      name: Active 2
                    - entity: input_number.ipm_new_active_concentration_2
                      name: Active 2 – conc.
                    - entity: input_select.ipm_new_active_unit_2
                      name: Active 2 – unit
                    - entity: input_boolean.ipm_new_show_active_3
                      name: Show 3rd Active
                  card_mod:
                    style: |
                      ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }

              # Active 3
              - type: conditional
                conditions:
                  - entity: input_boolean.ipm_new_show_active_3
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.ipm_new_active_3
                      name: Active 3
                    - entity: input_number.ipm_new_active_concentration_3
                      name: Active 3 – conc.
                    - entity: input_select.ipm_new_active_unit_3
                      name: Active 3 – unit
                    - entity: input_boolean.ipm_new_show_active_4
                      name: Show 4th Active
                  card_mod:
                    style: |
                      ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }

              # Active 4
              - type: conditional
                conditions:
                  - entity: input_boolean.ipm_new_show_active_4
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.ipm_new_active_4
                      name: Active 4
                    - entity: input_number.ipm_new_active_concentration_4
                      name: Active 4 – conc.
                    - entity: input_select.ipm_new_active_unit_4
                      name: Active 4 – unit
                    - entity: input_boolean.ipm_new_show_active_5
                      name: Show 5th Active
                  card_mod:
                    style: |
                      ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }

              # Active 5
              - type: conditional
                conditions:
                  - entity: input_boolean.ipm_new_show_active_5
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.ipm_new_active_5
                      name: Active 5
                    - entity: input_number.ipm_new_active_concentration_5
                      name: Active 5 – conc.
                    - entity: input_select.ipm_new_active_unit_5
                      name: Active 5 – unit
                    - entity: input_boolean.ipm_new_show_active_6
                      name: Show 6th Active
                  card_mod:
                    style: |
                      ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }

              # Active 6
              - type: conditional
                conditions:
                  - entity: input_boolean.ipm_new_show_active_6
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.ipm_new_active_6
                      name: Active 6
                    - entity: input_number.ipm_new_active_concentration_6
                      name: Active 6 – conc.
                    - entity: input_select.ipm_new_active_unit_6
                      name: Active 6 – unit
                  card_mod:
                    style: |
                      ha-card { --ha-card-background: #FFF1DE; border-radius: 14px; padding: 6px; }

############# Save product
              - type: custom:button-card
                name: SAVE PRODUCT
                icon: mdi:content-save
                tap_action:
                  action: call-service
                  service: script.ipm_save_product
                styles:
                  card:
                    - background: "Green"
                    - border-radius: 14px
                    - padding: 20px
                    - height: 90px
                  name:
                    - color: white
                    - font-size: 18px
                    - font-weight: 900
                  icon:
                    - color: white
                    - height: 34px
############################################# EOS ##########################
# Zero Product Form
##############################################
              # Zero stock (at selected location)
              - type: custom:button-card
                name: ZERO STOCK AT SELECTED LOCATION
                icon: mdi:trash-can-outline
                tap_action:
                  action: call-service
                  service: script.ipm_zero_product_location
                styles:
                  card:
                    - background: "#c62828"
                    - border-radius: 14px
                    - padding: 18px
                    - height: 90px
                  name:
                    - color: white
                    - font-size: 16px
                    - font-weight: 900
                    - text-align: center
                  icon:
                    - color: white
                    - height: 34px


  #################################################################
  # VIEW 3: Stock Overview (read-only)
  #################################################################
  - type: sections
    max_columns: 1
    title: Stock Overview
    path: ipm-overview
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                name: STOCK OVERVIEW

              - type: entities
                entities:
                  - entity: input_select.ipm_category
                    name: Category
                    icon: mdi:playlist-edit
                  - entity: input_select.ipm_subcategory_filter
                    name: Subcategory
                    icon: mdi:filter-variant
                  - entity: input_text.ipm_active_search
                    name: Search
                    icon: mdi:magnify
                card_mod:
                  style: |
                    ha-card { border-radius: 14px; padding: 6px 8px; }
                    .mdc-list-item__primary-text { font-size: 1.4rem !important; }
                    .mdc-text-field__input { font-size: 1.4rem !important; }

              - type: markdown
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 14px;
                      padding: 10px;
                      max-height: 70vh;
                      overflow-y: auto;
                    }
                content: >-
                  {% set products = state_attr('sensor.ipm_inventory_catalog','products') or [] %}
                  {% set category = states('input_select.ipm_category') %}
                  {% set subcat   = states('input_select.ipm_subcategory_filter') %}
                  {% set search   = states('input_text.ipm_active_search')|lower|trim %}

                  {% if not products %}
                    _No products found._
                  {% else %}
                    {# Category filter #}
                    {% if category not in ['All','',none] %}
                      {% set products = products | selectattr('category','eq',category) | list %}
                    {% endif %}

                    {# Subcategory filter #}
                    {% if subcat not in ['All Categories','',none] %}
                      {% set products = products | selectattr('subcategory','eq',subcat) | list %}
                    {% endif %}

                    {# Search filter (id + name) #}
                    {% if search != '' %}
                      {% set ns = namespace(list=[]) %}
                      {% for p in products %}
                        {% set nm  = (p.name | default('') | string | lower) %}
                        {% set pid = (p.id   | default('') | string | lower) %}
                        {% if search in nm or search in pid %}
                          {% set ns.list = ns.list + [p] %}
                        {% endif %}
                      {% endfor %}
                      {% set products = ns.list %}
                    {% endif %}

                    {% if not products %}
                      _No products match the current filters._
                    {% else %}
                      {% for p in products | sort(attribute='name') %}
                        {% set unit = p.unit | default('') %}
                        {% set sbl  = p.stock_by_location if p.stock_by_location is defined else {} %}
                        {% set total = (sbl.values() | sum) if sbl else (p.stock_on_hand | default(0)) %}

                        ### {{ p.name }} — {{ total|round(1) }} {{ unit }}
                        **{{ p.category }}**{% if p.subcategory %} / {{ p.subcategory }}{% endif %}

                        {% if sbl %}
                          {% for loc, qty in sbl.items() %}
                            - **{{ loc }}**: {{ qty|round(1) }} {{ unit }}
                          {% endfor %}
                        {% else %}
                          - _No location breakdown recorded_
                        {% endif %}

                        ---
                      {% endfor %}
                    {% endif %}
                  {% endif %}
