# =============================================================================
# HFM Dashboard Views - Hey Farmer Module
# PaddiSense Farm Management System
#
# Views:
#   1. Overview - Event summary and recent events
#   2. New Event - Step-by-step event wizard
#   3. History - View and manage past events
#   4. Settings - Module configuration
# =============================================================================

button_card_templates:
  #---------------------------------------------------------------------------
  # Section title bar (dark background for contrast)
  #---------------------------------------------------------------------------
  hfm_title:
    color_type: card
    color: "#E9E100"
    show_icon: false
    show_state: false
    styles:
      card:
        - height: 50px
        - border-radius: 12px
        - padding: 8px
        - background-color: "#E9E100"
      name:
        - font-size: 18px
        - font-weight: 700
        - text-align: center
        - color: black

  #---------------------------------------------------------------------------
  # Info display block (muted background)
  #---------------------------------------------------------------------------
  hfm_info_block:
    color_type: card
    color: "#546e7a"
    show_icon: false
    show_state: true
    tap_action:
      action: none
    styles:
      card:
        - height: 80px
        - border-radius: 12px
        - padding: 10px
      state:
        - font-size: 32px
        - font-weight: 800
        - text-align: center
        - color: white
      name:
        - font-size: 14px
        - font-weight: 600
        - text-align: center
        - color: white

  #---------------------------------------------------------------------------
  # Action button (primary color) - STANDARD HEIGHT 70px
  #---------------------------------------------------------------------------
  hfm_action:
    color_type: card
    color: "#0066cc"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Secondary action button - STANDARD HEIGHT 70px (was 60px, now consistent)
  #---------------------------------------------------------------------------
  hfm_secondary:
    color_type: card
    color: "#555555"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Success button (green) - STANDARD HEIGHT 70px
  #---------------------------------------------------------------------------
  hfm_success:
    color_type: card
    color: "#28a745"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Danger action button - STANDARD HEIGHT 70px
  #---------------------------------------------------------------------------
  hfm_danger:
    color_type: card
    color: "#dc3545"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Event type selection button
  #---------------------------------------------------------------------------
  hfm_type_btn:
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 90px
        - border-radius: 12px
        - background: '#A5A6A3'
      name:
        - font-size: 14px
        - font-weight: 600
        - color: black
      icon:
        - color: black
        - width: 36px

  #---------------------------------------------------------------------------
  # Stat chip (Mushroom-style)
  #---------------------------------------------------------------------------
  hfm_stat_chip:
    color_type: card
    color: "#A5A6A3"
    show_icon: true
    show_name: true
    show_state: true
    styles:
      card:
        - height: 50px
        - border-radius: 25px
        - padding: 0 16px
      grid:
        - grid-template-areas: '"i n s"'
        - grid-template-columns: 24px auto auto
        - gap: 8px
      name:
        - font-size: 12px
        - color: rgba(0,0,0,0.7)
        - justify-self: start
      state:
        - font-size: 18px
        - font-weight: 700
        - color: black
        - justify-self: end
      icon:
        - color: black
        - width: 22px

  #---------------------------------------------------------------------------
  # Navigation button - STANDARD HEIGHT 70px (was 60px, now consistent)
  #---------------------------------------------------------------------------
  hfm_nav:
    color_type: card
    color: "#37474f"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Time/Number selection button - for hour, duration numeric inputs
  # Usage: template: hfm_time_btn, variables: { value: 1, selected_color: '#43A047' }
  #---------------------------------------------------------------------------
  hfm_time_btn:
    show_icon: false
    variables:
      value: 1
      selected_color: '#43A047'
    styles:
      card:
        - height: 70px
        - border-radius: 10px
        - background: |
            [[[
              return parseInt(entity.state) === variables.value ? variables.selected_color : '#A5A6A3';
            ]]]
      name:
        - font-size: 18px
        - font-weight: 600
        - color: |
            [[[
              return parseInt(entity.state) === variables.value ? 'white' : 'black';
            ]]]

  #---------------------------------------------------------------------------
  # AM/PM selection button - for input_select string matching
  # Usage: template: hfm_ampm_btn, variables: { option: 'AM', selected_color: '#28a745' }
  #---------------------------------------------------------------------------
  hfm_ampm_btn:
    show_icon: false
    variables:
      option: 'AM'
      selected_color: '#28a745'
    styles:
      card:
        - height: 70px
        - border-radius: 10px
        - background: |
            [[[
              return entity.state === variables.option ? variables.selected_color : '#A5A6A3';
            ]]]
      name:
        - font-size: 18px
        - font-weight: 600
        - color: |
            [[[
              return entity.state === variables.option ? 'white' : 'black';
            ]]]

  #---------------------------------------------------------------------------
  # Duration button - slightly smaller font for "15m" style labels
  # Usage: template: hfm_duration_btn, variables: { value: 15 }
  #---------------------------------------------------------------------------
  hfm_duration_btn:
    show_icon: false
    variables:
      value: 15
    styles:
      card:
        - height: 70px
        - border-radius: 10px
        - background: |
            [[[
              return parseInt(entity.state) === variables.value ? '#43A047' : '#A5A6A3';
            ]]]
      name:
        - font-size: 16px
        - font-weight: 600
        - color: |
            [[[
              return parseInt(entity.state) === variables.value ? 'white' : 'black';
            ]]]

##############################################################################
# VIEWS
##############################################################################
views:
  #============================================================================
  # VIEW 1: OVERVIEW
  #============================================================================
  - title: Hey Farmer
    path: hfm
    icon: mdi:microphone
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              #----------------------------------------------------------------
              # TITLE
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                name: HEY FARMER

              #----------------------------------------------------------------
              # QUICK STATS
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_info_block
                    entity: sensor.hfm_events
                    name: Total Events
                    show_icon: false

                  - type: custom:button-card
                    template: hfm_info_block
                    entity: sensor.hfm_events_today
                    name: Today
                    show_icon: false

                  - type: custom:button-card
                    template: hfm_info_block
                    entity: sensor.hfm_pending_events
                    name: Pending
                    show_icon: false
                    color: |
                      [[[
                        return Number(entity.state) > 0 ? '#ffc107' : '#546e7a';
                      ]]]

              #----------------------------------------------------------------
              # EVENTS BY TYPE - Color-coded filter buttons
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                name: EVENTS BY TYPE

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    entity: sensor.hfm_events
                    name: Nutrient
                    icon: mdi:flask
                    show_icon: true
                    show_name: true
                    show_state: true
                    color_type: card
                    color: "#43a047"
                    state_display: |
                      [[[
                        const byType = entity.attributes.events_by_type || {};
                        return byType.nutrient || 0;
                      ]]]
                    styles:
                      card:
                        - height: 80px
                        - border-radius: 12px
                      icon:
                        - color: white
                        - width: 28px
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: white
                      state:
                        - font-size: 24px
                        - font-weight: 800
                        - color: white
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-history

                  - type: custom:button-card
                    entity: sensor.hfm_events
                    name: Chemical
                    icon: mdi:spray
                    show_icon: true
                    show_name: true
                    show_state: true
                    color_type: card
                    color: "#e53935"
                    state_display: |
                      [[[
                        const byType = entity.attributes.events_by_type || {};
                        return byType.chemical || 0;
                      ]]]
                    styles:
                      card:
                        - height: 80px
                        - border-radius: 12px
                      icon:
                        - color: white
                        - width: 28px
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: white
                      state:
                        - font-size: 24px
                        - font-weight: 800
                        - color: white
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-history

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    entity: sensor.hfm_events
                    name: Irrigation
                    icon: mdi:water
                    show_icon: true
                    show_name: true
                    show_state: true
                    color_type: card
                    color: "#1e88e5"
                    state_display: |
                      [[[
                        const byType = entity.attributes.events_by_type || {};
                        return byType.irrigation || 0;
                      ]]]
                    styles:
                      card:
                        - height: 80px
                        - border-radius: 12px
                      icon:
                        - color: white
                        - width: 28px
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: white
                      state:
                        - font-size: 24px
                        - font-weight: 800
                        - color: white
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-history

                  - type: custom:button-card
                    entity: sensor.hfm_events
                    name: Crop Stage
                    icon: mdi:sprout
                    show_icon: true
                    show_name: true
                    show_state: true
                    color_type: card
                    color: "#8d6e63"
                    state_display: |
                      [[[
                        const byType = entity.attributes.events_by_type || {};
                        return byType.crop_stage || 0;
                      ]]]
                    styles:
                      card:
                        - height: 80px
                        - border-radius: 12px
                      icon:
                        - color: white
                        - width: 28px
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: white
                      state:
                        - font-size: 24px
                        - font-weight: 800
                        - color: white
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-history

              #----------------------------------------------------------------
              # QUICK ACTIONS
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_action
                    name: New Event
                    icon: mdi:plus
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-new

                  - type: custom:button-card
                    template: hfm_secondary
                    name: Export
                    icon: mdi:export
                    tap_action:
                      action: call-service
                      service: script.hfm_export

  #============================================================================
  # VIEW 2: NEW EVENT WIZARD
  #============================================================================
  - title: New Event
    path: hfm-new
    icon: mdi:plus-circle
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              #----------------------------------------------------------------
              # WIZARD HEADER
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                entity: input_boolean.hfm_edit_mode
                name: |
                  [[[
                    const isEdit = entity.state === 'on';
                    const step = states['input_number.hfm_wizard_step'].state.split('.')[0];
                    return (isEdit ? 'EDIT EVENT' : 'NEW EVENT') + ' - STEP ' + step + ' OF 6';
                  ]]]

              #----------------------------------------------------------------
              # PROGRESS INDICATOR - With colors
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: Type
                    icon: mdi:numeric-1-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 1) return '#0066cc';
                              if (step > 1) return '#28a745';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 1 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 1 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 1

                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: When
                    icon: mdi:numeric-2-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 2) return '#0066cc';
                              if (step > 2) return '#28a745';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 2 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 2 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 2

                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: Where
                    icon: mdi:numeric-3-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 3) return '#0066cc';
                              if (step > 3) return '#28a745';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 3 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 3 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 3

                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: Details
                    icon: mdi:numeric-4-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 4) return '#0066cc';
                              if (step > 4) return '#28a745';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 4 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 4 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 4

                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: Notes
                    icon: mdi:numeric-5-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 5) return '#0066cc';
                              if (step > 5) return '#28a745';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 5 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 5 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 5

                  - type: custom:button-card
                    entity: input_number.hfm_wizard_step
                    name: Done
                    icon: mdi:numeric-6-circle
                    show_icon: true
                    show_name: true
                    styles:
                      card:
                        - height: 60px
                        - border-radius: 12px
                        - padding: 4px
                        - background: |
                            [[[
                              const step = parseInt(entity.state);
                              if (step === 6) return '#0066cc';
                              return '#A5A6A3';
                            ]]]
                      grid:
                        - grid-template-areas: '"i" "n"'
                        - grid-template-rows: 1fr min-content
                      icon:
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 6 ? 'white' : 'black';
                            ]]]
                        - width: 24px
                      name:
                        - font-size: 10px
                        - font-weight: 600
                        - color: |
                            [[[
                              const step = parseInt(entity.state);
                              return step >= 6 ? 'white' : 'black';
                            ]]]
                    tap_action:
                      action: call-service
                      service: input_number.set_value
                      target:
                        entity_id: input_number.hfm_wizard_step
                      data:
                        value: 6

              #----------------------------------------------------------------
              # STEP 1: EVENT TYPE
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "1.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: WHAT TYPE OF EVENT?

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          name: Nutrient
                          icon: mdi:flask
                          entity: input_select.hfm_event_type
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Nutrient Application' ? '#43a047' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Nutrient Application' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Nutrient Application' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_event_type
                            data:
                              option: "Nutrient Application"

                        - type: custom:button-card
                          name: Chemical
                          icon: mdi:spray
                          entity: input_select.hfm_event_type
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Chemical Application' ? '#e53935' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Chemical Application' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Chemical Application' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_event_type
                            data:
                              option: "Chemical Application"

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          name: Irrigation
                          icon: mdi:water
                          entity: input_select.hfm_event_type
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Irrigation' ? '#1e88e5' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Irrigation' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Irrigation' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_event_type
                            data:
                              option: "Irrigation"

                        - type: custom:button-card
                          name: Crop Stage
                          icon: mdi:sprout
                          entity: input_select.hfm_event_type
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Crop Stage' ? '#8d6e63' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Crop Stage' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Crop Stage' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_event_type
                            data:
                              option: "Crop Stage"

                    - type: markdown
                      content: |
                        **Selected:** {{ states('input_select.hfm_event_type') }}
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            text-align: center;
                            padding: 8px;
                            background: rgba(25, 118, 210, 0.2);
                          }

              #----------------------------------------------------------------
              # STEP 2: WHEN
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "2.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: WHEN DID THIS HAPPEN?

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          name: Today
                          icon: mdi:calendar-today
                          entity: input_select.hfm_when
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Today' ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Today' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Today' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_when
                            data:
                              option: "Today"

                        - type: custom:button-card
                          name: Yesterday
                          icon: mdi:calendar-arrow-left
                          entity: input_select.hfm_when
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Yesterday' ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Yesterday' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Yesterday' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_when
                            data:
                              option: "Yesterday"

                        - type: custom:button-card
                          name: Other
                          icon: mdi:calendar-edit
                          entity: input_select.hfm_when
                          show_icon: true
                          show_name: true
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - background: |
                                  [[[
                                    return entity.state === 'Specific Date' ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 14px
                              - font-weight: 600
                              - color: |
                                  [[[
                                    return entity.state === 'Specific Date' ? 'white' : 'black';
                                  ]]]
                            icon:
                              - color: |
                                  [[[
                                    return entity.state === 'Specific Date' ? 'white' : 'black';
                                  ]]]
                              - width: 36px
                          tap_action:
                            action: call-service
                            service: input_select.select_option
                            target:
                              entity_id: input_select.hfm_when
                            data:
                              option: "Specific Date"

                    - type: conditional
                      conditions:
                        - entity: input_select.hfm_when
                          state: "Specific Date"
                      card:
                        type: entities
                        entities:
                          - entity: input_text.hfm_specific_date
                            name: Date (YYYY-MM-DD)
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                            }

                    - type: markdown
                      content: |
                        **Event date:** {{ states('sensor.hfm_event_date') }}
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            text-align: center;
                            padding: 8px;
                            background: rgba(25, 118, 210, 0.2);
                          }

                    # Time and Duration (Chemical/Nutrient only)
                    - type: conditional
                      conditions:
                        - condition: or
                          conditions:
                            - entity: input_select.hfm_event_type
                              state: "Chemical Application"
                            - entity: input_select.hfm_event_type
                              state: "Nutrient Application"
                      card:
                        type: vertical-stack
                        cards:
                          # Time Selection Title
                          - type: custom:button-card
                            template: hfm_title
                            name: SELECT START TIME

                          # Hour buttons - Row 1 (1-4)
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "1"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 1
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 1
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "2"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 2
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 2
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "3"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 3
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 3
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "4"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 4
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 4

                          # Hour buttons - Row 2 (5-8)
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "5"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 5
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 5
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "6"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 6
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 6
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "7"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 7
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 7
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "8"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 8
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 8

                          # Hour buttons - Row 3 (9-12)
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "9"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 9
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 9
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "10"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 10
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 10
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "11"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 11
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 11
                              - type: custom:button-card
                                template: hfm_time_btn
                                name: "12"
                                entity: input_number.hfm_hour
                                variables:
                                  value: 12
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_hour
                                  data:
                                    value: 12

                          # AM/PM Toggle
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_ampm_btn
                                name: "AM"
                                entity: input_select.hfm_ampm
                                variables:
                                  option: 'AM'
                                tap_action:
                                  action: call-service
                                  service: input_select.select_option
                                  target:
                                    entity_id: input_select.hfm_ampm
                                  data:
                                    option: "AM"
                              - type: custom:button-card
                                template: hfm_ampm_btn
                                name: "PM"
                                entity: input_select.hfm_ampm
                                variables:
                                  option: 'PM'
                                tap_action:
                                  action: call-service
                                  service: input_select.select_option
                                  target:
                                    entity_id: input_select.hfm_ampm
                                  data:
                                    option: "PM"

                          # Duration Title
                          - type: custom:button-card
                            template: hfm_title
                            name: DURATION

                          # Duration buttons - Row 1
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "15m"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 15
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 15
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "30m"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 30
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 30
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "45m"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 45
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 45
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "1hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 60
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 60

                          # Duration buttons - Row 2
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "1.5hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 90
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 90
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "2hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 120
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 120
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "3hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 180
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 180
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "4hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 240
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 240

                          # Duration buttons - Row 3
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "5hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 300
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 300
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "6hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 360
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 360
                              - type: custom:button-card
                                template: hfm_duration_btn
                                name: "8hr"
                                entity: input_number.hfm_duration_minutes
                                variables:
                                  value: 480
                                tap_action:
                                  action: call-service
                                  service: input_number.set_value
                                  target:
                                    entity_id: input_number.hfm_duration_minutes
                                  data:
                                    value: 480

                          # Time/Duration Summary
                          - type: markdown
                            content: |
                              {% set hour = states('input_number.hfm_hour') | int %}
                              {% set ampm = states('input_select.hfm_ampm') %}
                              {% set dur = states('input_number.hfm_duration_minutes') | int %}
                              {% set dur_hr = dur // 60 %}
                              {% set dur_min = dur % 60 %}
                              {% set dur_str = '' %}
                              {% if dur_hr > 0 %}{% set dur_str = dur_hr ~ 'hr' %}{% endif %}
                              {% if dur_min > 0 %}{% set dur_str = dur_str ~ ' ' ~ dur_min ~ 'min' %}{% endif %}
                              {% if hour > 0 %}**Start:** {{ hour }}:00 {{ ampm }}{% endif %}
                              {% if dur > 0 %} | **Duration:** {{ dur_str | trim }}{% endif %}
                            card_mod:
                              style: |
                                ha-card {
                                  border-radius: 12px;
                                  text-align: center;
                                  padding: 8px;
                                  background: rgba(25, 118, 210, 0.2);
                                }

              #----------------------------------------------------------------
              # STEP 3: PADDOCK SELECTION (Multi-Farm, Multi-Paddock)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "3.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: SELECT PADDOCK(S)

                    # Farm Selection
                    - type: entities
                      entities:
                        - entity: input_select.hfm_selected_farm
                          name: Farm
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            margin-bottom: 8px;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.4rem !important;
                            font-weight: 600 !important;
                          }

                    # Quick actions row (All, Clear, Season)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          name: All
                          icon: mdi:checkbox-multiple-marked
                          color_type: card
                          color: "#8E44AD"
                          styles:
                            card:
                              - height: 70px
                              - border-radius: 12px
                            name:
                              - font-size: 16px
                              - font-weight: 700
                              - color: white
                            icon:
                              - color: white
                          tap_action:
                            action: call-service
                            service: script.hfm_select_all_paddocks

                        - type: custom:button-card
                          name: Clear
                          icon: mdi:checkbox-multiple-blank-outline
                          color_type: card
                          color: "#dc3545"
                          styles:
                            card:
                              - height: 70px
                              - border-radius: 12px
                            name:
                              - font-size: 16px
                              - font-weight: 700
                              - color: white
                            icon:
                              - color: white
                          tap_action:
                            action: call-service
                            service: script.hfm_clear_paddock_selection

                        - type: custom:button-card
                          name: Season
                          icon: mdi:calendar-check
                          color_type: card
                          color: "#ffc107"
                          styles:
                            card:
                              - height: 70px
                              - border-radius: 12px
                            name:
                              - font-size: 16px
                              - font-weight: 700
                              - color: black
                            icon:
                              - color: black
                          tap_action:
                            action: call-service
                            service: script.hfm_select_current_season_paddocks

                    # Paddock buttons - Row 1
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[0]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[0]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 0 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[0]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[0]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[1]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[1]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 1 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[1]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[1]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 2
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[2]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[2]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 2 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[2]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[2]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[3]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[3]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 3 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[3]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[3]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 3
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[4]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[4]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 4 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[4]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[4]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[5]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[5]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 5 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[5]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[5]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 4 (indices 6-7)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[6]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[6]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 6 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[6]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[6]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[7]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[7]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 7 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[7]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[7]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 5 (indices 8-9)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[8]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[8]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 8 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[8]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[8]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[9]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[9]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 9 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[9]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[9]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 6 (indices 10-11)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[10]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[10]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 10 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[10]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[10]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[11]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[11]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 11 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[11]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[11]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 7 (indices 12-13)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[12]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[12]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 12 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[12]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[12]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[13]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[13]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 13 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[13]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[13]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 8 (indices 14-15)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[14]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[14]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 14 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[14]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[14]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[15]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[15]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 15 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[15]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[15]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 9 (indices 16-17)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[16]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[16]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 16 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[16]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[16]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[17]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[17]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 17 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[17]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[17]?.id) ? 'white' : 'black';
                                  ]]]

                    # Paddock buttons - Row 10 (indices 18-19)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[18]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[18]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 18 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[18]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[18]?.id) ? 'white' : 'black';
                                  ]]]
                        - type: custom:button-card
                          entity: sensor.hfm_drafts
                          show_name: true
                          show_icon: false
                          tap_action:
                            action: call-service
                            service: script.hfm_toggle_paddock
                            service_data:
                              paddock_id: |
                                [[[
                                  const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                  const farms = entity?.attributes?.farms || {};
                                  let farmId = '';
                                  for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                  const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                  return paddocks[19]?.id || '';
                                ]]]
                          name: |
                            [[[
                              const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                              const farms = entity?.attributes?.farms || {};
                              let farmId = '';
                              for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                              const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                              return paddocks[19]?.name || '';
                            ]]]
                          styles:
                            card:
                              - height: 90px
                              - border-radius: 12px
                              - display: |
                                  [[[
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return paddocks.length > 19 ? 'flex' : 'none';
                                  ]]]
                              - background: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[19]?.id) ? '#28a745' : '#A5A6A3';
                                  ]]]
                            name:
                              - font-size: 18px
                              - font-weight: 700
                              - color: |
                                  [[[
                                    const deviceId = states['input_text.hfm_current_device']?.state || '';
                                    const draft = (entity?.attributes?.drafts || {})[deviceId] || {};
                                    const selected = draft.data?.paddocks || [];
                                    const selectedFarm = states['input_select.hfm_selected_farm']?.state || '';
                                    const farms = entity?.attributes?.farms || {};
                                    let farmId = '';
                                    for (const fid in farms) { if (farms[fid] === selectedFarm) { farmId = fid; break; } }
                                    const paddocks = (entity?.attributes?.paddocks_by_farm || {})[farmId] || [];
                                    return selected.includes(paddocks[19]?.id) ? 'white' : 'black';
                                  ]]]

                    # Selected paddocks summary
                    - type: markdown
                      content: |
                        {% set device_id = states('input_text.hfm_current_device') %}
                        {% if device_id %}
                          {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
                          {% set draft = drafts.get(device_id, {}) %}
                          {% set paddocks = draft.get('data', {}).get('paddocks', []) %}
                          {% set pmap = state_attr('sensor.hfm_drafts', 'paddock_map') or {} %}
                          {% if paddocks | length > 0 %}
                          **Selected ({{ paddocks | length }}):** {% for pid in paddocks %}{{ pmap.get(pid, pid) }}{% if not loop.last %}, {% endif %}{% endfor %}
                          {% else %}
                          *Tap paddocks to select them*
                          {% endif %}
                        {% else %}
                          {% set paddock = states('input_select.hfm_selected_paddock') %}
                          {% if paddock != 'Select Paddock' %}
                          **Selected:** {{ paddock }}
                          {% else %}
                          *Please select a paddock*
                          {% endif %}
                        {% endif %}
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            text-align: center;
                            padding: 8px;
                            background: rgba(25, 118, 210, 0.2);
                          }

              #----------------------------------------------------------------
              # STEP 4: DETAILS
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "4.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: EVENT DETAILS

                    # Nutrient/Chemical: Multiple Products + Method
                    - type: conditional
                      conditions:
                        - condition: or
                          conditions:
                            - entity: input_select.hfm_event_type
                              state: "Nutrient Application"
                            - entity: input_select.hfm_event_type
                              state: "Chemical Application"
                      card:
                        type: vertical-stack
                        cards:
                          # Product 1 (always shown)
                          - type: custom:button-card
                            color_type: card
                            color: "#C2185B"
                            show_icon: false
                            show_name: true
                            show_state: false
                            name: "Product 1"
                            styles:
                              card:
                                - height: 36px
                                - border-radius: 12px 12px 0 0
                                - margin-bottom: 0
                              name:
                                - font-size: 14px
                                - font-weight: 600
                                - color: white

                          - type: entities
                            entities:
                              - entity: input_select.hfm_selected_product
                                name: Product
                              - entity: input_text.hfm_product_rate
                                name: Rate
                              - entity: input_text.hfm_rate_unit
                                name: Unit
                            card_mod:
                              style: |
                                ha-card {
                                  border-radius: 0 0 12px 12px;
                                  margin-top: 0;
                                }

                          # Product 2
                          - type: conditional
                            conditions:
                              - condition: numeric_state
                                entity: input_number.hfm_product_count
                                above: 1
                            card:
                              type: vertical-stack
                              cards:
                                - type: custom:button-card
                                  color_type: card
                                  color: "#C2185B"
                                  show_icon: false
                                  show_name: true
                                  name: "Product 2"
                                  styles:
                                    card:
                                      - height: 36px
                                      - border-radius: 12px 12px 0 0
                                      - margin-top: 8px
                                    name:
                                      - font-size: 14px
                                      - font-weight: 600
                                      - color: white

                                - type: entities
                                  entities:
                                    - entity: input_select.hfm_selected_product_2
                                      name: Product
                                    - entity: input_text.hfm_product_rate_2
                                      name: Rate
                                    - entity: input_text.hfm_rate_unit_2
                                      name: Unit
                                  card_mod:
                                    style: |
                                      ha-card {
                                        border-radius: 0 0 12px 12px;
                                      }

                          # Product 3
                          - type: conditional
                            conditions:
                              - condition: numeric_state
                                entity: input_number.hfm_product_count
                                above: 2
                            card:
                              type: vertical-stack
                              cards:
                                - type: custom:button-card
                                  color_type: card
                                  color: "#C2185B"
                                  show_icon: false
                                  show_name: true
                                  name: "Product 3"
                                  styles:
                                    card:
                                      - height: 36px
                                      - border-radius: 12px 12px 0 0
                                      - margin-top: 8px
                                    name:
                                      - font-size: 14px
                                      - font-weight: 600
                                      - color: white

                                - type: entities
                                  entities:
                                    - entity: input_select.hfm_selected_product_3
                                      name: Product
                                    - entity: input_text.hfm_product_rate_3
                                      name: Rate
                                    - entity: input_text.hfm_rate_unit_3
                                      name: Unit
                                  card_mod:
                                    style: |
                                      ha-card {
                                        border-radius: 0 0 12px 12px;
                                      }

                          # Product 4
                          - type: conditional
                            conditions:
                              - condition: numeric_state
                                entity: input_number.hfm_product_count
                                above: 3
                            card:
                              type: vertical-stack
                              cards:
                                - type: custom:button-card
                                  color_type: card
                                  color: "#C2185B"
                                  show_icon: false
                                  show_name: true
                                  name: "Product 4"
                                  styles:
                                    card:
                                      - height: 36px
                                      - border-radius: 12px 12px 0 0
                                      - margin-top: 8px
                                    name:
                                      - font-size: 14px
                                      - font-weight: 600
                                      - color: white

                                - type: entities
                                  entities:
                                    - entity: input_select.hfm_selected_product_4
                                      name: Product
                                    - entity: input_text.hfm_product_rate_4
                                      name: Rate
                                    - entity: input_text.hfm_rate_unit_4
                                      name: Unit
                                  card_mod:
                                    style: |
                                      ha-card {
                                        border-radius: 0 0 12px 12px;
                                      }

                          # Product 5
                          - type: conditional
                            conditions:
                              - condition: numeric_state
                                entity: input_number.hfm_product_count
                                above: 4
                            card:
                              type: vertical-stack
                              cards:
                                - type: custom:button-card
                                  color_type: card
                                  color: "#C2185B"
                                  show_icon: false
                                  show_name: true
                                  name: "Product 5"
                                  styles:
                                    card:
                                      - height: 36px
                                      - border-radius: 12px 12px 0 0
                                      - margin-top: 8px
                                    name:
                                      - font-size: 14px
                                      - font-weight: 600
                                      - color: white

                                - type: entities
                                  entities:
                                    - entity: input_select.hfm_selected_product_5
                                      name: Product
                                    - entity: input_text.hfm_product_rate_5
                                      name: Rate
                                    - entity: input_text.hfm_rate_unit_5
                                      name: Unit
                                  card_mod:
                                    style: |
                                      ha-card {
                                        border-radius: 0 0 12px 12px;
                                      }

                          # Product 6
                          - type: conditional
                            conditions:
                              - condition: numeric_state
                                entity: input_number.hfm_product_count
                                above: 5
                            card:
                              type: vertical-stack
                              cards:
                                - type: custom:button-card
                                  color_type: card
                                  color: "#C2185B"
                                  show_icon: false
                                  show_name: true
                                  name: "Product 6"
                                  styles:
                                    card:
                                      - height: 36px
                                      - border-radius: 12px 12px 0 0
                                      - margin-top: 8px
                                    name:
                                      - font-size: 14px
                                      - font-weight: 600
                                      - color: white

                                - type: entities
                                  entities:
                                    - entity: input_select.hfm_selected_product_6
                                      name: Product
                                    - entity: input_text.hfm_product_rate_6
                                      name: Rate
                                    - entity: input_text.hfm_rate_unit_6
                                      name: Unit
                                  card_mod:
                                    style: |
                                      ha-card {
                                        border-radius: 0 0 12px 12px;
                                      }

                          # Add/Remove product buttons
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: hfm_action
                                name: Add Product
                                icon: mdi:plus
                                entity: input_number.hfm_product_count
                                color: "#0066cc"
                                state:
                                  - value: 6
                                    color: "#555555"
                                tap_action:
                                  action: call-service
                                  service: script.hfm_add_product_slot

                              - type: custom:button-card
                                template: hfm_secondary
                                name: Remove
                                icon: mdi:minus
                                entity: input_number.hfm_product_count
                                state:
                                  - value: 1
                                    color: "#555555"
                                tap_action:
                                  action: call-service
                                  service: script.hfm_remove_product_slot

                          # Applicator Selection (dropdown first, then display card)
                          - type: entities
                            entities:
                              - entity: input_select.hfm_selected_applicator
                                name: Select Applicator
                            card_mod:
                              style: |
                                ha-card {
                                  border-radius: 12px;
                                  margin-top: 8px;
                                }
                                .mdc-list-item__primary-text {
                                  font-size: 1.1rem !important;
                                }

                          - type: custom:button-card
                            entity: input_select.hfm_selected_applicator
                            triggers_update:
                              - input_select.hfm_selected_applicator
                              - sensor.hfm_events
                            show_icon: false
                            show_name: false
                            show_state: false
                            styles:
                              card:
                                - background: transparent
                                - box-shadow: none
                                - padding: 0
                                - margin-top: 8px
                              grid:
                                - display: block
                              custom_fields:
                                applicator:
                                  - width: 100%
                            custom_fields:
                              applicator: |
                                [[[
                                  try {
                                    const selected = entity?.state || '';
                                    const applicators = states['sensor.hfm_events']?.attributes?.applicators || [];
                                    let app = null;
                                    for (const a of applicators) {
                                      if (a.name === selected) { app = a; break; }
                                    }

                                    // Don't show card if nothing selected
                                    if (!selected || selected === 'Select Applicator') {
                                      return '';
                                    }

                                    const cfg = { icon: 'mdi:tractor', color: '#C2185B', bg: 'rgba(194,24,91,0.15)' };

                                    let html = `<div style="background:var(--card-background-color,#fff);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-left:4px solid ${cfg.color};">`;

                                    // Header with icon
                                    html += `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">`;
                                    html += `<div style="width:44px;height:44px;border-radius:50%;background:${cfg.bg};display:flex;align-items:center;justify-content:center;">
                                              <ha-icon icon="${cfg.icon}" style="--mdc-icon-size:24px;color:${cfg.color};"></ha-icon>
                                            </div>`;
                                    html += `<div style="flex:1;">`;
                                    html += `<div style="font-size:16px;font-weight:700;color:var(--primary-text-color);">${selected}</div>`;
                                    html += `<div style="font-size:13px;color:var(--secondary-text-color);">Equipment Details</div>`;
                                    html += `</div></div>`;

                                    if (!app) {
                                      html += `<div style="text-align:center;color:var(--secondary-text-color);padding:8px;font-style:italic;">Equipment not found in registry</div>`;
                                    } else {
                                      const attr = app.attributes || {};

                                      // Details grid
                                      html += `<div style="display:grid;gap:6px;">`;

                                      // Method row
                                      html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                <span style="font-size:14px;color:var(--secondary-text-color);">Method</span>
                                                <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${app.application_method || 'Not set'}</span>
                                              </div>`;

                                      if (attr.nozzle_type) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Nozzle</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.nozzle_type}</span>
                                                </div>`;
                                      }
                                      if (attr.spray_width_m) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Spray Width</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.spray_width_m}m</span>
                                                </div>`;
                                      }
                                      if (attr.water_rate_l_ha) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Water Rate</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.water_rate_l_ha} L/ha</span>
                                                </div>`;
                                      }
                                      if (attr.tank_size_l) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Tank Size</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.tank_size_l}L</span>
                                                </div>`;
                                      }
                                      if (attr.spread_width_m) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Spread Width</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.spread_width_m}m</span>
                                                </div>`;
                                      }
                                      if (attr.capacity_t) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Capacity</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.capacity_t}t</span>
                                                </div>`;
                                      }
                                      if (attr.vehicle) {
                                        html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                                  <span style="font-size:14px;color:var(--secondary-text-color);">Vehicle</span>
                                                  <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${attr.vehicle}</span>
                                                </div>`;
                                      }

                                      html += `</div>`;
                                    }

                                    html += `</div>`;
                                    return html;
                                  } catch (err) {
                                    return `<div style="padding:12px;color:#f44336;">Error: ${err}</div>`;
                                  }
                                ]]]
                            tap_action:
                              action: more-info

                    # Weather Phases Card (Chemical Application only)
                    - type: conditional
                      conditions:
                        - entity: input_select.hfm_event_type
                          state: "Chemical Application"
                      card:
                        type: vertical-stack
                        cards:
                          - type: custom:button-card
                            template: hfm_title
                            name: "SPRAY WEATHER (Auto-Captured)"

                          # Weather Status Row - Hold to clear a phase
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                entity: sensor.hfm_weather_start
                                name: |
                                  [[[
                                    const time = states['sensor.hfm_spray_start_time']?.state || '';
                                    return 'START\n' + time;
                                  ]]]
                                icon: |
                                  [[[
                                    return entity?.state === 'Captured' ? 'mdi:check-circle' : 'mdi:clock-outline';
                                  ]]]
                                show_icon: true
                                show_name: true
                                styles:
                                  card:
                                    - height: 50px
                                    - border-radius: 0
                                    - background: |
                                        [[[
                                          return entity?.state === 'Captured' ? 'rgba(40, 167, 69, 0.2)' : 'rgba(117, 117, 117, 0.1)';
                                        ]]]
                                  name:
                                    - font-size: 10px
                                    - font-weight: 600
                                    - white-space: pre-line
                                  icon:
                                    - color: |
                                        [[[
                                          return entity?.state === 'Captured' ? '#28a745' : '#757575';
                                        ]]]
                                tap_action:
                                  action: none
                                hold_action:
                                  action: call-service
                                  service: script.hfm_clear_weather_phase
                                  service_data:
                                    phase: start
                                  confirmation:
                                    text: "Clear START weather data?"

                              - type: custom:button-card
                                entity: sensor.hfm_weather_mid
                                name: |
                                  [[[
                                    const time = states['sensor.hfm_spray_mid_time']?.state || '';
                                    return 'MID\n' + time;
                                  ]]]
                                icon: |
                                  [[[
                                    return entity?.state === 'Captured' ? 'mdi:check-circle' : 'mdi:clock-outline';
                                  ]]]
                                show_icon: true
                                show_name: true
                                styles:
                                  card:
                                    - height: 50px
                                    - border-radius: 0
                                    - background: |
                                        [[[
                                          return entity?.state === 'Captured' ? 'rgba(40, 167, 69, 0.2)' : 'rgba(117, 117, 117, 0.1)';
                                        ]]]
                                  name:
                                    - font-size: 10px
                                    - font-weight: 600
                                    - white-space: pre-line
                                  icon:
                                    - color: |
                                        [[[
                                          return entity?.state === 'Captured' ? '#28a745' : '#757575';
                                        ]]]
                                tap_action:
                                  action: none
                                hold_action:
                                  action: call-service
                                  service: script.hfm_clear_weather_phase
                                  service_data:
                                    phase: mid
                                  confirmation:
                                    text: "Clear MID weather data?"

                              - type: custom:button-card
                                entity: sensor.hfm_weather_end
                                name: |
                                  [[[
                                    const time = states['sensor.hfm_spray_end_time']?.state || '';
                                    return 'END\n' + time;
                                  ]]]
                                icon: |
                                  [[[
                                    return entity?.state === 'Captured' ? 'mdi:check-circle' : 'mdi:clock-outline';
                                  ]]]
                                show_icon: true
                                show_name: true
                                styles:
                                  card:
                                    - height: 50px
                                    - border-radius: 0
                                    - background: |
                                        [[[
                                          return entity?.state === 'Captured' ? 'rgba(40, 167, 69, 0.2)' : 'rgba(117, 117, 117, 0.1)';
                                        ]]]
                                  name:
                                    - font-size: 10px
                                    - font-weight: 600
                                    - white-space: pre-line
                                  icon:
                                    - color: |
                                        [[[
                                          return entity?.state === 'Captured' ? '#28a745' : '#757575';
                                        ]]]
                                tap_action:
                                  action: none
                                hold_action:
                                  action: call-service
                                  service: script.hfm_clear_weather_phase
                                  service_data:
                                    phase: end
                                  confirmation:
                                    text: "Clear END weather data?"

                          # Weather Data Table (Markdown)
                          - type: markdown
                            content: |
                              {% set device_id = states('input_text.hfm_current_device') %}
                              {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
                              {% set draft = drafts.get(device_id, {}) %}
                              {% set data = draft.get('data', {}) %}
                              {% set ws = data.get('weather_start') %}
                              {% set wm = data.get('weather_mid') %}
                              {% set we = data.get('weather_end') %}
                              {% set source = ws.source if ws else (wm.source if wm else (we.source if we else none)) %}
                              {% if source %}**Data Source:** {{ source }}{% endif %}

                              | | START | MID | END |
                              |:--|:--:|:--:|:--:|
                              | **Wind** | {{ ws.wind_speed if ws else '-' }} | {{ wm.wind_speed if wm else '-' }} | {{ we.wind_speed if we else '-' }} |
                              | **Gust** | {{ ws.wind_gust if ws else '-' }} | {{ wm.wind_gust if wm else '-' }} | {{ we.wind_gust if we else '-' }} |
                              | **Dir** | {{ ws.wind_direction if ws else '-' }} | {{ wm.wind_direction if wm else '-' }} | {{ we.wind_direction if we else '-' }} |
                              | **T** | {{ ws.delta_t if ws else '-' }} | {{ wm.delta_t if wm else '-' }} | {{ we.delta_t if we else '-' }} |
                              | **Hum** | {{ ws.humidity if ws else '-' }}% | {{ wm.humidity if wm else '-' }}% | {{ we.humidity if we else '-' }}% |
                              | **Rain** | {{ ws.rain_chance_pct if ws else '-' }}% | {{ wm.rain_chance_pct if wm else '-' }}% | {{ we.rain_chance_pct if we else '-' }}% |
                            card_mod:
                              style: |
                                ha-card {
                                  border-radius: 0 0 12px 12px;
                                  padding: 12px;
                                }
                                table {
                                  width: 100%;
                                  font-size: 14px;
                                }
                                th, td {
                                  padding: 4px 6px;
                                }

                    # Irrigation: Type selection
                    - type: conditional
                      conditions:
                        - entity: input_select.hfm_event_type
                          state: "Irrigation"
                      card:
                        type: entities
                        entities:
                          - entity: input_select.hfm_irrigation_type
                            name: Irrigation Type
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                            }
                            .mdc-list-item__primary-text {
                              font-size: 1.2rem !important;
                            }

                    # Crop Stage: Stage selection
                    - type: conditional
                      conditions:
                        - entity: input_select.hfm_event_type
                          state: "Crop Stage"
                      card:
                        type: entities
                        entities:
                          - entity: input_select.hfm_crop_stage
                            name: Crop Stage
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                            }
                            .mdc-list-item__primary-text {
                              font-size: 1.2rem !important;
                            }

              #----------------------------------------------------------------
              # STEP 5: NOTES
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "5.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: ADDITIONAL NOTES (OPTIONAL)

                    - type: entities
                      entities:
                        - entity: input_text.hfm_notes
                          name: Notes
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                          }

              #----------------------------------------------------------------
              # STEP 6: CONFIRM
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - entity: input_number.hfm_wizard_step
                    state: "6.0"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_title
                      name: REVIEW & CONFIRM

                    # Summary card like IPM stock cards
                    - type: custom:button-card
                      entity: input_select.hfm_event_type
                      show_icon: false
                      show_name: false
                      show_state: false
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                          - padding: 0
                          - margin: 0
                        grid:
                          - display: block
                        custom_fields:
                          summary:
                            - width: 100%
                      custom_fields:
                        summary: |
                          [[[
                            try {
                              const typeConfig = {
                                'Nutrient Application': { icon: 'mdi:flask', color: '#43a047', bg: 'rgba(67,160,71,0.15)', label: 'Nutrient' },
                                'Chemical Application': { icon: 'mdi:spray', color: '#e53935', bg: 'rgba(229,57,53,0.15)', label: 'Chemical' },
                                'Irrigation': { icon: 'mdi:water', color: '#1e88e5', bg: 'rgba(30,136,229,0.15)', label: 'Irrigation' },
                                'Crop Stage': { icon: 'mdi:sprout', color: '#8d6e63', bg: 'rgba(141,110,99,0.15)', label: 'Crop Stage' }
                              };

                              if (!entity || !entity.state) {
                                return `<div style="text-align:center;padding:20px;color:var(--secondary-text-color);">Loading...</div>`;
                              }

                              const eventType = entity.state;
                              const cfg = typeConfig[eventType] || { icon: 'mdi:calendar', color: '#757575', bg: 'rgba(117,117,117,0.15)', label: eventType };

                              const eventDate = states['sensor.hfm_event_date']?.state || '';
                              const method = states['input_select.hfm_application_method']?.state || '';
                              const productCount = parseInt(states['input_number.hfm_product_count']?.state) || 1;

                              // Get applicator
                              const applicator = states['input_select.hfm_selected_applicator']?.state || '';

                              // Get weather summary
                              const weatherSummary = states['sensor.hfm_weather_summary']?.state || '';

                              // Get start time and duration
                              const startTime = states['input_text.hfm_start_time']?.state || '';
                              const duration = states['input_number.hfm_duration_minutes']?.state || '';

                              // Multi-paddock support - check draft first
                              const deviceId = states['input_text.hfm_current_device']?.state || '';
                              const draftsAttr = states['sensor.hfm_drafts']?.attributes || {};
                              const drafts = draftsAttr.drafts || {};
                              const draft = drafts[deviceId] || {};
                              const draftPaddocks = draft.data?.paddocks || [];
                              const paddockMap = draftsAttr.paddock_map || {};

                              // Get paddock display
                              let paddockDisplay = '';
                              if (draftPaddocks.length > 0) {
                                const paddockNames = draftPaddocks.map(pid => paddockMap[pid] || pid);
                                paddockDisplay = paddockNames.length > 3 ?
                                  paddockNames.slice(0, 3).join(', ') + ` +${paddockNames.length - 3} more` :
                                  paddockNames.join(', ');
                              } else {
                                paddockDisplay = states['input_select.hfm_selected_paddock']?.state || '';
                              }
                              const paddockCount = draftPaddocks.length || (paddockDisplay && paddockDisplay !== 'Select Paddock' ? 1 : 0);

                              // Build products array from all slots
                              const products = [];
                              const p1 = states['input_select.hfm_selected_product']?.state;
                              const r1 = states['input_text.hfm_product_rate']?.state;
                              const u1 = states['input_text.hfm_rate_unit']?.state;
                              if (p1 && p1 !== 'Select Product' && r1) {
                                products.push({name: p1, rate: r1, unit: u1});
                              }
                              if (productCount >= 2) {
                                const p2 = states['input_select.hfm_selected_product_2']?.state;
                                const r2 = states['input_text.hfm_product_rate_2']?.state;
                                const u2 = states['input_text.hfm_rate_unit_2']?.state;
                                if (p2 && p2 !== 'Select Product' && r2) {
                                  products.push({name: p2, rate: r2, unit: u2});
                                }
                              }
                              if (productCount >= 3) {
                                const p3 = states['input_select.hfm_selected_product_3']?.state;
                                const r3 = states['input_text.hfm_product_rate_3']?.state;
                                const u3 = states['input_text.hfm_rate_unit_3']?.state;
                                if (p3 && p3 !== 'Select Product' && r3) {
                                  products.push({name: p3, rate: r3, unit: u3});
                                }
                              }
                              if (productCount >= 4) {
                                const p4 = states['input_select.hfm_selected_product_4']?.state;
                                const r4 = states['input_text.hfm_product_rate_4']?.state;
                                const u4 = states['input_text.hfm_rate_unit_4']?.state;
                                if (p4 && p4 !== 'Select Product' && r4) {
                                  products.push({name: p4, rate: r4, unit: u4});
                                }
                              }
                              if (productCount >= 5) {
                                const p5 = states['input_select.hfm_selected_product_5']?.state;
                                const r5 = states['input_text.hfm_product_rate_5']?.state;
                                const u5 = states['input_text.hfm_rate_unit_5']?.state;
                                if (p5 && p5 !== 'Select Product' && r5) {
                                  products.push({name: p5, rate: r5, unit: u5});
                                }
                              }
                              if (productCount >= 6) {
                                const p6 = states['input_select.hfm_selected_product_6']?.state;
                                const r6 = states['input_text.hfm_product_rate_6']?.state;
                                const u6 = states['input_text.hfm_rate_unit_6']?.state;
                                if (p6 && p6 !== 'Select Product' && r6) {
                                  products.push({name: p6, rate: r6, unit: u6});
                                }
                              }
                              const irrigation = states['input_select.hfm_irrigation_type']?.state || '';
                              const cropStage = states['input_select.hfm_crop_stage']?.state || '';
                              const notes = states['input_text.hfm_notes']?.state || '';

                              let html = `<div style="background:var(--card-background-color,#fff);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-left:4px solid ${cfg.color};">`;

                              // Header
                              html += `<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">`;
                              html += `<div style="width:50px;height:50px;border-radius:50%;background:${cfg.bg};display:flex;align-items:center;justify-content:center;">
                                        <ha-icon icon="${cfg.icon}" style="--mdc-icon-size:28px;color:${cfg.color};"></ha-icon>
                                      </div>`;
                              html += `<div style="flex:1;">`;
                              html += `<div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">${cfg.label}</div>`;
                              html += `<div style="font-size:14px;color:var(--secondary-text-color);">${eventDate}</div>`;
                              html += `</div></div>`;

                              // Details section
                              html += `<div style="display:grid;gap:8px;">`;

                              // Paddock row (with count if multiple)
                              html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                        <span style="font-size:14px;color:var(--secondary-text-color);">Paddock${paddockCount > 1 ? 's (' + paddockCount + ')' : ''}</span>
                                        <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${paddockDisplay}</span>
                                      </div>`;

                              // Type-specific details
                              if (eventType === 'Nutrient Application' || eventType === 'Chemical Application') {
                                // Show all products
                                if (products.length > 0) {
                                  html += `<div style="padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:6px;">Products (${products.length})</div>`;
                                  for (const p of products) {
                                    html += `<div style="display:flex;justify-content:space-between;padding:4px 0;">
                                              <span style="font-size:14px;font-weight:500;color:var(--primary-text-color);">${p.name}</span>
                                              <span style="font-size:14px;color:var(--secondary-text-color);">${p.rate} ${p.unit}</span>
                                            </div>`;
                                  }
                                  html += `</div>`;
                                }
                                if (method && method !== 'Select Method') {
                                  html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <span style="font-size:14px;color:var(--secondary-text-color);">Method</span>
                                            <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${method}</span>
                                          </div>`;
                                }
                                // Applicator
                                if (applicator && applicator !== 'Select Applicator') {
                                  html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <span style="font-size:14px;color:var(--secondary-text-color);">Applicator</span>
                                            <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${applicator}</span>
                                          </div>`;
                                }
                                // Start time and duration
                                if (startTime) {
                                  html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <span style="font-size:14px;color:var(--secondary-text-color);">Time</span>
                                            <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${startTime}${duration ? ' (' + duration + ' min)' : ''}</span>
                                          </div>`;
                                }
                                // Weather - show phases for Chemical, summary for Nutrient
                                const draftData = draft.data || {};
                                const ws = draftData.weather_start;
                                const wm = draftData.weather_mid;
                                const we = draftData.weather_end;
                                const hasPhaseWeather = ws || wm || we;

                                if (eventType === 'Chemical Application' && hasPhaseWeather) {
                                  // Show weather phases table for Chemical
                                  html += `<div style="padding:8px 12px;background:rgba(199,127,0,0.12);border-radius:8px;">
                                            <div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:6px;">
                                              <ha-icon icon="mdi:weather-windy" style="--mdc-icon-size:14px;"></ha-icon> Weather Phases
                                            </div>
                                            <table style="width:100%;font-size:11px;border-collapse:collapse;">
                                              <tr style="border-bottom:1px solid rgba(0,0,0,0.1);">
                                                <th style="text-align:left;padding:2px 4px;"></th>
                                                <th style="text-align:center;padding:2px 4px;">START</th>
                                                <th style="text-align:center;padding:2px 4px;">MID</th>
                                                <th style="text-align:center;padding:2px 4px;">END</th>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">Wind</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.wind_speed : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.wind_speed : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.wind_speed : '-'}</td>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">Gust</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.wind_gust : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.wind_gust : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.wind_gust : '-'}</td>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">Dir</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.wind_direction : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.wind_direction : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.wind_direction : '-'}</td>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">T</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.delta_t + '' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.delta_t + '' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.delta_t + '' : '-'}</td>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">Hum</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.humidity + '%' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.humidity + '%' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.humidity + '%' : '-'}</td>
                                              </tr>
                                              <tr>
                                                <td style="padding:2px 4px;font-weight:600;">Rain</td>
                                                <td style="text-align:center;padding:2px 4px;">${ws ? ws.rain_chance_pct + '%' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${wm ? wm.rain_chance_pct + '%' : '-'}</td>
                                                <td style="text-align:center;padding:2px 4px;">${we ? we.rain_chance_pct + '%' : '-'}</td>
                                              </tr>
                                            </table>
                                          </div>`;
                                } else if (weatherSummary && weatherSummary !== 'unavailable') {
                                  // Show weather summary for Nutrient or Chemical without captured phases
                                  html += `<div style="padding:8px 12px;background:rgba(199,127,0,0.12);border-radius:8px;">
                                            <div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:4px;">
                                              <ha-icon icon="mdi:weather-windy" style="--mdc-icon-size:14px;"></ha-icon> Weather Conditions
                                            </div>
                                            <div style="font-size:13px;color:var(--primary-text-color);">${weatherSummary}</div>
                                          </div>`;
                                }
                              } else if (eventType === 'Irrigation') {
                                if (irrigation && irrigation !== 'Select Type') {
                                  html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <span style="font-size:14px;color:var(--secondary-text-color);">Irrigation Type</span>
                                            <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${irrigation}</span>
                                          </div>`;
                                }
                              } else if (eventType === 'Crop Stage') {
                                if (cropStage && cropStage !== 'Select Stage') {
                                  html += `<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                            <span style="font-size:14px;color:var(--secondary-text-color);">Crop Stage</span>
                                            <span style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${cropStage}</span>
                                          </div>`;
                                }
                              }

                              // Notes
                              if (notes) {
                                html += `<div style="padding:8px 12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                                          <div style="font-size:12px;color:var(--secondary-text-color);margin-bottom:4px;">Notes</div>
                                          <div style="font-size:14px;color:var(--primary-text-color);font-style:italic;">${notes}</div>
                                        </div>`;
                              }

                              html += `</div></div>`;
                              return html;
                            } catch (err) {
                              console.error('HFM Summary render error:', err);
                              return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);color:var(--primary-text-color);">
                                        <div style="font-weight:700;margin-bottom:6px;">Render error</div>
                                        <div style="font-family:monospace;font-size:12px;opacity:.85;">${String(err)}</div>
                                      </div>`;
                            }
                          ]]]

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: hfm_nav
                          name: Edit
                          icon: mdi:pencil
                          tap_action:
                            action: call-service
                            service: input_number.set_value
                            target:
                              entity_id: input_number.hfm_wizard_step
                            data:
                              value: 1

                        - type: custom:button-card
                          template: hfm_success
                          entity: input_boolean.hfm_edit_mode
                          name: |
                            [[[
                              return entity.state === 'on' ? 'Update' : 'Confirm';
                            ]]]
                          icon: mdi:check
                          styles:
                            card:
                              - background: "#28a745"
                            name:
                              - color: white
                            icon:
                              - color: white
                          tap_action:
                            action: call-service
                            service: script.hfm_submit_event

              #----------------------------------------------------------------
              # NAVIGATION BUTTONS (always visible except step 6)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: input_number.hfm_wizard_step
                    below: 6
                card:
                  type: horizontal-stack
                  cards:
                    - type: custom:button-card
                      template: hfm_nav
                      name: Back
                      icon: mdi:arrow-left
                      tap_action:
                        action: call-service
                        service: script.hfm_wizard_prev

                    - type: custom:button-card
                      template: hfm_action
                      name: Next
                      icon: mdi:arrow-right
                      tap_action:
                        action: call-service
                        service: script.hfm_wizard_next

              #----------------------------------------------------------------
              # CANCEL BUTTON
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_danger
                name: Cancel
                icon: mdi:close
                tap_action:
                  action: call-service
                  service: script.hfm_wizard_reset
                  confirmation:
                    text: "Discard this event?"

  #============================================================================
  # VIEW 3: EVENT HISTORY
  #============================================================================
  - title: History
    path: hfm-history
    icon: mdi:history
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              #----------------------------------------------------------------
              # HEADER with back button
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_nav
                    name: Back
                    icon: mdi:arrow-left
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm

                  - type: custom:button-card
                    template: hfm_title
                    name: EVENT HISTORY
                    styles:
                      card:
                        - height: 70px
                        - flex: 3

              #----------------------------------------------------------------
              # EDIT/DELETE CONTROLS
              #----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.hfm_edit_event
                    name: Select Event to Manage
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.2rem !important;
                    }

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_action
                    name: Edit
                    icon: mdi:pencil
                    tap_action:
                      action: call-service
                      service: script.hfm_load_event_for_edit
                    hold_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm-new

                  - type: custom:button-card
                    template: hfm_success
                    name: Confirm
                    icon: mdi:check-circle
                    tap_action:
                      action: call-service
                      service: script.hfm_confirm_event

                  - type: custom:button-card
                    template: hfm_danger
                    name: Delete
                    icon: mdi:delete
                    tap_action:
                      action: call-service
                      service: script.hfm_delete_event
                      confirmation:
                        text: "Delete this event?"

              # Navigation to edit form after loading event
              - type: custom:button-card
                template: hfm_nav
                name: Go to Edit Form
                icon: mdi:arrow-right-circle
                entity: input_boolean.hfm_edit_mode
                show_entity_picture: false
                state:
                  - value: "on"
                    color: "#0066cc"
                  - value: "off"
                    color: "#555555"
                tap_action:
                  action: navigate
                  navigation_path: /hfm-heyfarm/hfm-new

              #----------------------------------------------------------------
              # ALL EVENTS - IPM-style cards
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                name: ALL EVENTS

              - type: custom:button-card
                entity: sensor.hfm_events
                show_icon: false
                show_name: false
                show_state: false
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                    - padding: 0
                    - margin: 0
                  grid:
                    - display: block
                  custom_fields:
                    events:
                      - width: 100%
                custom_fields:
                  events: |
                    [[[
                      try {
                        const safeStr = (v) => (v === null || v === undefined) ? '' : String(v);

                        if (!entity || !entity.attributes) {
                          return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">
                                    Loading events
                                  </div>`;
                        }

                        const events = entity.attributes.all_events || [];
                        const pmap = entity.attributes.paddock_map || {};

                        if (events.length === 0) {
                          return `
                            <div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                              <ha-icon icon="mdi:calendar-blank" style="--mdc-icon-size:48px;margin-bottom:12px;"></ha-icon>
                              <div style="font-size:16px;">No events recorded yet</div>
                              <div style="font-size:14px;margin-top:8px;">Use <b>New Event</b> to add one</div>
                            </div>`;
                        }

                        const typeConfig = {
                          'nutrient':   { icon: 'mdi:flask',  color: '#43a047', bg: 'rgba(67,160,71,0.15)', label: 'Nutrient' },
                          'chemical':   { icon: 'mdi:spray',  color: '#e53935', bg: 'rgba(229,57,53,0.15)', label: 'Chemical' },
                          'irrigation': { icon: 'mdi:water',  color: '#1e88e5', bg: 'rgba(30,136,229,0.15)', label: 'Irrigation' },
                          'crop_stage': { icon: 'mdi:sprout', color: '#8d6e63', bg: 'rgba(141,110,99,0.15)', label: 'Crop Stage' }
                        };

                        let html = `<div style="display:grid;grid-template-columns:1fr;gap:12px;padding:4px;">`;

                        for (let i = 0; i < events.length; i++) {
                          const e = events[i] || {};
                          const eType = safeStr(e.event_type);
                          const cfg = typeConfig[eType] || { icon: 'mdi:calendar', color: '#757575', bg: 'rgba(117,117,117,0.15)', label: eType };

                          // Get paddock names
                          const paddocks = e.paddocks || [];
                          let paddockNames = [];
                          for (let p = 0; p < paddocks.length; p++) {
                            const pid = paddocks[p];
                            paddockNames.push(pmap[pid] || pid);
                          }
                          const paddockStr = paddockNames.join(', ') || 'Unknown';

                          // Status indicator
                          const status = safeStr(e.confirmation_status);
                          const isPending = status === 'pending';
                          const statusColor = isPending ? '#ffc107' : '#28a745';
                          const statusIcon = isPending ? 'mdi:clock-alert' : 'mdi:check-circle';
                          const statusLabel = isPending ? 'Pending' : 'Confirmed';

                          // Details based on type
                          let detailHtml = '';
                          if (eType === 'nutrient' || eType === 'chemical') {
                            const products = e.products || [];
                            if (products.length > 0) {
                              detailHtml = `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--divider-color,#e0e0e0);">`;
                              for (let pr = 0; pr < products.length; pr++) {
                                const prod = products[pr];
                                const pName = safeStr(prod.product_name);
                                const pRate = prod.rate || '';
                                const pUnit = safeStr(prod.rate_unit);
                                detailHtml += `<div style="display:flex;justify-content:space-between;font-size:13px;padding:2px 0;">
                                  <span style="color:var(--primary-text-color);">${pName}</span>
                                  <span style="color:var(--secondary-text-color);font-weight:500;">${pRate} ${pUnit}</span>
                                </div>`;
                              }
                              detailHtml += `</div>`;
                            }
                            if (e.application_method) {
                              detailHtml += `<div style="font-size:12px;color:var(--secondary-text-color);margin-top:4px;">Method: ${safeStr(e.application_method)}</div>`;
                            }
                          } else if (eType === 'irrigation' && e.irrigation_type) {
                            detailHtml = `<div style="font-size:13px;color:var(--secondary-text-color);margin-top:8px;padding-top:8px;border-top:1px solid var(--divider-color,#e0e0e0);">
                              Type: ${safeStr(e.irrigation_type)}
                            </div>`;
                          } else if (eType === 'crop_stage' && e.crop_stage) {
                            detailHtml = `<div style="font-size:13px;color:var(--secondary-text-color);margin-top:8px;padding-top:8px;border-top:1px solid var(--divider-color,#e0e0e0);">
                              Stage: ${safeStr(e.crop_stage)}
                            </div>`;
                          }

                          // Notes
                          if (e.notes) {
                            detailHtml += `<div style="font-size:12px;color:var(--secondary-text-color);margin-top:4px;font-style:italic;">${safeStr(e.notes)}</div>`;
                          }

                          html += `<div style="background:var(--card-background-color,#fff);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-left:4px solid ${cfg.color};">`;

                          // Header row
                          html += `<div style="display:flex;align-items:center;gap:12px;">`;
                          html += `<div style="width:44px;height:44px;border-radius:50%;background:${cfg.bg};display:flex;align-items:center;justify-content:center;">
                                    <ha-icon icon="${cfg.icon}" style="--mdc-icon-size:24px;color:${cfg.color};"></ha-icon>
                                  </div>`;
                          html += `<div style="flex:1;min-width:0;">`;
                          html += `<div style="font-size:16px;font-weight:600;color:var(--primary-text-color);">${cfg.label}</div>`;
                          html += `<div style="font-size:13px;color:var(--secondary-text-color);">${paddockStr}</div>`;
                          html += `</div>`;
                          html += `<div style="text-align:right;">`;
                          html += `<div style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${safeStr(e.event_date)}</div>`;
                          html += `<div style="display:flex;align-items:center;gap:4px;justify-content:flex-end;margin-top:2px;">
                                    <ha-icon icon="${statusIcon}" style="--mdc-icon-size:14px;color:${statusColor};"></ha-icon>
                                    <span style="font-size:11px;color:${statusColor};font-weight:500;">${statusLabel}</span>
                                  </div>`;
                          html += `</div></div>`;

                          // Details
                          html += detailHtml;

                          html += `</div>`;
                        }

                        html += `</div>`;
                        return html;

                      } catch (err) {
                        console.error('HFM History render error:', err);
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);color:var(--primary-text-color);">
                                  <div style="font-weight:700;margin-bottom:6px;">Render error</div>
                                  <div style="font-family:monospace;font-size:12px;opacity:.85;">${String(err)}</div>
                                </div>`;
                      }
                    ]]]

  #============================================================================
  # VIEW 4: SETTINGS
  #============================================================================
  - title: Settings
    path: hfm-settings
    icon: mdi:cog
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              #----------------------------------------------------------------
              # HEADER with back button
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_nav
                    name: Back
                    icon: mdi:arrow-left
                    tap_action:
                      action: navigate
                      navigation_path: /hfm-heyfarm/hfm

                  - type: custom:button-card
                    template: hfm_title
                    name: HFM SETTINGS
                    styles:
                      card:
                        - height: 70px
                        - flex: 3

              #----------------------------------------------------------------
              # SYSTEM STATUS - Styled card
              #----------------------------------------------------------------
              - type: custom:button-card
                entity: sensor.hfm_events
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color,#fff)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                  grid:
                    - display: block
                  custom_fields:
                    status:
                      - width: 100%
                custom_fields:
                  status: |
                    [[[
                      try {
                        const version = states['sensor.hfm_version']?.state || 'unknown';
                        const status = states['sensor.hfm_system_status']?.state || 'unknown';
                        const lastBackup = entity?.attributes?.last_backup || 'Never';
                        const backupCount = entity?.attributes?.backup_count || 0;
                        const totalEvents = entity?.state || 0;
                        const statusColor = status === 'ready' ? '#28a745' : '#ffc107';
                        const statusIcon = status === 'ready' ? 'mdi:check-circle' : 'mdi:alert-circle';

                        return `
                          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <div style="width:50px;height:50px;border-radius:50%;background:rgba(40,167,69,0.15);display:flex;align-items:center;justify-content:center;">
                              <ha-icon icon="mdi:microphone" style="--mdc-icon-size:28px;color:#28a745;"></ha-icon>
                            </div>
                            <div style="flex:1;">
                              <div style="font-size:20px;font-weight:700;color:var(--primary-text-color);">Hey Farmer Module</div>
                              <div style="font-size:14px;color:var(--secondary-text-color);">Version ${version}</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:16px;background:${status === 'ready' ? 'rgba(40,167,69,0.15)' : 'rgba(255,193,7,0.15)'};">
                              <ha-icon icon="${statusIcon}" style="--mdc-icon-size:16px;color:${statusColor};"></ha-icon>
                              <span style="font-size:13px;font-weight:600;color:${statusColor};text-transform:capitalize;">${status}</span>
                            </div>
                          </div>
                          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <div style="text-align:center;padding:12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                              <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);">${totalEvents}</div>
                              <div style="font-size:12px;color:var(--secondary-text-color);">Total Events</div>
                            </div>
                            <div style="text-align:center;padding:12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                              <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);">${backupCount}</div>
                              <div style="font-size:12px;color:var(--secondary-text-color);">Backups</div>
                            </div>
                            <div style="text-align:center;padding:12px;background:var(--secondary-background-color,#f5f5f5);border-radius:8px;">
                              <div style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${lastBackup === 'Never' ? 'Never' : lastBackup.split('T')[0]}</div>
                              <div style="font-size:12px;color:var(--secondary-text-color);">Last Backup</div>
                            </div>
                          </div>
                        `;
                      } catch (err) {
                        return `<div style="color:var(--error-color);">Error loading status</div>`;
                      }
                    ]]]

              #----------------------------------------------------------------
              # CROP STAGES - Styled list with delete buttons
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                name: CROP STAGES

              - type: custom:button-card
                entity: sensor.hfm_events
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                    - padding: 0
                  grid:
                    - display: block
                  custom_fields:
                    stages:
                      - width: 100%
                custom_fields:
                  stages: |
                    [[[
                      try {
                        const stages = entity?.attributes?.crop_stages || [];
                        if (stages.length === 0) {
                          return `<div style="text-align:center;padding:20px;color:var(--secondary-text-color);">No crop stages configured</div>`;
                        }

                        let html = `<div style="display:grid;gap:8px;">`;
                        for (const s of stages) {
                          html += `
                            <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card-background-color,#fff);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                              <div style="width:32px;height:32px;border-radius:50%;background:rgba(141,110,99,0.15);display:flex;align-items:center;justify-content:center;">
                                <span style="font-size:14px;font-weight:700;color:#8d6e63;">${s.order}</span>
                              </div>
                              <div style="flex:1;">
                                <div style="font-size:15px;font-weight:600;color:var(--primary-text-color);">${s.name}</div>
                              </div>
                              <ha-icon icon="mdi:sprout" style="--mdc-icon-size:20px;color:#8d6e63;"></ha-icon>
                            </div>
                          `;
                        }
                        html += `</div>`;
                        return html;
                      } catch (err) {
                        return `<div style="color:var(--error-color);">Error loading stages</div>`;
                      }
                    ]]]

              - type: custom:button-card
                template: hfm_title
                name: ADD NEW STAGE
                styles:
                  card:
                    - height: 40px
                  name:
                    - font-size: 14px

              - type: entities
                entities:
                  - entity: input_text.hfm_new_stage_id
                    name: Stage ID (e.g. pre_flood)
                  - entity: input_text.hfm_new_stage_name
                    name: Stage Name (e.g. Pre-Flood)
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                    }

              - type: custom:button-card
                template: hfm_action
                name: Add Stage
                icon: mdi:plus
                tap_action:
                  action: call-service
                  service: script.hfm_add_crop_stage

              #----------------------------------------------------------------
              # BACKUP & EXPORT
              #----------------------------------------------------------------
              - type: custom:button-card
                template: hfm_title
                name: BACKUP & EXPORT

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: hfm_action
                    name: Export Events
                    icon: mdi:export
                    tap_action:
                      action: call-service
                      service: script.hfm_export

                  - type: custom:button-card
                    template: hfm_secondary
                    name: Initialize
                    icon: mdi:cog-refresh
                    tap_action:
                      action: call-service
                      service: script.hfm_init
                      confirmation:
                        text: "Re-initialize HFM? This resets config to defaults if missing."

              - type: markdown
                content: |
                  Exports save to: `/config/local_data/hfm/backups/`
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 8px;
                      padding: 8px 12px;
                      font-size: 12px;
                      background: var(--secondary-background-color,#f5f5f5);
                    }
