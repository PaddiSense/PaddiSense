# =============================================================================
# HFM - Hey Farmer Module
# Voice-assisted farm event recording
# Version: 1.0.0
# =============================================================================

# -----------------------------------------------------------------------------
# Shell Commands
# -----------------------------------------------------------------------------
shell_command:
  hfm_init: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py init

  hfm_add_event: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py add_event
    --event_type "{{ event_type }}"
    --paddocks '{{ paddocks }}'
    --products '{{ products | default("[]") }}'
    --application_method "{{ application_method | default("") }}"
    --crop_stage "{{ crop_stage | default("") }}"
    --irrigation_type "{{ irrigation_type | default("") }}"
    --event_date "{{ event_date | default("") }}"
    --notes "{{ notes | default("") }}"
    --device_id "{{ device_id | default("") }}"

  hfm_edit_event: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py edit_event
    --event_id "{{ event_id }}"
    --event_date "{{ event_date | default("") }}"
    --paddocks '{{ paddocks | default("") }}'
    --products '{{ products | default("") }}'
    --application_method "{{ application_method | default("") }}"
    --crop_stage "{{ crop_stage | default("") }}"
    --irrigation_type "{{ irrigation_type | default("") }}"
    --notes "{{ notes | default("") }}"

  hfm_delete_event: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py delete_event
    --event_id "{{ event_id }}"

  hfm_confirm_event: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py confirm_event
    --event_id "{{ event_id }}"

  hfm_add_crop_stage: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py add_crop_stage
    --stage_id "{{ stage_id }}"
    --name "{{ name }}"

  hfm_delete_crop_stage: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py delete_crop_stage
    --stage_id "{{ stage_id }}"

  hfm_add_device: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py add_device
    --device_id "{{ device_id }}"
    --device_name "{{ device_name | default("") }}"
    --user_name "{{ user_name }}"

  hfm_delete_device: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py delete_device
    --device_id "{{ device_id }}"

  hfm_export: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py export

  # --- Draft Commands (Multi-user support) ---
  hfm_load_draft: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py load_draft
    --device-id "{{ device_id }}"

  hfm_update_draft: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py update_draft
    --device-id "{{ device_id }}"
    --data '{{ data }}'

  hfm_update_draft_weather_phase: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py update_draft
    --device-id "{{ device_id }}"
    --data '{"data": {"weather_{{ phase }}": {{ weather }}}}'

  hfm_clear_draft_weather_phase: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py update_draft
    --device-id "{{ device_id }}"
    --data '{"data": {"weather_{{ phase }}": null}}'

  hfm_clear_draft: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py clear_draft
    --device-id "{{ device_id }}"

  hfm_submit_draft: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py submit_draft
    --device-id "{{ device_id }}"

  hfm_cleanup_drafts: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py cleanup_drafts
    --max-age-hours {{ max_age_hours | default(24) }}

  # --- Applicator Commands ---
  hfm_add_applicator: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py add_applicator
    --name "{{ name }}"
    --type "{{ type }}"
    --attributes '{{ attributes | default("{}") }}'

  hfm_edit_applicator: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py edit_applicator
    --id "{{ id }}"
    --name "{{ name | default("") }}"
    --type "{{ type | default("") }}"
    --active "{{ active | default("") }}"
    --attributes '{{ attributes | default("") }}'

  hfm_delete_applicator: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py delete_applicator
    --id "{{ id }}"
    {{ "--hard" if hard | default(false) else "" }}

  hfm_list_applicators: >-
    python3 /config/PaddiSense/hfm/python/hfm_backend.py list_applicators
    {{ "--active-only" if active_only | default(false) else "" }}
    {{ "--type " ~ type if type | default("") else "" }}


# -----------------------------------------------------------------------------
# Command-line Sensor
# -----------------------------------------------------------------------------
command_line:
  - sensor:
      name: HFM Events
      unique_id: hfm_events
      command: 'python3 /config/PaddiSense/hfm/python/hfm_sensor.py'
      command_timeout: 30
      scan_interval: 300
      value_template: '{{ value_json.total_events | default(0) }}'
      json_attributes:
        - total_events
        - events_today
        - events_yesterday
        - pending_events
        - recent_events
        - pending_list
        - all_events
        - events_by_type
        - events_by_paddock
        - crop_stages
        - application_methods
        - irrigation_types
        - devices
        - paddock_names
        - paddock_map
        - product_names
        - crop_stage_names
        - crop_stage_ids
        - method_names
        - method_ids
        - irrigation_names
        - irrigation_ids
        - system_status
        - config_exists
        - voice_enabled
        - weather_enabled
        - weather_entities
        - version
        - last_backup
        - backup_count
        - applicators
        - active_applicators
        - applicators_by_type
        - applicator_names
        - applicator_ids
        - applicator_templates

  - sensor:
      name: HFM Drafts
      unique_id: hfm_drafts
      command: 'python3 /config/PaddiSense/hfm/python/hfm_drafts_sensor.py'
      command_timeout: 15
      scan_interval: 10
      value_template: '{{ value_json.draft_count | default(0) }}'
      json_attributes:
        - draft_count
        - drafts
        - active_devices
        - farms
        - paddock_map
        - paddocks_by_farm
        - applicators
        - applicators_by_type
        - applicator_names
        - applicator_ids
        - registered_devices
        - version
        - last_updated


# -----------------------------------------------------------------------------
# Input Helpers - Event Form
# -----------------------------------------------------------------------------
input_select:
  hfm_event_type:
    name: HFM Event Type
    icon: mdi:format-list-bulleted-type
    options:
      - Select Type
      - Nutrient Application
      - Chemical Application
      - Irrigation
      - Crop Stage

  hfm_when:
    name: HFM When
    icon: mdi:calendar-clock
    options:
      - Today
      - Yesterday
      - Specific Date

  hfm_ampm:
    name: HFM AM/PM
    icon: mdi:clock-time-eight-outline
    options:
      - AM
      - PM
    initial: AM

  hfm_application_method:
    name: HFM Application Method
    icon: mdi:spray
    options:
      - Select Method

  hfm_crop_stage:
    name: HFM Crop Stage
    icon: mdi:sprout
    options:
      - Select Stage

  hfm_irrigation_type:
    name: HFM Irrigation Type
    icon: mdi:water
    options:
      - Select Type

  hfm_selected_paddock:
    name: HFM Selected Paddock
    icon: mdi:vector-square
    options:
      - Select Paddock

  hfm_selected_product:
    name: HFM Product 1
    icon: mdi:flask
    options:
      - Select Product

  hfm_selected_product_2:
    name: HFM Product 2
    icon: mdi:flask
    options:
      - Select Product

  hfm_selected_product_3:
    name: HFM Product 3
    icon: mdi:flask
    options:
      - Select Product

  hfm_selected_product_4:
    name: HFM Product 4
    icon: mdi:flask
    options:
      - Select Product

  hfm_selected_product_5:
    name: HFM Product 5
    icon: mdi:flask
    options:
      - Select Product

  hfm_selected_product_6:
    name: HFM Product 6
    icon: mdi:flask
    options:
      - Select Product

  # For editing
  hfm_edit_event:
    name: HFM Edit Event
    icon: mdi:pencil
    options:
      - Select Event

  # Applicator Management
  hfm_applicator_type:
    name: HFM Applicator Type
    icon: mdi:shape
    options:
      - Select Type
      - boom_spray
      - broadcast
      - aerial
      - fertigation
      - seed_treatment
      - foliar

  hfm_selected_applicator:
    name: HFM Selected Applicator
    icon: mdi:tractor
    options:
      - Select Applicator

  # Farm Selection
  hfm_selected_farm:
    name: HFM Selected Farm
    icon: mdi:barn
    options:
      - Select Farm

  # Paddock toggle dropdown (populated by automation)
  hfm_paddock_to_toggle:
    name: HFM Paddock to Toggle
    icon: mdi:grass
    options:
      - Select Paddock

input_text:
  hfm_notes:
    name: HFM Notes
    icon: mdi:note-text
    max: 255

  hfm_specific_date:
    name: HFM Specific Date
    icon: mdi:calendar
    max: 10

  hfm_product_rate:
    name: HFM Product Rate
    icon: mdi:scale
    max: 20

  hfm_rate_unit:
    name: HFM Rate Unit 1
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  hfm_product_rate_2:
    name: HFM Product Rate 2
    icon: mdi:scale
    max: 20

  hfm_rate_unit_2:
    name: HFM Rate Unit 2
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  hfm_product_rate_3:
    name: HFM Product Rate 3
    icon: mdi:scale
    max: 20

  hfm_rate_unit_3:
    name: HFM Rate Unit 3
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  hfm_product_rate_4:
    name: HFM Product Rate 4
    icon: mdi:scale
    max: 20

  hfm_rate_unit_4:
    name: HFM Rate Unit 4
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  hfm_product_rate_5:
    name: HFM Product Rate 5
    icon: mdi:scale
    max: 20

  hfm_rate_unit_5:
    name: HFM Rate Unit 5
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  hfm_product_rate_6:
    name: HFM Product Rate 6
    icon: mdi:scale
    max: 20

  hfm_rate_unit_6:
    name: HFM Rate Unit 6
    icon: mdi:ruler
    max: 20
    initial: "kg/ha"

  # Settings inputs
  hfm_new_stage_id:
    name: HFM New Stage ID
    icon: mdi:identifier
    max: 50

  hfm_new_stage_name:
    name: HFM New Stage Name
    icon: mdi:label
    max: 100

  hfm_device_id:
    name: HFM Device ID
    icon: mdi:cellphone
    max: 50

  hfm_device_name:
    name: HFM Device Name
    icon: mdi:cellphone-text
    max: 100

  hfm_user_name:
    name: HFM User Name
    icon: mdi:account
    max: 100

  hfm_edit_event_id:
    name: HFM Edit Event ID
    icon: mdi:identifier
    max: 50

  # Draft System (Multi-user)
  hfm_current_device:
    name: HFM Current Device
    icon: mdi:cellphone-link
    max: 100

  # Applicator Management
  hfm_applicator_name:
    name: HFM Applicator Name
    icon: mdi:tractor
    max: 100

  hfm_applicator_id:
    name: HFM Applicator ID
    icon: mdi:identifier
    max: 50

  hfm_applicator_attributes:
    name: HFM Applicator Attributes
    icon: mdi:code-json
    max: 255

  # Application Timing
  hfm_start_time:
    name: HFM Start Time
    icon: mdi:clock-start
    max: 5

input_number:
  hfm_product_count:
    name: HFM Product Count
    min: 1
    max: 6
    step: 1
    mode: box
    icon: mdi:flask-plus

  hfm_wizard_step:
    name: HFM Wizard Step
    min: 1
    max: 6
    step: 1
    mode: box
    icon: mdi:step-forward

  # Application Timing
  hfm_hour:
    name: HFM Hour
    min: 1
    max: 12
    step: 1
    initial: 8
    mode: box
    icon: mdi:clock-outline

  hfm_duration_minutes:
    name: HFM Duration (minutes)
    icon: mdi:timer
    min: 5
    max: 720
    step: 5
    mode: box
    unit_of_measurement: "min"

input_boolean:
  hfm_edit_mode:
    name: HFM Edit Mode
    icon: mdi:pencil

  hfm_weather_capture_enabled:
    name: HFM Weather Capture Enabled
    icon: mdi:weather-partly-cloudy

input_datetime:
  hfm_weather_capture_start:
    name: HFM Weather Capture Start Time
    has_date: true
    has_time: true
    icon: mdi:play-circle

  hfm_weather_capture_middle:
    name: HFM Weather Capture Middle Time
    has_date: true
    has_time: true
    icon: mdi:pause-circle

  hfm_weather_capture_end:
    name: HFM Weather Capture End Time
    has_date: true
    has_time: true
    icon: mdi:stop-circle


# -----------------------------------------------------------------------------
# Template Sensors
# -----------------------------------------------------------------------------
template:
  - sensor:
      - name: "HFM Version"
        unique_id: hfm_version
        icon: mdi:tag
        state: "{{ state_attr('sensor.hfm_events', 'version') | default('unknown') }}"

      - name: "HFM System Status"
        unique_id: hfm_system_status
        icon: mdi:check-circle
        state: "{{ state_attr('sensor.hfm_events', 'system_status') | default('unknown') }}"

      - name: "HFM Events Today"
        unique_id: hfm_events_today
        icon: mdi:calendar-today
        state: "{{ state_attr('sensor.hfm_events', 'events_today') | default(0) }}"

      - name: "HFM Pending Events"
        unique_id: hfm_pending_events
        icon: mdi:clock-alert
        state: "{{ state_attr('sensor.hfm_events', 'pending_events') | default(0) }}"

      # Current wizard state
      - name: "HFM Current Event Type"
        unique_id: hfm_current_event_type
        icon: mdi:format-list-bulleted-type
        state: >
          {% set sel = states('input_select.hfm_event_type') %}
          {% if sel == 'Nutrient Application' %}nutrient
          {% elif sel == 'Chemical Application' %}chemical
          {% elif sel == 'Irrigation' %}irrigation
          {% elif sel == 'Crop Stage' %}crop_stage
          {% else %}none{% endif %}

      - name: "HFM Event Date"
        unique_id: hfm_event_date
        icon: mdi:calendar
        state: >
          {% set when = states('input_select.hfm_when') %}
          {% if when == 'Today' %}
            {{ now().strftime('%Y-%m-%d') }}
          {% elif when == 'Yesterday' %}
            {{ (now() - timedelta(days=1)).strftime('%Y-%m-%d') }}
          {% else %}
            {{ states('input_text.hfm_specific_date') }}
          {% endif %}

      - name: "HFM Selected Farm ID"
        unique_id: hfm_selected_farm_id
        icon: mdi:barn
        state: >
          {% set farm_name = states('input_select.hfm_selected_farm') %}
          {% set farms = state_attr('sensor.hfm_drafts', 'farms') or {} %}
          {% for fid, fname in farms.items() %}
            {% if fname == farm_name %}{{ fid }}{% endif %}
          {% endfor %}

      # Weather sensors for display (Local station first, BOM fallback)
      - name: "HFM Current Wind Speed"
        unique_id: hfm_current_wind_speed
        icon: mdi:weather-windy
        unit_of_measurement: "km/h"
        state: >
          {% set local = states('sensor.weather_api_station_1_wind_speed') %}
          {% set bom = states('sensor.bom_wind_speed_kilometre') %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {{ local | float(0) | round(1) }}
          {% else %}
            {{ bom | float(0) | round(1) }}
          {% endif %}

      - name: "HFM Current Wind Direction"
        unique_id: hfm_current_wind_direction
        icon: mdi:compass
        state: >
          {% set local = states('sensor.weather_api_station_1_wind_direction') %}
          {% set bom = states('sensor.bom_wind_direction') %}
          {% set dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'] %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {% if local | float(-1) >= 0 %}
              {{ dirs[((local | float(0) + 11.25) % 360 / 22.5) | int] }}
            {% else %}
              {{ local }}
            {% endif %}
          {% else %}
            {% set deg = bom | float(0) %}
            {{ dirs[((deg + 11.25) % 360 / 22.5) | int] }}
          {% endif %}

      - name: "HFM Current Wind Gust"
        unique_id: hfm_current_wind_gust
        icon: mdi:weather-windy-variant
        unit_of_measurement: "km/h"
        state: >
          {% set local = states('sensor.weather_api_station_1_wind_gust') %}
          {% set bom = states('sensor.bom_gust_speed_kilometre') %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {{ local | float(0) | round(1) }}
          {% else %}
            {{ bom | float(0) | round(1) }}
          {% endif %}

      - name: "HFM Current Temperature"
        unique_id: hfm_current_temperature
        icon: mdi:thermometer
        unit_of_measurement: "°C"
        state: >
          {% set local = states('sensor.weather_api_station_1_temperature') %}
          {% set bom = states('sensor.bom_temp') %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {{ local | float(0) | round(1) }}
          {% else %}
            {{ bom | float(0) | round(1) }}
          {% endif %}

      - name: "HFM Current Humidity"
        unique_id: hfm_current_humidity
        icon: mdi:water-percent
        unit_of_measurement: "%"
        state: >
          {% set local = states('sensor.weather_api_station_1_humidity') %}
          {% set bom = states('sensor.bom_humidity') %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {{ local | float(0) | round(0) }}
          {% else %}
            {{ bom | float(0) | round(0) }}
          {% endif %}

      - name: "HFM Current Delta T"
        unique_id: hfm_current_delta_t
        icon: mdi:thermometer-lines
        unit_of_measurement: "°C"
        state: >
          {% set local = states('sensor.weather_api_station_1_delta_t') %}
          {% set bom = states('sensor.bom_observations_delta_t') %}
          {% if local not in ['unknown', 'unavailable', ''] %}
            {{ local | float(0) | round(1) }}
          {% elif bom not in ['unknown', 'unavailable', ''] %}
            {{ bom | float(0) | round(1) }}
          {% else %}
            0
          {% endif %}

      - name: "HFM Current Rain Chance"
        unique_id: hfm_current_rain_chance
        icon: mdi:weather-rainy
        unit_of_measurement: "%"
        state: >
          {% set bom = states('sensor.bom_forecast_rain_chance_0') %}
          {{ bom | float(0) | round(0) if bom not in ['unknown', 'unavailable', ''] else 0 }}

      - name: "HFM Weather Summary"
        unique_id: hfm_weather_summary
        icon: mdi:weather-partly-cloudy
        state: >
          Wind: {{ states('sensor.hfm_current_wind_speed') }}km/h {{ states('sensor.hfm_current_wind_direction') }},
          Gusts: {{ states('sensor.hfm_current_wind_gust') }}km/h,
          ΔT: {{ states('sensor.hfm_current_delta_t') }}°C,
          {{ states('sensor.hfm_current_humidity') }}%

      # Farm & Paddock selection sensors
      - name: "HFM Selected Farm ID"
        unique_id: hfm_selected_farm_id
        icon: mdi:barn
        state: >
          {% set farm_name = states('input_select.hfm_selected_farm') %}
          {% set farms = state_attr('sensor.hfm_drafts', 'farms') or {} %}
          {% for fid, fname in farms.items() if fname == farm_name %}{{ fid }}{% endfor %}

      - name: "HFM Paddocks For Selected Farm"
        unique_id: hfm_paddocks_for_selected_farm
        icon: mdi:vector-square
        state: >
          {% set farm_id = states('sensor.hfm_selected_farm_id') %}
          {% set by_farm = state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} %}
          {% set paddocks = by_farm.get(farm_id, []) %}
          {{ paddocks | length }} paddocks
        attributes:
          paddocks: >
            {% set farm_id = states('sensor.hfm_selected_farm_id') %}
            {% set by_farm = state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} %}
            {{ by_farm.get(farm_id, []) }}

      - name: "HFM Current Draft Paddocks"
        unique_id: hfm_current_draft_paddocks
        icon: mdi:checkbox-multiple-marked
        state: >
          {% set device_id = states('input_text.hfm_current_device') %}
          {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
          {% set draft = drafts.get(device_id, {}) %}
          {% set paddocks = draft.get('data', {}).get('paddocks', []) %}
          {{ paddocks | length }} selected
        attributes:
          paddock_ids: >
            {% set device_id = states('input_text.hfm_current_device') %}
            {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
            {% set draft = drafts.get(device_id, {}) %}
            {{ draft.get('data', {}).get('paddocks', []) }}
          paddock_names: >
            {% set device_id = states('input_text.hfm_current_device') %}
            {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
            {% set draft = drafts.get(device_id, {}) %}
            {% set selected_ids = draft.get('data', {}).get('paddocks', []) %}
            {% set pmap = state_attr('sensor.hfm_drafts', 'paddock_map') or {} %}
            {% set ns = namespace(names=[]) %}
            {% for pid in selected_ids %}
              {% set ns.names = ns.names + [pmap.get(pid, pid)] %}
            {% endfor %}
            {{ ns.names }}

      # Spray Phase Time Calculations (for Chemical Applications)
      - name: "HFM Spray Start Time"
        unique_id: hfm_spray_start_time
        icon: mdi:play-circle
        state: >
          {% set hour = states('input_number.hfm_hour') | int(8) %}
          {% set ampm = states('input_select.hfm_ampm') %}
          {% if ampm == 'PM' and hour != 12 %}
            {% set hour24 = hour + 12 %}
          {% elif ampm == 'AM' and hour == 12 %}
            {% set hour24 = 0 %}
          {% else %}
            {% set hour24 = hour %}
          {% endif %}
          {{ '%02d:00' | format(hour24) }}

      - name: "HFM Spray Mid Time"
        unique_id: hfm_spray_mid_time
        icon: mdi:pause-circle
        state: >
          {% set hour = states('input_number.hfm_hour') | int(8) %}
          {% set ampm = states('input_select.hfm_ampm') %}
          {% set duration = states('input_number.hfm_duration_minutes') | int(60) %}
          {% if ampm == 'PM' and hour != 12 %}
            {% set hour24 = hour + 12 %}
          {% elif ampm == 'AM' and hour == 12 %}
            {% set hour24 = 0 %}
          {% else %}
            {% set hour24 = hour %}
          {% endif %}
          {% set start_minutes = hour24 * 60 %}
          {% set mid_minutes = start_minutes + (duration / 2) | int %}
          {% set mid_hour = (mid_minutes / 60) | int % 24 %}
          {% set mid_min = mid_minutes % 60 %}
          {{ '%02d:%02d' | format(mid_hour, mid_min) }}

      - name: "HFM Spray End Time"
        unique_id: hfm_spray_end_time
        icon: mdi:stop-circle
        state: >
          {% set hour = states('input_number.hfm_hour') | int(8) %}
          {% set ampm = states('input_select.hfm_ampm') %}
          {% set duration = states('input_number.hfm_duration_minutes') | int(60) %}
          {% if ampm == 'PM' and hour != 12 %}
            {% set hour24 = hour + 12 %}
          {% elif ampm == 'AM' and hour == 12 %}
            {% set hour24 = 0 %}
          {% else %}
            {% set hour24 = hour %}
          {% endif %}
          {% set start_minutes = hour24 * 60 %}
          {% set end_minutes = start_minutes + duration %}
          {% set end_hour = (end_minutes / 60) | int % 24 %}
          {% set end_min = end_minutes % 60 %}
          {{ '%02d:%02d' | format(end_hour, end_min) }}

      # Weather phase data from draft
      - name: "HFM Weather Start"
        unique_id: hfm_weather_start
        icon: mdi:weather-cloudy-clock
        state: >
          {% set device_id = states('input_text.hfm_current_device') %}
          {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
          {% set draft = drafts.get(device_id, {}) %}
          {% set weather = draft.get('data', {}).get('weather_start') %}
          {{ 'Captured' if weather else 'Not captured' }}
        attributes:
          data: >
            {% set device_id = states('input_text.hfm_current_device') %}
            {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
            {% set draft = drafts.get(device_id, {}) %}
            {{ draft.get('data', {}).get('weather_start') }}

      - name: "HFM Weather Mid"
        unique_id: hfm_weather_mid
        icon: mdi:weather-cloudy-clock
        state: >
          {% set device_id = states('input_text.hfm_current_device') %}
          {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
          {% set draft = drafts.get(device_id, {}) %}
          {% set weather = draft.get('data', {}).get('weather_mid') %}
          {{ 'Captured' if weather else 'Not captured' }}
        attributes:
          data: >
            {% set device_id = states('input_text.hfm_current_device') %}
            {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
            {% set draft = drafts.get(device_id, {}) %}
            {{ draft.get('data', {}).get('weather_mid') }}

      - name: "HFM Weather End"
        unique_id: hfm_weather_end
        icon: mdi:weather-cloudy-clock
        state: >
          {% set device_id = states('input_text.hfm_current_device') %}
          {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
          {% set draft = drafts.get(device_id, {}) %}
          {% set weather = draft.get('data', {}).get('weather_end') %}
          {{ 'Captured' if weather else 'Not captured' }}
        attributes:
          data: >
            {% set device_id = states('input_text.hfm_current_device') %}
            {% set drafts = state_attr('sensor.hfm_drafts', 'drafts') or {} %}
            {% set draft = drafts.get(device_id, {}) %}
            {{ draft.get('data', {}).get('weather_end') }}


# -----------------------------------------------------------------------------
# Automations - Dropdown Updates
# -----------------------------------------------------------------------------
automation:
  - id: hfm_update_paddock_options
    alias: "HFM Update Paddock Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_selected_paddock
        data:
          options: >
            {% set names = state_attr('sensor.hfm_events', 'paddock_names') or [] %}
            {{ ['Select Paddock'] + names if names else ['Select Paddock'] }}

  - id: hfm_update_product_options
    alias: "HFM Update Product Options"
    trigger:
      - platform: state
        entity_id: sensor.ipm_products
      - platform: state
        entity_id: input_select.hfm_event_type
      - platform: homeassistant
        event: start
    action:
      - delay: 1
      - variables:
          product_options: >
            {% set event_type = states('input_select.hfm_event_type') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set category_filter = 'Fertiliser' if event_type == 'Nutrient Application' else ('Chemical' if event_type == 'Chemical Application' else '') %}
            {% set ns = namespace(names=[]) %}
            {% for p in product_list if p.category == category_filter %}
              {% set ns.names = ns.names + [p.name] %}
            {% endfor %}
            {{ ['Select Product'] + (ns.names | sort) if ns.names else ['Select Product'] }}
      - service: input_select.set_options
        target:
          entity_id:
            - input_select.hfm_selected_product
            - input_select.hfm_selected_product_2
            - input_select.hfm_selected_product_3
            - input_select.hfm_selected_product_4
            - input_select.hfm_selected_product_5
            - input_select.hfm_selected_product_6
        data:
          options: "{{ product_options }}"

  - id: hfm_set_product_unit
    alias: "HFM Set Product Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_set_product_unit_2
    alias: "HFM Set Product 2 Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product_2
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product_2') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit_2
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product_2') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_set_product_unit_3
    alias: "HFM Set Product 3 Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product_3
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product_3') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit_3
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product_3') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_set_product_unit_4
    alias: "HFM Set Product 4 Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product_4
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product_4') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit_4
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product_4') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_set_product_unit_5
    alias: "HFM Set Product 5 Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product_5
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product_5') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit_5
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product_5') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_set_product_unit_6
    alias: "HFM Set Product 6 Unit from IPM"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_product_6
    condition:
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_product_6') != 'Select Product' }}"
    action:
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_rate_unit_6
        data:
          value: >
            {% set product_name = states('input_select.hfm_selected_product_6') %}
            {% set products = state_attr('sensor.ipm_products', 'products') or {} %}
            {% set product_list = products.values() | list if products is mapping else products %}
            {% set ns = namespace(unit='') %}
            {% for p in product_list if p.name == product_name %}
              {% set ns.unit = p.application_unit | default(p.unit, true) %}
            {% endfor %}
            {{ ns.unit | trim | default('kg/ha', true) }}

  - id: hfm_update_method_options
    alias: "HFM Update Application Method Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_application_method
        data:
          options: >
            {% set names = state_attr('sensor.hfm_events', 'method_names') or [] %}
            {{ ['Select Method'] + names if names else ['Select Method'] }}

  - id: hfm_update_stage_options
    alias: "HFM Update Crop Stage Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_crop_stage
        data:
          options: >
            {% set names = state_attr('sensor.hfm_events', 'crop_stage_names') or [] %}
            {{ ['Select Stage'] + names if names else ['Select Stage'] }}

  - id: hfm_update_irrigation_options
    alias: "HFM Update Irrigation Type Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_irrigation_type
        data:
          options: >
            {% set names = state_attr('sensor.hfm_events', 'irrigation_names') or [] %}
            {{ ['Select Type'] + names if names else ['Select Type'] }}

  - id: hfm_update_event_list
    alias: "HFM Update Event List for Editing"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_edit_event
        data:
          options: >
            {% set events = state_attr('sensor.hfm_events', 'all_events') or [] %}
            {% set pmap = state_attr('sensor.hfm_events', 'paddock_map') or {} %}
            {% set ns = namespace(opts=['Select Event']) %}
            {% for e in events[:20] %}
              {% set first_paddock = e.paddocks[0] if e.paddocks else '' %}
              {% set pname = pmap.get(first_paddock, first_paddock) if first_paddock else 'Unknown' %}
              {% set etype = e.event_type | replace('_', ' ') | title %}
              {% set label = e.event_date ~ ' | ' ~ etype ~ ' | ' ~ pname %}
              {% set ns.opts = ns.opts + [label] %}
            {% endfor %}
            {{ ns.opts }}

  # --- Draft System Automations ---

  - id: hfm_cleanup_old_drafts
    alias: "HFM Cleanup Old Drafts"
    description: "Remove drafts older than 24 hours"
    trigger:
      - platform: time
        at: "03:00:00"
      - platform: homeassistant
        event: start
    action:
      - delay: 30
      - service: shell_command.hfm_cleanup_drafts
        data:
          max_age_hours: 24
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  - id: hfm_update_applicator_options
    alias: "HFM Update Applicator Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_events
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_selected_applicator
        data:
          options: >
            {% set names = state_attr('sensor.hfm_events', 'applicator_names') or [] %}
            {{ ['Select Applicator'] + names if names else ['Select Applicator'] }}

  - id: hfm_update_farm_options
    alias: "HFM Update Farm Options"
    trigger:
      - platform: state
        entity_id: sensor.hfm_drafts
      - platform: homeassistant
        event: start
    action:
      - delay: 2
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_selected_farm
        data:
          options: >
            {% set farms = state_attr('sensor.hfm_drafts', 'farms') or {} %}
            {% set names = farms.values() | list | sort %}
            {{ ['Select Farm'] + names if names else ['Select Farm'] }}

  - id: hfm_sync_farm_to_draft
    alias: "HFM Sync Farm Selection to Draft"
    trigger:
      - platform: state
        entity_id: input_select.hfm_selected_farm
    condition:
      - condition: template
        value_template: "{{ states('input_text.hfm_current_device') != '' }}"
      - condition: template
        value_template: "{{ states('input_select.hfm_selected_farm') != 'Select Farm' }}"
    action:
      - variables:
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"farm_id": "{{ farm_id }}", "paddocks": []}}'
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts
      # Update paddock dropdown options
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_paddock_to_toggle
        data:
          options: >
            {% set farm_id = states('sensor.hfm_selected_farm_id') %}
            {% set by_farm = state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} %}
            {% set paddocks = by_farm.get(farm_id, []) %}
            {% set names = paddocks | map(attribute='name') | list | sort %}
            {{ ['Select Paddock'] + names if names else ['Select Paddock'] }}

  - id: hfm_populate_paddock_dropdown
    alias: "HFM Populate Paddock Dropdown on Sensor Update"
    trigger:
      - platform: state
        entity_id: sensor.hfm_selected_farm_id
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.hfm_paddock_to_toggle
        data:
          options: >
            {% set farm_id = states('sensor.hfm_selected_farm_id') %}
            {% set by_farm = state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} %}
            {% set paddocks = by_farm.get(farm_id, []) %}
            {% set names = paddocks | map(attribute='name') | list | sort %}
            {{ ['Select Paddock'] + names if names else ['Select Paddock'] }}

  - id: hfm_auto_toggle_paddock_on_select
    alias: "HFM Auto-Toggle Paddock When Selected"
    trigger:
      - platform: state
        entity_id: input_select.hfm_paddock_to_toggle
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select Paddock' and trigger.to_state.state != trigger.from_state.state }}"
    action:
      - service: script.hfm_toggle_selected_paddock
      - delay:
          milliseconds: 300
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_paddock_to_toggle
        data:
          option: "Select Paddock"

  # --- Weather Auto-Capture Automations ---

  - id: hfm_schedule_weather_captures
    alias: "HFM Schedule Weather Captures"
    description: "Calculate and schedule weather capture times, or capture immediately for past events"
    trigger:
      - platform: state
        entity_id: input_number.hfm_hour
      - platform: state
        entity_id: input_select.hfm_ampm
      - platform: state
        entity_id: input_number.hfm_duration_minutes
      - platform: state
        entity_id: sensor.hfm_event_date
      - platform: state
        entity_id: input_number.hfm_wizard_step
        to: "4"
    condition:
      - condition: template
        value_template: >
          {{ states('sensor.hfm_spray_start_time') | regex_match('^[0-9]{1,2}:[0-9]{2}$')
             and states('sensor.hfm_event_date') | regex_match('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
             and states('input_select.hfm_event_type') == 'Chemical Application' }}
    action:
      - variables:
          event_date: "{{ states('sensor.hfm_event_date') }}"
          start_time: "{{ states('sensor.hfm_spray_start_time') }}"
          duration: "{{ states('input_number.hfm_duration_minutes') | float(60) }}"
          start_dt: "{{ strptime(event_date ~ ' ' ~ start_time, '%Y-%m-%d %H:%M') }}"
          middle_dt: "{{ start_dt + timedelta(minutes=(duration/2)|int) }}"
          end_dt: "{{ start_dt + timedelta(minutes=duration|int) }}"
          # Check if event is in the past (end time already passed)
          is_past_event: "{{ end_dt < now() }}"
          start_passed: "{{ start_dt < now() }}"
          middle_passed: "{{ middle_dt < now() }}"
          end_passed: "{{ end_dt < now() }}"
      # For past events, immediately capture all phases with current weather
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_past_event }}"
            sequence:
              - service: script.hfm_capture_weather_phase
                data:
                  phase: start
              - delay:
                  milliseconds: 300
              - service: script.hfm_capture_weather_phase
                data:
                  phase: mid
              - delay:
                  milliseconds: 300
              - service: script.hfm_capture_weather_phase
                data:
                  phase: end
              - service: persistent_notification.create
                data:
                  title: "Weather Captured (Past Event)"
                  message: "All 3 weather records captured with current conditions for past event"
                  notification_id: hfm_weather_complete
        default:
          # For future/current events, schedule the captures
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.hfm_weather_capture_start
            data:
              datetime: "{{ start_dt.strftime('%Y-%m-%d %H:%M:%S') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.hfm_weather_capture_middle
            data:
              datetime: "{{ middle_dt.strftime('%Y-%m-%d %H:%M:%S') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.hfm_weather_capture_end
            data:
              datetime: "{{ end_dt.strftime('%Y-%m-%d %H:%M:%S') }}"
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.hfm_weather_capture_enabled
          # Immediately capture any phases whose time has already passed
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ start_passed }}"
                sequence:
                  - service: script.hfm_capture_weather_phase
                    data:
                      phase: start
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ middle_passed }}"
                sequence:
                  - service: script.hfm_capture_weather_phase
                    data:
                      phase: mid

  - id: hfm_auto_capture_weather_start
    alias: "HFM Auto Capture Weather - Start"
    description: "Automatically capture weather at start time"
    trigger:
      - platform: time
        at: input_datetime.hfm_weather_capture_start
    condition:
      - condition: state
        entity_id: input_boolean.hfm_weather_capture_enabled
        state: "on"
      - condition: template
        value_template: "{{ states('input_text.hfm_current_device') != '' }}"
    action:
      - service: script.hfm_capture_weather_start
      - service: persistent_notification.create
        data:
          title: "Weather Captured - Start"
          message: "Start weather conditions recorded automatically"
          notification_id: hfm_weather_start

  - id: hfm_auto_capture_weather_middle
    alias: "HFM Auto Capture Weather - Middle"
    description: "Automatically capture weather at middle time"
    trigger:
      - platform: time
        at: input_datetime.hfm_weather_capture_middle
    condition:
      - condition: state
        entity_id: input_boolean.hfm_weather_capture_enabled
        state: "on"
      - condition: template
        value_template: "{{ states('input_text.hfm_current_device') != '' }}"
    action:
      - service: script.hfm_capture_weather_mid
      - service: persistent_notification.create
        data:
          title: "Weather Captured - Mid"
          message: "Mid weather conditions recorded automatically"
          notification_id: hfm_weather_mid

  - id: hfm_auto_capture_weather_end
    alias: "HFM Auto Capture Weather - End"
    description: "Automatically capture weather at end time"
    trigger:
      - platform: time
        at: input_datetime.hfm_weather_capture_end
    condition:
      - condition: state
        entity_id: input_boolean.hfm_weather_capture_enabled
        state: "on"
      - condition: template
        value_template: "{{ states('input_text.hfm_current_device') != '' }}"
    action:
      - service: script.hfm_capture_weather_end
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hfm_weather_capture_enabled
      - service: persistent_notification.create
        data:
          title: "Weather Capture Complete"
          message: "All 3 weather records captured automatically"
          notification_id: hfm_weather_complete


# -----------------------------------------------------------------------------
# Scripts - Form Submissions
# -----------------------------------------------------------------------------
script:
  hfm_init:
    alias: "HFM Initialize"
    icon: mdi:cog
    sequence:
      - service: shell_command.hfm_init
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events

  # --- Draft-Based Wizard Scripts ---

  hfm_start_wizard:
    alias: "HFM Start New Event Wizard"
    icon: mdi:plus-circle
    description: "Initialize draft and start the event wizard"
    fields:
      device_id:
        description: "Device ID (optional - uses default if not provided)"
        example: "browser_abc123"
    sequence:
      - variables:
          # Use provided device_id or generate from timestamp
          effective_device_id: >
            {% if device_id is defined and device_id != '' %}
              {{ device_id }}
            {% elif states('input_text.hfm_current_device') != '' %}
              {{ states('input_text.hfm_current_device') }}
            {% else %}
              device_{{ now().strftime('%Y%m%d%H%M%S') }}
            {% endif %}
      # Set current device
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_current_device
        data:
          value: "{{ effective_device_id }}"
      # Initialize draft
      - service: shell_command.hfm_load_draft
        data:
          device_id: "{{ effective_device_id }}"
      # Clear draft to fresh state
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ effective_device_id }}"
          data: '{"wizard_step": 1, "data": {"event_type": null, "date": null, "start_time": null, "duration_minutes": null, "farm_id": null, "paddocks": [], "products": [], "applicator_id": null, "application_method": null, "crop_stage": null, "irrigation_type": null, "notes": "", "weather_start": null, "weather_mid": null, "weather_end": null}}'
      # Reset UI helpers
      - service: script.hfm_wizard_reset
      # Update sensors
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_sync_wizard_to_draft:
    alias: "HFM Sync Wizard State to Draft"
    icon: mdi:sync
    description: "Sync current input helper state to the draft"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          event_type_raw: "{{ states('input_select.hfm_event_type') }}"
          event_type: >
            {% if event_type_raw == 'Nutrient Application' %}nutrient
            {% elif event_type_raw == 'Chemical Application' %}chemical
            {% elif event_type_raw == 'Irrigation' %}irrigation
            {% elif event_type_raw == 'Crop Stage' %}crop_stage
            {% else %}null{% endif %}
          event_date: "{{ states('sensor.hfm_event_date') }}"
          wizard_step: "{{ states('input_number.hfm_wizard_step') | int }}"
          start_time: "{{ states('input_text.hfm_start_time') }}"
          duration: "{{ states('input_number.hfm_duration_minutes') | int }}"
          notes: "{{ states('input_text.hfm_notes') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          # Build paddock from single select (legacy) or multi-select
          paddock_id: >
            {% set pname = states('input_select.hfm_selected_paddock') %}
            {% set pmap = state_attr('sensor.hfm_events', 'paddock_map') or {} %}
            {% for pid, name in pmap.items() if name == pname %}{{ pid }}{% endfor %}
          # Get paddocks from draft (for multi-select)
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
          # Use draft paddocks if available, otherwise single selection
          paddocks: >
            {% if current_paddocks | length > 0 %}
              {{ current_paddocks }}
            {% elif paddock_id %}
              ["{{ paddock_id }}"]
            {% else %}
              []
            {% endif %}
          # Application method ID
          method_name: "{{ states('input_select.hfm_application_method') }}"
          method_id: >
            {% set methods = state_attr('sensor.hfm_events', 'application_methods') or [] %}
            {% for m in methods if m.name == method_name %}{{ m.id }}{% endfor %}
          # Applicator ID from selection
          app_name: "{{ states('input_select.hfm_selected_applicator') }}"
          applicator_id: >
            {% set apps = state_attr('sensor.hfm_events', 'active_applicators') or [] %}
            {% for a in apps if a.name == app_name %}{{ a.id }}{% endfor %}
          # Crop stage ID
          stage_name: "{{ states('input_select.hfm_crop_stage') }}"
          stage_id: >
            {% set stages = state_attr('sensor.hfm_events', 'crop_stages') or [] %}
            {% for s in stages if s.name == stage_name %}{{ s.id }}{% endfor %}
          # Irrigation type ID
          irrigation_name: "{{ states('input_select.hfm_irrigation_type') }}"
          irrigation_id: >
            {% set types = state_attr('sensor.hfm_events', 'irrigation_types') or [] %}
            {% for t in types if t.name == irrigation_name %}{{ t.id }}{% endfor %}
          # Build products array
          product_count: "{{ states('input_number.hfm_product_count') | int }}"
          products_json: >
            {% set ns = namespace(products=[]) %}
            {% set p1 = states('input_select.hfm_selected_product') %}
            {% set r1 = states('input_text.hfm_product_rate') %}
            {% set u1 = states('input_text.hfm_rate_unit') %}
            {% if p1 != 'Select Product' and r1 != '' %}
              {% set ns.products = ns.products + [{'product_name': p1, 'rate': r1 | float(0), 'rate_unit': u1}] %}
            {% endif %}
            {% if product_count >= 2 %}
              {% set p2 = states('input_select.hfm_selected_product_2') %}
              {% set r2 = states('input_text.hfm_product_rate_2') %}
              {% set u2 = states('input_text.hfm_rate_unit_2') %}
              {% if p2 != 'Select Product' and r2 != '' %}
                {% set ns.products = ns.products + [{'product_name': p2, 'rate': r2 | float(0), 'rate_unit': u2}] %}
              {% endif %}
            {% endif %}
            {% if product_count >= 3 %}
              {% set p3 = states('input_select.hfm_selected_product_3') %}
              {% set r3 = states('input_text.hfm_product_rate_3') %}
              {% set u3 = states('input_text.hfm_rate_unit_3') %}
              {% if p3 != 'Select Product' and r3 != '' %}
                {% set ns.products = ns.products + [{'product_name': p3, 'rate': r3 | float(0), 'rate_unit': u3}] %}
              {% endif %}
            {% endif %}
            {% if product_count >= 4 %}
              {% set p4 = states('input_select.hfm_selected_product_4') %}
              {% set r4 = states('input_text.hfm_product_rate_4') %}
              {% set u4 = states('input_text.hfm_rate_unit_4') %}
              {% if p4 != 'Select Product' and r4 != '' %}
                {% set ns.products = ns.products + [{'product_name': p4, 'rate': r4 | float(0), 'rate_unit': u4}] %}
              {% endif %}
            {% endif %}
            {% if product_count >= 5 %}
              {% set p5 = states('input_select.hfm_selected_product_5') %}
              {% set r5 = states('input_text.hfm_product_rate_5') %}
              {% set u5 = states('input_text.hfm_rate_unit_5') %}
              {% if p5 != 'Select Product' and r5 != '' %}
                {% set ns.products = ns.products + [{'product_name': p5, 'rate': r5 | float(0), 'rate_unit': u5}] %}
              {% endif %}
            {% endif %}
            {% if product_count >= 6 %}
              {% set p6 = states('input_select.hfm_selected_product_6') %}
              {% set r6 = states('input_text.hfm_product_rate_6') %}
              {% set u6 = states('input_text.hfm_rate_unit_6') %}
              {% if p6 != 'Select Product' and r6 != '' %}
                {% set ns.products = ns.products + [{'product_name': p6, 'rate': r6 | float(0), 'rate_unit': u6}] %}
              {% endif %}
            {% endif %}
            {{ ns.products }}
      - condition: template
        value_template: "{{ device_id != '' }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: >
            {
              "wizard_step": {{ wizard_step }},
              "data": {
                "event_type": {% if event_type != 'null' %}"{{ event_type }}"{% else %}null{% endif %},
                "date": {% if event_date %}"{{ event_date }}"{% else %}null{% endif %},
                "start_time": {% if start_time %}"{{ start_time }}"{% else %}null{% endif %},
                "duration_minutes": {% if duration > 0 %}{{ duration }}{% else %}null{% endif %},
                "farm_id": {% if farm_id %}"{{ farm_id }}"{% else %}null{% endif %},
                "paddocks": {{ paddocks | to_json }},
                "products": {{ products_json | to_json }},
                "applicator_id": {% if applicator_id %}"{{ applicator_id }}"{% else %}null{% endif %},
                "application_method": {% if method_id %}"{{ method_id }}"{% else %}null{% endif %},
                "crop_stage": {% if stage_id %}"{{ stage_id }}"{% else %}null{% endif %},
                "irrigation_type": {% if irrigation_id %}"{{ irrigation_id }}"{% else %}null{% endif %},
                "notes": "{{ notes }}"
              }
            }

  hfm_submit_from_draft:
    alias: "HFM Submit Event from Draft"
    icon: mdi:check-bold
    description: "Submit the current draft as event(s)"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' }}"
      # Sync current state to draft first
      - service: script.hfm_sync_wizard_to_draft
      - delay: 1
      # Capture weather if nutrient/chemical
      - variables:
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          event_type: "{{ draft.get('data', {}).get('event_type') }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ event_type in ['nutrient', 'chemical'] }}"
            sequence:
              - service: script.hfm_capture_weather
                data:
                  device_id: "{{ device_id }}"
              - delay: 1
      # Submit the draft
      - service: shell_command.hfm_submit_draft
        data:
          device_id: "{{ device_id }}"
      - delay: 1
      # Update sensors
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.hfm_events
            - sensor.hfm_drafts
      # Notify success
      - service: persistent_notification.create
        data:
          title: "Event Saved"
          message: "Farm event has been recorded successfully."
          notification_id: hfm_event_saved
      # Reset wizard
      - service: script.hfm_wizard_reset

  hfm_wizard_next:
    alias: "HFM Wizard Next Step"
    icon: mdi:arrow-right
    sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_wizard_step
        data:
          value: "{{ states('input_number.hfm_wizard_step') | int + 1 }}"

  hfm_wizard_prev:
    alias: "HFM Wizard Previous Step"
    icon: mdi:arrow-left
    sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_wizard_step
        data:
          value: "{{ [1, states('input_number.hfm_wizard_step') | int - 1] | max }}"

  # --- Paddock Selection Scripts ---

  hfm_select_all_paddocks:
    alias: "HFM Select All Paddocks"
    icon: mdi:checkbox-multiple-marked
    description: "Select all paddocks for the current farm"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          paddocks_by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          farm_paddocks: "{{ paddocks_by_farm.get(farm_id, []) }}"
          all_ids: "{{ farm_paddocks | map(attribute='id') | list }}"
      - condition: template
        value_template: "{{ device_id != '' and all_ids | length > 0 }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ all_ids | tojson }}}}'
      - delay: 0.5
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_clear_paddock_selection:
    alias: "HFM Clear Paddock Selection"
    icon: mdi:checkbox-multiple-blank-outline
    description: "Clear all selected paddocks"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": []}}'
      - delay: 0.5
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_select_current_season_paddocks:
    alias: "HFM Select Current Season Paddocks"
    icon: mdi:calendar-check
    description: "Select paddocks with current_season flag"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          paddocks_by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          farm_paddocks: "{{ paddocks_by_farm.get(farm_id, []) }}"
          season_ids: "{{ farm_paddocks | selectattr('current_season', 'eq', true) | map(attribute='id') | list }}"
      - condition: template
        value_template: "{{ device_id != '' }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ season_ids | tojson }}}}'
      - delay: 0.5
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_toggle_paddock_by_index:
    alias: "HFM Toggle Paddock by Index"
    icon: mdi:checkbox-marked-outline
    description: "Toggle a paddock selection by its index in the farm's paddock list"
    fields:
      index:
        description: "Index of paddock in the farm's paddock list (0-based)"
        example: 0
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          paddocks_by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          farm_paddocks: "{{ paddocks_by_farm.get(farm_id, []) }}"
          paddock_id: "{{ farm_paddocks[index | int].id if farm_paddocks | length > index | int else '' }}"
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
          is_selected: "{{ paddock_id in current_paddocks }}"
          new_paddocks: >
            {% if is_selected %}
              {{ current_paddocks | reject('eq', paddock_id) | list }}
            {% else %}
              {{ current_paddocks + [paddock_id] }}
            {% endif %}
      - condition: template
        value_template: "{{ device_id != '' and paddock_id != '' }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ new_paddocks | tojson }}}}'
      - delay: 0.3
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_toggle_paddock:
    alias: "HFM Toggle Paddock"
    icon: mdi:checkbox-marked-outline
    description: "Toggle a paddock selection by its ID"
    fields:
      paddock_id:
        description: "ID of the paddock to toggle"
        example: "paddock_abc123"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
          is_selected: "{{ paddock_id in current_paddocks }}"
          new_paddocks: >
            {% if is_selected %}
              {{ current_paddocks | reject('eq', paddock_id) | list }}
            {% else %}
              {{ current_paddocks + [paddock_id] }}
            {% endif %}
      - condition: template
        value_template: "{{ device_id != '' and paddock_id is defined }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ new_paddocks | tojson }}}}'
      - delay: 0.3
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_add_product_slot:
    alias: "HFM Add Product Slot"
    icon: mdi:flask-plus
    sequence:
      - condition: template
        value_template: "{{ states('input_number.hfm_product_count') | int < 6 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_product_count
        data:
          value: "{{ states('input_number.hfm_product_count') | int + 1 }}"

  hfm_remove_product_slot:
    alias: "HFM Remove Product Slot"
    icon: mdi:flask-minus
    sequence:
      - condition: template
        value_template: "{{ states('input_number.hfm_product_count') | int > 1 }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_product_count
        data:
          value: "{{ states('input_number.hfm_product_count') | int - 1 }}"

  hfm_wizard_reset:
    alias: "HFM Wizard Reset"
    icon: mdi:restart
    sequence:
      # Clear edit mode
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hfm_edit_mode
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_edit_event_id
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_wizard_step
        data:
          value: 1
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_event_type
        data:
          option: "Select Type"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_when
        data:
          option: "Today"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_selected_paddock
        data:
          option: "Select Paddock"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_selected_product
        data:
          option: "Select Product"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_application_method
        data:
          option: "Select Method"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_crop_stage
        data:
          option: "Select Stage"
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_irrigation_type
        data:
          option: "Select Type"
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_notes
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_specific_date
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_product_rate
        data:
          value: ""
      # Reset product count and all product slots
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_product_count
        data:
          value: 1
      - service: input_select.select_option
        target:
          entity_id:
            - input_select.hfm_selected_product_2
            - input_select.hfm_selected_product_3
            - input_select.hfm_selected_product_4
            - input_select.hfm_selected_product_5
            - input_select.hfm_selected_product_6
        data:
          option: "Select Product"
      - service: input_text.set_value
        target:
          entity_id:
            - input_text.hfm_product_rate_2
            - input_text.hfm_product_rate_3
            - input_text.hfm_product_rate_4
            - input_text.hfm_product_rate_5
            - input_text.hfm_product_rate_6
        data:
          value: ""

  hfm_submit_event:
    alias: "HFM Submit Event"
    icon: mdi:check
    description: "Submit event - uses draft system for multi-user support"
    sequence:
      # Check if we have a device ID (draft mode)
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - choose:
          # If device ID is set, use draft-based submission
          - conditions:
              - condition: template
                value_template: "{{ device_id != '' }}"
            sequence:
              - service: script.hfm_submit_from_draft
        # Otherwise fall back to legacy submission
        default:
          - variables:
              event_type: >
                {% set sel = states('input_select.hfm_event_type') %}
                {% if sel == 'Nutrient Application' %}nutrient
                {% elif sel == 'Chemical Application' %}chemical
                {% elif sel == 'Irrigation' %}irrigation
                {% elif sel == 'Crop Stage' %}crop_stage
                {% else %}unknown{% endif %}
              event_date: "{{ states('sensor.hfm_event_date') }}"
              paddock_name: "{{ states('input_select.hfm_selected_paddock') }}"
              paddock_id: >
                {% set pmap = state_attr('sensor.hfm_events', 'paddock_map') or {} %}
                {% for pid, pname in pmap.items() if pname == paddock_name %}{{ pid }}{% endfor %}
              product_count: "{{ states('input_number.hfm_product_count') | int }}"
              products_json: >
                {% set ns = namespace(products=[]) %}
                {% set p1 = states('input_select.hfm_selected_product') %}
                {% set r1 = states('input_text.hfm_product_rate') %}
                {% set u1 = states('input_text.hfm_rate_unit') %}
                {% if p1 != 'Select Product' and r1 != '' %}
                  {% set ns.products = ns.products + [{'product_name': p1, 'rate': r1 | float(0), 'rate_unit': u1}] %}
                {% endif %}
                {% if product_count >= 2 %}
                  {% set p2 = states('input_select.hfm_selected_product_2') %}
                  {% set r2 = states('input_text.hfm_product_rate_2') %}
                  {% set u2 = states('input_text.hfm_rate_unit_2') %}
                  {% if p2 != 'Select Product' and r2 != '' %}
                    {% set ns.products = ns.products + [{'product_name': p2, 'rate': r2 | float(0), 'rate_unit': u2}] %}
                  {% endif %}
                {% endif %}
                {% if product_count >= 3 %}
                  {% set p3 = states('input_select.hfm_selected_product_3') %}
                  {% set r3 = states('input_text.hfm_product_rate_3') %}
                  {% set u3 = states('input_text.hfm_rate_unit_3') %}
                  {% if p3 != 'Select Product' and r3 != '' %}
                    {% set ns.products = ns.products + [{'product_name': p3, 'rate': r3 | float(0), 'rate_unit': u3}] %}
                  {% endif %}
                {% endif %}
                {% if product_count >= 4 %}
                  {% set p4 = states('input_select.hfm_selected_product_4') %}
                  {% set r4 = states('input_text.hfm_product_rate_4') %}
                  {% set u4 = states('input_text.hfm_rate_unit_4') %}
                  {% if p4 != 'Select Product' and r4 != '' %}
                    {% set ns.products = ns.products + [{'product_name': p4, 'rate': r4 | float(0), 'rate_unit': u4}] %}
                  {% endif %}
                {% endif %}
                {% if product_count >= 5 %}
                  {% set p5 = states('input_select.hfm_selected_product_5') %}
                  {% set r5 = states('input_text.hfm_product_rate_5') %}
                  {% set u5 = states('input_text.hfm_rate_unit_5') %}
                  {% if p5 != 'Select Product' and r5 != '' %}
                    {% set ns.products = ns.products + [{'product_name': p5, 'rate': r5 | float(0), 'rate_unit': u5}] %}
                  {% endif %}
                {% endif %}
                {% if product_count >= 6 %}
                  {% set p6 = states('input_select.hfm_selected_product_6') %}
                  {% set r6 = states('input_text.hfm_product_rate_6') %}
                  {% set u6 = states('input_text.hfm_rate_unit_6') %}
                  {% if p6 != 'Select Product' and r6 != '' %}
                    {% set ns.products = ns.products + [{'product_name': p6, 'rate': r6 | float(0), 'rate_unit': u6}] %}
                  {% endif %}
                {% endif %}
                {{ ns.products | to_json }}
              method_name: "{{ states('input_select.hfm_application_method') }}"
              method_id: >
                {% set methods = state_attr('sensor.hfm_events', 'application_methods') or [] %}
                {% for m in methods if m.name == method_name %}{{ m.id }}{% endfor %}
              stage_name: "{{ states('input_select.hfm_crop_stage') }}"
              stage_id: >
                {% set stages = state_attr('sensor.hfm_events', 'crop_stages') or [] %}
                {% for s in stages if s.name == stage_name %}{{ s.id }}{% endfor %}
              irrigation_name: "{{ states('input_select.hfm_irrigation_type') }}"
              irrigation_id: >
                {% set types = state_attr('sensor.hfm_events', 'irrigation_types') or [] %}
                {% for t in types if t.name == irrigation_name %}{{ t.id }}{% endfor %}
              notes: "{{ states('input_text.hfm_notes') }}"
              is_edit: "{{ is_state('input_boolean.hfm_edit_mode', 'on') }}"
              edit_event_id: "{{ states('input_text.hfm_edit_event_id') }}"
          # Choose between add or edit based on mode
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.hfm_edit_mode
                    state: "on"
                sequence:
                  - service: shell_command.hfm_edit_event
                    data:
                      event_id: "{{ edit_event_id }}"
                      event_date: "{{ event_date }}"
                      paddocks: '["{{ paddock_id }}"]'
                      products: "{{ products_json }}"
                      application_method: "{{ method_id }}"
                      crop_stage: "{{ stage_id }}"
                      irrigation_type: "{{ irrigation_id }}"
                      notes: "{{ notes }}"
            default:
              - service: shell_command.hfm_add_event
                data:
                  event_type: "{{ event_type }}"
                  paddocks: '["{{ paddock_id }}"]'
                  products: "{{ products_json }}"
                  application_method: "{{ method_id }}"
                  crop_stage: "{{ stage_id }}"
                  irrigation_type: "{{ irrigation_id }}"
                  event_date: "{{ event_date }}"
                  notes: "{{ notes }}"
                  device_id: ""
          - delay: 1
          - service: homeassistant.update_entity
            target:
              entity_id: sensor.hfm_events
          - service: persistent_notification.create
            data:
              title: "{{ 'Event Updated' if is_edit else 'Event Saved' }}"
              message: "{{ event_type | title }} event {{ 'updated' if is_edit else 'recorded' }} for {{ states('input_select.hfm_selected_paddock') }} on {{ event_date }}"
              notification_id: hfm_event_saved
          - service: script.hfm_wizard_reset

  hfm_delete_event:
    alias: "HFM Delete Event"
    icon: mdi:delete
    sequence:
      - variables:
          selected: "{{ states('input_select.hfm_edit_event') }}"
          parts: "{{ selected.split(' | ') }}"
          sel_date: "{{ parts[0] if parts | length > 0 else '' }}"
          sel_type: "{{ parts[1] | lower | replace(' ', '_') if parts | length > 1 else '' }}"
          sel_paddock: "{{ parts[2] if parts | length > 2 else '' }}"
          events: "{{ state_attr('sensor.hfm_events', 'all_events') or [] }}"
          pmap: "{{ state_attr('sensor.hfm_events', 'paddock_map') or {} }}"
          event_id: >
            {% for e in events %}
              {% set first_paddock = e.paddocks[0] if e.paddocks else '' %}
              {% set pname = pmap.get(first_paddock, first_paddock) if first_paddock else 'Unknown' %}
              {% if e.event_date == sel_date and e.event_type == sel_type and pname == sel_paddock %}
                {{ e.id }}
              {% endif %}
            {% endfor %}
      - condition: template
        value_template: "{{ event_id | trim != '' }}"
      - service: shell_command.hfm_delete_event
        data:
          event_id: "{{ event_id | trim }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events

  hfm_confirm_event:
    alias: "HFM Confirm Event"
    icon: mdi:check-circle
    sequence:
      - variables:
          selected: "{{ states('input_select.hfm_edit_event') }}"
          parts: "{{ selected.split(' | ') }}"
          sel_date: "{{ parts[0] if parts | length > 0 else '' }}"
          sel_type: "{{ parts[1] | lower | replace(' ', '_') if parts | length > 1 else '' }}"
          sel_paddock: "{{ parts[2] if parts | length > 2 else '' }}"
          events: "{{ state_attr('sensor.hfm_events', 'all_events') or [] }}"
          pmap: "{{ state_attr('sensor.hfm_events', 'paddock_map') or {} }}"
          event_id: >
            {% for e in events %}
              {% set first_paddock = e.paddocks[0] if e.paddocks else '' %}
              {% set pname = pmap.get(first_paddock, first_paddock) if first_paddock else 'Unknown' %}
              {% if e.event_date == sel_date and e.event_type == sel_type and pname == sel_paddock %}
                {{ e.id }}
              {% endif %}
            {% endfor %}
      - condition: template
        value_template: "{{ event_id | trim != '' }}"
      - service: shell_command.hfm_confirm_event
        data:
          event_id: "{{ event_id | trim }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events

  hfm_load_event_for_edit:
    alias: "HFM Load Event for Editing"
    icon: mdi:pencil
    sequence:
      - variables:
          selected: "{{ states('input_select.hfm_edit_event') }}"
          parts: "{{ selected.split(' | ') }}"
          sel_date: "{{ parts[0] if parts | length > 0 else '' }}"
          sel_type: "{{ parts[1] | lower | replace(' ', '_') if parts | length > 1 else '' }}"
          sel_paddock: "{{ parts[2] if parts | length > 2 else '' }}"
      - condition: template
        value_template: "{{ sel_date != '' and sel_type != '' }}"
      - variables:
          events: "{{ state_attr('sensor.hfm_events', 'all_events') or [] }}"
          pmap: "{{ state_attr('sensor.hfm_events', 'paddock_map') or {} }}"
          event: >
            {% for e in events %}
              {% set first_paddock = e.paddocks[0] if e.paddocks else '' %}
              {% set pname = pmap.get(first_paddock, first_paddock) if first_paddock else 'Unknown' %}
              {% if e.event_date == sel_date and e.event_type == sel_type and pname == sel_paddock %}
                {{ e | tojson }}
              {% endif %}
            {% endfor %}
      - condition: template
        value_template: "{{ event != '' }}"
      - variables:
          event_data: "{{ event | from_json }}"
          pmap: "{{ state_attr('sensor.hfm_events', 'paddock_map') or {} }}"
          first_paddock_id: "{{ event_data.paddocks[0] if event_data.paddocks else '' }}"
          paddock_name: "{{ pmap.get(first_paddock_id, '') if first_paddock_id else '' }}"
          event_type_display: >
            {% set t = event_data.event_type %}
            {% if t == 'nutrient' %}Nutrient Application
            {% elif t == 'chemical' %}Chemical Application
            {% elif t == 'irrigation' %}Irrigation
            {% elif t == 'crop_stage' %}Crop Stage
            {% else %}Select Type{% endif %}
          # Look up display names from IDs
          methods: "{{ state_attr('sensor.hfm_events', 'application_methods') or [] }}"
          method_id: "{{ event_data.application_method | default('') }}"
          method_name: >
            {% for m in methods if m.id == method_id %}{{ m.name }}{% endfor %}
          irrigation_types: "{{ state_attr('sensor.hfm_events', 'irrigation_types') or [] }}"
          irrigation_id: "{{ event_data.irrigation_type | default('') }}"
          irrigation_name: >
            {% for t in irrigation_types if t.id == irrigation_id %}{{ t.name }}{% endfor %}
          crop_stages: "{{ state_attr('sensor.hfm_events', 'crop_stages') or [] }}"
          stage_id: "{{ event_data.crop_stage | default('') }}"
          stage_name: >
            {% for s in crop_stages if s.id == stage_id %}{{ s.name }}{% endfor %}
      # Store the event ID for editing
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_edit_event_id
        data:
          value: "{{ event_data.id }}"
      # Set edit mode on
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hfm_edit_mode
      # Set event type
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_event_type
        data:
          option: "{{ event_type_display }}"
      # Set date
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_when
        data:
          option: "Specific Date"
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_specific_date
        data:
          value: "{{ event_data.event_date }}"
      # Set paddock (wait for options to update)
      - delay: 1
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_selected_paddock
        data:
          option: "{{ paddock_name if paddock_name else 'Select Paddock' }}"
      # Set product details for nutrient/chemical
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ event_data.event_type in ['nutrient', 'chemical'] }}"
            sequence:
              - delay: 1
              # Set product count based on number of products
              - service: input_number.set_value
                target:
                  entity_id: input_number.hfm_product_count
                data:
                  value: "{{ [1, event_data.products | length] | max }}"
              # Load product 1
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product
                data:
                  option: >
                    {% if event_data.products and event_data.products | length > 0 %}
                    {{ event_data.products[0].product_name | default('Select Product') }}
                    {% else %}Select Product{% endif %}
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate
                data:
                  value: "{{ event_data.products[0].rate | default('') if event_data.products | length > 0 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit
                data:
                  value: "{{ event_data.products[0].rate_unit | default('kg/ha') if event_data.products | length > 0 else 'kg/ha' }}"
              # Load product 2
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product_2
                data:
                  option: "{{ event_data.products[1].product_name | default('Select Product') if event_data.products | length > 1 else 'Select Product' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate_2
                data:
                  value: "{{ event_data.products[1].rate | default('') if event_data.products | length > 1 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit_2
                data:
                  value: "{{ event_data.products[1].rate_unit | default('kg/ha') if event_data.products | length > 1 else 'kg/ha' }}"
              # Load product 3
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product_3
                data:
                  option: "{{ event_data.products[2].product_name | default('Select Product') if event_data.products | length > 2 else 'Select Product' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate_3
                data:
                  value: "{{ event_data.products[2].rate | default('') if event_data.products | length > 2 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit_3
                data:
                  value: "{{ event_data.products[2].rate_unit | default('kg/ha') if event_data.products | length > 2 else 'kg/ha' }}"
              # Load product 4
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product_4
                data:
                  option: "{{ event_data.products[3].product_name | default('Select Product') if event_data.products | length > 3 else 'Select Product' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate_4
                data:
                  value: "{{ event_data.products[3].rate | default('') if event_data.products | length > 3 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit_4
                data:
                  value: "{{ event_data.products[3].rate_unit | default('kg/ha') if event_data.products | length > 3 else 'kg/ha' }}"
              # Load product 5
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product_5
                data:
                  option: "{{ event_data.products[4].product_name | default('Select Product') if event_data.products | length > 4 else 'Select Product' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate_5
                data:
                  value: "{{ event_data.products[4].rate | default('') if event_data.products | length > 4 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit_5
                data:
                  value: "{{ event_data.products[4].rate_unit | default('kg/ha') if event_data.products | length > 4 else 'kg/ha' }}"
              # Load product 6
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_selected_product_6
                data:
                  option: "{{ event_data.products[5].product_name | default('Select Product') if event_data.products | length > 5 else 'Select Product' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_product_rate_6
                data:
                  value: "{{ event_data.products[5].rate | default('') if event_data.products | length > 5 else '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.hfm_rate_unit_6
                data:
                  value: "{{ event_data.products[5].rate_unit | default('kg/ha') if event_data.products | length > 5 else 'kg/ha' }}"
              - delay: 1
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_application_method
                data:
                  option: "{{ method_name if method_name else 'Select Method' }}"
          - conditions:
              - condition: template
                value_template: "{{ event_data.event_type == 'irrigation' }}"
            sequence:
              - delay: 1
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_irrigation_type
                data:
                  option: "{{ irrigation_name if irrigation_name else 'Select Type' }}"
          - conditions:
              - condition: template
                value_template: "{{ event_data.event_type == 'crop_stage' }}"
            sequence:
              - delay: 1
              - service: input_select.select_option
                target:
                  entity_id: input_select.hfm_crop_stage
                data:
                  option: "{{ stage_name if stage_name else 'Select Stage' }}"
      # Set notes
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_notes
        data:
          value: "{{ event_data.notes | default('') }}"
      # Go to step 6 (review)
      - service: input_number.set_value
        target:
          entity_id: input_number.hfm_wizard_step
        data:
          value: 6

  hfm_export:
    alias: "HFM Export Events"
    icon: mdi:export
    sequence:
      - service: shell_command.hfm_export
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events
      - service: persistent_notification.create
        data:
          title: "HFM Export Complete"
          message: "Events exported to /config/local_data/hfm/backups/"
          notification_id: hfm_export

  hfm_add_crop_stage:
    alias: "HFM Add Crop Stage"
    icon: mdi:plus
    sequence:
      - service: shell_command.hfm_add_crop_stage
        data:
          stage_id: "{{ states('input_text.hfm_new_stage_id') }}"
          name: "{{ states('input_text.hfm_new_stage_name') }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_new_stage_id
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_new_stage_name
        data:
          value: ""

  hfm_add_device:
    alias: "HFM Add Device"
    icon: mdi:cellphone-link
    sequence:
      - service: shell_command.hfm_add_device
        data:
          device_id: "{{ states('input_text.hfm_device_id') }}"
          device_name: "{{ states('input_text.hfm_device_name') }}"
          user_name: "{{ states('input_text.hfm_user_name') }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_device_id
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_device_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_user_name
        data:
          value: ""

  # --- Applicator Management Scripts ---

  hfm_add_applicator:
    alias: "HFM Add Applicator"
    icon: mdi:tractor-variant
    sequence:
      - condition: template
        value_template: >
          {{ states('input_text.hfm_applicator_name') != '' and
             states('input_select.hfm_applicator_type') != 'Select Type' }}
      - service: shell_command.hfm_add_applicator
        data:
          name: "{{ states('input_text.hfm_applicator_name') }}"
          type: "{{ states('input_select.hfm_applicator_type') }}"
          attributes: "{{ states('input_text.hfm_applicator_attributes') | default('{}') }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_applicator_name
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.hfm_applicator_type
        data:
          option: "Select Type"
      - service: input_text.set_value
        target:
          entity_id: input_text.hfm_applicator_attributes
        data:
          value: ""
      - service: persistent_notification.create
        data:
          title: "Applicator Added"
          message: "New applicator has been added successfully."
          notification_id: hfm_applicator_added

  hfm_delete_applicator:
    alias: "HFM Delete Applicator"
    icon: mdi:delete
    sequence:
      - variables:
          selected_name: "{{ states('input_select.hfm_selected_applicator') }}"
          applicators: "{{ state_attr('sensor.hfm_events', 'active_applicators') or [] }}"
          applicator_id: >
            {% for a in applicators if a.name == selected_name %}{{ a.id }}{% endfor %}
      - condition: template
        value_template: "{{ applicator_id | trim != '' }}"
      - service: shell_command.hfm_delete_applicator
        data:
          id: "{{ applicator_id | trim }}"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_events
      - service: persistent_notification.create
        data:
          title: "Applicator Deactivated"
          message: "{{ selected_name }} has been deactivated."
          notification_id: hfm_applicator_deleted

  # --- Weather Capture Helper Scripts ---

  hfm_capture_weather_start:
    alias: "HFM Capture Weather - Start"
    icon: mdi:play-circle
    description: "Capture weather at start of application"
    sequence:
      - service: script.hfm_capture_weather_phase
        data:
          phase: "start"

  hfm_capture_weather_mid:
    alias: "HFM Capture Weather - Mid"
    icon: mdi:pause-circle
    description: "Capture weather at middle of application"
    sequence:
      - service: script.hfm_capture_weather_phase
        data:
          phase: "mid"

  hfm_capture_weather_end:
    alias: "HFM Capture Weather - End"
    icon: mdi:stop-circle
    description: "Capture weather at end of application"
    sequence:
      - service: script.hfm_capture_weather_phase
        data:
          phase: "end"

  hfm_capture_weather_now:
    alias: "HFM Capture Weather Now"
    icon: mdi:weather-windy
    description: "Capture weather for next pending phase (smart detection)"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) if device_id else {} }}"
          data: "{{ draft.get('data', {}) if draft else {} }}"
          has_start: "{{ data.get('weather_start') is not none }}"
          has_mid: "{{ data.get('weather_mid') is not none }}"
          has_end: "{{ data.get('weather_end') is not none }}"
          next_phase: >
            {% if not has_start %}start
            {% elif not has_mid %}mid
            {% elif not has_end %}end
            {% else %}none{% endif %}
      - condition: template
        value_template: "{{ device_id != '' and next_phase != 'none' }}"
      - service: script.hfm_capture_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "{{ next_phase }}"
      - service: persistent_notification.create
        data:
          title: "Weather Captured"
          message: "{{ next_phase | capitalize }} weather recorded"
          notification_id: "hfm_weather_{{ next_phase }}"

  hfm_clear_weather_phase:
    alias: "HFM Clear Weather Phase"
    icon: mdi:weather-cloudy-alert
    description: "Clear captured weather for a specific phase"
    fields:
      phase:
        description: "Phase to clear: start, middle, or end"
        example: "start"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' and phase in ['start', 'middle', 'end'] }}"
      - service: shell_command.hfm_clear_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "{{ phase }}"
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts
      - service: persistent_notification.create
        data:
          title: "Weather Cleared"
          message: "{{ phase | capitalize }} weather record cleared"
          notification_id: "hfm_weather_clear_{{ phase }}"

  hfm_clear_all_weather:
    alias: "HFM Clear All Weather"
    icon: mdi:weather-cloudy-alert
    description: "Clear all captured weather records"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' }}"
      - service: shell_command.hfm_clear_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "start"
      - service: shell_command.hfm_clear_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "middle"
      - service: shell_command.hfm_clear_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "end"
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts
      - service: persistent_notification.create
        data:
          title: "Weather Cleared"
          message: "All weather records cleared"
          notification_id: "hfm_weather_clear_all"

  # Legacy single capture (for backwards compatibility)
  hfm_capture_weather:
    alias: "HFM Capture Current Weather"
    icon: mdi:weather-partly-cloudy
    description: "Capture current weather conditions and update draft"
    fields:
      device_id:
        description: "Device ID for the draft"
        example: "browser_abc123"
    sequence:
      - service: script.hfm_capture_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "start"

  hfm_capture_weather_for_current_device:
    alias: "HFM Capture Weather for Current Device"
    icon: mdi:weather-partly-cloudy
    description: "Capture weather for the current device from input helper"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' }}"
      - service: script.hfm_capture_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "start"
      - delay: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  # --- Paddock Multi-Select Scripts ---

  hfm_toggle_paddock:
    alias: "HFM Toggle Paddock Selection"
    icon: mdi:checkbox-marked
    description: "Toggle a paddock in/out of the current draft selection"
    fields:
      paddock_id:
        description: "Paddock ID to toggle"
        example: "sw5"
    sequence:
      - variables:
          existing_device_id: "{{ states('input_text.hfm_current_device') }}"
          device_id: "{{ existing_device_id if existing_device_id != '' else 'device_' ~ now().strftime('%Y%m%d%H%M%S') }}"
      # Auto-set device_id if missing
      - if:
          - condition: template
            value_template: "{{ existing_device_id == '' }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: input_text.hfm_current_device
            data:
              value: "{{ device_id }}"
          - service: shell_command.hfm_load_draft
            data:
              device_id: "{{ device_id }}"
          - delay:
              milliseconds: 300
      - variables:
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
          is_selected: "{{ paddock_id in current_paddocks }}"
          new_paddocks: >
            {% if is_selected %}
              {{ current_paddocks | reject('eq', paddock_id) | list }}
            {% else %}
              {{ current_paddocks + [paddock_id] }}
            {% endif %}
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ new_paddocks | to_json }}}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_toggle_selected_paddock:
    alias: "HFM Toggle Selected Paddock from Dropdown"
    icon: mdi:plus-minus
    description: "Toggle the paddock selected in hfm_paddock_to_toggle dropdown"
    sequence:
      - variables:
          paddock_name: "{{ states('input_select.hfm_paddock_to_toggle') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          paddocks: "{{ by_farm.get(farm_id, []) }}"
          paddock_id: >
            {% for p in paddocks if p.name == paddock_name %}{{ p.id }}{% endfor %}
      - condition: template
        value_template: "{{ paddock_name != 'Select Paddock' and paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_add_paddock:
    alias: "HFM Add Paddock to Selection"
    icon: mdi:plus-box
    description: "Add a paddock to the current draft selection (if not already selected)"
    fields:
      paddock_id:
        description: "Paddock ID to add"
        example: "sw5"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
          is_selected: "{{ paddock_id in current_paddocks }}"
      - condition: template
        value_template: "{{ device_id != '' and not is_selected }}"
      - variables:
          new_paddocks: "{{ current_paddocks + [paddock_id] }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ new_paddocks | to_json }}}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_remove_paddock:
    alias: "HFM Remove Paddock from Selection"
    icon: mdi:minus-box
    description: "Remove a paddock from the current draft selection"
    fields:
      paddock_id:
        description: "Paddock ID to remove"
        example: "sw5"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          drafts: "{{ state_attr('sensor.hfm_drafts', 'drafts') or {} }}"
          draft: "{{ drafts.get(device_id, {}) }}"
          current_paddocks: "{{ draft.get('data', {}).get('paddocks', []) }}"
      - condition: template
        value_template: "{{ device_id != '' and paddock_id in current_paddocks }}"
      - variables:
          new_paddocks: "{{ current_paddocks | reject('eq', paddock_id) | list }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ new_paddocks | to_json }}}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_select_all_paddocks:
    alias: "HFM Select All Paddocks"
    icon: mdi:checkbox-multiple-marked
    description: "Select all paddocks for the currently selected farm"
    sequence:
      - variables:
          existing_device_id: "{{ states('input_text.hfm_current_device') }}"
          device_id: "{{ existing_device_id if existing_device_id != '' else 'device_' ~ now().strftime('%Y%m%d%H%M%S') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          farm_paddocks: "{{ by_farm.get(farm_id, []) }}"
          all_paddock_ids: >
            {% set ns = namespace(ids=[]) %}
            {% for p in farm_paddocks %}
              {% set ns.ids = ns.ids + [p.id] %}
            {% endfor %}
            {{ ns.ids }}
      # Auto-set device_id if missing
      - if:
          - condition: template
            value_template: "{{ existing_device_id == '' }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: input_text.hfm_current_device
            data:
              value: "{{ device_id }}"
          - service: shell_command.hfm_load_draft
            data:
              device_id: "{{ device_id }}"
      - condition: template
        value_template: "{{ all_paddock_ids | length > 0 }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ all_paddock_ids | to_json }}}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_clear_paddock_selection:
    alias: "HFM Clear Paddock Selection"
    icon: mdi:checkbox-multiple-blank-outline
    description: "Clear all selected paddocks"
    sequence:
      - variables:
          existing_device_id: "{{ states('input_text.hfm_current_device') }}"
          device_id: "{{ existing_device_id if existing_device_id != '' else 'device_' ~ now().strftime('%Y%m%d%H%M%S') }}"
      # Auto-set device_id if missing
      - if:
          - condition: template
            value_template: "{{ existing_device_id == '' }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: input_text.hfm_current_device
            data:
              value: "{{ device_id }}"
          - service: shell_command.hfm_load_draft
            data:
              device_id: "{{ device_id }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": []}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_select_current_season_paddocks:
    alias: "HFM Select Current Season Paddocks"
    icon: mdi:calendar-check
    description: "Select only paddocks marked as current season for the selected farm"
    sequence:
      - variables:
          existing_device_id: "{{ states('input_text.hfm_current_device') }}"
          device_id: "{{ existing_device_id if existing_device_id != '' else 'device_' ~ now().strftime('%Y%m%d%H%M%S') }}"
          farm_id: "{{ states('sensor.hfm_selected_farm_id') }}"
          by_farm: "{{ state_attr('sensor.hfm_drafts', 'paddocks_by_farm') or {} }}"
          farm_paddocks: "{{ by_farm.get(farm_id, []) }}"
          season_paddock_ids: >
            {% set ns = namespace(ids=[]) %}
            {% for p in farm_paddocks if p.current_season %}
              {% set ns.ids = ns.ids + [p.id] %}
            {% endfor %}
            {{ ns.ids }}
      # Auto-set device_id if missing
      - if:
          - condition: template
            value_template: "{{ existing_device_id == '' }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: input_text.hfm_current_device
            data:
              value: "{{ device_id }}"
          - service: shell_command.hfm_load_draft
            data:
              device_id: "{{ device_id }}"
      - condition: template
        value_template: "{{ season_paddock_ids | length > 0 }}"
      - service: shell_command.hfm_update_draft
        data:
          device_id: "{{ device_id }}"
          data: '{"data": {"paddocks": {{ season_paddock_ids | to_json }}}}'
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  # --- Paddock Slot Toggle Scripts (for UI buttons) ---
  hfm_toggle_paddock_slot_0:
    alias: "Toggle Paddock Slot 0"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[0].id if paddocks | length > 0 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_1:
    alias: "Toggle Paddock Slot 1"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[1].id if paddocks | length > 1 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_2:
    alias: "Toggle Paddock Slot 2"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[2].id if paddocks | length > 2 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_3:
    alias: "Toggle Paddock Slot 3"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[3].id if paddocks | length > 3 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_4:
    alias: "Toggle Paddock Slot 4"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[4].id if paddocks | length > 4 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_5:
    alias: "Toggle Paddock Slot 5"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[5].id if paddocks | length > 5 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_6:
    alias: "Toggle Paddock Slot 6"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[6].id if paddocks | length > 6 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_7:
    alias: "Toggle Paddock Slot 7"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[7].id if paddocks | length > 7 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_8:
    alias: "Toggle Paddock Slot 8"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[8].id if paddocks | length > 8 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_9:
    alias: "Toggle Paddock Slot 9"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[9].id if paddocks | length > 9 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_10:
    alias: "Toggle Paddock Slot 10"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[10].id if paddocks | length > 10 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  hfm_toggle_paddock_slot_11:
    alias: "Toggle Paddock Slot 11"
    sequence:
      - variables:
          paddocks: "{{ state_attr('sensor.hfm_paddocks_for_selected_farm', 'paddocks') or [] }}"
          paddock_id: "{{ paddocks[11].id if paddocks | length > 11 else '' }}"
      - condition: template
        value_template: "{{ paddock_id != '' }}"
      - service: script.hfm_toggle_paddock
        data:
          paddock_id: "{{ paddock_id }}"

  # --- Weather Phase Capture Scripts ---
  hfm_capture_weather_phase:
    alias: "HFM Capture Weather Phase"
    icon: mdi:weather-cloudy-clock
    description: "Capture current weather for a spray phase (start/mid/end)"
    fields:
      phase:
        description: "Phase to capture (start, mid, end)"
        example: "start"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
          # Check if local station is available and determine source
          source: >
            {% if states('sensor.weather_api_station_1_wind_speed') not in ['unavailable', 'unknown', ''] %}
              Local Station
            {% else %}
              BOM
            {% endif %}
          # Get delta_t from local station or BOM
          delta_t_val: >
            {% set local = states('sensor.weather_api_station_1_delta_t') %}
            {% set bom = states('sensor.bom_observations_delta_t') %}
            {% if local not in ['unavailable', 'unknown', ''] %}
              {{ local | float(0) | round(1) }}
            {% elif bom not in ['unavailable', 'unknown', ''] %}
              {{ bom | float(0) | round(1) }}
            {% else %}
              null
            {% endif %}
          # Get rain chance from BOM forecast
          rain_chance_val: >
            {% set rc = states('sensor.bom_forecast_rain_chance_0') %}
            {{ rc | float(0) | round(0) if rc not in ['unknown', 'unavailable', ''] else 0 }}
          weather_data: >
            {
              "captured_at": "{{ now().isoformat() }}",
              "time": "{{ states('sensor.hfm_spray_' ~ phase ~ '_time') }}",
              "source": "{{ source }}",
              "temperature": {{ states('sensor.hfm_current_temperature') | float(0) }},
              "humidity": {{ states('sensor.hfm_current_humidity') | float(0) }},
              "wind_speed": {{ states('sensor.hfm_current_wind_speed') | float(0) }},
              "wind_direction": "{{ states('sensor.hfm_current_wind_direction') }}",
              "wind_gust": {{ states('sensor.hfm_current_wind_gust') | float(0) }},
              "delta_t": {{ delta_t_val }},
              "rain_chance_pct": {{ rain_chance_val }}
            }
      - condition: template
        value_template: "{{ device_id != '' and phase in ['start', 'mid', 'end'] }}"
      - service: shell_command.hfm_update_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "{{ phase }}"
          weather: "{{ weather_data }}"
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts

  hfm_clear_weather_phase:
    alias: "HFM Clear Weather Phase"
    icon: mdi:weather-cloudy-alert
    description: "Clear captured weather for a spray phase"
    fields:
      phase:
        description: "Phase to clear (start, mid, end)"
        example: "start"
    sequence:
      - variables:
          device_id: "{{ states('input_text.hfm_current_device') }}"
      - condition: template
        value_template: "{{ device_id != '' and phase in ['start', 'mid', 'end'] }}"
      - service: shell_command.hfm_clear_draft_weather_phase
        data:
          device_id: "{{ device_id }}"
          phase: "{{ phase }}"
      - delay:
          milliseconds: 500
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.hfm_drafts
