input_select:
  sw4_spur_automation_state:
    name: "SW4 SPUR Automation State"
    options: ["Manual","Auto"]
   
    icon: mdi:water
  mc_01_automation_state:
    name: "MC 01 Automation State"
    options: ["Manual","Auto","Fill Dam"]
   
    icon: mdi:water
  mc_02_automation_state:
    name: "MC 02 Automation State"
    options: ["Manual","Auto"]
    
    icon: mdi:water
  mc_03_automation_state:
    name: "MC 03 Automation State"
    options: ["Manual","Auto"]
  
    icon: mdi:water
  mc_05_automation_state:
    name: "MC 05 Automation State"
    options: ["Manual","Auto"]
    
    icon: mdi:water
  mc_07_automation_state:
    name: "MC 07 Automation State"
    options: ["Manual","Auto"]
   
    icon: mdi:water
  mc_wetlands_automation_state:
    name: "Wetlands Automation State"
    options: ["Manual","Auto","Fill Wetland"]
    
    icon: mdi:water
  creek_automation_state:
    name: "Creek Automation State"
    options: ["Manual","Auto"]
   
    icon: mdi:water
input_boolean:
###############################################
# Main Pump
#########################################
  mainpump_automation_countdown:
    name: Main Pump Automation Countdown
    icon: mdi:timer-outline
    
  mainpump_status_on_off:
    name: Main Pump Status
    icon: mdi:power-cycle
    
  mainpump_automation_demand:
    name: Main Pump Demand
    icon: mdi:power-cycle

  mainpump_scheduled_starttime:
    name: Main Pump Scheduled Start Time
    icon: mdi:timer-outline

  mainpump_cleaning_on_off:
    name: Main Pump Clean Cycle
    icon: mdi:timer-outline
    
###############################################
# Recycle Pump
#########################################
  recyclepump_automation_countdown:
    name: Recycle Pump Automation Countdown
    icon: mdi:timer-outline

  recyclepump_status_on_off:
    name: Recycle Pump Status
    icon: mdi:power-cycle

  recyclepump_automation_demand:
    name: Recycle Pump Demand
    icon: mdi:power-cycle

  recyclepump_scheduled_starttime:
    name: Recycle Pump Scheduled Start Time
    icon: mdi:timer-outline

###############################################
# Ward Pump
#########################################
  wardpump_automation_countdown:
    name: Ward Pump Automation Countdown
    icon: mdi:timer-outline

  wardpump_status_on_off:
    name: Ward Pump Status
    icon: mdi:power-cycle

  wardpump_automation_demand:
    name: Ward Pump Demand
    icon: mdi:power-cycle

  wardpump_scheduled_starttime:
    name: Ward Pump Scheduled Start Time
    icon: mdi:timer-outline

  wardpump_service_25hr_alert_sent:
    name: Ward Pump Service Alert
    icon: mdi:timer-outline

template:

  ################# Recyle Pump#######################
  - sensor:
      - name: "Fuel Remaining (hrs)"
        unique_id: recyclepump_fuel_hours_left
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        availability: >
          {{ states('input_number.recyclepump_fuelgauge') not in ['unknown','unavailable']
             and states('input_number.recyclepump_fuelburn_perhr') not in ['unknown','unavailable']
             and (states('input_number.recyclepump_fuelburn_perhr')|float(0)) > 0 }}
        state: >
          {% set fuel = states('input_number.recyclepump_fuelgauge') | float(0) %}
          {% set rate = states('input_number.recyclepump_fuelburn_perhr') | float(0) %}
          {{ (fuel / rate) | round(2) }}

      - name: "Fuel Remaining (HH:MM)"
        unique_id: recyclepump_fuel_time_left
        icon: mdi:clock-outline
        state: >
          {% set fuel = states('input_number.recyclepump_fuelgauge') | float(0) %}
          {% set rate = states('input_number.recyclepump_fuelburn_perhr') | float(0) %}
          {% if rate > 0 %}
            {% set total_minutes = (fuel / rate * 60) | int %}
            {% set h = (total_minutes // 60) %}
            {% set m = (total_minutes % 60) %}
            {{ '%02d:%02d' | format(h, m) }}
          {% else %}
            unknown
          {% endif %}

#####################  Ward Pump #######################

  - sensor:
      - name: "Fuel Remaining (hrs)"
        unique_id: wardpump_fuel_hours_left
        unit_of_measurement: "h"
        state_class: measurement
        icon: mdi:timer-outline
        availability: >
          {{ states('input_number.wardpump_fuelgauge') not in ['unknown','unavailable']
             and states('input_number.wardpump_fuelburn_perhr') not in ['unknown','unavailable']
             and (states('input_number.wardpump_fuelburn_perhr')|float(0)) > 0 }}
        state: >
          {% set fuel = states('input_number.wardpump_fuelgauge') | float(0) %}
          {% set rate = states('input_number.wardpump_fuelburn_perhr') | float(0) %}
          {{ (fuel / rate) | round(2) }}

      - name: "Fuel Remaining (HH:MM)"
        unique_id: wardpump_fuel_time_left
        icon: mdi:clock-outline
        state: >
          {% set fuel = states('input_number.wardpump_fuelgauge') | float(0) %}
          {% set rate = states('input_number.wardpump_fuelburn_perhr') | float(0) %}
          {% if rate > 0 %}
            {% set total_minutes = (fuel / rate * 60) | int %}
            {% set h = (total_minutes // 60) %}
            {% set m = (total_minutes % 60) %}
            {{ '%02d:%02d' | format(h, m) }}
          {% else %}
            unknown
          {% endif %}
input_datetime:
  mainpump_demandschedule_start:
    name: Main Pump Demand Schedule
    has_time: true
    has_date: true

  mainpump_schedule_start:
    name: Main Pump Schedule
    has_time: true
    has_date: true

  recyclepump_demandschedule_start:
    name: Recycle Pump Demand Schedule
    has_time: true
    has_date: true

  recyclepump_schedule_start:
    name: Recycle Pump Schedule
    has_time: true
    has_date: true

  wardpump_demandschedule_start:
    name: Ward Pump Demand Schedule
    has_time: true
    has_date: true

  wardpump_schedule_start:
    name: Ward Pump Schedule
    has_time: true
    has_date: true
input_number:
  mainpump_demand_on_hours:
    name: Main Pump Demand On Hours
   
    min: 1
    max: 24
    step: 1
    mode: box

  mainpump_demand_off_hours:
    name: Main Pump Demand Off Hours
  
    min: 1
    max: 24
    step: 1
    mode: box

  mainpump_5mwater_offset:
    name: Main Pump 5m Offset Number
    
    min: -500
    max: 500
    step: 1
    mode: box

  mainpump_total_runnng_hours:
    name: Main Pump Total Running Hours
   
    min: 0
    max: 40000
    step: 1
    mode: box
######################### Recycle Pump ###################
  recyclepump_fuelgauge:
    name: Recycle Pump Fuel Gauge
    
    min: 1
    max: 2000
    step: 1
    mode: box
    

  recyclepump_fuel_total:
    name: Recycle Pump Total Fuel Burn
   
    min: 1
    max: 40000
    step: 1
    mode: box
    

  recyclepump_fuelrefill:
    name: Recycle Pump Fuel Refill
  
    min: 1
    max: 3000
    step: 1
    mode: box

  recyclepump_service_timer_backup:
    name: Recycle Pump Service Timer Backup
   
    min: 1
    max: 1000000
    step: 1
    mode: box

  recyclepump_fuelburn_perhr:
    name: Recycle Pump L/hr Fuel use
    unit_of_measurement: "L/h"
    min: 0
    max: 40
    step: 0.01
    mode: box

  recyclepump_5mwater_offset:
    name: Recycle Pump 5m Offset Number
   
    unit_of_measurement: "cm"
    min: -50
    max: 50
    step: 0.1
    mode: box
    icon: mdi:water

  recyclepump_1mwater_offset:
    name: Recycle Pump 1m Offset Number
   
    min: -500
    max: 500
    step: 1
    mode: box
######################### Ward Pump ###################
  wardpump_fuelgauge:
    name: Ward Pump Fuel Gauge
    unit_of_measurement: "L"
    min: -200
    max: 2000
    step: 1
    mode: box

  wardpump_fuel_total:
    name: Ward Pump Total Fuel Burn
    unit_of_measurement: "L"
    min: 0
    max: 40000
    step: 0.1
    mode: box

  wardpump_fuelrefill:
    name: Ward Pump Fuel Refill
    unit_of_measurement: "L"
    min: 0
    max: 3000
    step: 1
    mode: box

  wardpump_fuelburn_perhr:
    name: Ward Pump L/hr Fuel use
    unit_of_measurement: "L/h"
    min: 0
    max: 40
    step: 0.01
    mode: box
timer:
  mainpump_timer_countdown:
    name: Main Pump Countdown Clock
    duration: "02:00:00"  # 10 minutes, change as needed
    restore: true
    icon: mdi:timer-sand
  recyclepump_timer_countdown:
    name: Recycle Pump Countdown Clock
    duration: "02:00:00"  # 10 minutes, change as needed
    restore: true
    icon: mdi:timer-sand
  recyclepump_timer_service:
    name: Recycle Pump Service Countdown
    duration: "200:00:00"  # 10 minutes, change as needed
    restore: true
    icon: mdi:timer-sand

  wardpump_timer_countdown:
    name: Ward Pump Countdown Clock
    duration: "02:00:00"  # 10 minutes, change as needed
    restore: true
    icon: mdi:timer-sand
  wardpump_timer_service:
    name: Ward Pump Service Countdown
    duration: "200:00:00"  # 10 minutes, change as needed
    restore: true
    icon: mdi:timer-sand
utility_meter:
  ward_pump_hours_daily:
    source: sensor.ward_pump_hours_total
    cycle: daily
  ward_pump_hours_weekly:
    source: sensor.ward_pump_hours_total
    cycle: weekly
  ward_pump_hours_monthly:
    source: sensor.ward_pump_hours_total
    cycle: monthly
  ward_pump_hours_yearly:
    source: sensor.ward_pump_hours_total
    cycle: yearly

  recycle_pump_hours_daily:
    source: sensor.recycle_pump_hours_total
    cycle: daily
  recycle_pump_hours_weekly:
    source: sensor.recycle_pump_hours_total
    cycle: weekly
  recycle_pump_hours_monthly:
    source: sensor.recycle_pump_hours_total
    cycle: monthly
  recycle_pump_hours_yearly:
    source: sensor.recycle_pump_hours_total
    cycle: yearly

  main_pump_hours_daily:
    source: sensor.main_pump_hours_total
    cycle: daily
  main_pump_hours_weekly:
    source: sensor.main_pump_hours_total
    cycle: weekly
  main_pump_hours_monthly:
    source: sensor.main_pump_hours_total
    cycle: monthly
  main_pump_hours_yearly:
    source: sensor.main_pump_hours_total
    cycle: yearly

sensor:
  - platform: integration
    source: sensor.ward_pump_on_rate
    name: Ward Pump Hours Total
    unique_id: ward_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1

  - platform: integration
    source: sensor.recycle_pump_on_rate
    name: Recycle Pump Hours Total
    unique_id: recycle_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1

  - platform: integration
    source: sensor.main_pump_on_rate
    name: Main Pump Hours Total
    unique_id: main_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1
sensor:
  - platform: integration
    source: sensor.ward_pump_on_rate
    name: Ward Pump Hours Total
    unique_id: ward_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1

  - platform: integration
    source: sensor.recycle_pump_on_rate
    name: Recycle Pump Hours Total
    unique_id: recycle_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1

  - platform: integration
    source: sensor.main_pump_on_rate
    name: Main Pump Hours Total
    unique_id: main_pump_hours_total
    unit_time: h
    method: trapezoidal
    round: 1
scripts:
  alias: Ward Pump - Reset Service Timer
description: Resets service timer to 200 hours only if less than 25 hours remain.
icon: mdi:water-pump
sequence:
  - condition: template
    value_template: >
      {% set remaining = state_attr('timer.wardpump_timer_service','remaining')
      %} {% if remaining %}
        {% set h, m, s = remaining.split(':') %}
        {{ (h | int * 3600 + m | int * 60 + s | int) < 25 * 3600 }}
      {% else %}
        false
      {% endif %}
  - target:
      entity_id: timer.wardpump_timer_service
    data:
      duration: "200:00:00"
    action: timer.start
automations:
  alias: WardPump Start
description: Turn Camera & Flashing Light and then toggle Start on Relay 1
triggers:
  - entity_id:
      - input_boolean.wardpump_status_on_off
    from: "off"
    to: "on"
    trigger: state
conditions: []
actions:
  - type: turn_on
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 07de1b69059d6a452a8716f22fe5c40c
    domain: switch
  - type: turn_on
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 5a99b492494c28a26e43d5137a27d661
    domain: switch
  - type: turn_on
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 989618fb3b574793d9b6bee8aee5491e
    domain: switch
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - alias: Toggle Pump Start- Relay 1
    type: turn_on
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 6ffd7bd244cb02d3efe2d1592b89bbdf
    domain: switch
  - action: notify.mobile_app_nats_phone
    metadata: {}
    data:
      message: Ward Pump Started
      target: Pump Update
  - action: notify.mobile_app_peter_sunrice
    metadata: {}
    data:
      message: Ward Pump Started
      title: Pump Update
  - type: turn_off
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 07de1b69059d6a452a8716f22fe5c40c
    domain: switch
  - delay:
      hours: 0
      minutes: 10
      seconds: 5
      milliseconds: 0
  - type: turn_off
    device_id: cf58b204f410e7e85eee03ffa592c10c
    entity_id: 5a99b492494c28a26e43d5137a27d661
    domain: switch
mode: restart

alias: Ward Pump- Countdown Expires shutdown
description: ""
triggers:
  - trigger: state
    entity_id:
      - timer.wardpump_timer_countdown
    from: active
    to: idle
conditions: []
actions:
  - action: input_boolean.turn_off
    target:
      entity_id:
        - input_boolean.wardpump_status_on_off
        - input_boolean.wardpump_automation_countdown
    data: {}
mode: single

alias: Ward Pump Update Fuel Gauge (10 min delayed start)
description: >
  When Ward Pump turns ON, wait 10 minutes before first fuel deduction. Then,
  while ON, every 10 minutes: - Subtract scaled fuel burn from gauge (can go
  below 0) - Add scaled fuel burn to total - Notify once at 100 L (warning) and
  once at 50 L (CRITICAL)
triggers:
  - entity_id: input_boolean.wardpump_status_on_off
    from: "off"
    to: "on"
    trigger: state
conditions: []
actions:
  - variables:
      notified_100: false
      notified_50: false
  - delay: "00:10:00"
  - repeat:
      while:
        - condition: state
          entity_id: input_boolean.wardpump_status_on_off
          state: "on"
      sequence:
        - variables:
            burn_per_10m: >-
              {{ (states('input_number.wardpump_fuelburn_perhr') | float(0)) / 6
              }}
            current_gauge: "{{ states('input_number.wardpump_fuelgauge') | float(0) }}"
            current_total: "{{ states('input_number.wardpump_fuel_total') | float(0) }}"
        - alias: Subtract fuel (10 min)
          target:
            entity_id: input_number.wardpump_fuelgauge
          data:
            value: "{{ (current_gauge - burn_per_10m) | round(1) }}"
          action: input_number.set_value
        - alias: Add fuel to total (10 min)
          target:
            entity_id: input_number.wardpump_fuel_total
          data:
            value: "{{ (current_total + burn_per_10m) | round(0) }}"
          action: input_number.set_value
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ (states('input_number.wardpump_fuelgauge') | float(0)) <=
                    50 }}
                - condition: template
                  value_template: "{{ notified_50 == false }}"
              sequence:
                - metadata: {}
                  data:
                    title: WARD PUMP FUEL CRITICAL
                    message: >-
                      Fuel is {{ states('input_number.wardpump_fuelgauge') |
                      float(0) | round(0) }} L. Pump is running.
                    data:
                      url: /pump-channels/ward-pump
                      push:
                        sound:
                          name: alarm.caf
                          critical: 1
                          volume: 1
                  action: notify.mobile_app_peter_sunrice
                - variables:
                    notified_50: true
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ (states('input_number.wardpump_fuelgauge') | float(0)) <=
                    100 }}
                - condition: template
                  value_template: "{{ notified_100 == false }}"
                - condition: template
                  value_template: "{{ notified_50 == false }}"
              sequence:
                - metadata: {}
                  data:
                    title: WARD PUMP FUEL LOW
                    message: >-
                      Fuel is {{ states('input_number.wardpump_fuelgauge') |
                      float(0) | round(0) }} L. Pump is running.
                    data:
                      url: /pump-channels/ward-pump
                  action: notify.mobile_app_peter_sunrice
                - variables:
                    notified_100: true
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ (states('input_number.wardpump_fuelgauge') | float(0)) >
                    100 }}
              sequence:
                - variables:
                    notified_100: false
                    notified_50: false
        - delay: "00:10:00"
mode: single

alias: Ward Pump Stop
description: toggle the stop switch and turn off flashing light
triggers:
  - trigger: state
    entity_id:
      - binary_sensor.pump_ward_pump_ward_pump_status_verified
    from:
      - "on"
    to:
      - "off"
    id: Manual Stop
  - trigger: state
    entity_id:
      - input_boolean.wardpump_status_on_off
    from:
      - "on"
    to:
      - "off"
    id: UI Off
conditions: []
actions:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - UI Off
          - condition: state
            entity_id: input_boolean.wardpump_status_on_off
            state:
              - "off"
        sequence:
          - type: turn_on
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: e8016216697dcb002eacd8e8b273e463
            domain: switch
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - type: turn_off
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: 5a99b492494c28a26e43d5137a27d661
            domain: switch
          - type: turn_off
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: 989618fb3b574793d9b6bee8aee5491e
            domain: switch
          - action: notify.mobile_app_peter_sunrice
            metadata: {}
            data:
              message: Ward Pump Stopped
              title: Pump Update
          - action: notify.mobile_app_nats_phone
            metadata: {}
            data:
              message: Ward Pump Stopped
              title: Pump Update
        alias: UI Shut Down
      - conditions:
          - condition: trigger
            id:
              - Manual Stop
          - condition: state
            entity_id: input_boolean.wardpump_status_on_off
            state:
              - "on"
        sequence:
          - type: turn_on
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: e8016216697dcb002eacd8e8b273e463
            domain: switch
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - action: input_boolean.turn_off
            metadata: {}
            data: {}
            target:
              entity_id:
                - input_boolean.wardpump_status_on_off
          - type: turn_off
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: 5a99b492494c28a26e43d5137a27d661
            domain: switch
          - type: turn_off
            device_id: cf58b204f410e7e85eee03ffa592c10c
            entity_id: 989618fb3b574793d9b6bee8aee5491e
            domain: switch
          - action: notify.mobile_app_peter_sunrice
            metadata: {}
            data:
              message: "Ward Pump Manually Stopped "
              title: Check Engine
              data:
                url: /pump-channels/ward-pump
                push:
                  sound:
                    name: alarm.caf
                    critical: 1
                    volume: 1
          - action: notify.mobile_app_nats_phone
            metadata: {}
            data:
              message: "Ward Pump Manually Stopped "
              title: Check Engine
              data:
                url: /pump-channels/ward-pump
                push:
                  sound:
                    name: alarm.caf
                    critical: 1
                    volume: 1
          - action: notify.mobile_app_paul_read_iphone
            metadata: {}
            data:
              message: "Ward Pump Manually Stopped "
              title: Check Engine
        alias: Manual Shutdown
mode: restart

alias: Ward Pump Service Timer (Start/Stop + 25h Critical)
description: >
  Starts/pauses Ward Pump service timer based on pump state. Sends a CRITICAL
  alert when timer remaining reaches 25 hours. If pump stops and starts again
  under 25 hours remaining, it reminds again.
triggers:
  - entity_id: input_boolean.wardpump_status_on_off
    trigger: state
  - value_template: >
      {% set r = state_attr('timer.wardpump_timer_service', 'remaining') %} {%
      if r in ['unknown','unavailable',None,''] %}
        false
      {% else %}
        {{ (r | as_timedelta).total_seconds() <= 25*3600 }}
      {% endif %}
    trigger: template
  - entity_id: timer.wardpump_timer_service
    trigger: state
actions:
  - variables:
      remaining: "{{ state_attr('timer.wardpump_timer_service', 'remaining') }}"
      remaining_sec: >
        {% set r = state_attr('timer.wardpump_timer_service', 'remaining') %} {%
        if r in ['unknown','unavailable',None,''] %}
          0
        {% else %}
          {{ (r | as_timedelta).total_seconds() | int(0) }}
        {% endif %}
      under_25: "{{ remaining_sec > 0 and remaining_sec <= 25*3600 }}"
      above_25: "{{ remaining_sec > 25*3600 }}"
  - choose:
      - alias: Pump Turns ON
        conditions:
          - condition: template
            value_template: "{{ trigger.entity_id == 'input_boolean.wardpump_status_on_off' }}"
          - condition: state
            entity_id: input_boolean.wardpump_status_on_off
            state: "on"
        sequence:
          - target:
              entity_id: timer.wardpump_timer_service
            action: timer.start
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ under_25 }}"
                  - condition: state
                    entity_id: input_boolean.wardpump_service_25hr_alert_sent
                    state: "off"
                sequence:
                  - metadata: {}
                    data:
                      title: "CRITICAL: WARD PUMP SERVICE DUE SOON"
                      message: >-
                        Ward Pump is running and service timer is under 25 hours
                        remaining. Remaining: {{ remaining }}.
                      data:
                        url: /pump-channels/ward-pump
                        push:
                          sound:
                            name: alarm.caf
                            critical: 1
                            volume: 1
                    action: notify.mobile_app_peter_sunrice
                  - target:
                      entity_id: input_boolean.wardpump_service_25hr_alert_sent
                    action: input_boolean.turn_on
      - alias: Pump Turns OFF
        conditions:
          - condition: template
            value_template: "{{ trigger.entity_id == 'input_boolean.wardpump_status_on_off' }}"
          - condition: state
            entity_id: input_boolean.wardpump_status_on_off
            state: "off"
        sequence:
          - target:
              entity_id: timer.wardpump_timer_service
            action: timer.pause
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ under_25 }}"
                sequence:
                  - target:
                      entity_id: input_boolean.wardpump_service_25hr_alert_sent
                    action: input_boolean.turn_off
      - alias: Timer <= 25h remaining
        conditions:
          - condition: template
            value_template: "{{ trigger.entity_id != 'input_boolean.wardpump_status_on_off' }}"
          - condition: template
            value_template: "{{ under_25 }}"
          - condition: state
            entity_id: input_boolean.wardpump_service_25hr_alert_sent
            state: "off"
        sequence:
          - metadata: {}
            data:
              title: "CRITICAL: WARD PUMP SERVICE DUE SOON"
              message: >
                Ward Pump service due in {{
                state_attr('timer.wardpump_timer_service', 'remaining') }}.
              data:
                url: /pump-channels/ward-pump
                push:
                  sound:
                    name: alarm.caf
                    critical: 1
                    volume: 1
            action: notify.mobile_app_peter_sunrice
          - action: notify.mobile_app_paul_read_iphone
            metadata: {}
            data:
              message: >-
                Ward Pump service due in {{
                state_attr('timer.wardpump_timer_service', 'remaining') }}.
          - target:
              entity_id: input_boolean.wardpump_service_25hr_alert_sent
            action: input_boolean.turn_on
            data: {}
  - choose:
      - alias: Timer reset above 25h -> clear latch
        conditions:
          - condition: template
            value_template: "{{ above_25 }}"
        sequence:
          - target:
              entity_id: input_boolean.wardpump_service_25hr_alert_sent
            action: input_boolean.turn_off
mode: restart

alias: Ward Pump - Refuel
description: Adds refill amount to fuel gauge, then resets refill helper to 0.
triggers: []
conditions:
  - condition: numeric_state
    entity_id: input_number.wardpump_fuelrefill
    above: 0
actions:
  - target:
      entity_id: input_number.wardpump_fuelgauge
    data:
      value: |-
        {{
          (states('input_number.wardpump_fuelgauge') | float(0)) +
          (states('input_number.wardpump_fuelrefill') | float(0))
        }}
    action: input_number.set_value
  - target:
      entity_id: input_number.wardpump_fuelrefill
    data:
      value: 0
    action: input_number.set_value
mode: single
