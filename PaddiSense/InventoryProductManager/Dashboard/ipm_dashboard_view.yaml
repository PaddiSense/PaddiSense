button_card_templates:
  template_titleblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(0,0, 0)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
        - height: 50px
  template_textblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(255,255,51)
    name: '[[[return variables.var_name]]]'
    styles:
      card:
        - height: 80px
  template_numberblock:
    variables:
      var_name: Name
    color_type: label-card
    color: rgb(140,146,172)
    name: '[[[ return variables.var_name ]]]'
    show_icon: false
    show_state: true
    tap_action:
      action: none
    styles:
      card:
        - height: 80px
        - border-radius: 16px
        - padding: 10px
      state:
        - font-size: 32px
        - font-weight: bold
        - text-align: center
  template_numberblock_minus:
    variables:
      amount: 1
      label: '-1'
    show_icon: false
    show_name: true
    show_state: false
    name: '[[[ return variables.label ]]]'
    tap_action:
      action: call-service
      service: input_number.set_value
      service_data:
        entity_id: input_number.inventory_quantity
        value: |
          [[[
            return Number(entity.state) - Number(variables.amount);
          ]]]
    styles:
      card:
        - height: 80px
        - border-radius: 12px
        - padding: 10px
        - background: '#ff1940'
      name:
        - font-size: 20px
        - font-weight: bold
        - text-align: center
        - color: '#000000'
  template_numberblock_plus:
    variables:
      amount: 1
      label: '+1'
    show_icon: false
    show_name: true
    show_state: false
    name: '[[[ return variables.label ]]]'
    tap_action:
      action: call-service
      service: input_number.set_value
      service_data:
        entity_id: input_number.inventory_quantity
        value: |
          [[[ 
            return Number(entity.state) + Number(variables.amount);
          ]]]
    styles:
      card:
        - height: 80px
        - border-radius: 10px
        - padding: 12px
        - background: '#19ff19'
      name:
        - font-size: 20px
        - font-weight: bold
        - text-align: center
        - color: '#000000'
browser_mod:
  style:
    select:
      font-size: 2.5rem !important
      min-height: 70px !important
      padding: 10px !important
    input:
      font-size: 2.5rem !important
      padding: 12px !important
views:
  - type: sections
    max_columns: 1
    title: Movement
    path: inventory-movement
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                name: FIND PRODUCT
              - type: horizontal-stack
                cards:
                  - type: entities
                    entities:
                      - entity: input_select.inventory_category
                        name: Product Type
                        icon: mdi:playlist-edit
                    card_mod:
                      style: |
                        ha-card {
                          border-radius: 14px;
                          padding: 6px;
                        }
                        .mdc-list-item__primary-text {
                          font-size: 1.6rem !important;
                        }
              - type: horizontal-stack
                cards:
                  - type: entities
                    entities:
                      - entity: input_select.inventory_subcategory_filter
                        name: Subcategory
                        icon: mdi:shape-outline
                    card_mod:
                      style: |
                        ha-card {
                          border-radius: 14px;
                          padding: 6px;
                        }
                        .mdc-list-item__primary-text {
                          font-size: 1.6rem !important;
                        }
              - type: entities
                entities:
                  - entity: input_text.inventory_active_search
                    name: Search
                    icon: mdi:magnify
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 14px;
                      padding: 6px;
                    }
                    .mdc-text-field__input {
                      font-size: 1.6rem !important;
                      padding: 16px !important;
                    }
              - type: entities
                entities:
                  - entity: input_select.inventory_product
                    name: Select Product
                    icon: mdi:flask-outline
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 14px;
                      padding: 6px 8px 10px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.6rem !important;
                    }
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    name: STOCK ON HAND
                    template: template_textblock
                  - type: custom:button-card
                    template: template_numberblock
                    entity: sensor.inventory_selected_product_stock
                    show_name: false
                    show_icon: false
                    show_state: true
                    tap_action: null
                    state_display: |
                      [[[
                        const product = states['input_select.inventory_product'].state;
                        const catalog = states['sensor.inventory_catalog'].attributes.products || [];
                        const found = catalog.find(p => p.name === product);
                        const unit = found?.unit || "";
                        return parseFloat(entity.state).toFixed(0) + " " + unit;
                      ]]]
              - type: vertical-stack
                cards:
                  - type: custom:button-card
                    template: template_titleblock
                    name: ADJUST STOCK
                  - square: false
                    type: grid
                    columns: 3
                    cards:
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 1
                          label: '- 1'
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 5
                          label: '- 5'
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 20
                          label: '- 20'
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 100
                          label: '- 100'
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 500
                          label: '- 500'
                      - type: custom:button-card
                        template: template_numberblock_minus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 2000
                          label: '- 2000'
                  - type: horizontal-stack
                    cards:
                      - type: custom:button-card
                        template: template_numberblock
                        entity: input_number.inventory_quantity
                        name: CHANGE AMOUNT
                        styles:
                          card:
                            - padding: 10px
                          name:
                            - font-size: 16px
                            - font-weight: bold
                            - text-align: center
                          state:
                            - font-size: 32px
                            - font-weight: bold
                            - text-align: center
                            - color: |
                                [[[
                                  const v = Number(entity.state);
                                  if (v > 0) return "#15F70A";      // green
                                  if (v < 0) return "#f90709";      // red
                                  return "#FFFFFF";                 // neutral
                                ]]]
                      - type: custom:button-card
                        name: CLEAR
                        icon: mdi:backspace
                        tap_action:
                          action: call-service
                          service: input_number.set_value
                          data:
                            value: 0
                          target:
                            entity_id: input_number.inventory_quantity
                        styles:
                          card:
                            - background: '#444444'
                            - border-radius: 12px
                            - padding: 10px
                            - height: 80px
                            - width: 100px
                          name:
                            - font-size: 18px
                            - font-weight: bold
                            - color: white
                          icon:
                            - width: 28px
                            - color: white
                  - square: false
                    type: grid
                    columns: 3
                    cards:
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 1
                          label: + 1
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 5
                          label: + 5
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 20
                          label: + 20
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 100
                          label: + 100
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 500
                          label: + 500
                      - type: custom:button-card
                        template: template_numberblock_plus
                        entity: input_number.inventory_quantity
                        variables:
                          amount: 2000
                          label: + 2000
                  - type: custom:button-card
                    template: template_numberblock
                    entity: sensor.inventory_quantity_update
                    name: New Amount
                    show_name: true
                    show_icon: false
                    show_state: true
                    tap_action: null
                    state_display: |
                      [[[
                        const product = states['input_select.inventory_product'].state;
                        const catalog = states['sensor.inventory_catalog'].attributes.products || [];
                        const found = catalog.find(p => p.name === product);
                        const unit = found?.unit || "";
                        return parseFloat(entity.state).toFixed(0) + " " + unit;
                      ]]]
              - type: custom:button-card
                name: SAVE CHANGE
                tap_action:
                  action: call-service
                  service: script.inventory_commit
                styles:
                  card:
                    - background: '#0047FF'
                    - border-radius: 14px
                    - padding: 20px
                    - height: 90px
                  name:
                    - color: white
                    - font-size: 18px
                    - font-weight: bold
    cards: []
  - type: sections
    max_columns: 3
    title: Manage Products
    path: inventory-management
    sections:
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: vertical-stack
            cards:
              - type: markdown
                content: >
                  # Product Editor

                  1. Choose **mode** (Add new / Edit existing).   2. For *Edit
                  existing*, pick Category + Product, then click **Load
                  product**.   3. Adjust fields and click **Save product**.
                card_mod:
                  style: |
                    ha-card {
                      font-size: 1.1rem;
                      line-height: 1.5;
                      border-radius: 12px;
                      padding: 12px;
                    }
              - type: entities
                entities:
                  - entity: input_select.inventory_new_mode
                    name: Editor mode
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 6px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.4rem !important;
                    }
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.inventory_new_mode
                    state_not: Add new
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: input_select.inventory_category
                          name: Product Type
                          icon: mdi:playlist-edit
                        - entity: input_select.inventory_subcategory_filter
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 14px;
                            padding: 6px;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.6rem !important;
                          }
                    - type: entities
                      entities:
                        - entity: input_select.inventory_product
                          name: Select Product
                          icon: mdi:flask-outline
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 14px;
                            padding: 6px 8px 10px;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.6rem !important;
                          }
                    - type: custom:button-card
                      name: Load Product
                      tap_action:
                        action: call-service
                        service: script.inventory_prepare_product_form
                      icon: mdi:download
                      styles:
                        card:
                          - background: '#0047FF'
                          - border-radius: 14px
                          - padding: 20px
                          - height: 90px
                        name:
                          - color: white
                          - font-size: 18px
                          - font-weight: bold
                        icon:
                          - height: 70px
              - type: entities
                title: Required Details
                entities:
                  - entity: input_select.inventory_new_category
                    name: Product category
                  - entity: input_select.inventory_new_subcategory
                    name: Subcategory
                  - entity: input_text.inventory_new_name
                    name: Product name
                  - entity: input_select.inventory_new_storage_location
                    name: Storage location
                  - entity: input_select.inventory_new_product_unit
                    name: Product Unit
                  - entity: input_select.inventory_new_container_size
                    name: Container size
                  - entity: input_select.inventory_new_application_unit
                    name: Application unit
                  - entity: input_select.inventory_new_chemical_group
                    name: Chemical group
                card_mod:
                  style: |
                    ha-card {
                      --ha-card-background: #E9FBE9;  /* light green */
                      border-radius: 12px;
                      padding: 6px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.4rem !important;
                    }
                    .mdc-text-field__input {
                      font-size: 1.4rem !important;
                    }
              - type: entities
                title: Chemistry
                entities:
                  - entity: input_text.inventory_new_active_1
                    name: Active 1 (e.g. Nitrogen 11%)
                  - entity: input_number.inventory_new_active_concentration
                    name: Active 1 – conc.
                  - entity: input_select.inventory_new_active_unit
                    name: Active 1 – unit
                  - entity: input_boolean.inventory_new_show_active_2
                    name: Show 2nd Active
                card_mod:
                  style: |
                    ha-card {
                      --ha-card-background: #FFF1DE;  /* light orange */
                      border-radius: 12px;
                      padding: 6px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.4rem !important;
                    }
                    .mdc-text-field__input {
                      font-size: 1.4rem !important;
                    }
              - type: conditional
                conditions:
                  - entity: input_boolean.inventory_new_show_active_2
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_text.inventory_new_active_2
                      name: Active 2
                    - entity: input_number.inventory_new_active_concentration_2
                      name: Active 2 – conc.
                    - entity: input_select.inventory_new_active_unit_2
                      name: Active 2 – unit
                    - entity: input_boolean.inventory_new_show_active_3
                      name: Show 3rd Active
                  card_mod:
                    style: |
                      ha-card {
                        --ha-card-background: #FFF1DE;
                        border-radius: 12px;
                        padding: 6px;
                      }
              - type: conditional
                conditions:
                  - entity: input_boolean.inventory_new_show_active_3
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_text.inventory_new_active_3
                      name: Active 3
                    - entity: input_number.inventory_new_active_concentration_3
                      name: Active 3 – conc.
                    - entity: input_select.inventory_new_active_unit_3
                      name: Active 3 – unit
                    - entity: input_boolean.inventory_new_show_active_4
                      name: Show 4th Active
                  card_mod:
                    style: |
                      ha-card {
                        --ha-card-background: #FFF1DE;
                        border-radius: 12px;
                        padding: 6px;
                      }
              - type: conditional
                conditions:
                  - entity: input_boolean.inventory_new_show_active_4
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_text.inventory_new_active_4
                      name: Active 4
                    - entity: input_number.inventory_new_active_concentration_4
                      name: Active 4 – conc.
                    - entity: input_select.inventory_new_active_unit_4
                      name: Active 4 – unit
                    - entity: input_boolean.inventory_new_show_active_5
                      name: Show 5th Active
                  card_mod:
                    style: |
                      ha-card {
                        --ha-card-background: #FFF1DE;
                        border-radius: 12px;
                        padding: 6px;
                      }
              - type: conditional
                conditions:
                  - entity: input_boolean.inventory_new_show_active_5
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_text.inventory_new_active_5
                      name: Active 5
                    - entity: input_number.inventory_new_active_concentration_5
                      name: Active 5 – conc.
                    - entity: input_select.inventory_new_active_unit_5
                      name: Active 5 – unit
                    - entity: input_boolean.inventory_new_show_active_6
                      name: Show 6th Active
                  card_mod:
                    style: |
                      ha-card {
                        --ha-card-background: #FFF1DE;
                        border-radius: 12px;
                        padding: 6px;
                      }
              - type: conditional
                conditions:
                  - entity: input_boolean.inventory_new_show_active_6
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_text.inventory_new_active_6
                      name: Active 6
                    - entity: input_number.inventory_new_active_concentration_6
                      name: Active 6 – conc.
                    - entity: input_select.inventory_new_active_unit_6
                      name: Active 6 – unit
                  card_mod:
                    style: |
                      ha-card {
                        --ha-card-background: #FFF1DE;
                        border-radius: 12px;
                        padding: 6px;
                      }
              - type: custom:button-card
                name: Save Product
                tap_action:
                  action: call-service
                  service: script.inventory_save_product
                icon: mdi:content-save
                styles:
                  card:
                    - background: Green
                    - border-radius: 14px
                    - padding: 20px
                    - height: 90px
                  name:
                    - color: white
                    - font-size: 18px
                    - font-weight: bold
                  icon:
                    - height: 70px
                    - color: white
      - type: grid
        cards:
          - type: heading
            heading: New section
          - type: vertical-stack
            title: PRODUCT MANAGEMENT
            cards:
              - type: markdown
                content: |
                  ## Zero Product Stock

                  Select a product and tap **Zero Product**  
                  to set its stock to 0 (product stays in the list).
              - type: entities
                style: |
                  ha-card {
                    border-radius: 12px;
                    padding: 8px;
                  }
                entities:
                  - entity: input_select.inventory_category
                    name: Category
                  - entity: input_select.inventory_product
                    name: Product
                  - entity: sensor.inventory_selected_product_stock
                    name: Current Stock
              - type: custom:button-card
                name: Zero Product
                icon: mdi-trash-can-outline
                tap_action:
                  action: call-service
                  service: script.inventory_zero_product
                styles:
                  card:
                    - background: '#c62828'
                    - border-radius: 14px
                    - padding: 16px
                  icon:
                    - color: white
                    - height: 32px
                  name:
                    - color: white
                    - font-size: 18px
                    - font-weight: bold
                    - text-align: center
      - type: grid
        cards:
          - type: heading
            heading: New section
    cards: []
  - type: sections
    max_columns: 1
    title: Stock Overview
    path: inventory-overview
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                name: STOCK OVERVIEW
              - type: entities
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 6px 8px;
                    }
                entities:
                  - entity: input_select.inventory_category
                    name: Category
                    icon: mdi:playlist-edit
                  - entity: input_select.inventory_subcategory_filter
                    name: Subcategory
                    icon: mdi:filter-variant
          - type: markdown
            card_mod:
              style: |
                ha-card {
                  border-radius: 12px;
                  padding: 8px;
                  max-height: 70vh;
                  overflow-y: auto;
                }
            content: >-
              {% set filtered_names =
              state_attr('sensor.inventory_filtered_products', 'names') or [] %}
              {% set catalog        = state_attr('sensor.inventory_catalog',
              'products') or [] %}

              {# full product objects for the filtered names #} {% set products
              = catalog | selectattr('name', 'in', filtered_names) | list %}

              {% if not products %} _No products match the current filters._ {%
              else %}

              {% for p_group in products | groupby('id') %} {% set prod       =
              p_group.list[0] %} {% set unit       = prod.unit if 'unit' in prod
              else '' %} {% set cat        = prod.category if 'category' in prod
              else '' %} {% set sub        = prod.subcategory if 'subcategory'
              in prod else '' %} {% set prod_total = p_group.list |
              map(attribute='stock_on_hand') | sum %}

              ### {{ prod.name }}{% if prod_total|float(0) > 0 %} – {{
              prod_total|round(1) }} {{ unit }}{% else %} – _No stock
              recorded_{% endif %}

              {{ cat }}{% if sub and sub|lower != cat|lower %} / {{ sub }}{%
              endif %}

              {% if prod_total|float(0) > 0 %}

              {% for loc_group in p_group.list | groupby('storage_location') %}
              {% set location_raw = loc_group.grouper %} {% set location =
              'Location not set' if not location_raw else location_raw %} {% set
              loc_total = loc_group.list | map(attribute='stock_on_hand') | sum
              %}

              {% if loc_total|float(0) > 0 %}

              **{{ location }}** – {{ loc_total|round(1) }} {{ unit }}

              {% set container_lines = [] %} {% for size_group in
              (loc_group.list | sort(attribute='container_size') |
              groupby('container_size')) %}
                {% set size       = size_group.grouper %}
                {% set size_total = size_group.list | map(attribute='stock_on_hand') | sum %}
                {% if size_total|float(0) > 0 %}
                  {% if size is not none and size|float(0) > 0 %}
                    {% set count = (size_total / size) | round(0) | int %}
                    {% set line = size|round(1) ~ ' ' ~ unit ~ ' (x' ~ count ~ ') – ' ~ size_total|round(1) ~ ' ' ~ unit %}
                  {% else %}
                    {% set line = 'Bulk storage – ' ~ size_total|round(1) ~ ' ' ~ unit %}
                  {% endif %}
                  {% set container_lines = container_lines + [line] %}
                {% endif %}
              {% endfor %}

              {% if container_lines %} • {{ container_lines | join('<br>• ') }}
              {% endif %}

              {% endif %}

              {% endfor %}

              {% endif %}

              --- {% endfor %} {% endif %}
    cards: []
