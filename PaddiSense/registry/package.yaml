# =============================================================================
# FARM REGISTRY - PaddiSense Shared Core
# =============================================================================
# This package provides the farm hierarchy (farms, paddocks, bays, seasons)
# for all PaddiSense modules. It is the single source of truth for:
#   - Grower/server identity
#   - Farm definitions (from server.yaml)
#   - Paddock configurations
#   - Bay configurations
#   - Season definitions
#
# Other modules (PWM, HFM, IPM, ASM) consume this data but store their own
# module-specific settings separately.
# =============================================================================

# -----------------------------------------------------------------------------
# COMMAND LINE SENSORS
# -----------------------------------------------------------------------------
command_line:
  - sensor:
      name: Farm Registry Data
      unique_id: farm_registry_data
      command: "python3 /config/PaddiSense/registry/python/registry_sensor.py"
      scan_interval: 60
      value_template: "{{ value_json.status }}"
      json_attributes:
        - initialized
        - config_ok
        - version
        - grower
        - total_farms
        - total_paddocks
        - total_bays
        - total_seasons
        - active_season
        - active_season_name
        - farms
        - paddocks
        - bays
        - seasons
        - businesses
        - crops
        - current_crops
        - current_month
        - hierarchy
        - business_names
        - farm_names
        - paddock_names
        - season_names
        - crop_names
        - modules
        - backup_count

# -----------------------------------------------------------------------------
# SHELL COMMANDS
# -----------------------------------------------------------------------------
shell_command:
  # System commands
  registry_init: "python3 /config/PaddiSense/registry/python/registry_backend.py init"
  registry_status: "python3 /config/PaddiSense/registry/python/registry_backend.py status"
  registry_export: "python3 /config/PaddiSense/registry/python/registry_backend.py export"
  registry_migrate_pwm: "python3 /config/PaddiSense/registry/python/registry_backend.py migrate_from_pwm"
  registry_reset: "python3 /config/PaddiSense/registry/python/registry_backend.py reset --token {{ token }}"
  registry_import: "python3 /config/PaddiSense/registry/python/registry_backend.py import_backup --filename '{{ filename }}'"
  registry_backup_list: "python3 /config/PaddiSense/registry/python/registry_backend.py backup_list"

  # Paddock commands
  registry_add_paddock: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_paddock
    --name '{{ name }}'
    --farm '{{ farm | default("farm_1") }}'
    --bay_prefix '{{ bay_prefix | default("B-") }}'
    --bay_count {{ bay_count }}
    {% if brown_area is defined and brown_area %}--brown_area {{ brown_area }}{% endif %}
    {% if green_area is defined and green_area %}--green_area {{ green_area }}{% endif %}

  registry_edit_paddock: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_paddock
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}
    {% if farm is defined %}--farm '{{ farm }}'{% endif %}
    {% if current_season is defined %}--current_season {{ current_season }}{% endif %}
    {% if brown_area is defined %}--brown_area {{ brown_area }}{% endif %}
    {% if green_area is defined %}--green_area {{ green_area }}{% endif %}

  registry_delete_paddock: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_paddock --id '{{ id }}'"

  registry_set_current_season: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py set_current_season
    --id '{{ id }}'
    {% if value is defined %}--value {{ value }}{% endif %}

  # Bay commands
  registry_add_bay: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_bay
    --paddock '{{ paddock }}'
    --name '{{ name }}'
    {% if order is defined %}--order {{ order }}{% endif %}
    {% if is_last is defined and is_last %}--is_last{% endif %}

  registry_edit_bay: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_bay
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}
    {% if order is defined %}--order {{ order }}{% endif %}
    {% if is_last is defined %}--is_last {{ is_last }}{% endif %}

  registry_delete_bay: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_bay --id '{{ id }}'"

  # Season commands
  registry_add_season: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_season
    --name '{{ name }}'
    --start '{{ start }}'
    --end '{{ end }}'
    {% if active is defined and active %}--active{% endif %}

  registry_edit_season: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_season
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}
    {% if start is defined %}--start '{{ start }}'{% endif %}
    {% if end is defined %}--end '{{ end }}'{% endif %}

  registry_delete_season: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_season --id '{{ id }}'"
  registry_set_active_season: "python3 /config/PaddiSense/registry/python/registry_backend.py set_active_season --id '{{ id }}'"

  # Business commands
  registry_add_business: "python3 /config/PaddiSense/registry/python/registry_backend.py add_business --name '{{ name }}'"

  registry_edit_business: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_business
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}

  registry_delete_business: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_business --id '{{ id }}'"

  # Farm commands
  registry_add_farm: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_farm
    --name '{{ name }}'
    {% if business is defined %}--business '{{ business }}'{% endif %}

  registry_edit_farm: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_farm
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}
    {% if business is defined %}--business '{{ business }}'{% endif %}

  registry_delete_farm: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_farm --id '{{ id }}'"

  # Crop commands
  registry_add_crop: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_crop
    --name '{{ name }}'
    {% if start_month is defined %}--start_month {{ start_month }}{% endif %}
    {% if end_month is defined %}--end_month {{ end_month }}{% endif %}
    {% if color is defined %}--color '{{ color }}'{% endif %}
    {% if stages is defined %}--stages '{{ stages }}'{% endif %}

  registry_edit_crop: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_crop
    --id '{{ id }}'
    {% if name is defined %}--name '{{ name }}'{% endif %}
    {% if start_month is defined %}--start_month {{ start_month }}{% endif %}
    {% if end_month is defined %}--end_month {{ end_month }}{% endif %}
    {% if color is defined %}--color '{{ color }}'{% endif %}
    {% if stages is defined %}--stages '{{ stages }}'{% endif %}

  registry_delete_crop: "python3 /config/PaddiSense/registry/python/registry_backend.py delete_crop --id '{{ id }}'"
  registry_list_crops: "python3 /config/PaddiSense/registry/python/registry_backend.py list_crops"

  registry_add_crop_stage: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py add_crop_stage
    --crop_id '{{ crop_id }}'
    --name '{{ name }}'
    {% if order is defined %}--order {{ order }}{% endif %}

  registry_delete_crop_stage: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py delete_crop_stage
    --crop_id '{{ crop_id }}'
    --stage_id '{{ stage_id }}'

  # Paddock crop assignment (extends edit_paddock)
  registry_set_paddock_crops: >-
    python3 /config/PaddiSense/registry/python/registry_backend.py edit_paddock
    --id '{{ id }}'
    {% if crop_1_id is defined %}--crop_1_id '{{ crop_1_id }}'{% endif %}
    {% if crop_1_start is defined %}--crop_1_start {{ crop_1_start }}{% endif %}
    {% if crop_1_end is defined %}--crop_1_end {{ crop_1_end }}{% endif %}
    {% if crop_2_id is defined %}--crop_2_id '{{ crop_2_id }}'{% endif %}
    {% if crop_2_start is defined %}--crop_2_start {{ crop_2_start }}{% endif %}
    {% if crop_2_end is defined %}--crop_2_end {{ crop_2_end }}{% endif %}

# -----------------------------------------------------------------------------
# TEMPLATE SENSORS
# -----------------------------------------------------------------------------
template:
  - sensor:
      # Version sensor for diagnostics
      - name: "Farm Registry Version"
        unique_id: farm_registry_version
        state: "{{ state_attr('sensor.farm_registry_data', 'version') | default('unknown') }}"
        icon: mdi:tag

      # Grower name
      - name: "Farm Registry Grower"
        unique_id: farm_registry_grower
        state: >-
          {% set grower = state_attr('sensor.farm_registry_data', 'grower') or {} %}
          {{ grower.name | default('PaddiSense Farm') }}
        icon: mdi:account-tie

      # Active season
      - name: "Farm Registry Active Season"
        unique_id: farm_registry_active_season
        state: "{{ state_attr('sensor.farm_registry_data', 'active_season_name') | default('None') }}"
        icon: mdi:calendar-range
        attributes:
          season_id: "{{ state_attr('sensor.farm_registry_data', 'active_season') }}"

      # Counts
      - name: "Farm Registry Paddock Count"
        unique_id: farm_registry_paddock_count
        state: "{{ state_attr('sensor.farm_registry_data', 'total_paddocks') | default(0) }}"
        icon: mdi:view-grid
        unit_of_measurement: "paddocks"

      - name: "Farm Registry Bay Count"
        unique_id: farm_registry_bay_count
        state: "{{ state_attr('sensor.farm_registry_data', 'total_bays') | default(0) }}"
        icon: mdi:view-column
        unit_of_measurement: "bays"

  - binary_sensor:
      # Registry initialized
      - name: "Farm Registry Initialized"
        unique_id: farm_registry_initialized
        state: "{{ state_attr('sensor.farm_registry_data', 'initialized') | default(false) }}"
        icon: mdi:check-circle

# -----------------------------------------------------------------------------
# INPUT HELPERS
# -----------------------------------------------------------------------------
input_select:
  # Editor mode selectors (IPM-style pattern)
  registry_business_editor_mode:
    name: "Business Editor Mode"
    options:
      - "Add New Business"
      - "Edit Existing Business"
    icon: mdi:domain

  # Business selector (for editing)
  registry_business:
    name: "Registry Business"
    options:
      - "Select..."
    icon: mdi:domain

  # Business filter for farms
  registry_farm_business_filter:
    name: "Filter by Business"
    options:
      - "All Businesses"
    icon: mdi:filter

  # Business assignment for new/edit farm
  registry_new_farm_business:
    name: "Assign to Business"
    options:
      - "None"
    icon: mdi:domain

  registry_farm_editor_mode:
    name: "Farm Editor Mode"
    options:
      - "Add New Farm"
      - "Edit Existing Farm"
    icon: mdi:barn

  registry_paddock_editor_mode:
    name: "Paddock Editor Mode"
    options:
      - "View"
      - "Edit"
      - "Add New"
    icon: mdi:view-grid

  registry_season_editor_mode:
    name: "Season Editor Mode"
    options:
      - "Add New Season"
      - "Edit Existing Season"
    icon: mdi:calendar-range

  # Season selector
  registry_season:
    name: "Registry Season"
    options:
      - "Select..."
    icon: mdi:calendar-range

  # Farm selector (for filtering)
  registry_farm:
    name: "Registry Farm"
    options:
      - "Select..."
    icon: mdi:barn

  # Paddock selector (for operations)
  registry_paddock:
    name: "Registry Paddock"
    options:
      - "Select..."
    icon: mdi:view-grid

  # Paddock filter by farm
  registry_paddock_farm_filter:
    name: "Filter by Farm"
    options:
      - "All Farms"
    icon: mdi:filter

  # Farm assignment for new paddock (separate from edit selector)
  registry_new_paddock_farm:
    name: "Assign to Farm"
    options:
      - "Select..."
    icon: mdi:barn

  # Module selector for install/remove actions (PaddiSense Manager)
  paddisense_module_action:
    name: "Select Module"
    options:
      - "ipm"
      - "asm"
      - "weather"
      - "pwm"
    icon: mdi:puzzle

  # Crop editor mode
  registry_crop_editor_mode:
    name: "Crop Editor Mode"
    options:
      - "Add New Crop"
      - "Edit Existing Crop"
    icon: mdi:sprout

  # Crop selector (for editing)
  registry_crop:
    name: "Registry Crop"
    options:
      - "Select..."
    icon: mdi:sprout

  # Crop 1 selector (for paddock assignment)
  registry_paddock_crop_1:
    name: "Crop 1 (Early Season)"
    options:
      - "None"
    icon: mdi:sprout

  # Crop 2 selector (for paddock assignment)
  registry_paddock_crop_2:
    name: "Crop 2 (Late Season)"
    options:
      - "None"
    icon: mdi:sprout

  # Month selectors for crop assignment
  registry_crop_1_start_month:
    name: "Crop 1 Start Month"
    options:
      - "Jan"
      - "Feb"
      - "Mar"
      - "Apr"
      - "May"
      - "Jun"
      - "Jul"
      - "Aug"
      - "Sep"
      - "Oct"
      - "Nov"
      - "Dec"
    icon: mdi:calendar-start

  registry_crop_1_end_month:
    name: "Crop 1 End Month"
    options:
      - "Jan"
      - "Feb"
      - "Mar"
      - "Apr"
      - "May"
      - "Jun"
      - "Jul"
      - "Aug"
      - "Sep"
      - "Oct"
      - "Nov"
      - "Dec"
    icon: mdi:calendar-end

  registry_crop_2_start_month:
    name: "Crop 2 Start Month"
    options:
      - "Jan"
      - "Feb"
      - "Mar"
      - "Apr"
      - "May"
      - "Jun"
      - "Jul"
      - "Aug"
      - "Sep"
      - "Oct"
      - "Nov"
      - "Dec"
    icon: mdi:calendar-start

  registry_crop_2_end_month:
    name: "Crop 2 End Month"
    options:
      - "Jan"
      - "Feb"
      - "Mar"
      - "Apr"
      - "May"
      - "Jun"
      - "Jul"
      - "Aug"
      - "Sep"
      - "Oct"
      - "Nov"
      - "Dec"
    icon: mdi:calendar-end

# -----------------------------------------------------------------------------
# INPUT TEXT (for add/edit forms)
# -----------------------------------------------------------------------------
input_text:
  registry_new_paddock_name:
    name: "New Paddock Name"
    icon: mdi:view-grid
    max: 50

  registry_new_season_name:
    name: "New Season Name"
    icon: mdi:calendar
    max: 20

  # Edit paddock helpers
  registry_edit_paddock_pointer:
    name: "Edit Paddock Pointer"
    icon: mdi:target
    max: 50

  registry_edit_paddock_name:
    name: "Paddock Name"
    icon: mdi:view-grid
    max: 50

  # Business helpers
  registry_new_business_name:
    name: "New Business Name"
    icon: mdi:domain
    max: 100

  registry_edit_business_name:
    name: "Business Name"
    icon: mdi:domain
    max: 100

  registry_edit_business_pointer:
    name: "Edit Business Pointer"
    icon: mdi:target
    max: 50

  # Farm helpers
  registry_new_farm_name:
    name: "New Farm Name"
    icon: mdi:barn
    max: 50

  registry_edit_farm_name:
    name: "Farm Name"
    icon: mdi:barn
    max: 50

  registry_edit_farm_pointer:
    name: "Edit Farm Pointer"
    icon: mdi:target
    max: 50

  registry_selected_paddock_id:
    name: "Selected Paddock ID"
    icon: mdi:target
    max: 50

  # Season edit helpers
  registry_edit_season_pointer:
    name: "Edit Season Pointer"
    icon: mdi:target
    max: 50

  registry_edit_season_name:
    name: "Season Name"
    icon: mdi:calendar
    max: 20

  # Excel import helper
  registry_excel_filename:
    name: "Excel/CSV Filename"
    icon: mdi:file-excel
    max: 100

  # Crop edit helpers
  registry_new_crop_name:
    name: "New Crop Name"
    icon: mdi:sprout
    max: 50

  registry_edit_crop_pointer:
    name: "Edit Crop Pointer"
    icon: mdi:target
    max: 50

  registry_edit_crop_name:
    name: "Crop Name"
    icon: mdi:sprout
    max: 50

  registry_edit_crop_color:
    name: "Crop Color"
    icon: mdi:palette
    max: 10

  registry_new_stage_name:
    name: "New Stage Name"
    icon: mdi:leaf
    max: 50

# -----------------------------------------------------------------------------
# INPUT NUMBER (for add paddock form)
# -----------------------------------------------------------------------------
input_number:
  registry_new_paddock_bay_count:
    name: "New Paddock Bay Count"
    icon: mdi:numeric
    min: 1
    max: 20
    step: 1
    mode: box

  registry_edit_paddock_bay_count:
    name: "Bay Count"
    icon: mdi:numeric
    min: 1
    max: 20
    step: 1
    mode: box

  registry_new_paddock_brown_area:
    name: "Brown Area (ha)"
    icon: mdi:ruler-square
    min: 0
    max: 10000
    step: 0.1
    mode: box
    unit_of_measurement: "ha"

  registry_new_paddock_green_area:
    name: "Green Area (ha)"
    icon: mdi:ruler-square
    min: 0
    max: 10000
    step: 0.1
    mode: box
    unit_of_measurement: "ha"

  registry_edit_paddock_brown_area:
    name: "Brown Area (ha)"
    icon: mdi:ruler-square
    min: 0
    max: 10000
    step: 0.1
    mode: box
    unit_of_measurement: "ha"

  registry_edit_paddock_green_area:
    name: "Green Area (ha)"
    icon: mdi:ruler-square
    min: 0
    max: 10000
    step: 0.1
    mode: box
    unit_of_measurement: "ha"

  registry_crop_start_month:
    name: "Crop Start Month"
    icon: mdi:calendar-start
    min: 1
    max: 12
    step: 1
    mode: box

  registry_crop_end_month:
    name: "Crop End Month"
    icon: mdi:calendar-end
    min: 1
    max: 12
    step: 1
    mode: box


# -----------------------------------------------------------------------------
# INPUT BOOLEAN (for edit forms)
# -----------------------------------------------------------------------------
input_boolean:
  registry_edit_current_season:
    name: "Current Season"
    icon: mdi:calendar-check

  registry_paddock_edit_mode:
    name: "Paddock Edit Mode"
    icon: mdi:pencil

# -----------------------------------------------------------------------------
# INPUT DATETIME (for season dates)
# -----------------------------------------------------------------------------
input_datetime:
  registry_season_start:
    name: "Season Start Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-start

  registry_season_end:
    name: "Season End Date"
    has_date: true
    has_time: false
    icon: mdi:calendar-end

  registry_edit_season_start:
    name: "Edit Season Start"
    has_date: true
    has_time: false
    icon: mdi:calendar-start

  registry_edit_season_end:
    name: "Edit Season End"
    has_date: true
    has_time: false
    icon: mdi:calendar-end

# -----------------------------------------------------------------------------
# SCRIPTS
# -----------------------------------------------------------------------------
script:
  # Refresh all dropdowns (can be called from dashboard)
  registry_refresh_dropdowns:
    alias: "Registry - Refresh Dropdowns"
    icon: mdi:refresh
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          seconds: 1
      # Business dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['Select...'] + (businesses | list) if businesses else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm_business_filter
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['All Businesses'] + (businesses | list) if businesses else ['All Businesses'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_farm_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['None'] + (businesses | list) if businesses else ['None'] }}
      # Other dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_farm_filter
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['All Farms'] + (farms | list) if farms else ['All Farms'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_paddock_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddock_names') or [] %}
            {{ ['Select...'] + paddocks if paddocks else ['Select...'] }}

  # Initialize registry
  registry_init_system:
    alias: "Registry - Initialize System"
    icon: mdi:database-plus
    sequence:
      - service: shell_command.registry_init
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Migrate from PWM
  registry_migrate_from_pwm:
    alias: "Registry - Migrate from PWM"
    icon: mdi:database-import
    sequence:
      - service: shell_command.registry_migrate_pwm
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Refresh data
  registry_refresh_data:
    alias: "Registry - Refresh Data"
    icon: mdi:refresh
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Export backup
  registry_export_data:
    alias: "Registry - Export Backup"
    icon: mdi:database-export
    sequence:
      - service: shell_command.registry_export
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Add paddock
  registry_add_paddock:
    alias: "Registry - Add Paddock"
    icon: mdi:view-grid-plus
    fields:
      name:
        description: "Paddock name"
        required: true
        selector:
          text:
      bay_count:
        description: "Number of bays"
        required: true
        selector:
          number:
            min: 1
            max: 20
      farm:
        description: "Farm ID (optional)"
        selector:
          text:
      bay_prefix:
        description: "Bay prefix (default: B-)"
        selector:
          text:
    sequence:
      - service: shell_command.registry_add_paddock
        data:
          name: "{{ name }}"
          bay_count: "{{ bay_count }}"
          farm: "{{ farm | default('farm_1') }}"
          bay_prefix: "{{ bay_prefix | default('B-') }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_paddock_name
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_new_paddock_bay_count
        data:
          value: 1
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_new_paddock_farm
        data:
          option: "Select..."

  # Delete paddock
  registry_delete_paddock:
    alias: "Registry - Delete Paddock"
    icon: mdi:view-grid-remove
    fields:
      id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_paddock
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Add season (with parameters - for programmatic use)
  registry_add_season:
    alias: "Registry - Add Season"
    icon: mdi:calendar-plus
    fields:
      name:
        description: "Season name (e.g., CY26)"
        required: true
        selector:
          text:
      start:
        description: "Start date (YYYY-MM-DD)"
        required: true
        selector:
          text:
      end:
        description: "End date (YYYY-MM-DD)"
        required: true
        selector:
          text:
      active:
        description: "Set as active season"
        selector:
          boolean:
    sequence:
      - service: shell_command.registry_add_season
        data:
          name: "{{ name }}"
          start: "{{ start }}"
          end: "{{ end }}"
          active: "{{ active | default(false) }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_season_name
        data:
          value: ""

  # Add season from form (reads input entities directly - for dashboard buttons)
  registry_add_season_from_form:
    alias: "Registry - Add Season from Form"
    icon: mdi:calendar-plus
    fields:
      set_active:
        description: "Set as active season after adding"
        selector:
          boolean:
    sequence:
      - variables:
          season_name: "{{ states('input_text.registry_new_season_name') }}"
          season_start: "{{ states('input_datetime.registry_season_start') }}"
          season_end: "{{ states('input_datetime.registry_season_end') }}"
          make_active: "{{ set_active | default(false) }}"
      # Validate inputs
      - condition: template
        value_template: "{{ season_name | length > 0 }}"
      - condition: template
        value_template: "{{ season_start not in ['unknown', 'unavailable', ''] }}"
      - condition: template
        value_template: "{{ season_end not in ['unknown', 'unavailable', ''] }}"
      # Call shell command
      - service: shell_command.registry_add_season
        data:
          name: "{{ season_name }}"
          start: "{{ season_start }}"
          end: "{{ season_end }}"
          active: "{{ make_active }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_season_name
        data:
          value: ""
      # Refresh season dropdown
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}

  # Set active season
  registry_set_active_season:
    alias: "Registry - Set Active Season"
    icon: mdi:calendar-check
    fields:
      id:
        description: "Season ID"
        required: true
        selector:
          text:
    sequence:
      # Validate that a season is selected
      - condition: template
        value_template: "{{ id | length > 0 and id != 'Select...' }}"
      - service: shell_command.registry_set_active_season
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh season dropdown to show updated active status
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}

  # Toggle paddock current_season
  registry_toggle_current_season:
    alias: "Registry - Toggle Paddock Current Season"
    icon: mdi:calendar-sync
    fields:
      id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_set_current_season
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Open edit paddock popup (loads values into helpers)
  registry_open_edit_paddock:
    alias: "Registry - Open Edit Paddock"
    icon: mdi:pencil
    fields:
      id:
        description: "Paddock ID"
        required: true
        selector:
          text:
    sequence:
      # Set pointer
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_pointer
        data:
          value: "{{ id }}"
      # Load current values
      - variables:
          paddock: "{{ state_attr('sensor.farm_registry_data', 'paddocks')[id] | default({}) }}"
          crops: "{{ state_attr('sensor.farm_registry_data', 'crops') | default({}) }}"
      - variables:
          crop_1: "{{ paddock.crop_1 | default({}) }}"
          crop_2: "{{ paddock.crop_2 | default({}) }}"
          crop_1_name: "{{ crops[crop_1.crop_id].name if crop_1.crop_id and crop_1.crop_id in crops else 'None' }}"
          crop_2_name: "{{ crops[crop_2.crop_id].name if crop_2.crop_id and crop_2.crop_id in crops else 'None' }}"
          month_names: "{{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_name
        data:
          value: "{{ paddock.name | default('') }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_edit_paddock_bay_count
        data:
          value: "{{ paddock.bay_count | default(1) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_edit_paddock_brown_area
        data:
          value: "{{ paddock.brown_area_ha | default(0) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_edit_paddock_green_area
        data:
          value: "{{ paddock.green_area_ha | default(0) }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ paddock.current_season | default(true) }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.registry_edit_current_season
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.registry_edit_current_season
      # Load crop rotation values
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_crop_1
        data:
          option: "{{ crop_1_name }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_crop_1_start_month
        data:
          option: "{{ month_names[(crop_1.start_month | default(1)) - 1] }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_crop_1_end_month
        data:
          option: "{{ month_names[(crop_1.end_month | default(12)) - 1] }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_crop_2
        data:
          option: "{{ crop_2_name }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_crop_2_start_month
        data:
          option: "{{ month_names[(crop_2.start_month | default(1)) - 1] }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_crop_2_end_month
        data:
          option: "{{ month_names[(crop_2.end_month | default(12)) - 1] }}"

  # Save paddock edit
  registry_save_paddock_edit:
    alias: "Registry - Save Paddock Edit"
    icon: mdi:content-save
    sequence:
      - variables:
          paddock_id: "{{ states('input_text.registry_edit_paddock_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_paddock_name') }}"
          current_season: "{{ is_state('input_boolean.registry_edit_current_season', 'on') }}"
      # Validate that a paddock is selected
      - condition: template
        value_template: "{{ paddock_id | length > 0 }}"
      - service: shell_command.registry_edit_paddock
        data:
          id: "{{ paddock_id }}"
          name: "{{ new_name }}"
          current_season: "{{ current_season }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh dropdown with updated data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddock_names') or [] %}
            {{ ['Select...'] + paddocks if paddocks else ['Select...'] }}
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_pointer
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_edit_paddock_bay_count
        data:
          value: 1
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock
        data:
          option: "Select..."

  # --------------------------------------------------------------------------
  # BUSINESS SCRIPTS
  # --------------------------------------------------------------------------

  # Add business
  registry_add_business:
    alias: "Registry - Add Business"
    icon: mdi:domain
    fields:
      name:
        description: "Business name"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_add_business
        data:
          name: "{{ name }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_business_name
        data:
          value: ""

  # Delete business
  registry_delete_business:
    alias: "Registry - Delete Business"
    icon: mdi:delete
    fields:
      id:
        description: "Business ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_business
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form after delete
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_business
        data:
          option: "Select..."

  # Open edit business (loads values into helpers)
  registry_open_edit_business:
    alias: "Registry - Open Edit Business"
    icon: mdi:pencil
    fields:
      id:
        description: "Business ID"
        required: true
        selector:
          text:
    sequence:
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_pointer
        data:
          value: "{{ id }}"
      - variables:
          business: "{{ state_attr('sensor.farm_registry_data', 'businesses')[id] | default({}) }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_name
        data:
          value: "{{ business.name | default('') }}"

  # Save business edit
  registry_save_business_edit:
    alias: "Registry - Save Business Edit"
    icon: mdi:content-save
    sequence:
      - variables:
          business_id: "{{ states('input_text.registry_edit_business_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_business_name') }}"
      # Validate that a business is selected
      - condition: template
        value_template: "{{ business_id | length > 0 }}"
      - service: shell_command.registry_edit_business
        data:
          id: "{{ business_id }}"
          name: "{{ new_name }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh dropdown with updated data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['Select...'] + (businesses | list) if businesses else ['Select...'] }}
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_business_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_business
        data:
          option: "Select..."

  # --------------------------------------------------------------------------
  # FARM SCRIPTS
  # --------------------------------------------------------------------------

  # Add farm
  registry_add_farm:
    alias: "Registry - Add Farm"
    icon: mdi:barn
    fields:
      name:
        description: "Farm name"
        required: true
        selector:
          text:
      business:
        description: "Business ID (optional)"
        selector:
          text:
    sequence:
      - service: shell_command.registry_add_farm
        data:
          name: "{{ name }}"
          business: "{{ business | default('') }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_farm_name
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_new_farm_business
        data:
          option: "None"

  # Delete farm
  registry_delete_farm:
    alias: "Registry - Delete Farm"
    icon: mdi:delete
    fields:
      id:
        description: "Farm ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_farm
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form after delete
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_farm
        data:
          option: "Select..."

  # Open edit farm (loads values into helpers)
  registry_open_edit_farm:
    alias: "Registry - Open Edit Farm"
    icon: mdi:pencil
    fields:
      id:
        description: "Farm ID"
        required: true
        selector:
          text:
    sequence:
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_pointer
        data:
          value: "{{ id }}"
      - variables:
          farm: "{{ state_attr('sensor.farm_registry_data', 'farms')[id] | default({}) }}"
          businesses: "{{ state_attr('sensor.farm_registry_data', 'businesses') | default({}) }}"
      - variables:
          business_id: "{{ farm.business_id | default('') }}"
          business_name: "{{ businesses[business_id].name if business_id and business_id in businesses else 'None' }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_name
        data:
          value: "{{ farm.name | default('') }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_new_farm_business
        data:
          option: "{{ business_name }}"

  # Save farm edit
  registry_save_farm_edit:
    alias: "Registry - Save Farm Edit"
    icon: mdi:content-save
    sequence:
      - variables:
          farm_id: "{{ states('input_text.registry_edit_farm_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_farm_name') }}"
          business_name: "{{ states('input_select.registry_new_farm_business') }}"
          businesses: "{{ state_attr('sensor.farm_registry_data', 'businesses') or {} }}"
      - variables:
          # Convert business name to ID
          business_id: >-
            {% if business_name == 'None' %}{% else %}
            {% for bid, b in businesses.items() if b.name == business_name %}{{ bid }}{% endfor %}
            {% endif %}
      # Validate that a farm is selected
      - condition: template
        value_template: "{{ farm_id | length > 0 }}"
      - service: shell_command.registry_edit_farm
        data:
          id: "{{ farm_id }}"
          name: "{{ new_name }}"
          business: "{{ business_id | trim }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh dropdown with updated data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_farm_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_farm
        data:
          option: "Select..."

  # Open edit season (loads values into helpers)
  registry_open_edit_season:
    alias: "Registry - Open Edit Season"
    icon: mdi:pencil
    fields:
      id:
        description: "Season ID"
        required: true
        selector:
          text:
    sequence:
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_pointer
        data:
          value: "{{ id }}"
      - variables:
          season: "{{ state_attr('sensor.farm_registry_data', 'seasons')[id] | default({}) }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_name
        data:
          value: "{{ season.name | default('') }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.registry_edit_season_start
        data:
          date: "{{ season.start_date | default(now().strftime('%Y-%m-%d')) }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.registry_edit_season_end
        data:
          date: "{{ season.end_date | default(now().strftime('%Y-%m-%d')) }}"

  # Save season edit
  registry_save_season_edit:
    alias: "Registry - Save Season Edit"
    icon: mdi:content-save
    sequence:
      - variables:
          season_id: "{{ states('input_text.registry_edit_season_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_season_name') }}"
          new_start: "{{ states('input_datetime.registry_edit_season_start') }}"
          new_end: "{{ states('input_datetime.registry_edit_season_end') }}"
      # Validate that a season is selected
      - condition: template
        value_template: "{{ season_id | length > 0 }}"
      - service: shell_command.registry_edit_season
        data:
          id: "{{ season_id }}"
          name: "{{ new_name }}"
          start: "{{ new_start }}"
          end: "{{ new_end }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh dropdown with updated data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_season
        data:
          option: "Select..."

  # Delete season
  registry_delete_season:
    alias: "Registry - Delete Season"
    icon: mdi:delete
    fields:
      id:
        description: "Season ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_season
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form after delete
      - delay:
          milliseconds: 500
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_season_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_season
        data:
          option: "Select..."

  # --------------------------------------------------------------------------
  # CROP SCRIPTS
  # --------------------------------------------------------------------------

  # Add new crop type
  registry_add_crop:
    alias: "Registry - Add Crop"
    icon: mdi:sprout
    fields:
      name:
        description: "Crop name"
        required: true
        selector:
          text:
      start_month:
        description: "Typical start month (1-12)"
        selector:
          number:
            min: 1
            max: 12
      end_month:
        description: "Typical end month (1-12)"
        selector:
          number:
            min: 1
            max: 12
      color:
        description: "Hex color code"
        selector:
          text:
    sequence:
      - service: shell_command.registry_add_crop
        data:
          name: "{{ name }}"
          start_month: "{{ start_month | default(1) }}"
          end_month: "{{ end_month | default(12) }}"
          color: "{{ color | default('#4caf50') }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_crop_name
        data:
          value: ""

  # Delete crop type
  registry_delete_crop:
    alias: "Registry - Delete Crop"
    icon: mdi:delete
    fields:
      id:
        description: "Crop ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_crop
        data:
          id: "{{ id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form after delete
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_crop
        data:
          option: "Select..."

  # Open edit crop (loads values into helpers)
  registry_open_edit_crop:
    alias: "Registry - Open Edit Crop"
    icon: mdi:pencil
    fields:
      id:
        description: "Crop ID"
        required: true
        selector:
          text:
    sequence:
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_crop_pointer
        data:
          value: "{{ id }}"
      - variables:
          crop: "{{ state_attr('sensor.farm_registry_data', 'crops')[id] | default({}) }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_crop_name
        data:
          value: "{{ crop.name | default('') }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_crop_color
        data:
          value: "{{ crop.color | default('#4caf50') }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_crop_start_month
        data:
          value: "{{ crop.typical_start_month | default(1) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_crop_end_month
        data:
          value: "{{ crop.typical_end_month | default(12) }}"

  # Save crop edit
  registry_save_crop_edit:
    alias: "Registry - Save Crop Edit"
    icon: mdi:content-save
    sequence:
      - variables:
          crop_id: "{{ states('input_text.registry_edit_crop_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_crop_name') }}"
          new_color: "{{ states('input_text.registry_edit_crop_color') }}"
          start_month: "{{ states('input_number.registry_crop_start_month') | int }}"
          end_month: "{{ states('input_number.registry_crop_end_month') | int }}"
      # Validate that a crop is selected
      - condition: template
        value_template: "{{ crop_id | length > 0 }}"
      - service: shell_command.registry_edit_crop
        data:
          id: "{{ crop_id }}"
          name: "{{ new_name }}"
          color: "{{ new_color }}"
          start_month: "{{ start_month }}"
          end_month: "{{ end_month }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Refresh crop dropdown
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_crop
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['Select...'] + crops if crops else ['Select...'] }}

  # Add stage to a crop
  registry_add_crop_stage:
    alias: "Registry - Add Crop Stage"
    icon: mdi:leaf
    fields:
      crop_id:
        description: "Crop ID"
        required: true
        selector:
          text:
      name:
        description: "Stage name"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_add_crop_stage
        data:
          crop_id: "{{ crop_id }}"
          name: "{{ name }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear stage name input
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_stage_name
        data:
          value: ""

  # Delete stage from a crop
  registry_delete_crop_stage:
    alias: "Registry - Delete Crop Stage"
    icon: mdi:delete
    fields:
      crop_id:
        description: "Crop ID"
        required: true
        selector:
          text:
      stage_id:
        description: "Stage ID"
        required: true
        selector:
          text:
    sequence:
      - service: shell_command.registry_delete_crop_stage
        data:
          crop_id: "{{ crop_id }}"
          stage_id: "{{ stage_id }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Set paddock crop rotation (with parameters - for programmatic use)
  registry_set_paddock_crops:
    alias: "Registry - Set Paddock Crops"
    icon: mdi:sprout
    fields:
      paddock_id:
        description: "Paddock ID"
        required: true
        selector:
          text:
      crop_1_id:
        description: "Crop 1 ID (early season)"
        selector:
          text:
      crop_1_start:
        description: "Crop 1 start month (1-12)"
        selector:
          number:
            min: 1
            max: 12
      crop_1_end:
        description: "Crop 1 end month (1-12)"
        selector:
          number:
            min: 1
            max: 12
      crop_2_id:
        description: "Crop 2 ID (late season)"
        selector:
          text:
      crop_2_start:
        description: "Crop 2 start month (1-12)"
        selector:
          number:
            min: 1
            max: 12
      crop_2_end:
        description: "Crop 2 end month (1-12)"
        selector:
          number:
            min: 1
            max: 12
    sequence:
      - service: shell_command.registry_set_paddock_crops
        data:
          id: "{{ paddock_id }}"
          crop_1_id: "{{ crop_1_id | default('') }}"
          crop_1_start: "{{ crop_1_start | default(1) }}"
          crop_1_end: "{{ crop_1_end | default(12) }}"
          crop_2_id: "{{ crop_2_id | default('') }}"
          crop_2_start: "{{ crop_2_start | default(1) }}"
          crop_2_end: "{{ crop_2_end | default(12) }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Save paddock crops from form (reads input entities - for dashboard buttons)
  registry_save_paddock_crops_from_form:
    alias: "Registry - Save Paddock Crops from Form"
    icon: mdi:sprout
    sequence:
      - variables:
          paddock_id: "{{ states('input_text.registry_edit_paddock_pointer') }}"
          crop_1_name: "{{ states('input_select.registry_paddock_crop_1') }}"
          crop_2_name: "{{ states('input_select.registry_paddock_crop_2') }}"
          crop_1_start_name: "{{ states('input_select.registry_crop_1_start_month') }}"
          crop_1_end_name: "{{ states('input_select.registry_crop_1_end_month') }}"
          crop_2_start_name: "{{ states('input_select.registry_crop_2_start_month') }}"
          crop_2_end_name: "{{ states('input_select.registry_crop_2_end_month') }}"
          crops: "{{ state_attr('sensor.farm_registry_data', 'crops') or {} }}"
      - variables:
          # Convert crop names to IDs
          crop_1_id: >-
            {% if crop_1_name == 'None' %}{% else %}
            {% for cid, c in crops.items() if c.name == crop_1_name %}{{ cid }}{% endfor %}
            {% endif %}
          crop_2_id: >-
            {% if crop_2_name == 'None' %}{% else %}
            {% for cid, c in crops.items() if c.name == crop_2_name %}{{ cid }}{% endfor %}
            {% endif %}
          # Convert month names to numbers
          month_map: "{{ {'Jan':1,'Feb':2,'Mar':3,'Apr':4,'May':5,'Jun':6,'Jul':7,'Aug':8,'Sep':9,'Oct':10,'Nov':11,'Dec':12} }}"
      - variables:
          crop_1_start: "{{ month_map[crop_1_start_name] | default(1) }}"
          crop_1_end: "{{ month_map[crop_1_end_name] | default(12) }}"
          crop_2_start: "{{ month_map[crop_2_start_name] | default(1) }}"
          crop_2_end: "{{ month_map[crop_2_end_name] | default(12) }}"
      # Validate paddock is selected
      - condition: template
        value_template: "{{ paddock_id | length > 0 }}"
      - service: shell_command.registry_set_paddock_crops
        data:
          id: "{{ paddock_id | trim }}"
          crop_1_id: "{{ crop_1_id | trim }}"
          crop_1_start: "{{ crop_1_start }}"
          crop_1_end: "{{ crop_1_end }}"
          crop_2_id: "{{ crop_2_id | trim }}"
          crop_2_start: "{{ crop_2_start }}"
          crop_2_end: "{{ crop_2_end }}"
      - delay:
          seconds: 1
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data

  # Save all paddock changes (details + crops) from form
  registry_save_paddock_all:
    alias: "Registry - Save All Paddock Changes"
    icon: mdi:content-save-all
    sequence:
      # Capture paddock ID first (before any script clears it)
      - variables:
          paddock_id: "{{ states('input_text.registry_edit_paddock_pointer') }}"
          new_name: "{{ states('input_text.registry_edit_paddock_name') }}"
          current_season: "{{ is_state('input_boolean.registry_edit_current_season', 'on') }}"
          brown_area: "{{ states('input_number.registry_edit_paddock_brown_area') | float(0) }}"
          green_area: "{{ states('input_number.registry_edit_paddock_green_area') | float(0) }}"
          crop_1_name: "{{ states('input_select.registry_paddock_crop_1') }}"
          crop_2_name: "{{ states('input_select.registry_paddock_crop_2') }}"
          crop_1_start_name: "{{ states('input_select.registry_crop_1_start_month') }}"
          crop_1_end_name: "{{ states('input_select.registry_crop_1_end_month') }}"
          crop_2_start_name: "{{ states('input_select.registry_crop_2_start_month') }}"
          crop_2_end_name: "{{ states('input_select.registry_crop_2_end_month') }}"
          crops: "{{ state_attr('sensor.farm_registry_data', 'crops') or {} }}"
      # Validate paddock is selected
      - condition: template
        value_template: "{{ paddock_id | length > 0 }}"
      # Convert crop names to IDs and month names to numbers
      - variables:
          crop_1_id: >-
            {% if crop_1_name == 'None' %}{% else %}
            {% for cid, c in crops.items() if c.name == crop_1_name %}{{ cid }}{% endfor %}
            {% endif %}
          crop_2_id: >-
            {% if crop_2_name == 'None' %}{% else %}
            {% for cid, c in crops.items() if c.name == crop_2_name %}{{ cid }}{% endfor %}
            {% endif %}
          month_map: "{{ {'Jan':1,'Feb':2,'Mar':3,'Apr':4,'May':5,'Jun':6,'Jul':7,'Aug':8,'Sep':9,'Oct':10,'Nov':11,'Dec':12} }}"
      - variables:
          crop_1_start: "{{ month_map[crop_1_start_name] | default(1) }}"
          crop_1_end: "{{ month_map[crop_1_end_name] | default(12) }}"
          crop_2_start: "{{ month_map[crop_2_start_name] | default(1) }}"
          crop_2_end: "{{ month_map[crop_2_end_name] | default(12) }}"
      # Save paddock details (name, current_season, areas)
      - service: shell_command.registry_edit_paddock
        data:
          id: "{{ paddock_id }}"
          name: "{{ new_name }}"
          current_season: "{{ current_season }}"
          brown_area: "{{ brown_area }}"
          green_area: "{{ green_area }}"
      - delay:
          milliseconds: 300
      # Save crop rotation
      - service: shell_command.registry_set_paddock_crops
        data:
          id: "{{ paddock_id | trim }}"
          crop_1_id: "{{ crop_1_id | trim }}"
          crop_1_start: "{{ crop_1_start }}"
          crop_1_end: "{{ crop_1_end }}"
          crop_2_id: "{{ crop_2_id | trim }}"
          crop_2_start: "{{ crop_2_start }}"
          crop_2_end: "{{ crop_2_end }}"
      - delay:
          seconds: 1
      # Refresh data
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          milliseconds: 500
      # Clear form after successful save
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_name
        data:
          value: ""
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock
        data:
          option: "Select..."
      # Switch back to View mode
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "View"

  # Start editing selected paddock (HFM pattern)
  registry_paddock_start_edit:
    alias: "Registry - Start Paddock Edit"
    icon: mdi:pencil
    sequence:
      # Validate a paddock is selected
      - condition: template
        value_template: "{{ states('input_text.registry_edit_paddock_pointer') | length > 0 }}"
      # Switch to Edit mode
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "Edit"

  # Start adding new paddock (HFM pattern)
  registry_paddock_start_add:
    alias: "Registry - Start Paddock Add"
    icon: mdi:plus
    sequence:
      # Clear the form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_paddock_name
        data:
          value: ""
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_new_paddock_bay_count
        data:
          value: 4
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_new_paddock_brown_area
        data:
          value: 0
      - service: input_number.set_value
        target:
          entity_id: input_number.registry_new_paddock_green_area
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_new_paddock_farm
        data:
          option: "Select..."
      # Switch to Add mode
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "Add New"

  # Clear paddock form / return to View mode (HFM pattern)
  registry_paddock_clear_form:
    alias: "Registry - Clear Paddock Form"
    icon: mdi:close
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "View"

  # Delete selected paddock (HFM pattern)
  registry_paddock_delete:
    alias: "Registry - Delete Selected Paddock"
    icon: mdi:delete
    sequence:
      - variables:
          paddock_id: "{{ states('input_text.registry_edit_paddock_pointer') }}"
      # Validate a paddock is selected
      - condition: template
        value_template: "{{ paddock_id | length > 0 }}"
      # Delete the paddock
      - service: shell_command.registry_delete_paddock
        data:
          id: "{{ paddock_id }}"
      - delay:
          seconds: 1
      # Refresh data
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear selection
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_edit_paddock_pointer
        data:
          value: ""
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock
        data:
          option: "Select..."
      # Stay in View mode
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "View"

  # Add paddock from form and return to View mode
  registry_add_paddock_from_form:
    alias: "Registry - Add Paddock from Form"
    icon: mdi:view-grid-plus
    sequence:
      - variables:
          paddock_name: "{{ states('input_text.registry_new_paddock_name') }}"
          bay_count: "{{ states('input_number.registry_new_paddock_bay_count') | int }}"
          brown_area: "{{ states('input_number.registry_new_paddock_brown_area') | float(0) }}"
          green_area: "{{ states('input_number.registry_new_paddock_green_area') | float(0) }}"
          farm_name: "{{ states('input_select.registry_new_paddock_farm') }}"
          farms: "{{ state_attr('sensor.farm_registry_data', 'farms') or {} }}"
      - variables:
          farm_id: >-
            {% for fid, f in farms.items() if f.name == farm_name %}{{ fid }}{% endfor %}
      # Validate
      - condition: template
        value_template: "{{ paddock_name | length > 0 and farm_name != 'Select...' }}"
      # Add paddock
      - service: shell_command.registry_add_paddock
        data:
          name: "{{ paddock_name }}"
          bay_count: "{{ bay_count }}"
          farm: "{{ farm_id | default('farm_1') | trim }}"
          bay_prefix: "B-"
          brown_area: "{{ brown_area }}"
          green_area: "{{ green_area }}"
      - delay:
          seconds: 1
      # Refresh data
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      # Clear form
      - service: input_text.set_value
        target:
          entity_id: input_text.registry_new_paddock_name
        data:
          value: ""
      # Switch back to View mode
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock_editor_mode
        data:
          option: "View"
      # Refresh dropdowns
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddock_names') or [] %}
            {{ ['Select...'] + paddocks if paddocks else ['Select...'] }}

# -----------------------------------------------------------------------------
# AUTOMATIONS
# -----------------------------------------------------------------------------
automation:
  # Initialize dropdowns on Home Assistant startup
  - id: registry_init_dropdowns_on_startup
    alias: "Registry - Initialize Dropdowns on Startup"
    trigger:
      - platform: homeassistant
        event: start
    action:
      # Wait for sensor to be available
      - delay:
          seconds: 10
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          seconds: 2
      # Update all dropdowns
      # Business dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['Select...'] + (businesses | list) if businesses else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm_business_filter
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['All Businesses'] + (businesses | list) if businesses else ['All Businesses'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_farm_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['None'] + (businesses | list) if businesses else ['None'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_farm_filter
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['All Farms'] + (farms | list) if farms else ['All Farms'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_paddock_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddock_names') or [] %}
            {{ ['Select...'] + paddocks if paddocks else ['Select...'] }}
      # Crop dropdowns
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_crop
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['Select...'] + crops if crops else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_crop_1
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['None'] + crops if crops else ['None'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_crop_2
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['None'] + crops if crops else ['None'] }}

  # Update season dropdown when data changes
  - id: registry_update_season_dropdown
    alias: "Registry - Update Season Dropdown"
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'season_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}

  # Update crop dropdowns when data changes
  - id: registry_update_crop_dropdowns
    alias: "Registry - Update Crop Dropdowns"
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'crop_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_crop_1
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['None'] + crops if crops else ['None'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_crop_2
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['None'] + crops if crops else ['None'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_crop
        data:
          options: >-
            {% set crops = state_attr('sensor.farm_registry_data', 'crop_names') or [] %}
            {{ ['Select...'] + crops if crops else ['Select...'] }}

  # Update business dropdowns when data changes
  - id: registry_update_business_dropdowns
    alias: "Registry - Update Business Dropdowns"
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'business_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['Select...'] + (businesses | list) if businesses else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm_business_filter
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['All Businesses'] + (businesses | list) if businesses else ['All Businesses'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_farm_business
        data:
          options: >-
            {% set businesses = state_attr('sensor.farm_registry_data', 'business_names') or [] %}
            {{ ['None'] + (businesses | list) if businesses else ['None'] }}

  # Load business edit form when business is selected
  - id: registry_load_business_on_select
    alias: "Registry - Load Business on Select"
    trigger:
      - platform: state
        entity_id: input_select.registry_business
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select...' }}"
    action:
      - variables:
          business_name: "{{ states('input_select.registry_business') }}"
          businesses: "{{ state_attr('sensor.farm_registry_data', 'businesses') or {} }}"
      - variables:
          business_id: >-
            {% for bid, b in businesses.items() if (b.name | default('')) == business_name %}
            {{ bid }}
            {% endfor %}
      - service: script.registry_open_edit_business
        data:
          id: "{{ business_id | trim }}"

  # Filter farms when business filter changes
  - id: registry_filter_farms_by_business
    alias: "Registry - Filter Farms by Business"
    trigger:
      - platform: state
        entity_id: input_select.registry_farm_business_filter
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set filter_business = states('input_select.registry_farm_business_filter') %}
            {% set farms = state_attr('sensor.farm_registry_data', 'farms') or {} %}
            {% set businesses = state_attr('sensor.farm_registry_data', 'businesses') or {} %}
            {% set ns = namespace(result=[]) %}
            {% for fid, f in farms.items() %}
              {% if filter_business == 'All Businesses' %}
                {% set ns.result = ns.result + [f.name | default(fid)] %}
              {% else %}
                {% set business_id = f.business_id | default('') %}
                {% set business_data = businesses[business_id] | default({}) %}
                {% set business_name = business_data.name | default('') %}
                {% if business_name == filter_business %}
                  {% set ns.result = ns.result + [f.name | default(fid)] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ['Select...'] + (ns.result | sort) if ns.result else ['Select...'] }}
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_farm
        data:
          option: "Select..."

  # Update paddock dropdown when data changes (all paddocks)
  - id: registry_update_paddock_dropdown
    alias: "Registry - Update Paddock Dropdown"
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'paddock_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set filter_farm = states('input_select.registry_paddock_farm_filter') %}
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddocks') or {} %}
            {% set farms = state_attr('sensor.farm_registry_data', 'farms') or {} %}
            {% set ns = namespace(result=[]) %}
            {% for pid, p in paddocks.items() %}
              {% if filter_farm == 'All Farms' %}
                {% set ns.result = ns.result + [p.name | default(pid)] %}
              {% else %}
                {% set farm_id = p.farm_id | default('') %}
                {% set farm_data = farms[farm_id] | default({}) %}
                {% set farm_name = farm_data.name | default('') %}
                {% if farm_name == filter_farm %}
                  {% set ns.result = ns.result + [p.name | default(pid)] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ['Select...'] + ns.result if ns.result else ['Select...'] }}

  # Update farm dropdown when data changes
  - id: registry_update_farm_dropdown
    alias: "Registry - Update Farm Dropdown"
    trigger:
      - platform: state
        entity_id: sensor.farm_registry_data
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.farm_registry_data', 'farm_names') is not none }}"
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_farm_filter
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['All Farms'] + (farms | list) if farms else ['All Farms'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_new_paddock_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}

  # Filter paddocks when farm filter changes
  - id: registry_filter_paddocks_by_farm
    alias: "Registry - Filter Paddocks by Farm"
    trigger:
      - platform: state
        entity_id: input_select.registry_paddock_farm_filter
    action:
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set filter_farm = states('input_select.registry_paddock_farm_filter') %}
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddocks') or {} %}
            {% set farms = state_attr('sensor.farm_registry_data', 'farms') or {} %}
            {% set ns = namespace(result=[]) %}
            {% for pid, p in paddocks.items() %}
              {% if filter_farm == 'All Farms' %}
                {% set ns.result = ns.result + [p.name | default(pid)] %}
              {% else %}
                {% set farm_id = p.farm_id | default('') %}
                {% set farm_data = farms[farm_id] | default({}) %}
                {% set farm_name = farm_data.name | default('') %}
                {% if farm_name == filter_farm %}
                  {% set ns.result = ns.result + [p.name | default(pid)] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ['Select...'] + ns.result if ns.result else ['Select...'] }}
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_paddock
        data:
          option: "Select..."

  # Load paddock edit form when paddock is selected
  - id: registry_load_paddock_on_select
    alias: "Registry - Load Paddock on Select"
    trigger:
      - platform: state
        entity_id: input_select.registry_paddock
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select...' }}"
    action:
      # Turn off edit mode when selecting a new paddock
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.registry_paddock_edit_mode
      - variables:
          paddock_name: "{{ states('input_select.registry_paddock') }}"
          paddocks: "{{ state_attr('sensor.farm_registry_data', 'paddocks') or {} }}"
      - variables:
          paddock_id: >-
            {% for pid, p in paddocks.items() if (p.name | default('')) == paddock_name %}
            {{ pid }}
            {% endfor %}
      - service: script.registry_open_edit_paddock
        data:
          id: "{{ paddock_id | trim }}"

  # Refresh paddock dropdown when switching to View mode
  - id: registry_refresh_paddock_dropdown_on_mode_change
    alias: "Registry - Refresh Paddock Dropdown on Mode Change"
    trigger:
      - platform: state
        entity_id: input_select.registry_paddock_editor_mode
        to: "View"
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock_farm_filter
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['All Farms'] + (farms | list) if farms else ['All Farms'] }}
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_paddock
        data:
          options: >-
            {% set paddocks = state_attr('sensor.farm_registry_data', 'paddock_names') or [] %}
            {{ ['Select...'] + paddocks if paddocks else ['Select...'] }}

  # Load farm edit form when farm is selected
  - id: registry_load_farm_on_select
    alias: "Registry - Load Farm on Select"
    trigger:
      - platform: state
        entity_id: input_select.registry_farm
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select...' }}"
    action:
      - variables:
          farm_name: "{{ states('input_select.registry_farm') }}"
          farms: "{{ state_attr('sensor.farm_registry_data', 'farms') or {} }}"
      - variables:
          farm_id: >-
            {% for fid, f in farms.items() if (f.name | default('')) == farm_name %}
            {{ fid }}
            {% endfor %}
      - service: script.registry_open_edit_farm
        data:
          id: "{{ farm_id | trim }}"

  # Refresh farm dropdown when switching to edit mode
  - id: registry_refresh_farm_dropdown_on_mode_change
    alias: "Registry - Refresh Farm Dropdown on Mode Change"
    trigger:
      - platform: state
        entity_id: input_select.registry_farm_editor_mode
        to: "Edit Existing Farm"
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_farm
        data:
          options: >-
            {% set farms = state_attr('sensor.farm_registry_data', 'farm_names') or [] %}
            {{ ['Select...'] + (farms | list) if farms else ['Select...'] }}
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_farm
        data:
          option: "Select..."

  # Load season edit form when season is selected
  - id: registry_load_season_on_select
    alias: "Registry - Load Season on Select"
    trigger:
      - platform: state
        entity_id: input_select.registry_season
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select...' }}"
    action:
      - variables:
          season_name: "{{ states('input_select.registry_season') }}"
          seasons: "{{ state_attr('sensor.farm_registry_data', 'seasons') or {} }}"
      - variables:
          season_id: >-
            {% for sid, s in seasons.items() if (s.name | default('')) == season_name %}
            {{ sid }}
            {% endfor %}
      - service: script.registry_open_edit_season
        data:
          id: "{{ season_id | trim }}"

  # Refresh season dropdown when switching to edit mode
  - id: registry_refresh_season_dropdown_on_mode_change
    alias: "Registry - Refresh Season Dropdown on Mode Change"
    trigger:
      - platform: state
        entity_id: input_select.registry_season_editor_mode
        to: "Edit Existing Season"
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.farm_registry_data
      - delay:
          milliseconds: 500
      - service: input_select.set_options
        target:
          entity_id: input_select.registry_season
        data:
          options: >-
            {% set seasons = state_attr('sensor.farm_registry_data', 'season_names') or [] %}
            {{ ['Select...'] + seasons if seasons else ['Select...'] }}
      - service: input_select.select_option
        target:
          entity_id: input_select.registry_season
        data:
          option: "Select..."

  # -----------------------------------------------------------------------------
  # RTR (Real Time Rice) AUTOMATION
  # -----------------------------------------------------------------------------
  # Daily refresh of RTR prediction data at 6am (RTR server updates at 3am)
  - id: paddisense_rtr_daily_refresh
    alias: "RTR - Daily Data Refresh"
    description: "Automatically refresh Real Time Rice data each morning at 6am"
    trigger:
      - platform: time
        at: "06:00:00"
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.paddisense_real_time_rice', 'rtr_url_set') == true }}"
    action:
      - service: paddisense.refresh_rtr_data
      - service: system_log.write
        data:
          message: "RTR daily refresh completed at 6am"
          level: info
