##############################################################################
# PaddiSense Manager Dashboard
# Comprehensive management interface for PaddiSense Farm Management System
#
# Views:
#   1. Farms - Business & Farm management, Excel import
#   2. Paddocks - Add/edit paddocks
#   3. Seasons - Manage growing seasons
#   4. Crops - Crop types and rotation
#   5. Modules - Install/remove modules, version & update status
#   6. Settings - Backup, restore, HACS dependencies, advanced options
##############################################################################

title: PaddiSense Manager

button_card_templates:
  #---------------------------------------------------------------------------
  # Section title bar (yellow like HFM)
  #---------------------------------------------------------------------------
  template_titleblock:
    variables:
      var_name: Name
    color_type: card
    color: "#E9E100"
    show_icon: false
    show_state: false
    name: '[[[ return variables.var_name ]]]'
    tap_action:
      action: none
    hold_action:
      action: none
    styles:
      card:
        - height: 50px
        - border-radius: 12px
        - padding: 8px
        - background-color: "#E9E100"
      name:
        - font-size: 18px
        - font-weight: 700
        - text-align: center
        - color: black

  #---------------------------------------------------------------------------
  # Action button (primary blue) - 70px min height
  #---------------------------------------------------------------------------
  template_action:
    color_type: card
    color: "#0066cc"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Secondary action button (muted) - 70px min height
  #---------------------------------------------------------------------------
  template_secondary:
    color_type: card
    color: "#555555"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Success button (green) - 70px min height
  #---------------------------------------------------------------------------
  template_success:
    color_type: card
    color: "#28a745"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Danger button (red) - 70px min height
  #---------------------------------------------------------------------------
  template_danger:
    color_type: card
    color: "#dc3545"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Warning button (orange)
  #---------------------------------------------------------------------------
  template_warning:
    color_type: card
    color: "#fd7e14"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 16px
        - font-weight: 700
        - color: white
      icon:
        - color: white
        - width: 28px

  #---------------------------------------------------------------------------
  # Info card (for status display)
  #---------------------------------------------------------------------------
  template_info:
    color_type: card
    color: "#17a2b8"
    show_icon: true
    show_name: true
    show_state: false
    styles:
      card:
        - height: 80px
        - border-radius: 12px
      name:
        - font-size: 14px
        - font-weight: 600
        - color: white
      icon:
        - color: white
        - width: 32px

  #---------------------------------------------------------------------------
  # Module info card (left side) - shows icon, name, description
  #---------------------------------------------------------------------------
  pds_module_info:
    entity: sensor.paddisense_version
    triggers_update:
      - sensor.paddisense_version
    show_state: false
    show_icon: false
    show_name: false
    show_label: false
    tap_action:
      action: none
    card_mod:
      style: |
        ha-card {
          justify-content: flex-start !important;
        }
        #container {
          justify-content: flex-start !important;
        }
    custom_fields:
      content: |
        [[[
          const modId = variables.module_id;
          const attrs = entity?.attributes || {};
          const installedList = attrs.installed_modules || [];
          const installedData = installedList.find(m => m.id === modId);
          const version = installedData?.version || '';

          const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
          const available = (attrs.available_modules || []).some(m => m.id === modId);
          const installed = !!installedData;

          const base = variables.desc || '';
          let statusText = '';
          if (installed) statusText = version ? ` • v${version}` : '';
          else if (!licensed) statusText = ' • Not licensed';
          else if (available) statusText = ' • Available';
          else statusText = ' • Unavailable';

          const icon = variables.icon || 'mdi:puzzle';
          const color = variables.color || '#0066cc';
          const title = variables.title || modId;

          return `
            <div style="display:flex;align-items:center;gap:12px;width:100%;margin-right:auto;justify-content:flex-start;">
              <ha-icon icon="${icon}" style="--mdc-icon-size:28px;color:${color};flex-shrink:0;"></ha-icon>
              <div style="text-align:left;">
                <div style="font-size:15px;font-weight:700;color:var(--primary-text-color);">${title}</div>
                <div style="font-size:12px;color:var(--secondary-text-color);">${base}${statusText}</div>
              </div>
            </div>
          `;
        ]]]
    styles:
      card:
        - border-radius: 12px 0 0 12px
        - padding: 12px 16px
        - background: var(--card-background-color)
        - box-shadow: 0 1px 3px rgba(0,0,0,0.08)
        - border-left: |
            [[[
              return `4px solid ${variables.color || '#0066cc'}`;
            ]]]
        - opacity: |
            [[[
              const modId = variables.module_id;
              const attrs = entity?.attributes || {};
              const installed = (attrs.installed_modules || []).some(m => m.id === modId);
              const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
              const available = (attrs.available_modules || []).some(m => m.id === modId);
              return (installed || (licensed && available)) ? '1' : '0.75';
            ]]]
        - display: |
            [[[
              return (entity && entity.state && entity.state !== 'unavailable' && entity.state !== 'unknown') ? 'grid' : 'none';
            ]]]
        - height: 70px
        - box-sizing: border-box
      grid:
        - grid-template-columns: 1fr
        - grid-template-rows: 1fr
        - justify-items: start
        - align-items: center
      custom_fields:
        content:
          - justify-self: start
          - text-align: left

  #---------------------------------------------------------------------------
  # Module button card (right side) - shows install/remove button
  #---------------------------------------------------------------------------
  pds_module_button:
    entity: sensor.paddisense_version
    triggers_update:
      - sensor.paddisense_version
    show_state: false
    show_icon: true
    show_name: true
    icon: |
      [[[
        const modId = variables.module_id;
        const attrs = entity?.attributes || {};
        const installed = (attrs.installed_modules || []).some(m => m.id === modId);
        const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
        const available = (attrs.available_modules || []).some(m => m.id === modId);

        if (installed) return 'mdi:trash-can-outline';
        if (licensed && available) return 'mdi:download';
        if (!licensed) return 'mdi:lock-outline';
        return 'mdi:minus-circle-outline';
      ]]]
    name: |
      [[[
        const modId = variables.module_id;
        const attrs = entity?.attributes || {};
        const installed = (attrs.installed_modules || []).some(m => m.id === modId);
        const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
        const available = (attrs.available_modules || []).some(m => m.id === modId);

        if (installed) return 'Remove';
        if (licensed && available) return 'Install';
        if (!licensed) return 'Add License';
        return 'N/A';
      ]]]
    tap_action:
      action: call-service
      service: |
        [[[
          const modId = variables.module_id;
          const attrs = entity?.attributes || {};
          const installed = (attrs.installed_modules || []).some(m => m.id === modId);
          const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
          const available = (attrs.available_modules || []).some(m => m.id === modId);

          if (installed) return 'paddisense.remove_module';
          if (licensed && available) return 'paddisense.install_module';
          if (!licensed) return 'script.paddisense_open_license_popup';
          return 'script.turn_on';
        ]]]
      service_data: |
        [[[
          return { module_id: variables.module_id };
        ]]]
    confirmation:
      text: |
        [[[
          const modId = variables.module_id;
          const attrs = entity?.attributes || {};
          const installed = (attrs.installed_modules || []).some(m => m.id === modId);
          const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
          // No confirmation for license entry - popup handles it
          if (!licensed) return null;
          return installed
            ? `Remove module: ${variables.title || modId}?`
            : `Install module: ${variables.title || modId}?`;
        ]]]
    styles:
      card:
        - border-radius: 0 12px 12px 0
        - padding: 12px 16px
        - box-shadow: 0 1px 3px rgba(0,0,0,0.08)
        - height: 70px
        - width: 110px
        - box-sizing: border-box
        - background: |
            [[[
              const modId = variables.module_id;
              const attrs = entity?.attributes || {};
              const installed = (attrs.installed_modules || []).some(m => m.id === modId);
              const licensed = (attrs.licensed_modules || attrs.license_modules || []).includes(modId);
              const available = (attrs.available_modules || []).some(m => m.id === modId);

              if (installed) return '#dc3545';
              if (licensed && available) return '#28a745';
              // Locked modules get orange "Add License" button
              return '#fd7e14';
            ]]]
        - opacity: '1'
        - display: |
            [[[
              return (entity && entity.state && entity.state !== 'unavailable' && entity.state !== 'unknown') ? 'grid' : 'none';
            ]]]
      name:
        - font-size: 13px
        - font-weight: 700
        - color: white
      icon:
        - width: 22px
        - color: white

views:
  # ===========================================================================
  # View 1: Farm Management
  # ===========================================================================
  - title: Farms
    path: farms
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              #----------------------------------------------------------------
              # QUICK ACTIONS
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_action
                name: Import from Excel/CSV
                icon: mdi:file-excel
                tap_action:
                  action: navigate
                  navigation_path: /paddisense-manager/settings
                styles:
                  card:
                    - height: 70px
                    - background: "linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%)"

              #----------------------------------------------------------------
              # BUSINESS MANAGEMENT SECTION
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: BUSINESS MANAGEMENT

              # Business editor mode selector
              - type: entities
                entities:
                  - entity: input_select.registry_business_editor_mode
                    name: Mode
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                    }

              # Edit Existing Business (conditional)
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_business_editor_mode
                    state: "Edit Existing Business"
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        **Step 1:** Select the business to edit below.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(0, 102, 204, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_select.registry_business
                          name: Select Business
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 4px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.3rem !important;
                          }

                    - type: markdown
                      content: |
                        **Step 2:** Edit the business name below.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(40, 167, 69, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_text.registry_edit_business_name
                          name: Business Name
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Save Changes
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.registry_save_business_edit
                          hold_action:
                            action: none
                          confirmation:
                            text: Save business changes?

                        - type: custom:button-card
                          template: template_danger
                          name: Delete
                          icon: mdi:delete
                          tap_action:
                            action: call-service
                            service: script.registry_delete_business
                            service_data:
                              id: "[[[ return states['input_text.registry_edit_business_pointer'].state; ]]]"
                          hold_action:
                            action: none
                          confirmation:
                            text: Delete this business? Businesses with farms cannot be deleted.

              # Add New Business (conditional)
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_business_editor_mode
                    state: "Add New Business"
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        **Enter the business name** and tap "Add Business" to create.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(40, 167, 69, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_text.registry_new_business_name
                          name: Business Name
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: custom:button-card
                      entity: input_text.registry_new_business_name
                      name: Add Business
                      icon: mdi:domain
                      color_type: card
                      color: "#28a745"
                      tap_action:
                        action: call-service
                        service: script.registry_add_business
                        service_data:
                          name: "[[[ return states['input_text.registry_new_business_name'].state; ]]]"
                        confirmation:
                          text: |
                            [[[
                              const name = states['input_text.registry_new_business_name'].state || '';
                              if (!name || name.trim() === '') {
                                return 'Please enter a business name first.';
                              }
                              return `Add new business: ${name}?`;
                            ]]]
                      styles:
                        card:
                          - height: 70px
                          - border-radius: 12px
                        name:
                          - font-size: 16px
                          - font-weight: 700
                          - color: white
                        icon:
                          - color: white
                          - width: 24px

              #----------------------------------------------------------------
              # FARM MANAGEMENT SECTION
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: FARM MANAGEMENT

              # Farm editor mode selector (above filter)
              - type: entities
                entities:
                  - entity: input_select.registry_farm_editor_mode
                    name: Mode
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                    }

              # Business filter for farms
              - type: entities
                entities:
                  - entity: input_select.registry_farm_business_filter
                    name: Filter by Business
                card_mod:
                  style: |
                    ha-card { border-radius: 12px; }

              #----------------------------------------------------------------
              # Edit Existing Farm (conditional)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_farm_editor_mode
                    state: "Edit Existing Farm"
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        **Step 1:** Use "Filter by Business" above to narrow the list (optional).
                        **Step 2:** Select the farm below.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(0, 102, 204, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_select.registry_farm
                          name: Select Farm
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 4px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.3rem !important;
                          }

                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: EDIT FARM DETAILS

                    - type: markdown
                      content: |
                        **Edit Name:** Change the farm name below.
                        **Assign Business:** Select which business owns this farm.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(40, 167, 69, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_text.registry_edit_farm_name
                          name: Farm Name
                        - entity: input_select.registry_new_farm_business
                          name: Assign to Business
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Save Changes
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.registry_save_farm_edit
                          hold_action:
                            action: none
                          confirmation:
                            text: Save farm changes?

                        - type: custom:button-card
                          template: template_danger
                          name: Delete
                          icon: mdi:delete
                          tap_action:
                            action: call-service
                            service: script.registry_delete_farm
                            service_data:
                              id: "[[[ return states['input_text.registry_edit_farm_pointer'].state; ]]]"
                          hold_action:
                            action: none
                          confirmation:
                            text: Delete this farm? Farms with paddocks cannot be deleted.

              #----------------------------------------------------------------
              # Add New Farm (conditional)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_farm_editor_mode
                    state: "Add New Farm"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: NEW FARM DETAILS

                    - type: markdown
                      content: |
                        **Enter the farm name** and optionally assign to a business.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: rgba(40, 167, 69, 0.1);
                          }

                    - type: entities
                      entities:
                        - entity: input_text.registry_new_farm_name
                          name: Farm Name
                        - entity: input_select.registry_new_farm_business
                          name: Assign to Business
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: custom:button-card
                      entity: input_text.registry_new_farm_name
                      name: Add Farm
                      icon: mdi:barn
                      color_type: card
                      color: "#28a745"
                      tap_action:
                        action: call-service
                        service: script.registry_add_farm
                        service_data:
                          name: "[[[ return states['input_text.registry_new_farm_name'].state; ]]]"
                          business: |
                            [[[
                              const businessName = states['input_select.registry_new_farm_business']?.state || 'None';
                              if (businessName === 'None') return '';
                              const businesses = hass.states['sensor.farm_registry_data']?.attributes?.businesses || {};
                              for (const [bid, b] of Object.entries(businesses)) {
                                if (b.name === businessName) return bid;
                              }
                              return '';
                            ]]]
                        confirmation:
                          text: |
                            [[[
                              const name = states['input_text.registry_new_farm_name'].state || '';
                              if (!name || name.trim() === '') {
                                return 'Please enter a farm name first.';
                              }
                              return `Add new farm: ${name}?`;
                            ]]]
                      styles:
                        card:
                          - height: 70px
                          - border-radius: 12px
                        name:
                          - font-size: 16px
                          - font-weight: 700
                          - color: white
                        icon:
                          - color: white
                          - width: 24px

              #----------------------------------------------------------------
              # Farm Cards Display
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: REGISTERED FARMS

              - type: custom:button-card
                entity: sensor.farm_registry_data
                triggers_update:
                  - sensor.farm_registry_data
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                    - padding: 0
                    - margin: 0
                  grid:
                    - display: block
                custom_fields:
                  farms: |
                    [[[
                      try {
                        if (!entity || !entity.attributes) {
                          return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">Loading...</div>`;
                        }

                        const farms = entity.attributes.farms || {};
                        const businesses = entity.attributes.businesses || {};
                        const paddocks = entity.attributes.paddocks || {};
                        const farmList = Object.entries(farms);

                        if (farmList.length === 0) {
                          return `<div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                                    <ha-icon icon="mdi:barn" style="--mdc-icon-size:48px;margin-bottom:12px;opacity:0.5;"></ha-icon>
                                    <div style="font-size:16px;">No farms defined</div>
                                    <div style="font-size:14px;margin-top:8px;">Add one using the form above</div>
                                  </div>`;
                        }

                        let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:4px;">`;

                        for (const [fid, farm] of farmList) {
                          const name = farm.name || fid;
                          const businessId = farm.business_id || '';
                          const business = businesses[businessId] || {};
                          const businessName = business.name || '';
                          const farmPaddocks = Object.values(paddocks).filter(p => p.farm_id === fid);
                          const paddockNames = farmPaddocks.map(p => p.name || 'Unnamed').sort();

                          html += `
                            <div style="background:var(--card-background-color);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-left:4px solid #8d6e63;">
                              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <div style="width:50px;height:50px;border-radius:50%;background:rgba(141,110,99,0.15);display:flex;align-items:center;justify-content:center;">
                                  <ha-icon icon="mdi:barn" style="--mdc-icon-size:28px;color:#8d6e63;"></ha-icon>
                                </div>
                                <div style="flex:1;min-width:0;">
                                  <div style="font-size:18px;font-weight:700;color:var(--primary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                                  ${businessName ? `<div style="font-size:13px;color:var(--secondary-text-color);display:flex;align-items:center;gap:4px;margin-top:2px;"><ha-icon icon="mdi:domain" style="--mdc-icon-size:14px;"></ha-icon>${businessName}</div>` : ''}
                                </div>
                              </div>
                              <div style="padding-top:12px;border-top:1px solid var(--divider-color,#e0e0e0);">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                  <ha-icon icon="mdi:view-grid" style="--mdc-icon-size:18px;color:var(--secondary-text-color);"></ha-icon>
                                  <span style="font-size:13px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;">Paddocks (${paddockNames.length})</span>
                                </div>
                                <div style="font-size:14px;color:var(--primary-text-color);line-height:1.5;">
                                  ${paddockNames.length > 0 ? paddockNames.join(', ') : '<span style="color:var(--secondary-text-color);font-style:italic;">No paddocks assigned</span>'}
                                </div>
                              </div>
                            </div>`;
                        }

                        html += `</div>`;
                        return html;
                      } catch (e) {
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                      }
                    ]]]

  # ===========================================================================
  # View 2: Paddock Management
  # ===========================================================================
  - title: Paddocks
    path: paddocks
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: PADDOCK MANAGEMENT

              # Farm filter dropdown
              - type: entities
                entities:
                  - entity: input_select.registry_paddock_farm_filter
                    name: Filter by Farm
                card_mod:
                  style: |
                    ha-card { border-radius: 12px; }

              # Paddock selector dropdown
              - type: entities
                entities:
                  - entity: input_select.registry_paddock
                    name: Select Paddock to View/Edit
                card_mod:
                  style: |
                    ha-card { border-radius: 12px; }

              #----------------------------------------------------------------
              # PADDOCK DETAILS CARD (shown when paddock selected)
              #----------------------------------------------------------------
              - type: custom:button-card
                entity: sensor.farm_registry_data
                triggers_update:
                  - sensor.farm_registry_data
                  - input_text.registry_edit_paddock_pointer
                  - input_select.registry_paddock_editor_mode
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 16px
                    - padding: 0
                    - box-shadow: 0 4px 12px rgba(0,0,0,0.15)
                    - display: |
                        [[[
                          const paddockId = states['input_text.registry_edit_paddock_pointer']?.state || '';
                          return paddockId ? 'block' : 'none';
                        ]]]
                  grid:
                    - display: block
                custom_fields:
                  content: |
                    [[[
                      try {
                        const paddockId = states['input_text.registry_edit_paddock_pointer']?.state || '';
                        if (!paddockId) return '';

                        const paddocks = entity?.attributes?.paddocks || {};
                        const farms = entity?.attributes?.farms || {};
                        const crops = entity?.attributes?.crops || {};
                        const currentCrops = entity?.attributes?.current_crops || {};
                        const seasons = entity?.attributes?.seasons || {};
                        const activeSeason = entity?.attributes?.active_season_name || 'None';
                        const paddock = paddocks[paddockId] || {};
                        const currentCrop = currentCrops[paddockId] || null;

                        const name = paddock.name || paddockId;
                        const farmId = paddock.farm_id || '';
                        const farm = farms[farmId] || {};
                        const farmName = farm.name || 'Unassigned';
                        const bayCount = paddock.bay_count || 0;
                        const isActive = paddock.current_season === true;
                        const brownArea = paddock.brown_area_ha || null;
                        const greenArea = paddock.green_area_ha || null;
                        const brownDisplay = brownArea ? brownArea.toFixed(1) : '--';
                        const greenDisplay = greenArea ? greenArea.toFixed(1) : '--';

                        // Crop info - default green (#43a047) when no crop assigned
                        const cropName = (currentCrop && currentCrop.crop_name) ? currentCrop.crop_name : '';
                        const cropColor = (currentCrop && currentCrop.crop_color) ? currentCrop.crop_color : '#43a047';
                        const crop1 = paddock.crop_1 || {};
                        const crop2 = paddock.crop_2 || {};
                        const crop1Data = (crop1.crop_id && crops[crop1.crop_id]) ? crops[crop1.crop_id] : null;
                        const crop2Data = (crop2.crop_id && crops[crop2.crop_id]) ? crops[crop2.crop_id] : null;
                        const crop1Name = crop1Data ? (crop1Data.name || '') : '';
                        const crop2Name = crop2Data ? (crop2Data.name || '') : '';
                        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

                        const statusColor = isActive ? '#4caf50' : '#9e9e9e';
                        const statusBg = isActive ? 'rgba(76,175,80,0.15)' : 'rgba(158,158,158,0.15)';
                        const statusText = isActive ? 'ACTIVE' : 'INACTIVE';

                        let html = `
                          <div style="border-left:5px solid ${cropName ? cropColor : '#43a047'};">
                            <!-- Header -->
                            <div style="padding:20px 20px 16px;background:linear-gradient(135deg,${cropName ? cropColor+'15' : 'rgba(67,160,71,0.08)'} 0%,transparent 100%);">
                              <div style="display:flex;align-items:flex-start;gap:16px;">
                                <div style="width:64px;height:64px;border-radius:16px;background:${cropName ? cropColor+'22' : 'rgba(67,160,71,0.15)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                  <ha-icon icon="${cropName ? 'mdi:sprout' : 'mdi:view-grid'}" style="--mdc-icon-size:36px;color:${cropName ? cropColor : '#43a047'};"></ha-icon>
                                </div>
                                <div style="flex:1;min-width:0;">
                                  <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);margin-bottom:4px;">${name}</div>
                                  <div style="font-size:14px;color:var(--secondary-text-color);margin-bottom:8px;">${farmName}</div>
                                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                    ${cropName ? `<div style="padding:4px 12px;border-radius:12px;background:${cropColor}22;color:${cropColor};font-size:12px;font-weight:700;">${cropName}</div>` : ''}
                                    <div style="padding:4px 12px;border-radius:12px;background:${statusBg};color:${statusColor};font-size:12px;font-weight:700;">${statusText}</div>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Stats Row -->
                            <div style="display:flex;padding:16px 20px;border-top:1px solid var(--divider-color,#e0e0e0);border-bottom:1px solid var(--divider-color,#e0e0e0);">
                              <div style="flex:1;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:var(--primary-text-color);">${bayCount}</div>
                                <div style="font-size:12px;color:var(--secondary-text-color);">Bays</div>
                              </div>
                              <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                              <div style="flex:1;text-align:center;">
                                <div style="font-size:18px;font-weight:600;color:#8B4513;">${brownDisplay}</div>
                                <div style="font-size:12px;color:var(--secondary-text-color);">Brown ha</div>
                              </div>
                              <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                              <div style="flex:1;text-align:center;">
                                <div style="font-size:18px;font-weight:600;color:#228B22;">${greenDisplay}</div>
                                <div style="font-size:12px;color:var(--secondary-text-color);">Green ha</div>
                              </div>
                              <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                              <div style="flex:1;text-align:center;">
                                <div style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${activeSeason}</div>
                                <div style="font-size:12px;color:var(--secondary-text-color);">Season</div>
                              </div>
                            </div>

                            <!-- Crop Rotation Section -->
                            <div style="padding:16px 20px;">
                              <div style="font-size:13px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:12px;">Crop Rotation</div>
                        `;

                        if (crop1Name || crop2Name) {
                          if (crop1Name && crop1Data) {
                            const c1Color = crop1Data.color || '#43a047';
                            html += `
                              <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--secondary-background-color);border-radius:10px;margin-bottom:8px;">
                                <div style="width:12px;height:12px;border-radius:3px;background:${c1Color};"></div>
                                <div style="flex:1;font-weight:500;">${crop1Name}</div>
                                <div style="font-size:13px;color:var(--secondary-text-color);">${months[(crop1.start_month||1)-1]} – ${months[(crop1.end_month||12)-1]}</div>
                              </div>`;
                          }
                          if (crop2Name && crop2Data) {
                            const c2Color = crop2Data.color || '#43a047';
                            html += `
                              <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--secondary-background-color);border-radius:10px;">
                                <div style="width:12px;height:12px;border-radius:3px;background:${c2Color};"></div>
                                <div style="flex:1;font-weight:500;">${crop2Name}</div>
                                <div style="font-size:13px;color:var(--secondary-text-color);">${months[(crop2.start_month||1)-1]} – ${months[(crop2.end_month||12)-1]}</div>
                              </div>`;
                          }
                        } else {
                          html += `<div style="padding:12px;text-align:center;color:var(--secondary-text-color);font-style:italic;">No crop rotation configured</div>`;
                        }

                        html += `
                            </div>
                          </div>`;
                        return html;
                      } catch (e) {
                        return `<div style="padding:20px;color:var(--error-color);">Error: ${e}</div>`;
                      }
                    ]]]

              #----------------------------------------------------------------
              # ACTION BUTTONS ROW (Edit / Add / Delete)
              #----------------------------------------------------------------
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_action
                    name: Edit
                    icon: mdi:pencil
                    tap_action:
                      action: call-service
                      service: script.registry_paddock_start_edit

                  - type: custom:button-card
                    template: template_success
                    name: Add
                    icon: mdi:plus
                    tap_action:
                      action: call-service
                      service: script.registry_paddock_start_add

                  - type: custom:button-card
                    template: template_danger
                    name: Delete
                    icon: mdi:delete
                    tap_action:
                      action: call-service
                      service: script.registry_paddock_delete
                    confirmation:
                      text: "Delete this paddock and all its bays?"

              #----------------------------------------------------------------
              # EDIT FORM (conditional - shown when mode is Edit)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_paddock_editor_mode
                    state: "Edit"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: EDIT PADDOCK

                    - type: entities
                      entities:
                        - entity: input_text.registry_edit_paddock_name
                          name: Paddock Name
                        - entity: input_number.registry_edit_paddock_bay_count
                          name: Number of Bays
                        - entity: input_number.registry_edit_paddock_brown_area
                          name: Brown Area (ha)
                        - entity: input_number.registry_edit_paddock_green_area
                          name: Green Area (ha)
                        - entity: input_boolean.registry_edit_current_season
                          name: Active This Season
                      card_mod:
                        style: |
                          ha-card { border-radius: 12px; }

                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: "CROP 1 (From Season Start)"

                    - type: entities
                      entities:
                        - entity: input_select.registry_paddock_crop_1
                          name: "Crop Type"
                        - entity: input_select.registry_crop_1_end_month
                          name: "Ends In"
                      card_mod:
                        style: |
                          ha-card { border-radius: 12px; }

                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: "CROP 2 (To Season End)"

                    - type: entities
                      entities:
                        - entity: input_select.registry_paddock_crop_2
                          name: "Crop Type"
                      card_mod:
                        style: |
                          ha-card { border-radius: 12px; }

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Save
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.registry_save_paddock_all

                        - type: custom:button-card
                          template: template_secondary
                          name: Cancel
                          icon: mdi:close
                          tap_action:
                            action: call-service
                            service: script.registry_paddock_clear_form

              #----------------------------------------------------------------
              # ADD NEW FORM (conditional - shown when mode is Add New)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_paddock_editor_mode
                    state: "Add New"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: ADD NEW PADDOCK

                    - type: entities
                      entities:
                        - entity: input_text.registry_new_paddock_name
                          name: Paddock Name
                        - entity: input_number.registry_new_paddock_bay_count
                          name: Number of Bays
                        - entity: input_number.registry_new_paddock_brown_area
                          name: Brown Area (ha)
                        - entity: input_number.registry_new_paddock_green_area
                          name: Green Area (ha)
                        - entity: input_select.registry_new_paddock_farm
                          name: Assign to Farm
                      card_mod:
                        style: |
                          ha-card { border-radius: 12px; }

                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Save
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.registry_add_paddock_from_form
                          confirmation:
                            text: Add this new paddock?

                        - type: custom:button-card
                          template: template_secondary
                          name: Cancel
                          icon: mdi:close
                          tap_action:
                            action: call-service
                            service: script.registry_paddock_clear_form

              #----------------------------------------------------------------
              # Paddock Cards Display
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: PADDOCK LIST

              - type: custom:button-card
                entity: sensor.farm_registry_data
                triggers_update:
                  - sensor.farm_registry_data
                  - input_select.registry_paddock_editor_mode
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                    - padding: 0
                    - margin: 0
                  grid:
                    - display: block
                custom_fields:
                  paddocks: |
                    [[[
                      try {
                        if (!entity || !entity.attributes) {
                          return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">Loading...</div>`;
                        }

                        const paddocks = entity.attributes.paddocks || {};
                        const farms = entity.attributes.farms || {};
                        const crops = entity.attributes.crops || {};
                        const currentCrops = entity.attributes.current_crops || {};
                        const activeSeason = entity.attributes.active_season_name || '';
                        const paddockList = Object.entries(paddocks);

                        // Default color when no crop assigned
                        const DEFAULT_COLOR = '#43a047';

                        // Helper to convert hex to rgba
                        const hexToRgba = (hex, alpha) => {
                          const fallback = `rgba(67, 160, 71, ${alpha})`;
                          if (!hex || typeof hex !== 'string') return fallback;
                          const cleanHex = hex.replace('#', '');
                          if (cleanHex.length !== 6) return fallback;
                          const r = parseInt(cleanHex.substring(0, 2), 16);
                          const g = parseInt(cleanHex.substring(2, 4), 16);
                          const b = parseInt(cleanHex.substring(4, 6), 16);
                          if (isNaN(r) || isNaN(g) || isNaN(b)) return fallback;
                          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                        };

                        // Helper to ensure valid hex color
                        const safeColor = (color) => {
                          if (!color || typeof color !== 'string') return DEFAULT_COLOR;
                          if (!color.startsWith('#') || color.length !== 7) return DEFAULT_COLOR;
                          return color;
                        };

                        if (paddockList.length === 0) {
                          return `<div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                                    <ha-icon icon="mdi:view-grid" style="--mdc-icon-size:48px;margin-bottom:12px;opacity:0.5;"></ha-icon>
                                    <div style="font-size:16px;">No paddocks configured</div>
                                    <div style="font-size:14px;margin-top:8px;">Click "Add" to create one</div>
                                  </div>`;
                        }

                        let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;padding:4px;">`;

                        for (const [pid, paddock] of paddockList) {
                          const name = paddock.name || pid;
                          const bayCount = paddock.bay_count || 0;
                          const isActive = paddock.current_season === true;
                          const farmId = paddock.farm_id || '';
                          const farm = farms[farmId] || {};
                          const farmName = farm.name || 'Unassigned';
                          const brownArea = paddock.brown_area_ha || null;
                          const greenArea = paddock.green_area_ha || null;
                          const brownDisplay = brownArea ? brownArea.toFixed(1) : '--';
                          const greenDisplay = greenArea ? greenArea.toFixed(1) : '--';

                          // Current crop - default green when no crop assigned
                          const currentCrop = currentCrops ? currentCrops[pid] : null;
                          const cropName = (currentCrop && currentCrop.crop_name) ? currentCrop.crop_name : '';
                          const cropColor = safeColor((currentCrop && currentCrop.crop_color) ? currentCrop.crop_color : DEFAULT_COLOR);

                          // Crop rotation
                          const crop1 = paddock.crop_1 || {};
                          const crop2 = paddock.crop_2 || {};
                          const crop1Data = (crop1.crop_id && crops && crops[crop1.crop_id]) ? crops[crop1.crop_id] : null;
                          const crop2Data = (crop2.crop_id && crops && crops[crop2.crop_id]) ? crops[crop2.crop_id] : null;
                          const crop1Name = crop1Data ? (crop1Data.name || '') : '';
                          const crop2Name = crop2Data ? (crop2Data.name || '') : '';
                          const crop1Color = safeColor(crop1Data ? crop1Data.color : null);
                          const crop2Color = safeColor(crop2Data ? crop2Data.color : null);
                          const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

                          const statusColor = isActive ? '#4caf50' : '#9e9e9e';
                          const statusBg = isActive ? 'rgba(76,175,80,0.15)' : 'rgba(158,158,158,0.15)';
                          const statusText = isActive ? 'ACTIVE' : 'INACTIVE';

                          // Build crop rotation HTML
                          let rotationHtml = '';
                          if (crop1Name || crop2Name) {
                            if (crop1Name) {
                              rotationHtml += `
                                <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--secondary-background-color);border-radius:8px;margin-bottom:6px;">
                                  <div style="width:10px;height:10px;border-radius:3px;background:${crop1Color};flex-shrink:0;"></div>
                                  <div style="flex:1;font-size:13px;font-weight:500;">${crop1Name}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">${months[(crop1.start_month||1)-1]} – ${months[(crop1.end_month||12)-1]}</div>
                                </div>`;
                            }
                            if (crop2Name) {
                              rotationHtml += `
                                <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--secondary-background-color);border-radius:8px;">
                                  <div style="width:10px;height:10px;border-radius:3px;background:${crop2Color};flex-shrink:0;"></div>
                                  <div style="flex:1;font-size:13px;font-weight:500;">${crop2Name}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">${months[(crop2.start_month||1)-1]} – ${months[(crop2.end_month||12)-1]}</div>
                                </div>`;
                            }
                          } else {
                            rotationHtml = `<div style="padding:8px;text-align:center;color:var(--secondary-text-color);font-size:12px;font-style:italic;">No rotation configured</div>`;
                          }

                          html += `
                            <div style="background:var(--card-background-color);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:5px solid ${cropColor};overflow:hidden;">
                              <!-- Header -->
                              <div style="padding:16px 16px 12px;background:${hexToRgba(cropColor, 0.08)};">
                                <div style="display:flex;align-items:flex-start;gap:14px;">
                                  <div style="width:56px;height:56px;border-radius:14px;background:${hexToRgba(cropColor, 0.15)};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                    <ha-icon icon="${cropName ? 'mdi:sprout' : 'mdi:view-grid'}" style="--mdc-icon-size:30px;color:${cropColor};"></ha-icon>
                                  </div>
                                  <div style="flex:1;min-width:0;">
                                    <div style="font-size:20px;font-weight:700;color:var(--primary-text-color);margin-bottom:2px;">${name}</div>
                                    <div style="font-size:13px;color:var(--secondary-text-color);margin-bottom:6px;">${farmName}</div>
                                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                                      ${cropName ? `<div style="padding:3px 10px;border-radius:10px;background:${hexToRgba(cropColor, 0.15)};color:${cropColor};font-size:11px;font-weight:700;">${cropName}</div>` : ''}
                                      <div style="padding:3px 10px;border-radius:10px;background:${statusBg};color:${statusColor};font-size:11px;font-weight:700;">${statusText}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Stats Row -->
                              <div style="display:flex;padding:14px 16px;border-top:1px solid var(--divider-color,#e0e0e0);border-bottom:1px solid var(--divider-color,#e0e0e0);">
                                <div style="flex:1;text-align:center;">
                                  <div style="font-size:24px;font-weight:700;color:var(--primary-text-color);">${bayCount}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">Bays</div>
                                </div>
                                <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                                <div style="flex:1;text-align:center;">
                                  <div style="font-size:16px;font-weight:600;color:#8B4513;">${brownDisplay}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">Brown</div>
                                </div>
                                <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                                <div style="flex:1;text-align:center;">
                                  <div style="font-size:16px;font-weight:600;color:#228B22;">${greenDisplay}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">Green</div>
                                </div>
                                <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                                <div style="flex:1;text-align:center;">
                                  <div style="font-size:13px;font-weight:600;color:var(--primary-text-color);">${activeSeason || '--'}</div>
                                  <div style="font-size:11px;color:var(--secondary-text-color);">Season</div>
                                </div>
                              </div>

                              <!-- Crop Rotation Section -->
                              <div style="padding:12px 16px;">
                                <div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:8px;">Crop Rotation</div>
                                ${rotationHtml}
                              </div>
                            </div>`;
                        }

                        html += `</div>`;
                        return html;
                      } catch (e) {
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                      }
                    ]]]

  # ===========================================================================
  # View 3: Season Management
  # ===========================================================================
  - title: Seasons
    path: seasons
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: SEASON MANAGEMENT

              # Current active season display - styled card
              - type: custom:button-card
                entity: sensor.farm_registry_active_season
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                  grid:
                    - display: block
                custom_fields:
                  content: |
                    [[[
                      const seasonName = entity.state || 'None';
                      const seasonId = entity.attributes.season_id || '';
                      const hasActive = seasonName && seasonName !== 'None' && seasonName !== 'unknown';

                      const iconBg = hasActive ? 'rgba(123,31,162,0.15)' : 'rgba(158,158,158,0.15)';
                      const iconColor = hasActive ? '#7b1fa2' : '#9e9e9e';
                      const statusBg = hasActive ? 'rgba(76,175,80,0.15)' : 'rgba(253,126,20,0.15)';
                      const statusColor = hasActive ? '#4caf50' : '#fd7e14';
                      const statusText = hasActive ? 'ACTIVE' : 'NOT SET';

                      return `
                        <div style="display:flex;align-items:center;gap:14px;">
                          <div style="width:56px;height:56px;border-radius:50%;background:${iconBg};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <ha-icon icon="mdi:calendar-star" style="--mdc-icon-size:32px;color:${iconColor};"></ha-icon>
                          </div>
                          <div style="flex:1;min-width:0;">
                            <div style="font-size:12px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:4px;">Current Season</div>
                            <div style="font-size:22px;font-weight:700;color:var(--primary-text-color);">${seasonName}</div>
                          </div>
                          <div style="padding:6px 12px;border-radius:8px;background:${statusBg};color:${statusColor};font-size:12px;font-weight:700;">${statusText}</div>
                        </div>
                      `;
                    ]]]

              # Refresh button for dropdowns
              - type: custom:button-card
                template: template_secondary
                name: Refresh Data
                icon: mdi:refresh
                tap_action:
                  action: call-service
                  service: script.registry_refresh_dropdowns
                hold_action:
                  action: none

              # Editor mode selector
              - type: entities
                entities:
                  - entity: input_select.registry_season_editor_mode
                    name: Mode
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                    }

              #----------------------------------------------------------------
              # Edit Existing Season (conditional)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_season_editor_mode
                    state: "Edit Existing Season"
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        **Select a season to edit.** Changes are auto-loaded when you select.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: var(--card-background-color);
                          }

                    # Season selector using HA input_select (matches farm/paddock pattern)
                    - type: entities
                      entities:
                        - entity: input_select.registry_season
                          name: Select Season
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 4px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.3rem !important;
                          }

                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: EDIT SEASON DETAILS

                    - type: entities
                      entities:
                        - entity: input_text.registry_edit_season_name
                          name: Season Name
                        - entity: input_datetime.registry_edit_season_start
                          name: Start Date
                        - entity: input_datetime.registry_edit_season_end
                          name: End Date
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    # Action buttons - horizontal row
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Save Changes
                          icon: mdi:content-save
                          tap_action:
                            action: call-service
                            service: script.registry_save_season_edit
                          hold_action:
                            action: none
                          confirmation:
                            text: Save season changes?

                        - type: custom:button-card
                          template: template_action
                          name: Set Active
                          icon: mdi:calendar-check
                          tap_action:
                            action: call-service
                            service: script.registry_set_active_season
                            service_data:
                              id: "[[[ return states['input_text.registry_edit_season_pointer'].state; ]]]"
                          hold_action:
                            action: none
                          confirmation:
                            text: Set this as the active season?

                        - type: custom:button-card
                          template: template_danger
                          name: Delete
                          icon: mdi:delete
                          tap_action:
                            action: call-service
                            service: script.registry_delete_season
                            service_data:
                              id: "[[[ return states['input_text.registry_edit_season_pointer'].state; ]]]"
                          hold_action:
                            action: none
                          confirmation:
                            text: Delete this season? This cannot be undone.

              #----------------------------------------------------------------
              # Add New Season (conditional)
              #----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_season_editor_mode
                    state: "Add New Season"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: NEW SEASON DETAILS

                    - type: entities
                      entities:
                        - entity: input_text.registry_new_season_name
                          name: Season Name (e.g., CY26)
                        - entity: input_datetime.registry_season_start
                          name: Start Date
                        - entity: input_datetime.registry_season_end
                          name: End Date
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 6px;
                            background: var(--card-background-color);
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    # Action buttons - horizontal row (matching Edit form style)
                    - type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          template: template_success
                          name: Add Season
                          icon: mdi:calendar-plus
                          tap_action:
                            action: call-service
                            service: script.registry_add_season_from_form
                            data:
                              set_active: false
                          hold_action:
                            action: none
                          confirmation:
                            text: Add this new season?

                        - type: custom:button-card
                          template: template_action
                          name: Add & Set Active
                          icon: mdi:calendar-star
                          tap_action:
                            action: call-service
                            service: script.registry_add_season_from_form
                            data:
                              set_active: true
                          hold_action:
                            action: none
                          confirmation:
                            text: Add this season and set it as the active season?

              #----------------------------------------------------------------
              # Season Cards Display
              #----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: SEASON LIST

              - type: custom:button-card
                entity: sensor.farm_registry_data
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                    - padding: 0
                    - margin: 0
                  grid:
                    - display: block
                custom_fields:
                  seasons: |
                    [[[
                      try {
                        if (!entity || !entity.attributes) {
                          return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">Loading...</div>`;
                        }

                        const seasons = entity.attributes.seasons || {};
                        const activeSeason = entity.attributes.active_season || '';
                        const seasonList = Object.entries(seasons);

                        if (seasonList.length === 0) {
                          return `<div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                                    <ha-icon icon="mdi:calendar-range" style="--mdc-icon-size:48px;margin-bottom:12px;opacity:0.5;"></ha-icon>
                                    <div style="font-size:16px;">No seasons defined</div>
                                    <div style="font-size:14px;margin-top:8px;">Add one using the form above</div>
                                  </div>`;
                        }

                        // Helper function to format date as dd/mm/yy
                        const formatDate = (dateStr) => {
                          if (!dateStr || dateStr === '---') return '---';
                          try {
                            const parts = dateStr.split('-');
                            if (parts.length === 3) {
                              const year = parts[0].slice(-2); // last 2 digits
                              const month = parts[1];
                              const day = parts[2];
                              return day + '/' + month + '/' + year;
                            }
                          } catch (e) {}
                          return dateStr;
                        };

                        let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:4px;">`;

                        for (const [sid, season] of seasonList) {
                          const name = season.name || sid;
                          const startDate = formatDate(season.start_date);
                          const endDate = formatDate(season.end_date);
                          const isActive = sid === activeSeason;

                          const cardColor = isActive ? '#7b1fa2' : '#5c6bc0';
                          const cardBg = isActive ? 'rgba(123,31,162,0.15)' : 'rgba(92,107,192,0.15)';
                          const statusColor = isActive ? '#4caf50' : '#9e9e9e';
                          const statusBg = isActive ? 'rgba(76,175,80,0.15)' : 'rgba(158,158,158,0.15)';
                          const statusText = isActive ? 'ACTIVE' : 'INACTIVE';

                          html += `
                            <div style="background:var(--card-background-color);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);border-left:4px solid ${cardColor};">
                              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                                <div style="width:50px;height:50px;border-radius:50%;background:${cardBg};display:flex;align-items:center;justify-content:center;">
                                  <ha-icon icon="${isActive ? 'mdi:calendar-star' : 'mdi:calendar-range'}" style="--mdc-icon-size:28px;color:${cardColor};"></ha-icon>
                                </div>
                                <div style="flex:1;min-width:0;">
                                  <div style="font-size:20px;font-weight:700;color:var(--primary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                                </div>
                                <div style="padding:4px 10px;border-radius:12px;background:${statusBg};color:${statusColor};font-size:11px;font-weight:700;">${statusText}</div>
                              </div>
                              <div style="display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid var(--divider-color,#e0e0e0);">
                                <div style="text-align:center;flex:1;">
                                  <div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:4px;">Start</div>
                                  <div style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${startDate}</div>
                                </div>
                                <div style="width:1px;background:var(--divider-color,#e0e0e0);"></div>
                                <div style="text-align:center;flex:1;">
                                  <div style="font-size:11px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:4px;">End</div>
                                  <div style="font-size:14px;font-weight:600;color:var(--primary-text-color);">${endDate}</div>
                                </div>
                              </div>
                            </div>`;
                        }

                        html += `</div>`;
                        return html;
                      } catch (e) {
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                      }
                    ]]]

  # ===========================================================================
  # View 4: Crop Types
  # ===========================================================================
  - title: Crops
    path: crops
    icon: mdi:sprout
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: CROP TYPES

              - type: markdown
                content: |
                  Define crop types and their growth stages. Each crop can have
                  multiple stages (e.g., Germination, Tillering, Flowering).
                card_mod:
                  style: |
                    ha-card {
                      background: transparent;
                      box-shadow: none;
                      padding: 0 12px;
                    }

              # ----------------------------------------------------------------
              # MODE SELECTOR: Add New / Edit Existing
              # ----------------------------------------------------------------
              - type: entities
                entities:
                  - entity: input_select.registry_crop_editor_mode
                    name: Mode
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 4px;
                    }
                    .mdc-list-item__primary-text {
                      font-size: 1.3rem !important;
                    }

              # ----------------------------------------------------------------
              # EDIT EXISTING CROP (conditional)
              # ----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_crop_editor_mode
                    state: "Edit Existing Crop"
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        **Select a crop to edit.** Data auto-loads when you select.
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 8px;
                            background: var(--card-background-color);
                          }

                    # Crop selector
                    - type: entities
                      entities:
                        - entity: input_select.registry_crop
                          name: Select Crop
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                            padding: 4px;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.3rem !important;
                          }

                    # Crop details card (when selected)
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_select.registry_crop
                          state_not: "Select..."
                      card:
                        type: custom:button-card
                        entity: sensor.farm_registry_data
                        triggers_update:
                          - sensor.farm_registry_data
                          - input_select.registry_crop
                        show_name: false
                        show_icon: false
                        show_state: false
                        tap_action:
                          action: none
                        styles:
                          card:
                            - background: var(--card-background-color)
                            - border-radius: 12px
                            - padding: 16px
                            - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                          grid:
                            - display: block
                        custom_fields:
                          content: |
                            [[[
                              try {
                                const selectedName = states['input_select.registry_crop']?.state || '';
                                if (!selectedName || selectedName === 'Select...') {
                                  return `<div style="text-align:center;padding:20px;color:var(--secondary-text-color);">Select a crop to view details</div>`;
                                }

                                const crops = entity?.attributes?.crops || {};
                                let cropId = null;
                                let crop = null;
                                for (const [id, c] of Object.entries(crops)) {
                                  if (c.name === selectedName) {
                                    cropId = id;
                                    crop = c;
                                    break;
                                  }
                                }

                                if (!crop) {
                                  return `<div style="text-align:center;padding:20px;color:var(--secondary-text-color);">Crop not found</div>`;
                                }

                                const stages = crop.stages || [];
                                const color = crop.color || '#4caf50';
                                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                                const startMonth = months[(crop.typical_start_month || 1) - 1];
                                const endMonth = months[(crop.typical_end_month || 12) - 1];

                                let html = `<div style="border-left:4px solid ${color};padding-left:12px;">`;
                                html += `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">`;
                                html += `<div style="width:20px;height:20px;border-radius:4px;background:${color};"></div>`;
                                html += `<div style="font-size:18px;font-weight:700;color:var(--primary-text-color);">${crop.name}</div>`;
                                html += `<div style="font-size:13px;color:var(--secondary-text-color);">${startMonth} - ${endMonth}</div>`;
                                html += `</div>`;

                                html += `<div style="font-size:13px;font-weight:600;color:var(--secondary-text-color);margin-bottom:6px;">Growth Stages (${stages.length})</div>`;
                                if (stages.length === 0) {
                                  html += `<div style="padding:10px;background:var(--secondary-background-color);border-radius:8px;text-align:center;color:var(--secondary-text-color);font-size:13px;">No stages defined</div>`;
                                } else {
                                  html += `<div style="display:flex;flex-wrap:wrap;gap:6px;">`;
                                  for (const stage of stages) {
                                    html += `<div style="padding:6px 12px;background:var(--secondary-background-color);border-radius:6px;font-size:13px;">`;
                                    html += `<span style="color:${color};font-weight:600;">${stage.order}.</span> ${stage.name}`;
                                    html += `</div>`;
                                  }
                                  html += `</div>`;
                                }
                                html += `</div>`;
                                return html;
                              } catch (e) {
                                return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                              }
                            ]]]

                    # Edit form (when selected)
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_select.registry_crop
                          state_not: "Select..."
                      card:
                        type: vertical-stack
                        cards:
                          - type: custom:button-card
                            template: template_titleblock
                            variables:
                              var_name: EDIT CROP DETAILS

                          - type: entities
                            entities:
                              - entity: input_text.registry_edit_crop_name
                                name: Crop Name
                              - entity: input_text.registry_edit_crop_color
                                name: Color (Hex)
                              - entity: input_number.registry_crop_start_month
                                name: Start Month (1-12)
                              - entity: input_number.registry_crop_end_month
                                name: End Month (1-12)
                            card_mod:
                              style: |
                                ha-card {
                                  border-radius: 12px;
                                }

                          # Action buttons row
                          - type: horizontal-stack
                            cards:
                              - type: custom:button-card
                                template: template_success
                                name: Save
                                icon: mdi:content-save
                                tap_action:
                                  action: call-service
                                  service: script.registry_save_crop_edit
                                confirmation:
                                  text: Save crop changes?

                              - type: custom:button-card
                                template: template_danger
                                name: Delete
                                icon: mdi:delete
                                tap_action:
                                  action: call-service
                                  service: script.registry_delete_crop
                                  service_data:
                                    id: "[[[ return states['input_text.registry_edit_crop_pointer'].state; ]]]"
                                confirmation:
                                  text: "Delete this crop type? This cannot be undone."

                    # Manage stages (when selected)
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_select.registry_crop
                          state_not: "Select..."
                      card:
                        type: vertical-stack
                        cards:
                          - type: custom:button-card
                            template: template_titleblock
                            variables:
                              var_name: GROWTH STAGES

                          # Stages list display
                          - type: custom:button-card
                            entity: sensor.farm_registry_data
                            triggers_update:
                              - sensor.farm_registry_data
                              - input_select.registry_crop
                            show_name: false
                            show_icon: false
                            show_state: false
                            tap_action:
                              action: none
                            styles:
                              card:
                                - background: var(--card-background-color)
                                - border-radius: 12px
                                - padding: 12px
                              grid:
                                - display: block
                            custom_fields:
                              stages: |
                                [[[
                                  try {
                                    const selectedName = states['input_select.registry_crop']?.state || '';
                                    const crops = entity?.attributes?.crops || {};
                                    let crop = null;
                                    for (const [id, c] of Object.entries(crops)) {
                                      if (c.name === selectedName) {
                                        crop = c;
                                        break;
                                      }
                                    }

                                    if (!crop) return '';
                                    const stages = crop.stages || [];
                                    const color = crop.color || '#4caf50';

                                    if (stages.length === 0) {
                                      return `<div style="text-align:center;padding:16px;color:var(--secondary-text-color);">No stages defined yet.</div>`;
                                    }

                                    let html = `<div style="display:flex;flex-wrap:wrap;gap:8px;">`;
                                    for (const stage of stages) {
                                      html += `<div style="padding:8px 14px;background:var(--secondary-background-color);border-radius:8px;border-left:3px solid ${color};">`;
                                      html += `<span style="font-weight:600;color:${color};">${stage.order}.</span> ${stage.name}`;
                                      html += `</div>`;
                                    }
                                    html += `</div>`;
                                    return html;
                                  } catch (e) {
                                    return `<div style="color:red;">Error: ${e}</div>`;
                                  }
                                ]]]

                          # Add new stage row
                          - type: horizontal-stack
                            cards:
                              - type: entities
                                entities:
                                  - entity: input_text.registry_new_stage_name
                                    name: New Stage Name
                                card_mod:
                                  style: |
                                    ha-card {
                                      border-radius: 12px;
                                    }

                              - type: custom:button-card
                                template: template_action
                                name: Add
                                icon: mdi:plus
                                styles:
                                  card:
                                    - height: 70px
                                tap_action:
                                  action: call-service
                                  service: script.registry_add_crop_stage
                                  service_data:
                                    crop_id: "[[[ return states['input_text.registry_edit_crop_pointer'].state; ]]]"
                                    name: "[[[ return states['input_text.registry_new_stage_name'].state; ]]]"

                          # Delete stage row
                          - type: horizontal-stack
                            cards:
                              - type: entities
                                entities:
                                  - entity: input_select.registry_crop_stage
                                    name: Select Stage to Delete
                                card_mod:
                                  style: |
                                    ha-card {
                                      border-radius: 12px;
                                    }

                              - type: custom:button-card
                                template: template_danger
                                name: Delete
                                icon: mdi:delete
                                styles:
                                  card:
                                    - height: 70px
                                tap_action:
                                  action: call-service
                                  service: script.registry_delete_selected_stage
                                confirmation:
                                  text: "Delete this growth stage?"

              # ----------------------------------------------------------------
              # ADD NEW CROP (conditional)
              # ----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_select.registry_crop_editor_mode
                    state: "Add New Crop"
                card:
                  type: vertical-stack
                  cards:
                    - type: custom:button-card
                      template: template_titleblock
                      variables:
                        var_name: NEW CROP DETAILS

                    - type: entities
                      entities:
                        - entity: input_text.registry_new_crop_name
                          name: Crop Name
                      card_mod:
                        style: |
                          ha-card {
                            border-radius: 12px;
                          }
                          .mdc-list-item__primary-text {
                            font-size: 1.2rem !important;
                          }

                    - type: markdown
                      content: |
                        New crops are created with default settings (green color, Jan-Dec season).
                        You can edit these after creating the crop.
                      card_mod:
                        style: |
                          ha-card {
                            background: transparent;
                            box-shadow: none;
                            padding: 0 12px;
                            font-size: 13px;
                          }

                    - type: custom:button-card
                      template: template_success
                      name: Create Crop
                      icon: mdi:plus
                      tap_action:
                        action: call-service
                        service: script.registry_add_crop
                        service_data:
                          name: "[[[ return states['input_text.registry_new_crop_name'].state; ]]]"
                          start_month: 1
                          end_month: 12
                          color: "#4caf50"
                      confirmation:
                        text: Create this new crop type?

              # ----------------------------------------------------------------
              # CROP TYPE LIST (always visible)
              # ----------------------------------------------------------------
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: ALL CROP TYPES

              - type: custom:button-card
                entity: sensor.farm_registry_data
                triggers_update:
                  - sensor.farm_registry_data
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: transparent
                    - box-shadow: none
                  grid:
                    - display: block
                custom_fields:
                  crops: |
                    [[[
                      try {
                        const crops = entity?.attributes?.crops || {};
                        const cropList = Object.entries(crops);

                        if (cropList.length === 0) {
                          return `<div style="text-align:center;padding:30px;color:var(--secondary-text-color);">
                                    <ha-icon icon="mdi:sprout" style="--mdc-icon-size:40px;opacity:0.5;margin-bottom:10px;"></ha-icon>
                                    <div>No crop types defined</div>
                                  </div>`;
                        }

                        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">`;

                        for (const [id, crop] of cropList) {
                          const color = crop.color || '#4caf50';
                          const stages = crop.stages || [];
                          const start = months[(crop.typical_start_month || 1) - 1];
                          const end = months[(crop.typical_end_month || 12) - 1];

                          html += `
                            <div style="background:var(--card-background-color);border-radius:12px;padding:14px;border-left:4px solid ${color};">
                              <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="width:16px;height:16px;border-radius:3px;background:${color};"></div>
                                <div style="font-size:16px;font-weight:700;">${crop.name}</div>
                              </div>
                              <div style="display:flex;gap:12px;font-size:12px;color:var(--secondary-text-color);">
                                <span>${start} - ${end}</span>
                                <span>${stages.length} stage${stages.length !== 1 ? 's' : ''}</span>
                              </div>
                            </div>`;
                        }

                        html += `</div>`;
                        return html;
                      } catch (e) {
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                      }
                    ]]]

  # ===========================================================================
  # View 5: Module Management
  # ===========================================================================
  - title: Modules
    path: modules
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              # ----------------------------------------------------------------
              # Setup Required Card - Shows when integration not configured
              # ----------------------------------------------------------------
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.paddisense_version
                    state_not: unavailable
                card:
                  type: custom:button-card
                  show_name: false
                  show_icon: false
                  tap_action:
                    action: none
                  styles:
                    card:
                      - display: none

              - type: custom:button-card
                entity: sensor.paddisense_version
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: navigate
                  navigation_path: /config/integrations/dashboard
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 16px
                    - padding: 24px
                    - box-shadow: 0 4px 12px rgba(0,0,0,0.15)
                    - border-left: 6px solid "#fd7e14"
                    - display: |
                        [[[
                          return (entity && entity.state && entity.state !== 'unavailable' && entity.state !== 'unknown') ? 'none' : 'block';
                        ]]]
                  grid:
                    - display: block
                custom_fields:
                  setup: |
                    [[[
                      return `
                        <div style="text-align:center;">
                          <div style="width:80px;height:80px;border-radius:50%;background:rgba(253,126,20,0.15);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
                            <ha-icon icon="mdi:alert-circle-outline" style="--mdc-icon-size:48px;color:#fd7e14;"></ha-icon>
                          </div>
                          <div style="font-size:22px;font-weight:700;color:var(--primary-text-color);margin-bottom:12px;">Setup Required</div>
                          <div style="font-size:14px;color:var(--secondary-text-color);line-height:1.6;margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto;">
                            PaddiSense integration needs to be configured before you can manage modules.
                            <br><br>
                            Please complete the setup wizard to register your account and activate your license.
                          </div>
                          <div style="display:flex;flex-direction:column;gap:12px;max-width:300px;margin:0 auto;">
                            <div style="background:#0066cc;color:white;padding:14px 24px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;">
                              <ha-icon icon="mdi:cog" style="--mdc-icon-size:22px;"></ha-icon>
                              Go to Integrations
                            </div>
                            <div style="font-size:12px;color:var(--secondary-text-color);">
                              Settings → Devices & Services → Add Integration → Search "PaddiSense"
                            </div>
                          </div>
                        </div>
                      `;
                    ]]]

              # Title - hidden when not configured
              - type: custom:button-card
                entity: sensor.paddisense_version
                template: template_titleblock
                variables:
                  var_name: MODULE MANAGEMENT
                styles:
                  card:
                    - display: |
                        [[[
                          return (entity && entity.state && entity.state !== 'unavailable' && entity.state !== 'unknown') ? 'flex' : 'none';
                        ]]]

              # Version & Update Status Card (display only)
              - type: custom:button-card
                entity: sensor.paddisense_version
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                    - display: |
                        [[[
                          return (entity && entity.state && entity.state !== 'unavailable' && entity.state !== 'unknown') ? 'block' : 'none';
                        ]]]
                  grid:
                    - display: block
                custom_fields:
                  status: |
                    [[[
                      if (!entity || !entity.attributes) {
                        return `<div style="text-align:center;padding:20px;color:var(--secondary-text-color);">Loading...</div>`;
                      }

                      const version = entity.state || 'Unknown';
                      const latestVersion = entity.attributes.latest_version || 'Not checked';
                      const updateAvailable = entity.attributes.update_available === true;
                      const lastChecked = entity.attributes.last_checked ? new Date(entity.attributes.last_checked).toLocaleString() : 'Never';

                      const statusBadge = updateAvailable
                        ? `<span style="background:#fd7e14;color:white;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;">UPDATE AVAILABLE: v${latestVersion}</span>`
                        : `<span style="background:#4caf50;color:white;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;">UP TO DATE</span>`;

                      return `
                        <div style="display:flex;align-items:center;gap:12px;">
                          <ha-icon icon="mdi:package-variant" style="--mdc-icon-size:28px;color:#0066cc;"></ha-icon>
                          <div style="flex:1;">
                            <div style="font-size:14px;font-weight:700;color:var(--primary-text-color);">PaddiSense v${version}</div>
                            <div style="font-size:11px;color:var(--secondary-text-color);">Last checked: ${lastChecked}</div>
                          </div>
                          ${statusBadge}
                        </div>
                      `;
                    ]]]

              # Check for Updates button (full width)
              - type: custom:button-card
                entity: sensor.paddisense_version
                name: Check for Updates
                icon: mdi:cloud-download
                color_type: card
                color: "#0066cc"
                tap_action:
                  action: call-service
                  service: paddisense.check_for_updates
                styles:
                  card:
                    - height: 70px
                    - border-radius: 12px
                  name:
                    - font-size: 14px
                    - font-weight: 700
                    - color: white
                  icon:
                    - color: white
                    - width: 22px

              # Update button (only visible when update available)
              - type: custom:button-card
                entity: sensor.paddisense_version
                name: |
                  [[[
                    const ver = entity?.attributes?.latest_version || 'latest';
                    return `Update to v${ver}`;
                  ]]]
                icon: mdi:download
                color_type: card
                color: "#28a745"
                tap_action:
                  action: call-service
                  service: paddisense.update_paddisense
                  service_data:
                    backup_first: true
                  confirmation:
                    text: Update PaddiSense? A backup will be created first.
                styles:
                  card:
                    - height: 70px
                    - border-radius: 12px
                    - display: |
                        [[[
                          const updateAvailable = entity?.attributes?.update_available === true;
                          return updateAvailable ? 'flex' : 'none';
                        ]]]
                  name:
                    - font-size: 14px
                    - font-weight: 700
                    - color: white
                  icon:
                    - color: white
                    - width: 22px

              # Module Cards - Using horizontal-stack with info + button
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: weather
                      title: Weather
                      desc: Local weather data
                      icon: mdi:weather-cloudy
                      color: '#2196f3'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: weather
                      title: Weather
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: ipm
                      title: Inventory Product Manager
                      desc: Farm consumables
                      icon: mdi:warehouse
                      color: '#4caf50'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: ipm
                      title: Inventory Product Manager
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: asm
                      title: Asset Service Manager
                      desc: Farm maintenance & inspections
                      icon: mdi:tractor
                      color: '#ff9800'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: asm
                      title: Asset Service Manager
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: hfm
                      title: Hey Farmer
                      desc: Farm event data
                      icon: mdi:chart-areaspline
                      color: '#7b1fa2'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: hfm
                      title: Hey Farmer
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: rtr
                      title: Real Time Rice
                      desc: Rice prediction model data
                      icon: mdi:rice
                      color: '#43a047'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: rtr
                      title: Real Time Rice
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: str
                      title: Stock Tracker
                      desc: Manage your mobs
                      icon: mdi:cow
                      color: '#8d6e63'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: str
                      title: Stock Tracker
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: pwm
                      title: Precision Water Management
                      desc: Irrigation automation
                      icon: mdi:water
                      color: '#00bcd4'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: pwm
                      title: Precision Water Management
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: pds_module_info
                    variables:
                      module_id: wss
                      title: Worker Safety System
                      desc: Know where your people are
                      icon: mdi:account-hard-hat
                      color: '#e53935'
                  - type: custom:button-card
                    template: pds_module_button
                    variables:
                      module_id: wss
                      title: Worker Safety System

  # ===========================================================================
  # View 6: Settings
  # ===========================================================================
  - title: Settings
    path: settings
    icon: mdi:cog-outline
    type: sections
    max_columns: 1
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: BACKUP & RESTORE

              - type: markdown
                content: |
                  Create backups of your PaddiSense configuration and farm data.
                  Backups can be restored to recover from issues or migrate to a new server.
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 8px;
                      background: var(--card-background-color);
                    }

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_action
                    name: Create Backup
                    icon: mdi:backup-restore
                    tap_action:
                      action: call-service
                      service: paddisense.create_backup
                    hold_action:
                      action: none
                    confirmation:
                      text: Create a backup of PaddiSense configuration?

                  - type: custom:button-card
                    template: template_action
                    name: Export Registry
                    icon: mdi:database-export
                    tap_action:
                      action: call-service
                      service: paddisense.export_registry
                    hold_action:
                      action: none
                    confirmation:
                      text: Export registry data to backup file?

              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: IMPORT / EXPORT

              - type: markdown
                content: |
                  Import farms and paddocks from a CSV file. Download the template first, fill it out in Excel, save as CSV, then upload to `/config` and import.
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 12px;
                      background: var(--card-background-color);
                    }

              # Export Template button
              - type: custom:button-card
                template: template_action
                name: Download CSV Template
                icon: mdi:file-download
                tap_action:
                  action: call-service
                  service: paddisense.export_registry_template
                confirmation:
                  text: |
                    Export a CSV template to /config/paddisense_import_template.csv?

                    Open this file in Excel, add your farms and paddocks, save as CSV, then import.

              - type: custom:button-card
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                  grid:
                    - display: block
                custom_fields:
                  info: |
                    [[[
                      return `
                        <div>
                          <div style="font-size:14px;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;">CSV Columns:</div>
                          <div style="background:rgba(0,102,204,0.1);border:1px solid #0066cc;border-radius:8px;padding:12px;overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;font-size:11px;">
                              <tr style="border-bottom:1px solid rgba(0,102,204,0.3);">
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Business</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Farm</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Paddock</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Brown Ha</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Green Ha</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Crop 1</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Start</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">End</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Crop 2</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">Start</th>
                                <th style="text-align:left;padding:4px;color:#0066cc;white-space:nowrap;">End</th>
                              </tr>
                              <tr>
                                <td style="padding:4px;color:var(--secondary-text-color);">Smith Farms</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">Main</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">North</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">50</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">45</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">Fallow</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">5</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">10</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">Rice</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">10</td>
                                <td style="padding:4px;color:var(--secondary-text-color);">4</td>
                              </tr>
                            </table>
                          </div>
                          <div style="font-size:11px;color:var(--secondary-text-color);margin-top:8px;">
                            <strong>Note:</strong> Crop months are 1-12 (Jan-Dec). Leave crop columns empty if not used.
                          </div>
                        </div>
                      `;
                    ]]]

              - type: entities
                entities:
                  - entity: input_text.registry_excel_filename
                    name: CSV Filename (in /config)
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 6px;
                      background: var(--card-background-color);
                    }

              - type: custom:button-card
                template: template_success
                name: Import from CSV
                icon: mdi:file-upload
                tap_action:
                  action: call-service
                  service: paddisense.import_from_excel
                  service_data:
                    filename: "[[[ return states['input_text.registry_excel_filename'].state; ]]]"
                confirmation:
                  text: |
                    [[[
                      const filename = states['input_text.registry_excel_filename'].state || '';
                      if (!filename) return 'Please enter a filename first.';
                      return `Import farms and paddocks from ${filename}?`;
                    ]]]

              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: HACS DEPENDENCIES

              - type: markdown
                content: |
                  PaddiSense dashboards require the following HACS components.
                  Click below to install these automatically (requires HACS).
                card_mod:
                  style: |
                    ha-card {
                      border-radius: 12px;
                      padding: 8px;
                      background: var(--card-background-color);
                    }

              # HACS Required Components Display
              - type: custom:button-card
                show_icon: false
                show_name: false
                show_state: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                styles:
                  card:
                    - background: var(--card-background-color)
                    - border-radius: 12px
                    - padding: 16px
                    - box-shadow: 0 2px 6px rgba(0,0,0,0.1)
                  grid:
                    - display: block
                custom_fields:
                  hacs: |
                    [[[
                      try {
                        // Core HACS components (required for all modules)
                        const coreComponents = [
                          { name: 'button-card', desc: 'Action buttons' },
                          { name: 'card-mod', desc: 'Card styling' },
                          { name: 'auto-entities', desc: 'Dynamic lists' },
                          { name: 'mushroom', desc: 'Modern UI cards' },
                          { name: 'apexcharts-card', desc: 'Charts & graphs' },
                          { name: 'mini-graph-card', desc: 'Compact graphs' },
                          { name: 'flex-table-card', desc: 'Data tables' },
                          { name: 'restriction-card', desc: 'Access control' },
                        ];

                        // PWM module components
                        const pwmComponents = [
                          { name: 'circular-timer-card', desc: 'Timer display' },
                          { name: 'flipdown-timer-card', desc: 'Countdown timer' },
                        ];

                        // Weather module components
                        const weatherComponents = [
                          { name: 'windrose-card', desc: 'Wind display' },
                          { name: 'weather-radar-card', desc: 'Radar map' },
                        ];

                        // Integration requirements
                        const integrations = [
                          { name: 'Browser Mod', desc: 'Popups & navigation (Core)' },
                          { name: 'Bureau of Meteorology', desc: 'BOM weather data (Weather module)' },
                        ];

                        let html = '<div>';

                        // Core components
                        html += '<div style="font-size:14px;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;">Core Components (8)</div>';
                        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">';
                        for (const comp of coreComponents) {
                          html += `<div style="background:rgba(76,175,80,0.1);border:1px solid #4caf50;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:6px;">
                            <ha-icon icon="mdi:check-circle" style="--mdc-icon-size:16px;color:#4caf50;"></ha-icon>
                            <div>
                              <div style="font-size:12px;font-weight:600;color:var(--primary-text-color);">${comp.name}</div>
                              <div style="font-size:9px;color:var(--secondary-text-color);">${comp.desc}</div>
                            </div>
                          </div>`;
                        }
                        html += '</div>';

                        // PWM components
                        html += '<div style="font-size:14px;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;">PWM Module (2)</div>';
                        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">';
                        for (const comp of pwmComponents) {
                          html += `<div style="background:rgba(0,150,136,0.1);border:1px solid #009688;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:6px;">
                            <ha-icon icon="mdi:water" style="--mdc-icon-size:16px;color:#009688;"></ha-icon>
                            <div>
                              <div style="font-size:12px;font-weight:600;color:var(--primary-text-color);">${comp.name}</div>
                              <div style="font-size:9px;color:var(--secondary-text-color);">${comp.desc}</div>
                            </div>
                          </div>`;
                        }
                        html += '</div>';

                        // Weather components
                        html += '<div style="font-size:14px;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;">Weather Module (2)</div>';
                        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">';
                        for (const comp of weatherComponents) {
                          html += `<div style="background:rgba(33,150,243,0.1);border:1px solid #2196f3;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:6px;">
                            <ha-icon icon="mdi:weather-cloudy" style="--mdc-icon-size:16px;color:#2196f3;"></ha-icon>
                            <div>
                              <div style="font-size:12px;font-weight:600;color:var(--primary-text-color);">${comp.name}</div>
                              <div style="font-size:9px;color:var(--secondary-text-color);">${comp.desc}</div>
                            </div>
                          </div>`;
                        }
                        html += '</div>';

                        // Integrations
                        html += '<div style="font-size:14px;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;">Integrations (2)</div>';
                        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
                        for (const int of integrations) {
                          html += `<div style="background:rgba(156,39,176,0.1);border:1px solid #9c27b0;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:6px;">
                            <ha-icon icon="mdi:puzzle" style="--mdc-icon-size:16px;color:#9c27b0;"></ha-icon>
                            <div>
                              <div style="font-size:12px;font-weight:600;color:var(--primary-text-color);">${int.name}</div>
                              <div style="font-size:9px;color:var(--secondary-text-color);">${int.desc}</div>
                            </div>
                          </div>`;
                        }
                        html += '</div>';

                        html += '</div>';
                        return html;
                      } catch (e) {
                        return `<div style="padding:14px;border-radius:12px;background:rgba(244,67,54,0.12);">Error: ${e}</div>`;
                      }
                    ]]]

              # HACS Installation buttons
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_action
                    name: Install HACS
                    icon: mdi:store
                    tap_action:
                      action: call-service
                      service: shell_command.paddisense_install_hacs
                    hold_action:
                      action: none
                    confirmation:
                      text: |
                        Install HACS (Home Assistant Community Store)?

                        After installation, restart Home Assistant and configure HACS in Settings > Integrations.

                  - type: custom:button-card
                    template: template_success
                    name: Install HACS Cards
                    icon: mdi:download-box
                    tap_action:
                      action: call-service
                      service: paddisense.install_hacs_cards
                    hold_action:
                      action: none
                    confirmation:
                      text: Install all required HACS frontend cards?

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_action
                    name: Install Browser Mod
                    icon: mdi:application-brackets
                    tap_action:
                      action: call-service
                      service: paddisense.install_module_hacs
                      service_data:
                        module_id: core
                    hold_action:
                      action: none
                    confirmation:
                      text: |
                        Install Browser Mod integration?

                        Required for popups and navigation controls.

                  - type: custom:button-card
                    template: template_action
                    name: Install BOM Integration
                    icon: mdi:weather-cloudy
                    tap_action:
                      action: call-service
                      service: paddisense.install_module_hacs
                      service_data:
                        module_id: weather
                    hold_action:
                      action: none
                    confirmation:
                      text: |
                        Install Bureau of Meteorology integration?

                        This is required for Australian weather forecasts.

              - type: custom:button-card
                template: template_titleblock
                variables:
                  var_name: ADVANCED

              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: template_warning
                    name: Rollback
                    icon: mdi:undo-variant
                    tap_action:
                      action: call-service
                      service: paddisense.rollback
                    hold_action:
                      action: none
                    confirmation:
                      text: Rollback to the previous version? This will restore from the last backup.

                  - type: custom:button-card
                    template: template_action
                    name: Integration Settings
                    icon: mdi:tune
                    tap_action:
                      action: navigate
                      navigation_path: /config/integrations/integration/paddisense
                    hold_action:
                      action: none
