# =============================================================================
# REAL TIME RICE (RTR) DASHBOARD
# =============================================================================
# Displays paddock predictions from Real Time Rice integration.
# Data is fetched daily from the RTR CSV endpoint.
# =============================================================================

title: Real Time Rice
views:
  - title: Predictions
    path: predictions
    icon: mdi:rice
    cards:
      # Title
      - type: markdown
        content: |
          ## Real Time Rice Predictions
        card_mod:
          style: |
            ha-card {
              background: transparent;
              box-shadow: none;
            }

      # Refresh Button
      - type: custom:button-card
        name: Refresh RTR Data
        icon: mdi:refresh
        tap_action:
          action: call-service
          service: paddisense.refresh_rtr_data
        styles:
          card:
            - height: 50px
            - background: "#0066cc"
            - border-radius: 12px
          name:
            - color: white
            - font-weight: 600
            - font-size: 15px
          icon:
            - color: white
            - width: 22px

      # Paddock Predictions - one card per row with IPM-style layout
      # Filtered to show only current season (sow_date from Sep 2025 onwards)
      - type: custom:auto-entities
        card:
          type: grid
          columns: 1
          square: false
        card_param: cards
        filter:
          include:
            - entity_id: sensor.paddisense_rtr_*
              attributes:
                sow_date: ">=2025-09-01"
              options:
                type: custom:button-card
                entity: this.entity_id
                show_name: false
                show_state: false
                show_icon: false
                styles:
                  card:
                    - padding: 20px
                    - border-radius: 12px
                    - border-left: 5px solid var(--primary-color)
                    - box-shadow: 0 2px 8px rgba(0,0,0,0.1)
                  grid:
                    - display: block
                custom_fields:
                  content: |
                    [[[
                      var a = entity.attributes;
                      var name = a.paddock || entity.entity_id.split('.')[1].replace('paddisense_rtr_', '').replace(/_/g, ' ').toUpperCase();
                      var variety = a.variety || '';
                      var method = a.sow_method || '';
                      var subtitle = [variety, method].filter(function(x) { return x; }).join(' · ');

                      function formatDate(d) {
                        if (!d) return '—';
                        try {
                          var date = new Date(d);
                          return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
                        } catch(e) { return d; }
                      }

                      function getDays(d) {
                        if (!d) return null;
                        try {
                          var now = new Date();
                          return Math.round((new Date(d) - now) / 86400000);
                        } catch(e) { return null; }
                      }

                      function badge(d) {
                        var days = getDays(d);
                        var color = 'var(--primary-text-color)';
                        var bg = 'transparent';
                        if (days !== null && days <= 0) { color = '#f44336'; bg = 'rgba(244,67,54,0.15)'; }
                        else if (days !== null && days <= 7) { color = '#ff9800'; bg = 'rgba(255,152,0,0.15)'; }
                        else if (days !== null && days <= 14) { color = '#4caf50'; bg = 'rgba(76,175,80,0.15)'; }
                        return '<span style="padding:6px 12px;border-radius:8px;background:' + bg + ';color:' + color + ';font-weight:600;font-size:16px;">' + formatDate(d) + '</span>';
                      }

                      var warning = a.warnings ? '<div style="margin-top:16px;padding:12px;background:rgba(244,67,54,0.1);border-radius:8px;color:#f44336;font-size:14px;"><ha-icon icon="mdi:alert" style="--mdc-icon-size:18px;vertical-align:middle;margin-right:6px;"></ha-icon>' + a.warnings + '</div>' : '';

                      var html = '';

                      // Header row with icon and name
                      html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">';
                      html += '<div style="width:56px;height:56px;border-radius:50%;background:rgba(76,175,80,0.15);display:flex;align-items:center;justify-content:center;">';
                      html += '<ha-icon icon="mdi:rice" style="--mdc-icon-size:30px;color:#4caf50;"></ha-icon>';
                      html += '</div>';
                      html += '<div style="flex:1;">';
                      html += '<div style="font-size:22px;font-weight:700;color:var(--primary-text-color);">' + name + '</div>';
                      if (subtitle) {
                        html += '<div style="font-size:14px;color:var(--secondary-text-color);margin-top:4px;">' + subtitle + '</div>';
                      }
                      html += '</div>';
                      html += '</div>';

                      // Dates in 2-column grid
                      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding-top:16px;border-top:1px solid var(--divider-color,#333);">';

                      // Sow Date
                      html += '<div style="padding:12px;background:var(--card-background-color);border-radius:8px;">';
                      html += '<div style="font-size:12px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:8px;">Sow Date</div>';
                      html += '<div style="font-size:18px;font-weight:600;color:var(--primary-text-color);">' + formatDate(a.sow_date) + '</div>';
                      html += '</div>';

                      // PI Date
                      html += '<div style="padding:12px;background:var(--card-background-color);border-radius:8px;">';
                      html += '<div style="font-size:12px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:8px;">PI Predict</div>';
                      html += '<div>' + badge(a.pi_date) + '</div>';
                      html += '</div>';

                      // Flowering Date
                      html += '<div style="padding:12px;background:var(--card-background-color);border-radius:8px;">';
                      html += '<div style="font-size:12px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:8px;">Flowering</div>';
                      html += '<div>' + badge(a.flowering_date) + '</div>';
                      html += '</div>';

                      // Harvest Date
                      html += '<div style="padding:12px;background:var(--card-background-color);border-radius:8px;">';
                      html += '<div style="font-size:12px;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;margin-bottom:8px;">Harvest (22%)</div>';
                      html += '<div>' + badge(a.harvest_date) + '</div>';
                      html += '</div>';

                      html += '</div>';

                      html += warning;

                      return html;
                    ]]]
          exclude:
            - entity_id: sensor.paddisense_rtr
            - entity_id: sensor.paddisense_real_time_rice
        sort:
          method: name
          ignore_case: true

      # Fallback message when no paddocks configured
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.paddisense_real_time_rice
            state: "Not configured"
        card:
          type: markdown
          content: |
            ## RTR Not Configured

            To enable Real Time Rice predictions:

            1. Go to **Developer Tools → Services**
            2. Call `paddisense.set_rtr_url` with your RTR dashboard URL
            3. Click **Call Service**

            Data will refresh automatically each day at 6am.
          card_mod:
            style: |
              ha-card {
                background: rgba(255, 193, 7, 0.1);
                border-left: 4px solid var(--warning-color);
              }
