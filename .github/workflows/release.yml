# PaddiSense Release Workflow
#
# Automatically promotes modules to paddisense-release when a version tag is pushed.
#
# Triggers:
#   - Push of version tag (v*)
#   - Manual dispatch (workflow_dispatch)
#
# Usage:
#   git tag -a v1.2.0 -m "Release 1.2.0"
#   git push origin v1.2.0
#

name: Release to Production

on:
  push:
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string
      modules:
        description: 'Modules to release (comma-separated, or "all")'
        required: true
        default: 'all'
        type: string

env:
  RELEASE_REPO: PKmac78/paddisense-release

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout dev repository
        uses: actions/checkout@v4
        with:
          path: dev

      - name: Checkout release repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.RELEASE_REPO }}
          token: ${{ secrets.RELEASE_REPO_TOKEN }}
          path: release

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF_NAME#v}"
          else
            # Use manual input
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Determine modules
        id: modules
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag push = release all modules
            MODULES="all"
          else
            MODULES="${{ github.event.inputs.modules }}"
          fi
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "Modules to release: $MODULES"

      - name: Copy modules to release repo
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MODULES="${{ steps.modules.outputs.modules }}"

          # Module list
          if [[ "$MODULES" == "all" ]]; then
            MODULE_LIST=(registry ipm weather hfm wss str rtr)
          else
            IFS=',' read -ra MODULE_LIST <<< "$MODULES"
          fi

          echo "Copying modules: ${MODULE_LIST[*]}"

          for mod in "${MODULE_LIST[@]}"; do
            mod=$(echo "$mod" | xargs)  # trim whitespace

            # Copy package file
            PACKAGE="PaddiSense/packages/${mod}.yaml"
            if [[ -f "dev/$PACKAGE" ]]; then
              echo "✓ Copying $PACKAGE"
              cp "dev/$PACKAGE" "release/$PACKAGE"
            else
              echo "! Package not found: $PACKAGE"
            fi

            # Copy dashboard directory
            DASHBOARD="PaddiSense/dashboards/${mod}"
            if [[ -d "dev/$DASHBOARD" ]]; then
              echo "✓ Copying $DASHBOARD/"
              mkdir -p "release/$DASHBOARD"
              cp -r "dev/$DASHBOARD/"* "release/$DASHBOARD/"
            fi
          done

      - name: Copy shared assets
        run: |
          # Copy any shared files that should always be in release
          SHARED_FILES=(
            "PaddiSense/modules.json"
            "PaddiSense/schemas/"
          )

          for item in "${SHARED_FILES[@]}"; do
            if [[ -e "dev/$item" ]]; then
              echo "✓ Copying shared: $item"
              cp -r "dev/$item" "release/$item" 2>/dev/null || true
            fi
          done

      - name: Commit and push to release
        run: |
          cd release
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.version }}"
          MODULES="${{ steps.modules.outputs.modules }}"

          if [[ "$MODULES" == "all" ]]; then
            MSG="Release v${VERSION}"
          else
            MSG="Release ${MODULES} v${VERSION}"
          fi

          git commit -m "$MSG"
          git push origin main

          echo "✓ Released to ${{ env.RELEASE_REPO }}"

      - name: Create release tag in release repo
        if: github.event_name == 'push'
        run: |
          cd release
          VERSION="${{ steps.version.outputs.version }}"

          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

          echo "✓ Tagged release repo with v${VERSION}"
