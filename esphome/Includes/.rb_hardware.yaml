###################################################################################################
# FILE: Includes/.rb-hardware.yaml
#
# üîß PURPOSE
# This file defines the *hardware layer* for all RiceBoard relay boards (RB-xxx).
# It is intended to be included by each device YAML via `includes:` and contains:
#   ‚úî ADC inputs (water depth, soil moisture, battery voltage)
#   ‚úî GPIO inputs (manual switches)
#   ‚úî Outputs (relays, buzzer)
#   ‚úî Safety logic (relay mutual exclusion, beeper alerts)
#   ‚úî Diagnostics (WiFi strength, online status)
#   ‚úî Debug mode toggle (enables raw ADC output)
#
# üß± PHILOSOPHY
# - All hardware logic lives HERE (never repeat in each device)
# - All device-specific calibration lives in substitutions
# - Only API/logger/OTA/WiFi live in `.base.yaml`
# - The config is safe-by-default (no relay starts ON after reboot)
# - All smoothing uses a 3-stage pipeline:
#         Stage 1: Median filter
#         Stage 2: EMA smoothing
#         Stage 3: delta + throttle (reduces HA noise)
#
# üè∑ REQUIRED SUBSTITUTIONS (each device must define)
#   cal_1m_v0, cal_1m_d0, cal_1m_v1, cal_1m_d1
#   cal_5m_v0, cal_5m_d0, cal_5m_v1, cal_5m_d1
#   soil_v0, soil_kpa0, soil_v1, soil_kpa1
#   vbat_divider_ratio
#
# üìù VERSION HISTORY
#   1.0 ‚Äî Finalised production-ready hardware include:
#         - Added 3-stage smoothing for depth sensors
#         - Added debug mode for raw ADC voltage
#         - Added mutual-exclusion actuator logic (Open vs Close)
#         - Added buzzer safety feedback on Close
#         - Added WiFi diagnostics + % strength
#         - Added on-boot safety: force relays OFF
#         - Added soil moisture smoothing
#         - Added battery low-voltage alarm with beeper cancel
#   1.1 (20-11-25)
#         - Added OPEN and CLOSE labels on D1 and D2 manual switches names
#   1.2 (01-12-25)
#         - Removed OPEN and CLOSE labels on D1 and D2 manual switch names (not required)
#         - Added project key to track version installed on a device in device info screen on home assistant
#         - Added action on wifi disconnect to set online sensor state to false
#   1.3 (03-12-25)
#         - Added Ping Response functionality, where before interacting with a devices relays home assistant
#           will ping the device to test connection. Implemented this as a devices connection sensor has some
#           amount of delay after a disconnect to update state to disconnected.
#   1.4 (11-12-25)
#         - Moved Ping button to base file
#
#   1.5 (11-12-25)
#         - updated sensor filter for 1m sensor
##################################################################################################
#
# VERSION CONTROL (IMPORTANT)
# - rb_hardware_version is the authoritative version for this include file.
# - This version is:
#     1) logged on boot
#     2) published to Home Assistant as a text_sensor
#     3) (optionally) used in esphome.project.version for device info display
#
# VERSIONING RULES (practical)
# - PATCH: docs/comments/filter tuning without entity rename
# - MINOR: add new entities/features (backwards compatible)
# - MAJOR: breaking changes (entity rename/remove, behavior change)
###################################################################################################

substitutions:
  rb_hardware_version: "1.5.0"   # <- Update this when you change this include

# ================================================================================================
#                                    BOOT SAFETY + PROJECT INFO
# ================================================================================================
esphome:
  on_boot:
    priority: -100
    then:
      - logger.log: "Boot: RB hardware include initialising"
      - lambda: |-
          ESP_LOGI("rb_hw", "RB hardware include version: %s", "${rb_hardware_version}");


# ================================================================================================
#                                     WIFI CONNECTIVITY HOOKS
# ================================================================================================
wifi:
  # When WiFi disconnects, force your Online sensor false immediately (reduces ‚Äústale online‚Äù time).
  on_disconnect:
    lambda: >-
      id(ha_online).publish_state(false);

###################################################################################################
#                                           PIN MAP
###################################################################################################
# A1 (GPIO34): 4-20mA input            ‚Äî used for 1m depth sensors
# A2 (GPIO35): 4-20mA input            ‚Äî used for 5m depth sensors
# A3 (GPIO32): 0-5V input              ‚Äî used for soil moisture (SS200/WM converter)
# A4 (GPIO33): 0-5V input              ‚Äî used for battery divider
#
# D1 (GPIO36): Manual switch for Relay 1 (inverted)
# D2 (GPIO39): Manual switch for Relay 2 (inverted)
# D3 (GPIO27): Spare
# D4 (GPIO14): Spare
#
# K1 (GPIO2):  Relay 2
# K2 (GPIO15): Relay 1
# K3 (GPIO5):  Relay 3
# K4 (GPIO4):  Relay 4
#
# Buzzer (GPIO18)
###################################################################################################

# ================================================================================================
#                             GLOBAL TOGGLE: DEBUG MODE
# ================================================================================================
# When ON ‚Üí ADC sensors output RAW voltage instead of calibrated readings.
# Useful for calibration and field debugging.
globals:
  - id: debug_mode
    type: bool
    restore_value: no
    initial_value: 'false'

# ================================================================================================
#                               VERSION EXPORT TO HOME ASSISTANT
# ================================================================================================
# Publishes the hardware include version as a HA entity so you can verify deployments remotely.
text_sensor:
  - platform: template
    name: "${friendly_name} RB Hardware Config Version"
    id: "rb_hardware_config_version"
    icon: mdi:chip
    lambda: |-
      return {"${rb_hardware_version}"};

# ================================================================================================
#                                      DIAGNOSTIC SENSORS
# ================================================================================================
sensor:
  # ----------------------------------------------------------------------------------------------
  # WiFi Signal (dB)
  # ----------------------------------------------------------------------------------------------
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal dB"
    id: wifi_signal_db
    update_interval: 240s
    entity_category: diagnostic

  # Convert WiFi dB ‚Üí WiFi Strength %
  - platform: copy
    source_id: wifi_signal_db
    name: "${friendly_name} WiFi Strength"
    unit_of_measurement: "%"
    entity_category: diagnostic
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);

  #################################################################################################
  #                                   1-METER WATER DEPTH SENSOR
  #  ADC34 (A1) ‚Äî 4-20mA ‚Üí voltage via resistor (Kincony internal)
  #  Output unit: cm
  #
  #  FILTER PIPELINE:
  #     - lambda: linear calibration + clamp
  #     - median: remove spikes
  #     - EMA: smooth curve
  #     - delta: reduce HA noise
  #################################################################################################
  - platform: adc
    pin: 34
    name: "${friendly_name} 1m Water Depth"
    update_interval: 20s
    accuracy_decimals: 1
    attenuation: auto
    unit_of_measurement: cm
    filters:
      - lambda: |-
          const float v0 = ${cal_1m_v0};
          const float d0 = ${cal_1m_d0};
          const float v1 = ${cal_1m_v1};
          const float d1 = ${cal_1m_d1};

          if (id(debug_mode)) {
            ESP_LOGD("sensor", "[RAW] 1m ADC pin volts: %.3f V", x);
            return x;
          }

          float meters = d0 + (x - v0) * (d1 - d0) / (v1 - v0);
          float cm = meters * 100.0f;

          // Safety clamp
          if (cm < -10.0f) cm = -10.0f;
          return cm;

      - median:
          window_size: 15
          send_every: 7
          send_first_at: 1

#      - exponential_moving_average:
#          alpha: 0.18
#          send_every: 1

      #- delta: 0.1

  #################################################################################################
  #                                   5-METER WATER DEPTH SENSOR
  #################################################################################################
  - platform: adc
    pin: 35
    name: "${friendly_name} 5m Water Depth"
    update_interval: 60s
    accuracy_decimals: 1
    attenuation: 12db
    unit_of_measurement: cm
    filters:
      - lambda: |-
          if (id(debug_mode)) {
            ESP_LOGD("sensor", "[RAW] 5m ADC pin volts: %.3f V", x);
            return x;
          }

          const float v0 = ${cal_5m_v0};
          const float d0 = ${cal_5m_d0};
          const float v1 = ${cal_5m_v1};
          const float d1 = ${cal_5m_d1};

          float meters = d0 + (x - v0) * (d1 - d0) / (v1 - v0);
          float cm = meters * 100.0f;

          if (cm < -10.0f) cm = -10.0f;
          return cm;

      - median:
          window_size: 15
          send_every: 1
          send_first_at: 1

      - exponential_moving_average:
          alpha: 0.2
          send_every: 1

      - delta: 0.1
      - throttle: 5s

  #################################################################################################
  #                                   SOIL MOISTURE SENSOR
  #  ADC32 (A3) ‚Äî SS200/Watermark via converter
  #  Output: negative kPa (per your convention)
  #################################################################################################
  - platform: adc
    pin: 32
    name: "${friendly_name} Soil Moisture"
    update_interval: 30s
    accuracy_decimals: 1
    attenuation: 6db
    unit_of_measurement: kPa
    filters:
      - lambda: |-
          if (id(debug_mode)) {
            ESP_LOGD("sensor", "Raw Soil Voltage: %.3f V", x);
            return x;
          }

          const float v0 = ${soil_v0};
          const float k0 = ${soil_kpa0};
          const float v1 = ${soil_v1};
          const float k1 = ${soil_kpa1};

          float kpa = k0 + (x - v0) * (k1 - k0) / (v1 - v0);

          ESP_LOGD("sensor", "Calibrated moisture sensor value: %f", kpa);

          float result = (kpa == 0) ? 0 : -kpa;
          ESP_LOGD("sensor", "Soil moisture Output: %f kPa", result);

          return result;

      - median:
          window_size: 15
          send_every: 7
          send_first_at: 1

      - exponential_moving_average:
          alpha: 0.2
          send_every: 7

      - delta: 0.5
      - throttle: 5s

  #################################################################################################
  #                                      BATTERY VOLTAGE SENSOR
  #  ADC33 (A4)
  #  Uses substitution `vbat_divider_ratio` + compensation factor.
  #################################################################################################
  - platform: adc
    pin: 33
    name: "${friendly_name} Battery Voltage"
    id: vbat_raw
    update_interval: 300s
    attenuation: auto
    accuracy_decimals: 2
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    icon: mdi:car-battery
    filters:
      - lambda: |-
          if (id(debug_mode)) {
            ESP_LOGD("sensor", "[RAW] Battery ADC pin volts: %.3f V", x);
            return x;
          }

          float v = x * (${vbat_divider_ratio}) * 1.51515f;
          ESP_LOGD("sensor", "Battery Final value: %f V", v);
          return v;

    on_value_range:
      - below: 11
        then:
          - homeassistant.action:
              action: notify.persistent_notification
              data:
                title: "ESPHome Device Low Battery Alert"
                message: "${friendly_name} battery low"

      - above: 11.1
        then:
          - switch.turn_off: beeper_switch

# ================================================================================================
#                                     BINARY SENSORS
# ================================================================================================
binary_sensor:
  # Manual Switch D1 ‚Üí Relay 1
  - platform: gpio
    pin: GPIO36
    name: "${friendly_name} D1 Manual Switch"
    id: d1_feedback
    device_class: power
    filters:
      - lambda: return !x;
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      - logger.log: "D1 pressed ‚Äî Relay 1 ON"
      - switch.turn_on: relay_1_switch
    on_release:
      - logger.log: "D1 released ‚Äî Relay 1 OFF"
      - switch.turn_off: relay_1_switch

  # Manual Switch D2 ‚Üí Relay 2
  - platform: gpio
    pin: GPIO39
    name: "${friendly_name} D2 Manual Switch"
    id: d2_feedback
    device_class: power
    filters:
      - lambda: return !x;
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      - logger.log: "D2 pressed ‚Äî Relay 2 ON"
      - switch.turn_on: relay_2_switch
    on_release:
      - logger.log: "D2 released ‚Äî Relay 2 OFF"
      - switch.turn_off: relay_2_switch

  # HA Online Sensor
  - platform: status
    name: "${friendly_name} Online"
    id: ha_online
    device_class: connectivity
    # NOTE: status sensor already tracks connectivity. The on_state block below is redundant,
    # but kept to preserve your structure. If you want, we can simplify later.
    on_state:
      if:
        condition:
          binary_sensor.is_on: ha_online
        then:
          lambda: >-
            id(ha_online).publish_state(true);
        else:
          lambda: >-
            id(ha_online).publish_state(false);

# ================================================================================================
#                               OUTPUTS (RAW GPIO DRIVERS)
# ================================================================================================
output:
  - platform: gpio
    pin: GPIO15
    id: relay_1

  - platform: gpio
    pin: GPIO2
    id: relay_2

  - platform: gpio
    pin: GPIO5
    id: relay_3

  - platform: gpio
    pin: GPIO4
    id: relay_4

  - platform: gpio
    pin: GPIO18
    id: beeper

# ================================================================================================
#                                       SWITCH LOGIC
# ================================================================================================
switch:
  # Debug mode toggle (controls ADC raw vs calibrated output)
  - platform: template
    name: "${friendly_name} Debug Logging"
    id: debug_logging
    icon: mdi:bug
    lambda: |-
      return id(debug_mode);
    turn_on_action:
      - lambda: |-
          id(debug_mode) = true;
    turn_off_action:
      - lambda: |-
          id(debug_mode) = false;

  # Relay 1 ‚Äî Actuator OPEN
  - platform: output
    name: "${friendly_name} Actuator Open"
    output: relay_1
    id: relay_1_switch
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_off: relay_2_switch
      - delay: 100ms

  # Relay 2 ‚Äî Actuator CLOSE
  - platform: output
    name: "${friendly_name} Actuator Close"
    output: relay_2
    id: relay_2_switch
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - switch.turn_off: relay_1_switch

      # Safety reminder beep
      - repeat:
          count: 2
          then:
            - switch.turn_on: beeper_switch
            - delay: 0.5s
            - switch.turn_off: beeper_switch
            - delay: 0.5s

      - delay: 100ms

  # Relay 3 (free)
  - platform: output
    name: "${friendly_name} Relay 3"
    output: relay_3
    id: relay_3_switch
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF

  # Relay 4 (free)
  - platform: output
    name: "${friendly_name} Relay 4"
    output: relay_4
    id: relay_4_switch
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF

  # Buzzer
  - platform: output
    name: "${friendly_name} Beeper"
    id: beeper_switch
    output: beeper
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF
